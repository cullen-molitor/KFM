

# Define server logic
server <- function(input, output, session) {
  
  output$oneM_UIout <- renderUI({ # oneM_UI   ----
    if (is.null(input$oneM_allORone))
      return(NULL)
    
    else if(input$oneM_allORone == "One Species by Site") { #  oneM_TP_One     ----
      dyn_ui <- tabPanel("1 m Quadrats", value = 'oneM_TP',  
                         tags$hr(),
                         plotOutput(outputId = "oneM_Plot_One",
                                    height = 500),
                         tags$hr(),
                         fluidRow(
                           conditionalPanel("input.oneM_Graph_One == 'Line' || input.oneM_Graph_One == 'Bar'",
                                            column(3, radioButtons(inputId = "oneM_EB_one",
                                                                   label = "Show error bars?",
                                                                   choices = c("Yes" = 1, "No" = 0),
                                                                   inline = TRUE))),
                           conditionalPanel("input.oneM_Graph_One == 'Bar'",
                                            column(3, radioButtons(inputId = "oneM_Bar_Text_One",
                                                                   label = "Show density value?",
                                                                   choices = c("Yes" = 1, "No" = 0), selected = 0,
                                                                   inline = TRUE))),
                           conditionalPanel("input.oneM_Graph_One == 'Smooth Line'",
                                            column(3, radioButtons(inputId = "oneM_SmoothSE_One",
                                                                   label = "Show the standard error?",
                                                                   choices = c("Yes" = TRUE, "No" = FALSE),
                                                                   inline = TRUE, selected = FALSE))),
                           conditionalPanel("input.oneM_Graph_One == 'Smooth Line' || input.oneM_Graph_One == 'Boxplot' || 
                                            input.oneM_Graph_One == 'Jitter'",
                                            column(3, radioButtons(inputId = "oneM_SmoothPoint_One",
                                                                   label = "Show the mean values?",
                                                                   choices = c("Yes" = 1, "No" = 0),
                                                                   inline = TRUE))),
                           conditionalPanel("input.oneM_GraphOptions_One != 'With No Index'",
                                            column(6, imageOutput(outputId = "oneM_ONIpdoPIC_One",
                                                                  height = 75)))),
                         conditionalPanel("input.oneM_Graph_One == 'Smooth Line'",
                                          sliderInput(inputId = "oneM_SmoothSlide_One",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%")),
                         conditionalPanel("input.oneM_GraphOptions_One == 'With ONI'",
                                          tags$hr(),
                                          ONI_tagList),
                         conditionalPanel("input.oneM_GraphOptions_One == 'With PDO (NOAA)'",
                                          tags$hr(),
                                          PDO_NOAA_tagList),
                         conditionalPanel("input.oneM_GraphOptions_One == 'With PDO (UW)'",
                                          tags$hr(),
                                          PDO_UW_tagList),
                         conditionalPanel("input.oneM_Graph_One == 'Boxplot'",
                                          tags$hr(),
                                          imageOutput(outputId = "oneM_BoxplotDescription_One")),
                         tags$hr(),
                         fluidRow(column(3, tags$h2(tags$strong("Species Classification")),
                                         DTOutput(outputId = "oneM_DToutClass_One")),
                                  column(4, tags$h2(tags$strong(input$oneM_SpeciesName_One)),
                                         imageOutput(outputId = "oneM_LargeSpPhoto_One",
                                                     height = 500)),
                                  column(5, tags$h2(tags$strong("Species Description")),
                                         DTOutput(outputId = "oneM_DToutDesc_One",
                                                  height = 500))),
                         tags$hr(),
                         tags$h2(tags$strong("Summary Data")),
                         DTOutput(outputId = "oneM_DToutData_One",
                                  height = 575),
                         tags$hr()
      )
    } 
    else if(input$oneM_allORone == "One Species by Island") { #  oneM_TP_by_Isl      ---- 
      dyn_ui <- tabPanel("1 m Quadrats", value = 'oneM_TP',
                         tags$hr(),
                         conditionalPanel("input.oneM_FreeOrLock_Isl == 'Locked Scales' ||
                                          input.oneM_FreeOrLock_Isl == 'Free Scales'",
                                          plotOutput(outputId = "oneM_Plot_Isl1",
                                                     height = 800)),
                         conditionalPanel("input.oneM_FreeOrLock_Isl == 'Single Plot'", 
                                          plotOutput(outputId = "oneM_Plot_Isl2",
                                                     height = 500)),
                         tags$hr(),
                         conditionalPanel("input.oneM_DataSummary_Isl == 'Site Means (by Island)' && input.oneM_Graph_Isl != 'Bar'",
                                          fluidRow(
                                            column(11, tags$h4("Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected"))),
                                          tags$hr()),
                         fluidRow(conditionalPanel("input.oneM_Graph_Isl == 'Line' || (input.oneM_Graph_Isl == 'Bar' && 
                                                   input.oneM_DataSummary_Isl == 'Island Mean' && 
                                                   input.oneM_FreeOrLock_Isl != 'Single Plot')",
                                                   column(3, radioButtons(inputId = "oneM_EB_Isl",
                                                                          label = "Show error bars?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                  conditionalPanel("input.oneM_Graph_Isl == 'Bar' && 
                                                   input.oneM_DataSummary_Isl == 'Island Mean' && 
                                                   input.oneM_FreeOrLock_Isl != 'Single Plot'",
                                                   column(3, radioButtons(inputId = "oneM_Bar_Text_Isl",
                                                                          label = "Show density value?",
                                                                          choices = c("Yes" = 1, "No" = 0), selected = 0,
                                                                          inline = TRUE))),
                                  conditionalPanel("(input.oneM_Graph_Isl == 'Bar' && 
                                                   input.oneM_DataSummary_Isl == 'Island Mean' && 
                                                   input.oneM_FreeOrLock_Isl != 'Locked Scales' && 
                                                   input.oneM_FreeOrLock_Isl != 'Free Scales') ||
                                                   (input.oneM_Graph_Isl == 'Bar' && 
                                                   input.oneM_DataSummary_Isl == 'Site Means (by Island)')",
                                                   column(3, radioButtons(inputId = "oneM_BarOptions_Isl",
                                                                          label =  "Bar Graph Options:",
                                                                          choices = c("Stack" = "stack", "Fill" = "fill", "Dodge" = "dodge"),
                                                                          inline = TRUE))),
                                  conditionalPanel("input.oneM_GraphOptions_Isl == 'With ONI' ||
                                                      input.oneM_GraphOptions_Isl == 'With PDO (NOAA)' ||
                                                      input.oneM_GraphOptions_Isl == 'With PDO (UW)'",
                                                   column(6, imageOutput(outputId = "oneM_ONIpdoPIC_Isl",
                                                                         height = 75)))),
                         fluidRow(conditionalPanel("input.oneM_Graph_Isl == 'Line' || input.oneM_Graph_Isl == 'Bar'",
                                                   tags$hr())),
                         conditionalPanel("input.oneM_Graph_Isl == 'Smooth Line'",
                                          sliderInput(inputId = "oneM_SmoothSlide_Isl",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "oneM_SmoothSE_Isl",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "oneM_SmoothPoint_Isl",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                          tags$hr()),
                         conditionalPanel("input.oneM_GraphOptions_Isl == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.oneM_GraphOptions_Isl == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr())
      )
    } 
    else if(input$oneM_allORone == "One Species by MPA") { #  oneM_TP_byMPA     ---- 
      dyn_ui <- tabPanel("1 m Quadrats", value = 'oneM_TP',  
                         tags$hr(),
                         plotOutput(outputId = "oneM_Plot_MPA",
                                    height = 750),
                         tags$hr(),
                         conditionalPanel("input.oneM_DataSummary_MPA == 'Site Means (by MPA)' && input.oneM_Graph_MPA != 'Bar'",
                                          fluidRow(
                                            column(11, tags$h4("Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected"))),
                                          tags$hr()),
                         fluidRow(conditionalPanel("input.oneM_Graph_MPA == 'Line' || (input.oneM_Graph_MPA == 'Bar' && 
                                                   input.oneM_DataSummary_MPA == 'MPA Mean')",
                                                   column(3, radioButtons(inputId = "oneM_EB_MPA",
                                                                          label = "Show error bars?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                  conditionalPanel("input.oneM_Graph_MPA == 'Bar' && input.oneM_DataSummary_MPA == 'MPA Mean'",
                                                   column(3, radioButtons(inputId = "oneM_Bar_Text_MPA",
                                                                          label = "Show density value?",
                                                                          choices = c("Yes" = 1, "No" = 0), selected = 0,
                                                                          inline = TRUE))),
                                  conditionalPanel("input.oneM_GraphOptions_MPA == 'With ONI' ||
                                                      input.oneM_GraphOptions_MPA == 'With PDO (NOAA)' ||
                                                      input.oneM_GraphOptions_MPA == 'With PDO (UW)'",
                                                   column(6, imageOutput(outputId = "oneM_ONIpdoPIC_MPA",
                                                                         height = 75)))),
                         fluidRow(conditionalPanel("input.oneM_Graph_MPA == 'Line' || input.oneM_Graph_MPA == 'Bar'",
                                                   tags$hr())),
                         conditionalPanel("input.oneM_Graph_MPA == 'Smooth Line'",
                                          sliderInput(inputId = "oneM_SmoothSlide_MPA",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "oneM_SmoothSE_MPA",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "oneM_SmoothPoint_MPA",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                          tags$hr()),
                         conditionalPanel("input.oneM_GraphOptions_MPA == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.oneM_GraphOptions_MPA == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr()),
                         MPA_tagList,
                         tags$hr())
    }
    else if(input$oneM_allORone == "Two Species by Site") { #  oneM_TP_Two     ----
      dyn_ui <- tabPanel("1 m Quadrats", value = 'oneM_TP',  
                         tags$hr(),
                         plotOutput(outputId = "oneM_Plot_Two",
                                    height = 500),
                         tags$hr(),
                         sliderInput(inputId = "oneM_Y_Slide_Two",
                                     label = "Adjust the second y-axis by a multiple of:",
                                     min = 1, max = 50, step = 1, value = 1, width = "100%", ticks = T),
                         conditionalPanel("input.oneM_Graph_Two == 'Smooth Line'",
                                          sliderInput(inputId = "oneM_SmoothSlide_Two",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "oneM_SmoothSE_Two",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "oneM_SmoothPoint_Two",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE)))),
                         fluidRow(
                           conditionalPanel("input.oneM_Graph_Two == 'Line' || input.oneM_Graph_Two == 'Bar'",
                                            column(3, radioButtons(inputId = "oneM_EB_Two",
                                                                   label = "Show error bars?",
                                                                   choices = c("Yes" = 1, "No" = 0),
                                                                   inline = TRUE))),
                           conditionalPanel("input.oneM_GraphOptions_Two == 'With ONI' ||
                                                      input.oneM_GraphOptions_Two == 'With PDO (NOAA)' ||
                                                      input.oneM_GraphOptions_Two == 'With PDO (UW)'",
                                            column(6, imageOutput(outputId = "oneM_ONIpdoPIC_Two",
                                                                  height = 75)))),
                         tags$hr(),
                         conditionalPanel("input.oneM_GraphOptions_Two == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.oneM_GraphOptions_Two == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr()),
                         conditionalPanel("input.oneM_GraphOptions_Two == 'With PDO (UW)'",
                                          PDO_UW_tagList,
                                          tags$hr()),
                         fluidRow(column(6, tags$h1(tags$strong(input$oneM_SpeciesName_Two_One)),
                                         imageOutput(outputId = "oneM_LargeSpPhoto_Two_1",
                                                     height = 450)),
                                  column(6, tags$h1(tags$strong(input$oneM_SpeciesName_Two_Two)),
                                         imageOutput(outputId = "oneM_LargeSpPhoto_Two_2",
                                                     height = 450))),
                         tags$hr(),
                         fluidRow(column(6, tags$h1(tags$strong(input$oneM_SpeciesName_Two_One)),
                                         DTOutput(outputId = "oneM_DToutData_Two_1")),
                                  column(6, tags$h1(tags$strong(input$oneM_SpeciesName_Two_Two)),
                                         DTOutput(outputId = "oneM_DToutData_Two_2"))),
                         tags$hr()
      )
    }
    else if(input$oneM_allORone == "All Species") { # oneM_TP_all   ----
      dyn_ui <- tabPanel("1 m Quadrats", value = 'oneM_TP',  
                         tags$hr(),
                         tags$h1(tags$strong(
                           "This section has the species in the order they appear on the datasheet")),
                         plotOutput(outputId = "oneM_Plot_All",
                                    height = 7000),
                         tags$hr())
    }
    return(dyn_ui)
  })
  
  { # ........ oneM_SERVERS ........     ----
    
    { # oneM_Server_One_Species   ----
      
      # filtered summary table
      oneM_Filter_One <- reactive({ 
        oneM_DF %>%
          dplyr::filter(SiteName == input$oneM_SiteName_One,
                        CommonName == input$oneM_SpeciesName_One) %>%
          dplyr::select(SurveyYear, Date, SiteName, IslandName, ScientificName, CommonName, MeanDensity_sqm, 
                        StandardError, StandardError, TotalCount, AreaSurveyed_sqm, MeanDepth, Island_Mean_Density,
                        Species, SiteNumber, IslandCode, SiteCode, IslandSE) 
      }) 
      
      # filtered raw table
      oneM_RawFilter_One <- reactive({ 
        oneM_DFRaw %>%
          dplyr::filter(SiteName == input$oneM_SiteName_One,
                        CommonName == input$oneM_SpeciesName_One)
      }) 
      
      # filtered Species classification table
      oneM_SpeciesClass_One <- reactive({ 
        SpeciesName %>%
          dplyr::filter(CommonName == input$oneM_SpeciesName_One) %>%
          dplyr::select(ScientificName, Kingdom, Phylum, Class, Order, Family, Genus, "Species (Used by KFM)",
                        Status, "Currently Accepted Name", "Authority (Accepted)", CommonName) %>%
          tidyr::pivot_longer(-ScientificName, names_to = "Rank", values_to = "Name") %>%
          dplyr::select(Rank, Name)
      }) 
      
      # filtered Species Description table
      oneM_SpeciesDescription_One <- reactive({
        SpeciesName%>%
          dplyr::filter(CommonName == input$oneM_SpeciesName_One) %>%
          dplyr::select(ScientificName, "Geographic Range", Identification, Habitat, "Size Range", "Trophic Level", Abundance) %>%
          tidyr::pivot_longer(-ScientificName, names_to = "Category", values_to = "Information") %>%
          dplyr::select(Category, Information)
      }) 
      
      # 1st Small species photo above plot
      output$oneM_TopPhoto_One <- renderImage({
        
        if (input$oneM_allORone =='One Species by Site') {
          return(list(src = glue("www/Indicator_Species/{unique(oneM_Filter_One()$Species)}.jpg"),
                      contentType = "image/jpg", width = 210, height = 210))
        }
        else if (input$oneM_allORone == 'One Species by Island') {
          return(list(src = glue("www/Indicator_Species/{unique(oneM_FilterByIsl_Isl()$Species)}.jpg"),
                      contentType = "image/jpg", width = 210, height = 210))
        }
        else if (input$oneM_allORone == 'One Species by MPA') {
          return(list(src = glue("www/Indicator_Species/{unique(oneM_Filter_MPA()$Species)}.jpg"),
                      contentType = "image/jpg", width = 210, height = 210))
        }
        else if (input$oneM_allORone == 'Two Species by Site') {
          return(list(src = glue("www/Indicator_Species/{unique(oneM_Filter_Two_One()$Species)}.jpg"),
                      contentType = "image/jpg", width = 210, height = 210))
        }
        else if (input$oneM_allORone == 'All Species') {
          return(list(src = "www/Protocol_Photos/oneM_.jpg", contentType = "image/jpg", width = 210, height = 210))
        }
      }, deleteFile = FALSE) 
      
      # 2nd Small species photo above plot
      output$oneM_TopPhoto_Two <- renderImage({
        list(src = glue("www/Indicator_Species/{unique(oneM_Filter_Two_Two()$Species)}.jpg"),
             contentType = "image/jpg", width = 210, height = 210)
      }, deleteFile = FALSE) 
      
      # Large species photo below plot
      output$oneM_LargeSpPhoto_One <- renderImage({
        list(src = glue("www/Indicator_Species/{unique(oneM_Filter_One()$Species)}.jpg"),
             contentType = "image/jpg", width = 400, height = 400)
      }, deleteFile = FALSE)
      
      # Small Site photo above plot
      output$oneM_TopSitePhoto_One <- renderImage({
        
        if (input$oneM_allORone =='One Species by Site') {
          return(list(src = glue("www/Sat_Imagery/{unique(oneM_Filter_One()$SiteCode)}.png"),
                      contentType = "image/png", width = 430, height = 210))
        }
        else if (input$oneM_allORone == 'One Species by Island') {
          return(list(src = "www/Sat_Imagery/CHISisl.png",
                      contentType = "image/png", width = 430, height = 210))
        }
        else if (input$oneM_allORone == 'One Species by MPA') {
          return(list(src = "www/Sat_Imagery/CHISmpa.png",
                      contentType = "image/png", width = 430, height = 210))
        }
        else if (input$oneM_allORone == 'Two Species by Site') {
          return(list(src = glue("www/Sat_Imagery/{unique(oneM_Filter_Two_One()$SiteCode)}.png"),
                      contentType = "image/png", width = 430, height = 210))
        }
        else if (input$oneM_allORone == 'All Species') {
          return(list(src = glue("www/Sat_Imagery/{unique(oneM_Filter_All()$SiteCode)}.png"),
                      contentType = "image/png", width = 430, height = 210))
        }
      }, deleteFile = FALSE) 
      
      # Large Site photo below plot
      output$oneM_LargeSitePhoto_One <- renderImage({
        if (input$oneM_allORone =='One Species by Site') {
          return(list(src = glue("www/Sat_Imagery/{unique(oneM_Filter_One()$SiteCode)}.png"),
                      contentType = "image/png", width = 1250, height = 625))
        }
        else if (input$oneM_allORone == 'One Species by Island') {
          return(list(src = "www/Sat_Imagery/CHISisl.png",
                      contentType = "image/png", width = 1250, height = 625))
        }
        else if (input$oneM_allORone == 'One Species by MPA') {
          return(list(src = "www/Sat_Imagery/CHISmpa.png",
                      contentType = "image/png", width = 1250, height = 625))
        }
        else if (input$oneM_allORone == 'Two Species by Site') {
          return(list(src = glue("www/Sat_Imagery/{unique(oneM_Filter_Two_One()$SiteCode)}.png"),
                      contentType = "image/png", width = 1250, height = 625))
        }
        else if (input$oneM_allORone == 'All Species') {
          return(list(src = glue("www/Sat_Imagery/{unique(oneM_Filter_All()$SiteCode)}.png"),
                      contentType = "image/png", width = 1250, height = 625))
        }
        
      }, deleteFile = FALSE) 
      
      # Species Classification data table
      output$oneM_DToutClass_One <- renderDT({
        datatable(oneM_SpeciesClass_One(), 
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    searching = FALSE,
                    lengthChange = FALSE,
                    paging = FALSE,
                    ordering = FALSE,
                    info = FALSE),
                  rownames = FALSE) %>% 
          formatStyle(names(oneM_SpeciesClass_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      }) 
      
      # Species Description data table
      output$oneM_DToutDesc_One <- renderDT({
        datatable(oneM_SpeciesDescription_One(), rownames = FALSE, # editable = TRUE, 
                  options = list(searching = FALSE, lengthChange = FALSE, paging = FALSE,
                                 ordering = FALSE, info = FALSE, 
                                 initComplete = JS(
                                   "function(settings, json) {",
                                   "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                                   "}"))) %>%
          formatStyle(names(oneM_SpeciesDescription_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      })
      
      # proxyDescr <- dataTableProxy("oneM_DToutDesc_One")
      # 
      # observeEvent(input$oneM_DToutDesc_One_cell_edit, {
      #   info <- input$oneM_DToutDesc_One_cell_edit
      #   i <- info$row
      #   j <- info$col + 1L # column index offset by 1
      #   v <- info$value
      #   oneM_SpeciesDescription_One()[i, j] <- coerceValue(v, oneM_SpeciesDescription_One()[i, j])
      #   replaceData(proxyDescr, oneM_SpeciesDescription_One(), resetPaging = FALSE, rownames = FALSE)  # important
      # })
      
      # ONI layer toggle (changes alpha value)
      oneM_alphaONI_one <- reactive({
        if(input$oneM_GraphOptions_One == "With ONI"){return(1)}else{0}
      }) 
      
      # PDO NOAA layer toggle (changes alpha value)
      oneM_alphaPDO_NOAA_one <- reactive({
        if(input$oneM_GraphOptions_One == "With PDO (NOAA)"){return(1)}else{0}
      }) 
      
      # PDO UW layer toggle (changes alpha value)
      oneM_alphaPDO_UW_one <- reactive({
        if(input$oneM_GraphOptions_One == "With PDO (UW)"){return(1)}else{0}
      }) 
      
      # ONI/PDO scale photo
      output$oneM_ONIpdoPIC_One <- renderImage({
        if(input$oneM_GraphOptions_One == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$oneM_GraphOptions_One == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$oneM_GraphOptions_One == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) 
      
      # Line Plot
      oneM_LinePlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin = DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(oneM_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          geom_line(data = oneM_Filter_One(),
                    aes(x = Date, y = MeanDensity_sqm, group = ScientificName, color = CommonName), 
                    size = 1) +
          geom_errorbar(data = oneM_Filter_One(),
                        aes(x = Date, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                        width = 0, color = "black", alpha = as.numeric(input$oneM_EB_one)) +
          scale_x_date(date_labels = "%b %Y", breaks = unique(oneM_Filter_One()$Date),
                       limits = c(min(as.Date(oneM_Filter_One()$Date))-365, max(as.Date(oneM_Filter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          scale_y_continuous(expand = expansion(mult = c(0, .1))) +
          labs(title = glue("{unique(oneM_Filter_One()$ScientificName)}"),
               subtitle = glue("{unique(oneM_Filter_One()$IslandName)} {unique(oneM_Filter_One()$SiteName)}"),
               color = "Common Name",
               fill = "Oceanic Nino \nIndex Gradient",
               caption = glue("{oneM_Filter_One()$SiteName} is typically surveyed in {
                       lubridate::month(round(mean(month(oneM_Filter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                       } and has a mean depth of {round(mean(oneM_Filter_One()$MeanDepth), 2)} ft"),
               x = "Year",
               y = "Mean Density") +
          scale_color_manual(values = SpeciesColor) +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
      })
      
      # Bar Plot
      oneM_BarPlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(oneM_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          new_scale_fill() +
          geom_col(data = oneM_Filter_One(), aes(x = Date - ifelse(input$oneM_DataSummary_One == "One species at one site", 0, 50),
                                                 y = MeanDensity_sqm, fill = CommonName), 
                   position = "dodge", width = ifelse(input$oneM_DataSummary_One == "One species at one site", 250, 100)) +
          geom_errorbar(data = oneM_Filter_One(),
                        aes(x = Date - ifelse(input$oneM_DataSummary_One == "One species at one site", 0, 50), 
                            ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                        width = 0, color = "black", alpha = as.numeric(input$oneM_EB_one)) +
          geom_text(data = oneM_Filter_One(),
                    aes(x = Date - ifelse(input$oneM_DataSummary_One == "One species at one site", 0, 50),
                        y = MeanDensity_sqm, label = round(MeanDensity_sqm, digits = 2)),
                    vjust = -.2, hjust = .5, alpha = as.numeric(input$oneM_Bar_Text_One)) +
          scale_x_date(date_labels = "%b %Y", breaks = unique(oneM_Filter_One()$Date),
                       limits = c(min(as.Date(oneM_Filter_One()$Date))-365,  max(as.Date(oneM_Filter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          scale_y_continuous(expand = expansion(mult = c(0, .1))) +
          labs(title = glue("{unique(oneM_Filter_One()$ScientificName)}"),
               subtitle = glue("{unique(oneM_Filter_One()$IslandName)} {unique(oneM_Filter_One()$SiteName)}"),
               color = "Common Name",
               fill = "Common Name",
               caption = glue("{oneM_Filter_One()$SiteName} is typically surveyed in {
                 lubridate::month(round(mean(month(oneM_Filter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                 } and has a mean depth of {round(mean(oneM_Filter_One()$MeanDepth), 2)} ft"),
               x = "Year",
               y = "Mean Density") +
          scale_fill_manual(values = SpeciesColor) +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
      })
      
      # Smooth Line Plot
      oneM_SmoothPlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(oneM_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          stat_smooth(data = oneM_Filter_One(), 
                      aes(x = Date, y = MeanDensity_sqm, group = ScientificName, color = CommonName), 
                      size = 1, span = input$oneM_SmoothSlide_One, se = as.logical(input$oneM_SmoothSE_One)) +
          scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 1)) +
          geom_point(data = oneM_Filter_One(), aes(x = Date, y = MeanDensity_sqm, color = CommonName), 
                     size = 2, alpha = as.numeric(input$oneM_SmoothPoint_One)) +
          scale_x_date(date_labels = "%b %Y", breaks = unique(oneM_Filter_One()$Date), 
                       limits = c(min(as.Date(oneM_Filter_One()$Date))-365, 
                                  max(as.Date(oneM_Filter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          scale_y_continuous(expand = expansion(mult = c(0, .1))) +
          labs(title = glue("{unique(oneM_Filter_One()$ScientificName)}"), 
               subtitle = glue("{unique(oneM_Filter_One()$IslandName)} {unique(oneM_Filter_One()$SiteName)}"),
               color = "Common Name",
               caption = glue("{oneM_Filter_One()$SiteName} is typically surveyed in {
                       lubridate::month(round(mean(month(oneM_Filter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                       } and has a mean depth of {round(mean(oneM_Filter_One()$MeanDepth), 2)} ft"),
               x = "Year", y = "Smoothed Conditional Mean") +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
      }) 
      
      # Boxplot Plot
      oneM_BoxPlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(oneM_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          geom_boxplot(data = oneM_RawFilter_One(), aes(x = Date, y = Count, group = SurveyYear, color = CommonName)) +
          scale_color_manual(values = SpeciesColor) +
          scale_x_date(date_labels = "%b %Y", breaks = unique(oneM_RawFilter_One()$Date), 
                       limits = c(min(as.Date(oneM_RawFilter_One()$Date))-365, max(as.Date(oneM_RawFilter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          scale_y_continuous(expand = expansion(mult = c(0, .1))) +
          labs(title = glue("{unique(oneM_RawFilter_One()$ScientificName)}"), 
               subtitle = glue("{unique(oneM_RawFilter_One()$IslandName)} {unique(oneM_RawFilter_One()$SiteName)}"),
               color = "Common Name",
               caption = glue("{oneM_RawFilter_One()$SiteName} is typically surveyed in {
                       lubridate::month(round(mean(month(oneM_RawFilter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                       } and has a mean depth of {round(mean(oneM_RawFilter_One()$MeanDepth), 2)} ft"),
               x = "Year",
               y = "Count per Quadrat") +
          new_scale_color() +
          geom_point(data = oneM_Filter_One(), aes(x = Date, y = MeanDensity_sqm, color = SiteName),
                     size = 3, alpha = as.numeric(input$oneM_SmoothPoint_One)) +
          scale_color_manual(values = SiteColor) +
          labs(color = "Site Average") +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
      }) 
      
      # Jitter Plot
      oneM_JiiterPlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(oneM_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          geom_violin(data = oneM_RawFilter_One(), aes(x = Date, y = Count, group = SurveyYear, color = CommonName)) +
          geom_jitter(data = oneM_RawFilter_One() %>% dplyr::filter(Count > 1), aes(x = Date, y = Count, group = SurveyYear, color = CommonName)) +
          scale_color_manual(values = SpeciesColor) +
          scale_x_date(date_labels = "%b %Y", breaks = unique(oneM_RawFilter_One()$Date), 
                       limits = c(min(as.Date(oneM_RawFilter_One()$Date))-365, max(as.Date(oneM_RawFilter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          scale_y_continuous(expand = expansion(mult = c(0, .1))) +
          labs(title = glue("{unique(oneM_RawFilter_One()$ScientificName)}"), 
               subtitle = glue("{unique(oneM_RawFilter_One()$IslandName)} {unique(oneM_RawFilter_One()$SiteName)}"),
               color = "Common Name",
               caption = glue("{oneM_RawFilter_One()$SiteName} is typically surveyed in {
                       lubridate::month(round(mean(month(oneM_RawFilter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                       } and has a mean depth of {round(mean(oneM_RawFilter_One()$MeanDepth), 2)} ft"),
               x = "Year",
               y = "Count per Quadrat") +
          new_scale_color() +
          geom_point(data = oneM_Filter_One(), aes(x = Date, y = MeanDensity_sqm, color = SiteName),
                     size = 3, alpha = as.numeric(input$oneM_SmoothPoint_One)) +
          scale_color_manual(values = SiteColor) +
          labs(color = "Site Average") +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
      })
      
      # Main Plot 
      output$oneM_Plot_One <- renderPlot({
        
        if (is.null(input$oneM_Graph_One))
          return(NULL) 
        
        else if(input$oneM_Graph_One == "Line" && input$oneM_DataSummary_One == "One species at one site")
        {
          p <- oneM_LinePlot_One()
        } 
        else if(input$oneM_Graph_One == "Line" && input$oneM_DataSummary_One == "One species with island average")
        {
          p <- oneM_LinePlot_One() +
            new_scale_color() +
            geom_line(data = oneM_Filter_One(),
                      aes(x = Date, y = Island_Mean_Density, group = ScientificName, color = IslandName),
                      size = 1) +
            geom_errorbar(data = oneM_Filter_One(),
                          aes(x = Date, ymin = Island_Mean_Density - IslandSE,ymax = Island_Mean_Density + IslandSE),
                          width = 0, color = "black", alpha = as.numeric(input$oneM_EB_one)) +
            labs(color = "Island Average") +
            scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 2))
        }
        else if(input$oneM_Graph_One == "Bar" && input$oneM_DataSummary_One == "One species at one site") 
        {
          p <- oneM_BarPlot_One()
        }
        else if(input$oneM_Graph_One == "Bar" && input$oneM_DataSummary_One == "One species with island average") 
        {
          p <- oneM_BarPlot_One() +
            new_scale_fill() +
            geom_col(data = oneM_Filter_One(),
                     aes(x = Date + 50, y = Island_Mean_Density, fill = IslandName),
                     position = "dodge",
                     width = 100) +
            geom_errorbar(data = oneM_Filter_One(),
                          aes(x = Date + 50, ymin = Island_Mean_Density - IslandSE, ymax = Island_Mean_Density + IslandSE),
                          width = 0, color = "black", alpha = as.numeric(input$oneM_EB_one)) +
            scale_fill_manual(values = SpeciesColor, guide = guide_legend(order = 2)) +
            labs(fill = "Island Mean")
        } 
        else if(input$oneM_Graph_One == "Smooth Line" && input$oneM_DataSummary_One == "One species at one site")
        {
          p <- oneM_SmoothPlot_One()
        }
        else if(input$oneM_Graph_One == "Smooth Line" && input$oneM_DataSummary_One == "One species with island average")
        {
          p <- oneM_SmoothPlot_One() +
            new_scale_color() +
            stat_smooth(data = oneM_Filter_One(), 
                        aes(x = Date, y = Island_Mean_Density, group = ScientificName, color = IslandName), 
                        size = 1,
                        span = input$oneM_SmoothSlide_One,
                        se = as.logical(input$oneM_SmoothSE_One)) +
            geom_point(data = oneM_Filter_One(), aes(x = Date, y = Island_Mean_Density, color = IslandName), 
                       size = 2, alpha = as.numeric(input$oneM_SmoothPoint_One)) +
            labs(color = "Island Average") +
            scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 2)) 
        }
        else if(input$oneM_Graph_One == "Boxplot" && input$oneM_DataSummary_One == "One species at one site")
        {
          p <- oneM_BoxPlot_One()  
        }
        else if(input$oneM_Graph_One == "Boxplot" && input$oneM_DataSummary_One == "One species with island average")
        {
          p <- oneM_BoxPlot_One() +
            new_scale_color() +
            geom_point(data = oneM_Filter_One(), aes(x = Date, y = Island_Mean_Density, color = IslandName), 
                       size = 3, alpha = as.numeric(input$oneM_SmoothPoint_One)) +
            labs(color = "Island Average") +
            scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 2)) 
        }
        else if(input$oneM_Graph_One == "Jitter" && input$oneM_DataSummary_One == "One species at one site")
        {
          p <- oneM_JiiterPlot_One()  
        }
        else if(input$oneM_Graph_One == "Jitter" && input$oneM_DataSummary_One == "One species with island average")
        {
          p <- oneM_JiiterPlot_One() +
            new_scale_color() +
            geom_point(data = oneM_Filter_One(), aes(x = Date, y = Island_Mean_Density, color = IslandName), 
                       size = 3, alpha = as.numeric(input$oneM_SmoothPoint_One)) +
            labs(color = "Island Average") +
            scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 2)) 
        }
        return(p)
      }) 
      
      # Boxplot drawing/explanation
      output$oneM_BoxplotDescription_One <- renderImage({
        list(src = glue("www/Boxplot_Description.jpg"), contentType = "image/jpg", width = 550, height = 400)
      }, deleteFile = FALSE) 
      
      # Filtered data table output
      output$oneM_DToutData_One <- renderDT({
        datatable(oneM_Filter_One(), rownames = FALSE, extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    scrollY = "500px", scrollX = TRUE, paging = FALSE,
                    ordering = TRUE, info = FALSE, dom = 'Bfrtip', colReorder = TRUE,
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    columnDefs = c(list(list(visible = FALSE, targets = c(10, 12, 13, 14, 15))), 
                                   list(list(className = 'dt-center', targets = 0:11))))) %>% 
          formatStyle(names(oneM_Filter_One()),
                      color = "black", backgroundColor = 'white')
      }) 
      
    }
    
    { # oneM_Server_by_Island   ----
      
      oneM_Filter_Isl <- reactive({
        oneM_DF <- oneM_DF %>%
          dplyr::filter(CommonName == input$oneM_SpeciesName_Isl) %>%
          dplyr::group_by(SurveyYear, IslandName) %>%
          dplyr::mutate(Date = mean(Date),
                        MaxSumBar = sum(MeanDensity_sqm)) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SiteName, SurveyYear) %>%
          dplyr::mutate(MaxSum = max(sum(MeanDensity_sqm)))
        
      })
      
      oneM_FilterByIsl_Isl <- reactive({
        oneM_DF %>%
          dplyr::filter(CommonName == input$oneM_SpeciesName_Isl) %>%
          dplyr::group_by(IslandDate, IslandCode, IslandName, Species, ScientificName, CommonName, SurveyYear) %>%
          dplyr::distinct(IslandDate, IslandCode, IslandName,Species, ScientificName, CommonName, SurveyYear, 
                          Island_Mean_Density, IslandSD, IslandSE, IslandQuads, IslandAreaSurveyed, IslandTotalCount) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SurveyYear) %>%
          dplyr::mutate(IslandDate = mean(IslandDate))
      })
      
      oneM_yValue_Isl <- reactive({
        if(input$oneM_BarOptions_Isl == "stack"){
          return({
            max(oneM_Filter_Isl()$MaxSumBar)
          }) 
        }
        else if(input$oneM_BarOptions_Isl == "dodge"){
          return({
            max(oneM_Filter_Isl()$MeanDensity_sqm)
          })
        }
        else if(input$oneM_BarOptions_Isl == "fill"){
          return(1)
        }
      })
      
      oneM_yLabel_Isl <- reactive({
        if(input$oneM_BarOptions_Isl == "stack"){
          y <- "Combined Densities"
        }
        else if(input$oneM_BarOptions_Isl == "dodge"){
          y <- "Site Densities"
        }
        else if(input$oneM_BarOptions_Isl == "fill"){
          y <- "Normalized Densities"
        }
        y
      })
      
      oneM_alphaONI_Isl <- reactive({
        if(input$oneM_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        else if(input$oneM_GraphOptions_Isl == "With ONI"){
          return(1)
        }
        else if(input$oneM_GraphOptions_Isl == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$oneM_GraphOptions_Isl == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      oneM_alphaPDO_NOAA_Isl <- reactive({
        if(input$oneM_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        if(input$oneM_GraphOptions_Isl == "With ONI"){
          return(0)
          
        }
        if(input$oneM_GraphOptions_Isl == "With PDO (NOAA)"){
          return(1)
        }
        if(input$oneM_GraphOptions_Isl == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      oneM_alphaPDO_UW_Isl <- reactive({
        if(input$oneM_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        if(input$oneM_GraphOptions_Isl == "With ONI"){
          return(0)
          
        }
        if(input$oneM_GraphOptions_Isl == "With PDO (NOAA)"){
          return(0)
        }
        if(input$oneM_GraphOptions_Isl == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$oneM_ONIpdoPIC_Isl <- renderImage({
        if(input$oneM_GraphOptions_Isl == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$oneM_GraphOptions_Isl == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$oneM_GraphOptions_Isl == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      oneM_AxisScale_Isl <- reactive({
        if(input$oneM_FreeOrLock_Isl == "Locked Scales"){
          return("fixed")
        }
        if(input$oneM_FreeOrLock_Isl == "Free Scales"){
          return("free")
        }
      }) # Facet Plot Axis Scale free or fixed 
      
      output$oneM_Plot_Isl1 <- renderPlot({ # Facet plots    ---- 
        
        if (is.null(input$oneM_Graph_Isl))
          return(NULL) 
        
        else if(input$oneM_Graph_Isl == "Line" && input$oneM_DataSummary_Isl == "Island Mean") { # Line   ----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(oneM_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = oneM_FilterByIsl_Isl(), 
                        aes(x = IslandDate, y = Island_Mean_Density, group = IslandName, color = IslandName),
                        size = 1) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(oneM_FilterByIsl_Isl()$IslandDate))-365,
                                      max(as.Date(oneM_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              geom_errorbar(data = oneM_FilterByIsl_Isl(), 
                            aes(x = IslandDate, ymin = Island_Mean_Density - IslandSE, ymax = Island_Mean_Density + IslandSE),
                            width = 0, color = "black", alpha = as.numeric(input$oneM_EB_Isl)) +
              labs(title = oneM_FilterByIsl_Isl()$ScientificName, 
                   subtitle = oneM_FilterByIsl_Isl()$CommonName,
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Density") +
              facet_grid(rows = vars(IslandName), scales = oneM_AxisScale_Isl()) +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16, face = "bold"),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"),
                    panel.border = element_rect(fill = NA)) 
          })
        } 
        else if(input$oneM_Graph_Isl == "Line" && input$oneM_DataSummary_Isl == "Site Means (by Island)") {
          return({
            out <- by(data = oneM_Filter_Isl(), INDICES = oneM_Filter_Isl()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(oneM_alphaONI_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_Isl()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_line(data = m, 
                          aes(Date, MeanDensity_sqm, group = SiteName, colour = SiteName, linetype = SiteName),
                          size = 1) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date),
                             limits = c(min(as.Date(m$Date))-365, max(as.Date(m$Date))+365),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(limits = c(0, ifelse(input$oneM_FreeOrLock_Isl == "Locked Scales", 
                                                        max(oneM_Filter_Isl()$MaxSum), max(m$MeanDensity_sqm))),
                                   expand = expansion(mult = c(0, .1))) +
                geom_errorbar(data = m, 
                              aes(x = Date, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                              width = 0, color = "black", alpha = as.numeric(input$oneM_EB_Isl)) +
                labs(color = "Site Name",
                     linetype ="Site Name",
                     x = NULL,
                     y = "Mean Density") +
                facet_grid(rows = vars(IslandName)) +
                scale_color_manual(values = SiteColor, breaks = as.character(m$SiteName), guide = guide_legend(ncol = 2)) +
                scale_linetype_manual(values = SiteLine, breaks = as.character(m$SiteName), guide = guide_legend(ncol = 2)) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(.5, "cm"),
                      legend.spacing = unit(.1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(oneM_Filter_Isl()$ScientificName)} - {unique(oneM_Filter_Isl()$CommonName)}"),
                                          label_size = 20, label_fontface = "bold"
            ))
          })
        } 
        else if(input$oneM_Graph_Isl == "Bar" && input$oneM_DataSummary_Isl == "Island Mean") { # Bar   ----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(oneM_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = oneM_FilterByIsl_Isl(), 
                       aes(x = IslandDate, y = Island_Mean_Density, fill = IslandName),
                       position = "dodge",
                       width = 280) +
              facet_grid(rows = vars(IslandName), scales = oneM_AxisScale_Isl()) +
              geom_text(data = oneM_FilterByIsl_Isl(),
                        aes(x = IslandDate, y = Island_Mean_Density, label = round(Island_Mean_Density, digits = 2)),
                        position = position_dodge(1), vjust = -.2, hjust = .5, angle = 0, alpha = as.numeric(input$oneM_Bar_Text_Isl)) +
              geom_errorbar(data = oneM_FilterByIsl_Isl(), 
                            aes(x = IslandDate, ymin = Island_Mean_Density - IslandSE, ymax = Island_Mean_Density + IslandSE),
                            width = 0, color = "black", alpha = as.numeric(input$oneM_EB_Isl)) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              scale_x_date(date_labels = "%b %Y", date_breaks = "1 year", 
                           limits = c(min(as.Date(oneM_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(oneM_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(oneM_FilterByIsl_Isl()$ScientificName)}"),
                   subtitle = glue("{unique(oneM_FilterByIsl_Isl()$CommonName)}"),
                   color = "Common Name",
                   fill = "Common Name",
                   x = "Year",
                   y = "Mean Density") +
              scale_fill_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16, face = "bold"),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"),
                    panel.border = element_rect(fill = NA))
          })
        }
        else if(input$oneM_Graph_Isl == "Bar" && input$oneM_DataSummary_Isl == "Site Means (by Island)") {
          return({
            out <- by(data = oneM_Filter_Isl(), INDICES = oneM_Filter_Isl()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() +
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(oneM_alphaONI_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_Isl()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                new_scale_fill() +
                geom_col(data = m, aes(x = Date, y = MeanDensity_sqm, fill = SiteName),
                         position = input$oneM_BarOptions_Isl, width = 280) +
                coord_cartesian(ylim = c(0, ifelse(input$oneM_FreeOrLock_Isl == "Locked Scales", 
                                                   oneM_yValue_Isl(), max(m$MaxSumBar)))) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date), expand = expansion(mult = c(0.01, .01)),
                             limits = c(min(as.Date(m$Date))-365, max(as.Date(m$Date))+365)) +
                scale_y_continuous(expand = expansion(mult = c(0, .1))) +
                labs(fill = "Site Name",
                     x = "Year",
                     y = oneM_yLabel_Isl()) +
                facet_grid(rows = vars(IslandName)) +
                scale_fill_manual(values = SiteColor, guide = guide_legend(ncol = 2)) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(.5, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title.x = element_text(size = 16, face = "bold"),
                      axis.title.y = element_text(size = 12, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(oneM_Filter_Isl()$ScientificName)} - {unique(oneM_Filter_Isl()$CommonName)}"),
                                          label_size = 20, label_fontface = "bold"
            ))
          })
        } 
        else if(input$oneM_Graph_Isl == "Smooth Line" && input$oneM_DataSummary_Isl == "Island Mean") { # Smooth   -----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(oneM_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_smooth(data = oneM_FilterByIsl_Isl(), aes(x = IslandDate, y = Island_Mean_Density, color = IslandName),
                          se = as.logical(input$oneM_SmoothSE_Isl),
                          span = input$oneM_SmoothSlide_Isl) +
              geom_point(data = oneM_FilterByIsl_Isl(), aes(x = IslandDate, y = Island_Mean_Density, color = IslandName),
                         size = 1, alpha = as.numeric(input$oneM_SmoothPoint_Isl),inherit.aes = FALSE) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(oneM_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(oneM_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              labs(title = glue("{unique(oneM_FilterByIsl_Isl()$ScientificName)}"), 
                   subtitle = input$oneM_SpeciesName_Isl,
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Density") +
              facet_grid(rows = vars(IslandName), scales = oneM_AxisScale_Isl()) +
              scale_color_manual(values = SpeciesColor, guide = guide_legend(nrow = 5)) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16, face = "bold"),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"),
                    panel.border = element_rect(fill = NA))
          })
        }
        else if(input$oneM_Graph_Isl == "Smooth Line" && input$oneM_DataSummary_Isl == "Site Means (by Island)") { 
          return({
            out <- by(data = oneM_Filter_Isl(), INDICES = oneM_Filter_Isl()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() +
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(oneM_alphaONI_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_Isl()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_point(data = m, aes(x = Date, y = MeanDensity_sqm, color = SiteName),
                           size = 1, alpha = as.numeric(input$oneM_SmoothPoint_Isl), inherit.aes = FALSE) +
                geom_smooth(data = m, aes(x = Date, y = MeanDensity_sqm, color = SiteName, linetype = SiteName),
                            se = as.logical(input$oneM_SmoothSE_Isl), span = input$oneM_SmoothSlide_Isl) +
                scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                             limits = c(min(as.Date(oneM_FilterByIsl_Isl()$IslandDate))-365, 
                                        max(as.Date(oneM_FilterByIsl_Isl()$IslandDate))+365),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(expand = expansion(mult = c(0, .01)),
                                   limits = c(0, ifelse(input$oneM_FreeOrLock_Isl == "Locked Scales", 
                                                        max(oneM_Filter_Isl()$MaxSum), max(m$MeanDensity_sqm)))) +
                labs(color = "Site Name",
                     linetype = "Site Name",
                     x = "Year",
                     y = "Mean Density") +
                facet_grid(rows = vars(IslandName)) +
                scale_color_manual(values = SiteColor, guide = guide_legend(ncol = 2)) +
                scale_linetype_manual(values = SiteLine, guide = guide_legend(ncol = 2)) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 13, colour = "black", face = "bold"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(oneM_Filter_Isl()$ScientificName)} - {unique(oneM_Filter_Isl()$CommonName)}"),
                                          label_size = 20, label_fontface = "bold"
            ))
          })
        }
        
      })
      
      output$oneM_Plot_Isl2 <- renderPlot({  # Single plot    ----
        
        if (is.null(input$oneM_Graph_Isl))
          return(NULL) 
        
        else if(input$oneM_Graph_Isl == "Line" && input$oneM_DataSummary_Isl == "Island Mean") { # Line   ----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(oneM_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = oneM_FilterByIsl_Isl(), 
                        aes(x = IslandDate, y = Island_Mean_Density, group = IslandName, color = IslandName),
                        size = 1) +
              scale_x_date(date_labels = "%Y", breaks = oneM_FilterByIsl_Isl()$IslandDate, 
                           limits = c(min(as.Date(oneM_FilterByIsl_Isl()$IslandDate))-365,
                                      max(as.Date(oneM_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              geom_errorbar(data = oneM_FilterByIsl_Isl(), 
                            aes(x = IslandDate, ymin = Island_Mean_Density - IslandSE, ymax = Island_Mean_Density + IslandSE),
                            width = 0, color = "black", alpha = as.numeric(input$oneM_EB_Isl)) +
              labs(title = glue("{unique(oneM_FilterByIsl_Isl()$ScientificName)}"),
                   subtitle = glue("{unique(oneM_FilterByIsl_Isl()$CommonName)}"),
                   color = "Island Name",
                   x = "Year",
                   y = "Mean Density") +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "right",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16, face = "bold"),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        } 
        else if(input$oneM_Graph_Isl == "Line" && input$oneM_DataSummary_Isl == "Site Means (by Island)") {
          return({
            ggplot() + 
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(oneM_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = oneM_Filter_Isl(), 
                        aes(Date, MeanDensity_sqm, group = SiteName, colour = SiteName, linetype = SiteName),
                        size = 1) +
              scale_x_date(date_labels = "%Y", date_breaks = "1 year",
                           limits = c(min(as.Date(oneM_FilterByIsl_Isl()$IslandDate))-365,
                                      max(as.Date(oneM_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              scale_y_continuous(limits = c(0, max(oneM_Filter_Isl()$MaxSum)), expand = expansion(mult = c(0, .01))) +
              geom_errorbar(data = oneM_Filter_Isl(), 
                            aes(x = Date, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                            width = 0, color = "black", alpha = as.numeric(input$oneM_EB_Isl)) +
              labs(title = oneM_Filter_Isl()$ScientificName,
                   subtitle = oneM_Filter_Isl()$CommonName,
                   color = "Site Name",
                   linetype ="Site Name",
                   caption = "Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected",
                   x = NULL,
                   y = "Mean Density") +
              geom_vline(size = 1, xintercept = as.Date("2005-07-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2005-07-01", format = "%Y-%m-%d"), 
                        y= Inf, aes(label = "16 New Sites Added"),
                        hjust = 0,
                        vjust = 1,
                        inherit.aes = FALSE) +
              geom_vline(size = 1, xintercept = as.Date("2001-06-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2001-06-01", format = "%Y-%m-%d"), 
                        y= Inf, aes(label = "Miracle Mile Added"),
                        hjust = 1,
                        vjust = 1,
                        inherit.aes = FALSE) +
              scale_color_manual(values = SiteColor2, guide = guide_legend(ncol = 10)) +
              scale_linetype_manual(values = SiteLine, guide = guide_legend(ncol = 10)) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.key.width = unit(1, "cm"),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 12, colour = "black"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16, face = "bold"),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$oneM_Graph_Isl == "Bar" && input$oneM_DataSummary_Isl == "Island Mean") { # Bar -----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(oneM_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = oneM_FilterByIsl_Isl(), 
                       aes(x = IslandDate, y = Island_Mean_Density, fill = IslandName),
                       position = input$oneM_BarOptions_Isl, width = 280) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              scale_x_date(date_labels = "%Y", breaks = oneM_FilterByIsl_Isl()$IslandDate, 
                           limits = c(min(as.Date(oneM_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(oneM_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(oneM_FilterByIsl_Isl()$ScientificName)}"),
                   subtitle = glue("{unique(oneM_FilterByIsl_Isl()$CommonName)}"),
                   color = "Island Name",
                   fill = "Island Name",
                   x = "Year",
                   y = oneM_yLabel_Isl()) +
              scale_fill_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "right",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16, face = "bold"),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$oneM_Graph_Isl == "Bar" && input$oneM_DataSummary_Isl == "Site Means (by Island)") {
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(oneM_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = oneM_Filter_Isl() %>% dplyr::group_by(SurveyYear) %>% dplyr::mutate(Date = mean(Date)), 
                       aes(x = Date-75, y = MeanDensity_sqm, fill = SiteName),
                       position = input$oneM_BarOptions_Isl, width = 280) +
              scale_x_date(date_labels = "%Y", date_breaks = "1 year",
                           limits = c(min(as.Date(oneM_Filter_Isl()$Date))-365,
                                      max(as.Date(oneM_Filter_Isl()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              labs(title = oneM_Filter_Isl()$ScientificName,
                   subtitle = oneM_Filter_Isl()$CommonName,
                   color = "Site Name", fill = "Site Name",
                   x = "Year", y = oneM_yLabel_Isl()) +
              geom_vline(size = 1, xintercept = as.Date("2005-01-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2005-01-01", format = "%Y-%m-%d"), y= Inf, aes(label = "16 New Sites Added"),
                        hjust = 0, vjust = 1, inherit.aes = FALSE) +
              geom_vline(size = 1, xintercept = as.Date("2001-01-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2001-01-01", format = "%Y-%m-%d"),  y= Inf, aes(label = "Miracle Mile Added"),
                        hjust = 1, vjust = 1, inherit.aes = FALSE) +
              scale_fill_manual(values = SiteColor2, guide = guide_legend(ncol = 10)) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.key.width = unit(1, "cm"),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 12, colour = "black"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16, face = "bold"),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        } 
        else if(input$oneM_Graph_Isl == "Smooth Line" && input$oneM_DataSummary_Isl == "Island Mean") { # Smooth   ----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(oneM_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_point(data = oneM_FilterByIsl_Isl(), aes(x = IslandDate, y = Island_Mean_Density, color = IslandName), 
                         size = 2, alpha = as.numeric(input$oneM_SmoothPoint_Isl)) +
              geom_smooth(data = oneM_FilterByIsl_Isl(), aes(x= IslandDate, y = Island_Mean_Density, color = IslandName),
                          se = as.logical(input$oneM_SmoothSE_Isl), span = input$oneM_SmoothSlide_Isl) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(oneM_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(oneM_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              labs(title = oneM_FilterByIsl_Isl()$ScientificName,
                   subtitle = oneM_FilterByIsl_Isl()$CommonName, 
                   color = "Island Name",
                   x = "Year",
                   y = "Mean Density") +
              scale_color_manual(values = SpeciesColor, guide = guide_legend(nrow = 5)) +
              theme_classic() +
              theme(legend.position = "right",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16, face = "bold"),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$oneM_Graph_Isl == "Smooth Line" && input$oneM_DataSummary_Isl == "Site Means (by Island)") {
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(oneM_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_point(data = oneM_Filter_Isl(), aes(x = Date, y = MeanDensity_sqm, color = SiteName), 
                         size = 2, alpha = as.numeric(input$oneM_SmoothPoint_Isl)) +
              geom_smooth(data = oneM_Filter_Isl(), aes(x= Date, y = MeanDensity_sqm, color = SiteName, linetype = SiteName),
                          se = as.logical(input$oneM_SmoothSE_Isl), span = input$oneM_SmoothSlide_Isl) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(oneM_Filter_Isl()$Date))-365, 
                                      max(as.Date(oneM_Filter_Isl()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              labs(title = oneM_Filter_Isl()$ScientificName, 
                   subtitle = oneM_Filter_Isl()$CommonName, 
                   color = "Site Name",
                   x = "Year",
                   y = "Mean Density") +
              scale_color_manual(values = SiteColor2, guide = guide_legend(ncol = 10)) +
              scale_linetype_manual(values = SiteLine, guide = guide_legend(ncol = 10)) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 12, colour = "black"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16, face = "bold"),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
      })
      
    }
    
    { # oneM_Server_byMPA ----
      
      oneM_Filter_MPA <- reactive({
        oneM_DFMPA %>%
          dplyr::filter(CommonName == input$oneM_SpeciesName_MPA) %>%
          dplyr::group_by(IslandCode, SurveyYear) %>%
          dplyr::mutate(Date = mean(Date),
                        MaxSumBar = max(sum(MeanDensity_sqm))) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SiteName, SurveyYear) %>%
          dplyr::mutate(MaxSum = max(sum(MeanDensity_sqm))) %>%
          arrange(SiteName)
      })
      
      oneM_FilterBarSite_MPA <-reactive({
        oneM_DFMPA %>%
          dplyr::filter(CommonName == input$oneM_SpeciesName_MPA,
                        SiteName != "Keyhole") %>%
          dplyr::group_by(IslandCode, SurveyYear) %>%
          dplyr::mutate(Date = mean(Date),
                        MaxSumBar = max(sum(MeanDensity_sqm))) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SiteName, SurveyYear) %>%
          dplyr::mutate(MaxSum = max(sum(MeanDensity_sqm)))
      })
      
      oneM_Inside_MPA <- reactive({
        oneM_DFMPA %>% 
          dplyr::filter(CommonName == input$oneM_SpeciesName_MPA,
                        ReserveStatus == "Inside",
                        SiteName != "Keyhole") %>%
          dplyr::group_by(MPA_Date, IslandCode, IslandName, Species, ScientificName, CommonName, SurveyYear) %>%
          dplyr::distinct(MPA_Date, IslandCode, IslandName,Species, ScientificName, CommonName, SurveyYear,
                          MPA_TotalCount, MPA_Mean, MPA_SD, MPA_SE, MPA_Quadrats_Sampled, MPA_AreaSurveyed_sqm, .keep_all = TRUE)
      })
      
      oneM_Outside_MPA <- reactive({
        oneM_DFMPA %>%
          dplyr::filter(CommonName == input$oneM_SpeciesName_MPA,
                        ReserveStatus == "Outside",
                        SiteName != "Keyhole") %>%
          dplyr::group_by(MPA_Date, IslandCode, IslandName, Species, ScientificName, CommonName, SurveyYear) %>%
          dplyr::distinct(MPA_Date, IslandCode, IslandName,Species, ScientificName, CommonName, SurveyYear,
                          MPA_TotalCount, MPA_Mean, MPA_SD, MPA_SE, MPA_Quadrats_Sampled, MPA_AreaSurveyed_sqm, .keep_all = TRUE)
      })
      
      oneM_alphaONI_MPA <- reactive({
        if(input$oneM_GraphOptions_MPA == "With No Index"){
          return(0)
        }
        else if(input$oneM_GraphOptions_MPA == "With ONI"){
          return(1)
        }
        else if(input$oneM_GraphOptions_MPA == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$oneM_GraphOptions_MPA == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      oneM_alphaPDO_NOAA_MPA <- reactive({
        if(input$oneM_GraphOptions_MPA == "With No Index"){
          return(0)
        }
        if(input$oneM_GraphOptions_MPA == "With ONI"){
          return(0)
          
        }
        if(input$oneM_GraphOptions_MPA == "With PDO (NOAA)"){
          return(1)
        }
        if(input$oneM_GraphOptions_MPA == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      oneM_alphaPDO_UW_MPA <- reactive({
        if(input$oneM_GraphOptions_MPA == "With No Index"){
          return(0)
        }
        if(input$oneM_GraphOptions_MPA == "With ONI"){
          return(0)
          
        }
        if(input$oneM_GraphOptions_MPA == "With PDO (NOAA)"){
          return(0)
        }
        if(input$oneM_GraphOptions_MPA == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$oneM_ONIpdoPIC_MPA <- renderImage({
        if(input$oneM_GraphOptions_MPA == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$oneM_GraphOptions_MPA == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$oneM_GraphOptions_MPA == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      oneM_AxisScale_MPA <- reactive({
        if(input$oneM_FreeOrLock_MPA == "Locked Scales"){
          return("fixed")
        }
        if(input$oneM_FreeOrLock_MPA == "Free Scales"){
          return("free")
        }
      }) # Free or fixed axis Scale 
      
      output$oneM_Plot_MPA <- renderPlot({
        if (is.null(input$oneM_Graph_MPA))
          return(NULL)
        
        else if(input$oneM_Graph_MPA == "Line" && input$oneM_DataSummary_MPA == "MPA Mean") {  # Line    ----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(oneM_alphaONI_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = oneM_Filter_MPA() %>% dplyr::filter(SiteName != "Keyhole"), 
                        aes(x = MPA_Date, y = MPA_Mean, group = ReserveStatus, color = ReserveStatus, linetype = ReserveStatus),
                        size = 1) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(oneM_Filter_MPA()$MPA_Date)), 
                                      max(as.Date(oneM_Filter_MPA()$MPA_Date))),
                           expand = expansion(mult = c(0.01, .01))) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              geom_errorbar(data = oneM_Filter_MPA(), 
                            aes(x = MPA_Date, ymin = MPA_Mean - MPA_SE, ymax = MPA_Mean + MPA_SE),
                            width = 0, color = "black", alpha = as.numeric(input$oneM_EB_MPA)) +
              labs(title = glue("{unique(oneM_Filter_MPA()$ScientificName)}"),
                   subtitle = glue("{unique(oneM_Filter_MPA()$CommonName)}"),
                   color = "Reserve Status",
                   linetype = "Reserve Status",
                   x = "Year",
                   y = "Mean Density") +
              scale_color_manual(values=c(Inside = "green3", Outside = "red3")) +
              scale_linetype_manual(values = c(Inside = "dashed", Outside = "solid")) +
              facet_grid(rows = vars(IslandName), scales = oneM_AxisScale_MPA()) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    legend.key.width = unit(2, "cm"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18, face = "bold"),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"),
                    strip.text = element_text(size = 12, colour = "Black", angle = 90, face = "bold"),
                    panel.border = element_rect(fill = NA))
          })
        }
        else if(input$oneM_Graph_MPA == "Line" && input$oneM_DataSummary_MPA == "Site Means (by MPA)") {
          return({
            out <- by(data = oneM_Filter_MPA(), INDICES = oneM_Filter_MPA()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(oneM_alphaONI_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_MPA()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_line(data = m, 
                          aes(x = Date, MeanDensity_sqm, group = SiteName, color = SiteName, linetype = SiteName),
                          size = 1) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date),
                             limits = c(min(as.Date(m$Date)), max(as.Date(m$Date))),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(limits = c(0, ifelse(input$oneM_FreeOrLock_MPA == "Locked Scales", 
                                                        max(oneM_Filter_MPA()$MaxSum), max(m$MeanDensity_sqm))), 
                                   expand = expansion(mult = c(0, .01))) +
                geom_errorbar(data = m, 
                              aes(x = Date, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                              width = 0, color = "black", alpha = as.numeric(input$oneM_EB_MPA)) +
                labs(color = "Site Name",
                     linetype = "Site Name",
                     x = "Year",
                     y = "Mean Density") +
                facet_grid(rows = vars(IslandName)) +
                scale_color_manual(values = SiteColor, breaks = as.character(m$SiteName)) +
                scale_linetype_manual(values = SiteLine, breaks = as.character(m$SiteName)) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(oneM_Filter_MPA()$ScientificName)} - {unique(oneM_Filter_MPA()$CommonName)}"),
                                          label_size = 20,
                                          label_fontface = "bold"
            ))
          })
        }
        else if(input$oneM_Graph_MPA == "Bar" && input$oneM_DataSummary_MPA == "MPA Mean") { # Bar    -----
          return({ 
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(oneM_alphaONI_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = oneM_Inside_MPA(), 
                       aes(x = MPA_Date - 60, y = MPA_Mean, group = ReserveStatus, fill = ReserveStatus),
                       width = 120) +
              geom_text(data = oneM_Inside_MPA(),
                        aes(x = MPA_Date - 60, y = MPA_Mean, label = round(MPA_Mean, digits = 2)),
                        vjust = -.2, hjust = .5, angle = 0, alpha = as.numeric(input$oneM_Bar_Text_MPA)) +
              geom_errorbar(data = oneM_Inside_MPA(), 
                            aes(x = MPA_Date - 60, ymin = MPA_Mean - MPA_SE, ymax = MPA_Mean + MPA_SE),
                            width = 0, color = "black", alpha = as.numeric(input$oneM_EB_MPA)) +
              geom_col(data = oneM_Outside_MPA(), 
                       aes(x = MPA_Date + 60, y = MPA_Mean, group = ReserveStatus, fill = ReserveStatus),
                       width = 120) +
              geom_text(data = oneM_Outside_MPA(),
                        aes(x = MPA_Date + 60, y = MPA_Mean, label = round(MPA_Mean, digits = 2)),
                        vjust = -.2, hjust = .5, angle = 0, alpha = as.numeric(input$oneM_Bar_Text_MPA)) +
              geom_errorbar(data = oneM_Outside_MPA(), 
                            aes(x = MPA_Date + 60, ymin = MPA_Mean - MPA_SE, ymax = MPA_Mean + MPA_SE),
                            width = 0, color = "black", alpha = as.numeric(input$oneM_EB_MPA)) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(oneM_Filter_MPA()$MPA_Date)) - 150, 
                                      max(as.Date(oneM_Filter_MPA()$MPA_Date))),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(oneM_Filter_MPA()$ScientificName)}"),
                   subtitle = glue("{unique(oneM_Filter_MPA()$CommonName)}"),
                   color = "Reserve Status",
                   linetype = "Reserve Status",
                   x = "Year",
                   y = "Mean Density") +
              scale_fill_manual(values = c(Inside = "green3", Outside = "red3")) +
              facet_grid(rows = vars(IslandName), scales = oneM_AxisScale_MPA()) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    legend.key.width = unit(2, "cm"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18, face = "bold"),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"),
                    strip.text = element_text(size = 12, colour = "Black", angle = 90, face = "bold"),
                    panel.border = element_rect(fill = NA))
          })
        }
        else if(input$oneM_Graph_MPA == "Bar" &&  input$oneM_DataSummary_MPA == "Site Means (by MPA)") {
          return({
            out <- by(data = oneM_FilterBarSite_MPA(), INDICES = oneM_FilterBarSite_MPA()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() +
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(oneM_alphaONI_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_MPA()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                new_scale_fill() +
                geom_col(data = m %>% dplyr::filter(ReserveStatus == "Inside"), 
                         aes(x = Date - 70, y = MeanDensity_sqm, fill = SiteName),
                         position = "stack", width = 140) +
                geom_text(data = m %>% dplyr::filter(ReserveStatus == "Inside") %>% 
                            dplyr::group_by(IslandName, SurveyYear) %>% dplyr::mutate(SumBar = sum(MeanDensity_sqm)),
                          aes(x = Date - 70, y = SumBar, label = "In"),
                          vjust = -.2, hjust = .5, angle = 0) +
                scale_fill_manual(values = SiteColor) +
                labs(fill = "Inside") +
                new_scale_fill() +
                geom_col(data = m %>% dplyr::filter(ReserveStatus == "Outside") , 
                         aes(x = Date + 70, y = MeanDensity_sqm, fill = SiteName),
                         position = "stack", width = 140) +
                geom_text(data = m %>% dplyr::filter(ReserveStatus == "Outside") %>%
                            dplyr::group_by(IslandName, SurveyYear) %>%
                            dplyr::mutate(SumBar = sum(MeanDensity_sqm)),
                          aes(x = Date + 70, y = SumBar, label = "Out"),
                          vjust = -.2, hjust = .5, angle = 0) +
                scale_y_continuous(limits = c(0, ifelse(input$oneM_FreeOrLock_MPA == "Locked Scales", 
                                                        max(oneM_Filter_MPA()$MaxSumBar), max(m$MeanDensity_sqm))),
                                   expand = expansion(mult = c(0, .01))) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date), 
                             limits = c(min(as.Date(m$Date)) - 150, max(as.Date(m$Date))),
                             expand = expansion(mult = c(0.01, .01))) +
                labs(fill = "Outside",
                     x = "Year",
                     y = "Mean Density") +
                facet_grid(rows = vars(IslandName)) +
                scale_fill_manual(values = SiteColor) +
                scale_color_manual(values = SiteColor) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(oneM_Filter_MPA()$ScientificName)} - {unique(oneM_Filter_MPA()$CommonName)}"),
                                          label_size = 20,
                                          label_fontface = "bold"
            ))
          })
        } 
        else if(input$oneM_Graph_MPA == "Smooth Line" && input$oneM_DataSummary_MPA == "MPA Mean") {  # Smooth       ----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(oneM_alphaONI_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_point(data = oneM_Filter_MPA() %>% dplyr::filter(SiteName != "Keyhole"), 
                         aes(x= MPA_Date, y = MPA_Mean, color = ReserveStatus),
                         size = 1, alpha = as.numeric(input$oneM_SmoothPoint_MPA), show.legend = FALSE) +
              geom_smooth(data = oneM_Filter_MPA() %>% dplyr::filter(SiteName != "Keyhole"), 
                          aes(x= MPA_Date, y = MPA_Mean, color = ReserveStatus),
                          se = as.logical(input$oneM_SmoothSE_MPA),
                          span = input$oneM_SmoothSlide_MPA) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(oneM_Filter_MPA()$MPA_Date)), 
                                      max(as.Date(oneM_Filter_MPA()$MPA_Date))),
                           expand = expansion(mult = c(0.01, .01))) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              labs(title = glue("{unique(oneM_Filter_MPA()$ScientificName)}"),
                   subtitle = glue("{unique(oneM_Filter_MPA()$CommonName)}"),
                   color = "Reserve Status",
                   linetype = "Reserve Status",
                   x = "Year",
                   y = "Mean Density") +
              scale_color_manual(values=c(Inside = "green3", Outside = "red3")) +
              scale_linetype_manual(values = c(Inside = "dashed", Outside = "solid")) +
              facet_grid(rows = vars(IslandName), scales = oneM_AxisScale_MPA()) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    legend.key.width = unit(2, "cm"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18, face = "bold"),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"),
                    strip.text = element_text(size = 12, colour = "Black", angle = 90, face = "bold"),
                    panel.border = element_rect(fill = NA))
          })
        }
        else if(input$oneM_Graph_MPA == "Smooth Line" && input$oneM_DataSummary_MPA == "Site Means (by MPA)") {
          return({
            out <- by(data = oneM_Filter_MPA(), INDICES = oneM_Filter_MPA()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(oneM_alphaONI_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_MPA()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_point(data = m, aes(x = Date, MeanDensity_sqm, color = SiteName),
                           size = 2, alpha = as.numeric(input$oneM_SmoothPoint_MPA), show.legend = FALSE) +
                geom_smooth(data = m, aes(x = Date, MeanDensity_sqm, color = SiteName, linetype = SiteName),
                            se = as.logical(input$oneM_SmoothSE_MPA),
                            span = input$oneM_SmoothSlide_MPA) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date),
                             limits = c(min(as.Date(m$Date)) - 150, max(as.Date(m$Date))),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(expand = expansion(mult = c(0, .1)),
                                   limits = c(NA, ifelse(input$oneM_FreeOrLock_MPA == "Locked Scales", 
                                                         max(oneM_Filter_MPA()$MaxSum) + max(oneM_Filter_MPA()$MPA_SE), NA))) +
                labs(color = "Site Name",
                     linetype = "Site Name",
                     x = "Year",
                     y = "Mean Density") +
                facet_grid(rows = vars(IslandName)) +
                scale_color_manual(values = SiteColor) +
                scale_linetype_manual(values = SiteLine) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(oneM_Filter_MPA()$ScientificName)} - {unique(oneM_Filter_MPA()$CommonName)}"),
                                          label_size = 20,
                                          label_fontface = "bold"
            ))
          })
        }
      })
      
    }
    
    { # oneM_Server_Two_Species    ----
      
      oneM_Filter_Two_One <- reactive({
        oneM_DF %>%
          dplyr::filter(SiteName == input$oneM_SiteName_Two,
                        CommonName == input$oneM_SpeciesName_Two_One) %>%
          dplyr::select(SurveyYear, Date, SiteName, IslandName, ScientificName, CommonName, MeanDensity_sqm, 
                        StandardError, StandardError, TotalCount, AreaSurveyed_sqm, MeanDepth, Island_Mean_Density,
                        Species, SiteNumber, IslandCode, SiteCode) 
      })
      
      oneM_Filter_Two_Two <- reactive({
        oneM_DF %>%
          dplyr::filter(SiteName == input$oneM_SiteName_Two,
                        CommonName == input$oneM_SpeciesName_Two_Two) %>%
          dplyr::select(SurveyYear, Date, SiteName, IslandName, ScientificName, CommonName, MeanDensity_sqm, 
                        StandardError, StandardError, TotalCount, AreaSurveyed_sqm, MeanDepth, Island_Mean_Density,
                        Species, SiteNumber, IslandCode, SiteCode) 
      })
      
      output$oneM_LargeSpPhoto_Two_1 <- renderImage({
        
        if (is.null(input$oneM_SpeciesName_Two_One))
          return(NULL) 
        
        if (input$oneM_SpeciesName_Two_One == unique(oneM_Filter_Two_One()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(oneM_Filter_Two_One()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(oneM_Filter_Two_One()$CommonName)}"),
            width = 450,
            height = 450
          ))
        }
      }, deleteFile = FALSE)
      
      output$oneM_LargeSpPhoto_Two_2 <- renderImage({
        
        if (input$oneM_SpeciesName_Two_Two == unique(oneM_Filter_Two_Two()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(oneM_Filter_Two_Two()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(oneM_Filter_Two_Two()$CommonName)}"),
            width = 450,
            height = 450
          ))
        }
      }, deleteFile = FALSE)
      
      
      oneM_alphaONI_Two <- reactive({
        if(input$oneM_GraphOptions_Two == "With No Index"){
          return(0)
        }
        else if(input$oneM_GraphOptions_Two == "With ONI"){
          return(1)
        }
        else if(input$oneM_GraphOptions_Two == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$oneM_GraphOptions_Two == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      oneM_alphaPDO_NOAA_Two <- reactive({
        if(input$oneM_GraphOptions_Two == "With No Index"){
          return(0)
        }
        if(input$oneM_GraphOptions_Two == "With ONI"){
          return(0)
          
        }
        if(input$oneM_GraphOptions_Two == "With PDO (NOAA)"){
          return(1)
        }
        if(input$oneM_GraphOptions_Two == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      oneM_alphaPDO_UW_Two <- reactive({
        if(input$oneM_GraphOptions_Two == "With No Index"){
          return(0)
        }
        if(input$oneM_GraphOptions_Two == "With ONI"){
          return(0)
          
        }
        if(input$oneM_GraphOptions_Two == "With PDO (NOAA)"){
          return(0)
        }
        if(input$oneM_GraphOptions_Two == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$oneM_ONIpdoPIC_Two <- renderImage({
        if(input$oneM_GraphOptions_Two == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$oneM_GraphOptions_Two == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$oneM_GraphOptions_Two == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      output$oneM_Plot_Two <- renderPlot({
        
        if (is.null(input$oneM_Graph_Two))
          return(NULL) 
        
        else if(input$oneM_Graph_Two == "Line"){
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(oneM_alphaONI_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_Two()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = oneM_Filter_Two_One(), 
                        aes(x = Date, y = MeanDensity_sqm, group = ScientificName, color = CommonName),
                        size = 1) +
              geom_errorbar(data = oneM_Filter_Two_One(),
                            aes(x = Date, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                            width = 0, color = "black", alpha = as.numeric(input$oneM_EB_Two)) + 
              geom_line(data = oneM_Filter_Two_Two(), 
                        aes(x = Date, y = MeanDensity_sqm*input$oneM_Y_Slide_Two, group = ScientificName, color = CommonName),
                        size = 1) +
              geom_errorbar(data = oneM_Filter_Two_Two(),
                            aes(x = Date, ymin = MeanDensity_sqm*input$oneM_Y_Slide_Two - StandardError*input$oneM_Y_Slide_Two, 
                                ymax = MeanDensity_sqm*input$oneM_Y_Slide_Two + StandardError*input$oneM_Y_Slide_Two),
                            width = 0, color = "black", alpha = as.numeric(input$oneM_EB_Two)) + 
              scale_y_continuous(expand = expansion(mult = c(0, .1)),
                                 sec.axis = sec_axis(~./input$oneM_Y_Slide_Two, 
                                                     name = glue("{unique(oneM_Filter_Two_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%b %Y", breaks = unique(oneM_Filter_Two_One()$Date), 
                           limits = c(min(as.Date(oneM_Filter_Two_One()$Date))-365, 
                                      max(as.Date(oneM_Filter_Two_One()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(oneM_Filter_Two_One()$ScientificName)
                              } and {unique(oneM_Filter_Two_Two()$ScientificName)}"), 
                   subtitle = glue("{unique(oneM_Filter_Two_One()$IslandName)} {unique(oneM_Filter_Two_One()$SiteName)}"),
                   color = "Common Name",
                   caption = 
                     glue(
                       "{oneM_Filter_Two_One()$SiteName} is typically surveyed in {
                     lubridate::month(round(mean(month(oneM_Filter_Two_One()$Date)), 0), label = TRUE, abbr = FALSE)
                     } and has a mean depth of {round(mean(oneM_Filter_Two_One()$MeanDepth), 2)} ft"),
                   x = "Year",
                   y = glue('{unique(oneM_Filter_Two_One()$CommonName)} Mean Density')) +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
          })}
        else if(input$oneM_Graph_Two == "Bar") {
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(oneM_alphaONI_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_Two()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = oneM_Filter_Two_One(), 
                       aes(x = Date - 50, y = MeanDensity_sqm, fill = CommonName),
                       position = "dodge",
                       width = 100) +
              geom_col(data = oneM_Filter_Two_Two(), 
                       aes(x = Date + 50, y = MeanDensity_sqm*input$oneM_Y_Slide_Two, fill = CommonName),
                       position = "dodge",
                       width = 100) +
              geom_errorbar(data = oneM_Filter_Two_One(),
                            aes(x = Date - 50, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                            width = 0, color = "black", alpha = as.numeric(input$oneM_EB_Two)) + 
              geom_errorbar(data = oneM_Filter_Two_Two(),
                            aes(x = Date + 50, ymin = MeanDensity_sqm*input$oneM_Y_Slide_Two - StandardError*input$oneM_Y_Slide_Two, 
                                ymax = MeanDensity_sqm*input$oneM_Y_Slide_Two + StandardError*input$oneM_Y_Slide_Two),
                            width = 0, color = "black", alpha = as.numeric(input$oneM_EB_Two)) + 
              scale_y_continuous(expand = expansion(mult = c(0, .1)), 
                                 sec.axis = sec_axis(~./input$oneM_Y_Slide_Two, 
                                                     name = glue("{unique(oneM_Filter_Two_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%b %Y", breaks = unique(oneM_Filter_Two_One()$Date),
                           limits = c(min(as.Date(oneM_Filter_Two_One()$Date))-365,
                                      max(as.Date(oneM_Filter_Two_One()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(oneM_Filter_Two_One()$ScientificName)
                              } and {unique(oneM_Filter_Two_Two()$ScientificName)}"),
                   subtitle = glue("{unique(oneM_Filter_Two_One()$IslandName)} {unique(oneM_Filter_Two_One()$SiteName)}"),
                   color = "Common Name",
                   caption =
                     glue(
                       "{oneM_Filter_Two_One()$SiteName} is typically surveyed in {
                     lubridate::month(round(mean(month(oneM_Filter_Two_One()$Date)), 0), label = TRUE, abbr = FALSE)
                     } and has a mean depth of {round(mean(oneM_Filter_Two_One()$MeanDepth), 2)} ft"),
                   x = "Year",
                   y = "Mean Density") +
              scale_fill_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
          })}
        else if(input$oneM_Graph_Two == "Smooth Line"){
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(oneM_alphaONI_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_NOAA_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(oneM_alphaPDO_UW_Two()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_smooth(data = oneM_Filter_Two_One(), 
                          aes(x = Date, y = MeanDensity_sqm, group = ScientificName, color = CommonName),
                          size = 1,  span = input$oneM_SmoothSlide_Two, se = as.logical(input$oneM_SmoothSE_Two)) +
              geom_point(data = oneM_Filter_Two_One(),
                         aes(x = Date, y = MeanDensity_sqm, color = CommonName),
                         size = 1, alpha = as.numeric(input$oneM_SmoothPoint_Two)) +
              geom_smooth(data = oneM_Filter_Two_Two(), 
                          aes(x = Date, y = MeanDensity_sqm*input$oneM_Y_Slide_Two, group = ScientificName, color = CommonName),
                          size = 1,  span = input$oneM_SmoothSlide_Two, se = as.logical(input$oneM_SmoothSE_Two)) +
              geom_point(data = oneM_Filter_Two_Two(),
                         aes(x = Date, y = MeanDensity_sqm*input$oneM_Y_Slide_Two, color = CommonName),
                         size = 1, alpha = as.numeric(input$oneM_SmoothPoint_Two)) +
              scale_y_continuous(expand = expansion(mult = c(0, .1)),
                                 sec.axis = sec_axis(~./input$oneM_Y_Slide_Two, 
                                                     name = glue("{unique(oneM_Filter_Two_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%b %Y", breaks = unique(oneM_Filter_Two_One()$Date), 
                           limits = c(min(as.Date(oneM_Filter_Two_One()$Date))-365, 
                                      max(as.Date(oneM_Filter_Two_One()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(oneM_Filter_Two_One()$ScientificName)
                              } and {unique(oneM_Filter_Two_Two()$ScientificName)}"), 
                   subtitle = glue("{unique(oneM_Filter_Two_One()$IslandName)} {unique(oneM_Filter_Two_One()$SiteName)}"),
                   color = "Common Name",
                   caption = 
                     glue(
                       "{oneM_Filter_Two_One()$SiteName} is typically surveyed in {
                     lubridate::month(round(mean(month(oneM_Filter_Two_One()$Date)), 0), label = TRUE, abbr = FALSE)
                     } and has a mean depth of {round(mean(oneM_Filter_Two_One()$MeanDepth), 2)} ft"),
                   x = "Year",
                   y = glue('{unique(oneM_Filter_Two_One()$CommonName)} Mean Density')) +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
          })}
      })
      
      output$oneM_DToutData_Two_1 <- renderDT({
        datatable(oneM_Filter_Two_One(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "500px",
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = c(list(list(visible = FALSE, targets = c(1, 3, 4, 7, 8, 9, 10, 11, 12, 13, 14, 15))), 
                                   list(list(className = 'dt-center', targets = 0:6))),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(oneM_Filter_Two_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      })
      
      output$oneM_DToutData_Two_2 <- renderDT({
        datatable(oneM_Filter_Two_Two(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "500px",
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = c(list(list(visible = FALSE, targets = c(1, 3, 4, 7, 8, 9, 10, 11, 12, 13, 14, 15))), 
                                   list(list(className = 'dt-center', targets = 0:6))),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(oneM_Filter_Two_Two()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      })
      
    }
    
    { # oneM_Server_all   ----
      
      oneM_Filter_All <- reactive({
        oneM_DF %>%
          dplyr::filter(SiteName == input$oneM_SiteName_All) %>%
          drop_na()
      })
      
      oneM_line_alpha <- reactive({
        if (input$oneM_Graph_All == "Line"){return(1)}else{return(0)}
      })
      
      oneM_bar_alpha <- reactive({
        if (input$oneM_Graph_All == "Bar"){return(1)}else{return(0)}
      })
      
      output$oneM_Plot_All <- renderPlot({
        out <- by(data = oneM_Filter_All(), INDICES = oneM_Filter_All()$CommonName, FUN = function(m) {
          m <- droplevels(m)
          m <- ggplot() + 
            geom_line(data = m, size = 1, alpha = oneM_line_alpha(),
                      aes(x = Date, y = MeanDensity_sqm, group = CommonName, colour = CommonName, linetype = SiteName)) +
            geom_col(data = m, width = 250, alpha =  oneM_bar_alpha(),
                     aes(x = Date, y = MeanDensity_sqm, group = CommonName, fill = CommonName)) +
            scale_x_date(date_labels = "%b %Y", breaks = unique(m$Date),
                         expand = expansion(mult = c(0.01, .01))) +
            scale_y_continuous(expand = expansion(mult = c(0, .1))) +
            geom_errorbar(data = m, aes(x = Date, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                          width = 0.25, color = "black") +
            labs(title = m$ScientificName, 
                 subtitle = glue("{m$IslandName} {m$SiteName}"),
                 color = "Common Name",
                 fill = "Common Name",
                 x = "Year",
                 y = "Mean Density") +
            scale_color_manual(values = SpeciesColor) +
            scale_fill_manual(values = SpeciesColor) +
            scale_linetype_manual(values = SiteLine, guide = FALSE) +
            theme_classic() +
            theme(legend.position = "right",
                  legend.justification = c(0,0.5),
                  legend.background = element_rect(),
                  legend.title = element_text(size = 14, colour = "black", face = "bold"),
                  legend.text = element_text(size = 13, colour = "black", face = "bold"),
                  plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                  plot.subtitle = element_text(hjust = 0.5, size = 16),
                  plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                  axis.title = element_text(size = 16, face = "bold"),
                  axis.text.y = element_text(size = 12, face = "bold"),
                  axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                  strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
        })
        do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v'))
      })
    }
    
  }
  
  output$fiveM_UIout <- renderUI({ # fiveM_UI   ----
    if (is.null(input$fiveM_allORone))
      return(NULL)
    
    else if(input$fiveM_allORone == "One Species by Site") { #  fiveM_TP_One     ----
      dyn_ui <- tabPanel("5 m Quadrats", value = 'fiveM_TP',  
                         tags$hr(),
                         plotOutput(outputId = "fiveM_Plot_One",
                                    height = 500),
                         tags$hr(),
                         fluidRow(
                           column(3, conditionalPanel("input.fiveM_Graph_One == 'Line' || input.fiveM_Graph_One == 'Bar'",
                                                      radioButtons(inputId = "fiveM_EB_one",
                                                                   label = "Show error bars?",
                                                                   choices = c("Yes" = 1, "No" = 0),
                                                                   inline = TRUE))),
                           column(3, conditionalPanel("input.fiveM_Graph_One == 'Bar'",
                                                      radioButtons(inputId = "fiveM_Bar_Text_One",
                                                                   label = "Show density value?",
                                                                   choices = c("Yes" = 1, "No" = 0), selected = 0,
                                                                   inline = TRUE))),
                           column(6, conditionalPanel("input.fiveM_GraphOptions_One == 'With ONI' ||
                                                      input.fiveM_GraphOptions_One == 'With PDO (NOAA)' ||
                                                      input.fiveM_GraphOptions_One == 'With PDO (UW)'",
                                                      imageOutput(outputId = "fiveM_ONIpdoPIC_One",
                                                                  height = 75)))),
                         conditionalPanel("input.fiveM_Graph_One == 'Smooth Line'",
                                          sliderInput(inputId = "fiveM_SmoothSlide_One",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "fiveM_SmoothSE_One",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "fiveM_SmoothPoint_One",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE)))),
                         conditionalPanel("input.fiveM_GraphOptions_One == 'With ONI'",
                                          tags$hr(),
                                          ONI_tagList),
                         conditionalPanel("input.fiveM_GraphOptions_One == 'With PDO (NOAA)'",
                                          tags$hr(),
                                          PDO_NOAA_tagList),
                         conditionalPanel("input.fiveM_GraphOptions_One == 'With PDO (UW)'",
                                          tags$hr(),
                                          PDO_UW_tagList),
                         conditionalPanel("input.fiveM_Graph_One == 'Boxplot'",
                                          tags$hr(),
                                          imageOutput(outputId = "fiveM_BoxplotDescription_One")),
                         tags$hr(),
                         fluidRow(column(4, tags$h2(tags$strong(input$fiveM_SpeciesName_One)),
                                         imageOutput(outputId = "fiveM_LargeSpPhoto_One",
                                                     height = 500)),
                                  column(3, tags$h2(tags$strong("Species Classification")),
                                         DTOutput(outputId = "fiveM_DToutClass_One",
                                                  height = 500)),
                                  column(5, tags$h2(tags$strong("Species Description")),
                                         DTOutput(outputId = "fiveM_DToutDesc_One",
                                                  height = 500))),
                         
                         tags$hr(),
                         DTOutput(outputId = "fiveM_DToutData_One",
                                  height = 550),
                         tags$hr(), tags$hr(),
                         imageOutput(outputId = "fiveM_LargeSitePhoto_One",
                                     height = 625),
                         tags$hr()
      )
    } 
    else if(input$fiveM_allORone == "One Species by Island") { #  fiveM_TP_by_Isl      ---- 
      dyn_ui <- tabPanel("5 m Quadrats", value = 'fiveM_TP',
                         tags$hr(),
                         conditionalPanel("input.fiveM_FreeOrLock_Isl == 'Locked Scales' ||
                                          input.fiveM_FreeOrLock_Isl == 'Free Scales'",
                                          plotOutput(outputId = "fiveM_Plot_Isl1",
                                                     height = 1000)),
                         conditionalPanel("input.fiveM_FreeOrLock_Isl == 'Single Plot'", 
                                          plotOutput(outputId = "fiveM_Plot_Isl2",
                                                     height = 500)),
                         tags$hr(),
                         fluidRow(conditionalPanel("input.fiveM_Graph_Isl == 'Line' || (input.fiveM_Graph_Isl == 'Bar' && 
                                                   input.fiveM_DataSummary_Isl == 'Island Mean' && 
                                                   input.fiveM_FreeOrLock_Isl != 'Single Plot')",
                                                   column(3, radioButtons(inputId = "fiveM_EB_Isl",
                                                                          label = "Show error bars?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                  conditionalPanel("input.fiveM_Graph_Isl == 'Bar' && 
                                                   input.fiveM_DataSummary_Isl == 'Island Mean' && 
                                                   input.fiveM_FreeOrLock_Isl != 'Single Plot'",
                                                   column(3, radioButtons(inputId = "fiveM_Bar_Text_Isl",
                                                                          label = "Show density value?",
                                                                          choices = c("Yes" = 1, "No" = 0), selected = 0,
                                                                          inline = TRUE))),
                                  conditionalPanel("(input.fiveM_Graph_Isl == 'Bar' && 
                                                   input.fiveM_DataSummary_Isl == 'Island Mean' && 
                                                   input.fiveM_FreeOrLock_Isl != 'Locked Scales' && 
                                                   input.fiveM_FreeOrLock_Isl != 'Free Scales') ||
                                                   (input.fiveM_Graph_Isl == 'Bar' && 
                                                   input.fiveM_DataSummary_Isl == 'Site Means (by Island)')",
                                                   column(3, radioButtons(inputId = "fiveM_BarOptions_Isl",
                                                                          label =  "Bar Graph Options:",
                                                                          choices = c("Stack" = "stack", "Fill" = "fill", "Dodge" = "dodge"),
                                                                          inline = TRUE))),
                                  conditionalPanel("input.fiveM_GraphOptions_Isl == 'With ONI' ||
                                                      input.fiveM_GraphOptions_Isl == 'With PDO (NOAA)' ||
                                                      input.fiveM_GraphOptions_Isl == 'With PDO (UW)'",
                                                   column(6, imageOutput(outputId = "fiveM_ONIpdoPIC_Isl",
                                                                         height = 75)))),
                         fluidRow(conditionalPanel("input.fiveM_Graph_Isl == 'Line' || input.fiveM_Graph_Isl == 'Bar'",
                                                   tags$hr())),
                         conditionalPanel("input.fiveM_Graph_Isl == 'Smooth Line'",
                                          sliderInput(inputId = "fiveM_SmoothSlide_Isl",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "fiveM_SmoothSE_Isl",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "fiveM_SmoothPoint_Isl",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                          tags$hr()),
                         conditionalPanel("input.fiveM_GraphOptions_Isl == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.fiveM_GraphOptions_Isl == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr())
      )
    } 
    else if(input$fiveM_allORone == "One Species by MPA") { #  fiveM_TP_byMPA     ---- 
      dyn_ui <- tabPanel("5 m Quadrats", value = 'fiveM_TP',  
                         tags$hr(),
                         plotOutput(outputId = "fiveM_Plot_MPA",
                                    height = 850),
                         tags$hr(),
                         fluidRow(conditionalPanel("input.fiveM_Graph_MPA == 'Line' || (input.fiveM_Graph_MPA == 'Bar' && 
                                                   input.fiveM_DataSummary_MPA == 'MPA Mean')",
                                                   column(3, radioButtons(inputId = "fiveM_EB_MPA",
                                                                          label = "Show error bars?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                  conditionalPanel("input.fiveM_Graph_MPA == 'Bar' && input.fiveM_DataSummary_MPA == 'MPA Mean'",
                                                   column(3, radioButtons(inputId = "fiveM_Bar_Text_MPA",
                                                                          label = "Show density value?",
                                                                          choices = c("Yes" = 1, "No" = 0), selected = 0,
                                                                          inline = TRUE))),
                                  conditionalPanel("input.fiveM_GraphOptions_MPA == 'With ONI' ||
                                                      input.fiveM_GraphOptions_MPA == 'With PDO (NOAA)' ||
                                                      input.fiveM_GraphOptions_MPA == 'With PDO (UW)'",
                                                   column(6, imageOutput(outputId = "fiveM_ONIpdoPIC_MPA",
                                                                         height = 75)))),
                         fluidRow(conditionalPanel("input.fiveM_Graph_MPA == 'Line' || input.fiveM_Graph_MPA == 'Bar'",
                                                   tags$hr())),
                         conditionalPanel("input.fiveM_Graph_MPA == 'Smooth Line'",
                                          sliderInput(inputId = "fiveM_SmoothSlide_MPA",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "fiveM_SmoothSE_MPA",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "fiveM_SmoothPoint_MPA",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                          tags$hr()),
                         conditionalPanel("input.fiveM_GraphOptions_MPA == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.fiveM_GraphOptions_MPA == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr()),
                         MPA_tagList,
                         tags$hr())
    }
    else if(input$fiveM_allORone == "Two Species by Site") { #  fiveM_TP_Two     ----
      dyn_ui <- tabPanel("5 m Quadrats", value = 'fiveM_TP',  
                         tags$hr(),
                         plotOutput(outputId = "fiveM_Plot_Two",
                                    height = 500),
                         tags$hr(),
                         sliderInput(inputId = "fiveM_Y_Slide_Two",
                                     label = "Adjust the second y-axis by a multiple of:",
                                     min = 1, max = 50, step = 1, value = 1, width = "100%", ticks = T),
                         conditionalPanel("input.fiveM_Graph_Two == 'Smooth Line'",
                                          sliderInput(inputId = "fiveM_SmoothSlide_Two",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "fiveM_SmoothSE_Two",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "fiveM_SmoothPoint_Two",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE)))),
                         fluidRow(
                           conditionalPanel("input.fiveM_Graph_Two == 'Line' || input.fiveM_Graph_Two == 'Bar'",
                                            column(3, radioButtons(inputId = "fiveM_EB_Two",
                                                                   label = "Show error bars?",
                                                                   choices = c("Yes" = 1, "No" = 0),
                                                                   inline = TRUE))),
                           conditionalPanel("input.fiveM_GraphOptions_Two == 'With ONI' ||
                                                      input.fiveM_GraphOptions_Two == 'With PDO (NOAA)' ||
                                                      input.fiveM_GraphOptions_Two == 'With PDO (UW)'",
                                            column(6, imageOutput(outputId = "fiveM_ONIpdoPIC_Two",
                                                                  height = 75)))),
                         tags$hr(),
                         conditionalPanel("input.fiveM_GraphOptions_Two == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.fiveM_GraphOptions_Two == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr()),
                         conditionalPanel("input.fiveM_GraphOptions_Two == 'With PDO (UW)'",
                                          PDO_UW_tagList,
                                          tags$hr()),
                         fluidRow(column(6, tags$h1(tags$strong(input$fiveM_SpeciesName_Two_One)),
                                         imageOutput(outputId = "fiveM_LargeSpPhoto_Two_1",
                                                     height = 450)),
                                  column(6, tags$h1(tags$strong(input$fiveM_SpeciesName_Two_Two)),
                                         imageOutput(outputId = "fiveM_LargeSpPhoto_Two_2",
                                                     height = 450))),
                         tags$hr(),
                         fluidRow(column(6, tags$h1(tags$strong(input$fiveM_SpeciesName_Two_One)),
                                         DTOutput(outputId = "fiveM_DToutData_Two_1")),
                                  column(6, tags$h1(tags$strong(input$fiveM_SpeciesName_Two_Two)),
                                         DTOutput(outputId = "fiveM_DToutData_Two_2"))),
                         tags$hr(),
                         imageOutput(outputId = "fiveM_LargeSitePhoto_Two",
                                     height = 625),
                         tags$hr()
      )
    }
    else if(input$fiveM_allORone == "All Species") { # fiveM_TP_all   ----
      dyn_ui <- tabPanel("5 m Quadrats", value = 'fiveM_TP',  
                         fluidRow(column(12, tags$h1(tags$strong(
                           "This section has the species in the order they appear on the datasheet")))),
                         plotOutput(outputId = "fiveM_Plot_All",
                                    height = 7000))
    }
    return(dyn_ui)
  })
  
  { # ........ fiveM_SERVERS ........     ----
    
    { # fiveM_Server_One_Species   ----
      
      fiveM_Filter_One <- reactive({ 
        fiveM_DF %>%
          dplyr::filter(SiteName == input$fiveM_SiteName_One,
                        CommonName == input$fiveM_SpeciesName_One) %>%
          dplyr::select(SurveyYear, Date, SiteName, IslandName, ScientificName, CommonName, MeanDensity_sqm, 
                        StandardError, StandardError, TotalCount, AreaSurveyed_sqm, MeanDepth, Island_Mean_Density,
                        Species, SiteNumber, IslandCode, SiteCode, IslandSE) 
      }) # filtered one meter summary table
      
      fiveM_RawFilter_One <- reactive({ 
        fiveM_DFRaw %>%
          dplyr::filter(SiteName == input$fiveM_SiteName_One,
                        CommonName == input$fiveM_SpeciesName_One) %>% 
          dplyr::group_by(SurveyYear) %>% 
          dplyr::mutate(Mean = mean(Count))
      }) # filtered  one Meter raw table
      
      fiveM_SpeciesClass_One <- reactive({ 
        SpeciesName %>%
          dplyr::filter(CommonName == input$fiveM_SpeciesName_One) %>%
          dplyr::select(ScientificName, Kingdom, Phylum, Class, Order, Family, Genus, "Species (Used by KFM)",
                        Status, "Currently Accepted Name", "Authority (Accepted)", CommonName) %>%
          tidyr::pivot_longer(-ScientificName, names_to = "Rank", values_to = "Name") %>%
          dplyr::select(Rank, Name)
      }) # filtered Species classification table
      
      fiveM_SpeciesDescription_One <- reactive({
        SpeciesName %>%
          dplyr::filter(CommonName == input$fiveM_SpeciesName_One) %>%
          dplyr::select(ScientificName, "Geographic Range", Identification, Habitat, "Size Range", "Trophic Level", Abundance) %>%
          tidyr::pivot_longer(-ScientificName, names_to = "Category", values_to = "Information") %>%
          dplyr::select(Category, Information)
      }) # filtered Species Description table  
      
      output$fiveM_TopPhoto_One <- renderImage({
        
        if (input$fiveM_allORone =='One Species by Site') {
          return(list(
            src = glue("www/Indicator_Species/{unique(fiveM_Filter_One()$Species)}.jpg"),
            contentType = "image/jpg", width = 210, height = 210))
        }
        else if (input$fiveM_allORone == 'One Species by Island') {
          return(list(
            src = glue("www/Indicator_Species/{unique(fiveM_FilterByIsl_Isl()$Species)}.jpg"),
            contentType = "image/jpg", width = 210, height = 210))
        }
        else if (input$fiveM_allORone == 'One Species by MPA') {
          return(list(
            src = glue("www/Indicator_Species/{unique(fiveM_Filter_MPA()$Species)}.jpg"),
            contentType = "image/jpg", width = 210, height = 210))
        }
        else if (input$fiveM_allORone == 'Two Species by Site') {
          return(list(
            src = glue("www/Indicator_Species/{unique(fiveM_Filter_Two_One()$Species)}.jpg"),
            contentType = "image/jpg", width = 210, height = 210))
        }
      }, deleteFile = FALSE) # Small species photo above plot
      
      output$fiveM_TopPhoto_Two <- renderImage({
        list(src = glue("www/Indicator_Species/{unique(fiveM_Filter_Two_Two()$Species)}.jpg"),
             contentType = "image/jpg", width = 210, height = 210)
      }, deleteFile = FALSE) # 2nd Small species photo above plot
      
      output$fiveM_LargeSpPhoto_One <- renderImage({
        list(src = glue("www/Indicator_Species/{unique(fiveM_Filter_One()$Species)}.jpg"),
             contentType = "image/jpg", width = 400, height = 400)
      }, deleteFile = FALSE) # Large species photo below plot
      
      output$fiveM_TopSitePhoto_One <- renderImage({
        list(src = glue("www/Sat_Imagery/{unique(fiveM_Filter_One()$SiteCode)}.png"),
             contentType = "image/png", width = 430, height = 210)
      }, deleteFile = FALSE) # Small Site photo above plot
      
      output$fiveM_LargeSitePhoto_One <- renderImage({
        list(src = glue("www/Sat_Imagery/{unique(fiveM_Filter_One()$SiteCode)}.png"),
             contentType = "image/png", width = 1250, height = 625)
      }, deleteFile = FALSE) # Large Site photo below plot
      
      output$fiveM_DToutClass_One <- renderDT({
        datatable(fiveM_SpeciesClass_One(), 
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    searching = FALSE,
                    lengthChange = FALSE,
                    paging = FALSE,
                    ordering = FALSE,
                    info = FALSE),
                  rownames = FALSE) %>% 
          formatStyle(names(fiveM_SpeciesClass_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      }) # Species Classification data table
      
      output$fiveM_DToutDesc_One <- renderDT({
        datatable(fiveM_SpeciesDescription_One(), 
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    searching = FALSE,
                    lengthChange = FALSE,
                    paging = FALSE,
                    ordering = FALSE,
                    info = FALSE),
                  rownames = FALSE) %>% 
          formatStyle(names(fiveM_SpeciesDescription_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      }) # Species Description data table
      
      fiveM_alphaONI_one <- reactive({
        if(input$fiveM_GraphOptions_One == "With No Index"){
          return(0)
        }
        else if(input$fiveM_GraphOptions_One == "With ONI"){
          return(1)
        }
        else if(input$fiveM_GraphOptions_One == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$fiveM_GraphOptions_One == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      fiveM_alphaPDO_NOAA_one <- reactive({
        if(input$fiveM_GraphOptions_One == "With No Index"){
          return(0)
        }
        if(input$fiveM_GraphOptions_One == "With ONI"){
          return(0)
          
        }
        if(input$fiveM_GraphOptions_One == "With PDO (NOAA)"){
          return(1)
        }
        if(input$fiveM_GraphOptions_One == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      fiveM_alphaPDO_UW_one <- reactive({
        if(input$fiveM_GraphOptions_One == "With No Index"){
          return(0)
        }
        if(input$fiveM_GraphOptions_One == "With ONI"){
          return(0)
          
        }
        if(input$fiveM_GraphOptions_One == "With PDO (NOAA)"){
          return(0)
        }
        if(input$fiveM_GraphOptions_One == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$fiveM_ONIpdoPIC_One <- renderImage({
        if(input$fiveM_GraphOptions_One == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$fiveM_GraphOptions_One == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$fiveM_GraphOptions_One == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      fiveM_LinePlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(fiveM_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          geom_line(data = fiveM_Filter_One(),
                    aes(x = Date, y = MeanDensity_sqm, group = ScientificName, color = CommonName), 
                    size = 1) +
          geom_errorbar(data = fiveM_Filter_One(),
                        aes(x = Date, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                        width = 0, color = "black", alpha = as.numeric(input$fiveM_EB_one)) +
          scale_x_date(date_labels = "%b %Y", breaks = unique(fiveM_Filter_One()$Date),
                       limits = c(min(as.Date(fiveM_Filter_One()$Date))-365, max(as.Date(fiveM_Filter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          labs(title = glue("{unique(fiveM_Filter_One()$ScientificName)}"),
               subtitle = glue("{unique(fiveM_Filter_One()$IslandName)} {unique(fiveM_Filter_One()$SiteName)}"),
               color = "Common Name",
               fill = "Oceanic Nino \nIndex Gradient",
               caption = glue("{fiveM_Filter_One()$SiteName} is typically surveyed in {
                       lubridate::month(round(mean(month(fiveM_Filter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                       } and has a mean depth of {round(mean(fiveM_Filter_One()$MeanDepth), 2)} ft"),
               x = "Year",
               y = "Mean Density") +
          scale_color_manual(values = SpeciesColor) +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
      }) # Main Line Plot
      
      fiveM_BarPlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(fiveM_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          new_scale_fill() +
          geom_col(data = fiveM_Filter_One(), aes(x = Date - ifelse(input$fiveM_DataSummary_One == "One species at one site", 0, 50),
                                                  y = MeanDensity_sqm, fill = CommonName), 
                   position = "dodge", width = ifelse(input$fiveM_DataSummary_One == "One species at one site", 250, 100)) +
          geom_errorbar(data = fiveM_Filter_One(),
                        aes(x = Date - ifelse(input$fiveM_DataSummary_One == "One species at one site", 0, 50), 
                            ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                        width = 0, color = "black", alpha = as.numeric(input$fiveM_EB_one)) +
          geom_text(data = fiveM_Filter_One(),
                    aes(x = Date - ifelse(input$fiveM_DataSummary_One == "One species at one site", 0, 50),
                        y = MeanDensity_sqm, label = round(MeanDensity_sqm, digits = 2)),
                    vjust = -.2, hjust = .5, alpha = as.numeric(input$fiveM_Bar_Text_One)) +
          scale_x_date(date_labels = "%b %Y", breaks = unique(fiveM_Filter_One()$Date),
                       limits = c(min(as.Date(fiveM_Filter_One()$Date))-365,  max(as.Date(fiveM_Filter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          labs(title = glue("{unique(fiveM_Filter_One()$ScientificName)}"),
               subtitle = glue("{unique(fiveM_Filter_One()$IslandName)} {unique(fiveM_Filter_One()$SiteName)}"),
               color = "Common Name",
               fill = "Common Name",
               caption = glue("{fiveM_Filter_One()$SiteName} is typically surveyed in {
                 lubridate::month(round(mean(month(fiveM_Filter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                 } and has a mean depth of {round(mean(fiveM_Filter_One()$MeanDepth), 2)} ft"),
               x = "Year",
               y = "Mean Density") +
          scale_fill_manual(values = SpeciesColor) +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
      }) # Main Bar Plot
      
      fiveM_SmoothPlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(fiveM_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          stat_smooth(data = fiveM_Filter_One(), 
                      aes(x = Date, y = MeanDensity_sqm, group = ScientificName, color = CommonName), 
                      size = 1, span = input$fiveM_SmoothSlide_One, se = as.logical(input$fiveM_SmoothSE_One)) +
          scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 1)) +
          geom_point(data = fiveM_Filter_One(), aes(x = Date, y = MeanDensity_sqm, color = CommonName), 
                     size = 2, alpha = as.numeric(input$fiveM_SmoothPoint_One)) +
          scale_x_date(date_labels = "%b %Y", breaks = unique(fiveM_Filter_One()$Date), 
                       limits = c(min(as.Date(fiveM_Filter_One()$Date))-365, 
                                  max(as.Date(fiveM_Filter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          labs(title = glue("{unique(fiveM_Filter_One()$ScientificName)}"), 
               subtitle = glue("{unique(fiveM_Filter_One()$IslandName)} {unique(fiveM_Filter_One()$SiteName)}"),
               color = "Common Name",
               caption = glue("{fiveM_Filter_One()$SiteName} is typically surveyed in {
                       lubridate::month(round(mean(month(fiveM_Filter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                       } and has a mean depth of {round(mean(fiveM_Filter_One()$MeanDepth), 2)} ft"),
               x = "Year", y = "Smoothed Conditional Mean Values") +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
      }) # Main Smooth Line Plot
      
      fiveM_BoxPlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(fiveM_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          geom_boxplot(data = fiveM_RawFilter_One(), aes(x = Date, y = Count, group = SurveyYear, color = CommonName)) +
          scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 1)) +
          geom_point(data = fiveM_RawFilter_One(), aes(x = Date, y = Mean),
                     size = 2, color = "black") +
          scale_x_date(date_labels = "%b %Y", breaks = unique(fiveM_RawFilter_One()$Date), 
                       limits = c(min(as.Date(fiveM_RawFilter_One()$Date))-365, max(as.Date(fiveM_RawFilter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          labs(title = glue("{unique(fiveM_RawFilter_One()$ScientificName)}"), 
               subtitle = glue("{unique(fiveM_RawFilter_One()$IslandName)} {unique(fiveM_RawFilter_One()$SiteName)}"),
               color = "Common Name",
               caption = glue("{fiveM_RawFilter_One()$SiteName} is typically surveyed in {
                       lubridate::month(round(mean(month(fiveM_RawFilter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                       } and has a mean depth of {round(mean(fiveM_RawFilter_One()$MeanDepth), 2)} ft"),
               x = "Year",
               y = "Count per Quadrat") +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
      }) # Main Boxplot Plot
      
      output$fiveM_Plot_One <- renderPlot({
        
        if (is.null(input$fiveM_Graph_One))
          return(NULL) 
        
        else if(input$fiveM_Graph_One == "Line" && input$fiveM_DataSummary_One == "One species at one site")
        {
          p <- fiveM_LinePlot_One()
        } 
        else if(input$fiveM_Graph_One == "Line" && input$fiveM_DataSummary_One == "One species with island average")
        {
          p <- fiveM_LinePlot_One() +
            new_scale_color() +
            geom_line(data = fiveM_Filter_One(),
                      aes(x = Date, y = Island_Mean_Density, group = ScientificName, color = IslandName),
                      size = 1) +
            geom_errorbar(data = fiveM_Filter_One(),
                          aes(x = Date, ymin = Island_Mean_Density - IslandSE,ymax = Island_Mean_Density + IslandSE),
                          width = 0, color = "black", alpha = as.numeric(input$fiveM_EB_one)) +
            labs(color = "Island Average") +
            scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 2))
        }
        else if(input$fiveM_Graph_One == "Bar" && input$fiveM_DataSummary_One == "One species at one site") 
        {
          p <- fiveM_BarPlot_One()
        }
        else if(input$fiveM_Graph_One == "Bar" && input$fiveM_DataSummary_One == "One species with island average") 
        {
          p <- fiveM_BarPlot_One() +
            new_scale_fill() +
            geom_col(data = fiveM_Filter_One(),
                     aes(x = Date + 50, y = Island_Mean_Density, fill = IslandName),
                     position = "dodge",
                     width = 100) +
            geom_errorbar(data = fiveM_Filter_One(),
                          aes(x = Date + 50, ymin = Island_Mean_Density - IslandSE, ymax = Island_Mean_Density + IslandSE),
                          width = 0, color = "black", alpha = as.numeric(input$fiveM_EB_one)) +
            scale_fill_manual(values = SpeciesColor, guide = guide_legend(order = 2)) +
            labs(fill = "Island Mean")
        } 
        else if(input$fiveM_Graph_One == "Smooth Line" && input$fiveM_DataSummary_One == "One species at one site")
        {
          p <- fiveM_SmoothPlot_One()
        }
        else if(input$fiveM_Graph_One == "Smooth Line" && input$fiveM_DataSummary_One == "One species with island average")
        {
          p <- fiveM_SmoothPlot_One() +
            new_scale_color() +
            stat_smooth(data = fiveM_Filter_One(), 
                        aes(x = Date, y = Island_Mean_Density, group = ScientificName, color = IslandName), 
                        size = 1,
                        span = input$fiveM_SmoothSlide_One,
                        se = as.logical(input$fiveM_SmoothSE_One)) +
            geom_point(data = fiveM_Filter_One(), aes(x = Date, y = Island_Mean_Density, color = IslandName), 
                       size = 2, alpha = as.numeric(input$fiveM_SmoothPoint_One)) +
            labs(color = "Island Average") +
            scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 2)) 
        }
        else if(input$fiveM_Graph_One == "Boxplot" && input$fiveM_DataSummary_One == "One species at one site")
        {
          p <- fiveM_BoxPlot_One()  
        }
        else if(input$fiveM_Graph_One == "Boxplot" && input$fiveM_DataSummary_One == "One species with island average")
        {
          p <- fiveM_BoxPlot_One() +
            new_scale_color() +
            geom_point(data = fiveM_Filter_One(), aes(x = Date, y = Island_Mean_Density, color = IslandName), 
                       size = 2) +
            labs(color = "Island Average") +
            scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 2)) 
        }
        return(p)
      }) # Main Plot for fiveM_ Quadrats with one species 
      
      output$fiveM_BoxplotDescription_One <- renderImage({
        list(src = glue("www/Boxplot_Description.jpg"), contentType = "image/jpg", width = 550, height = 400)
      }, deleteFile = FALSE) # Boxplot drawing/explanation
      
      output$fiveM_DToutData_One <- renderDT({
        datatable(fiveM_Filter_One(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "500px",
                    scrollX = TRUE, 
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = c(list(list(visible = FALSE, targets = c(10, 12, 13, 14, 15))), 
                                   list(list(className = 'dt-center', targets = 0:11))),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(fiveM_Filter_One()),
                      color = "black",
                      backgroundColor = 'white'
          )
      }) # Filtered data table output
      
    }
    
    { # fiveM_Server_by_Island   ----
      
      fiveM_Filter_Isl <- reactive({
        fiveM_DF <- fiveM_DF %>%
          dplyr::filter(CommonName == input$fiveM_SpeciesName_Isl) %>%
          dplyr::group_by(SurveyYear, IslandName) %>%
          dplyr::mutate(Date = mean(Date),
                        MaxSumBar = sum(MeanDensity_sqm)) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SiteName, SurveyYear) %>%
          dplyr::mutate(MaxSum = max(sum(MeanDensity_sqm)))
        
      })
      
      fiveM_FilterByIsl_Isl <- reactive({
        fiveM_DF %>%
          dplyr::filter(CommonName == input$fiveM_SpeciesName_Isl) %>%
          dplyr::group_by(IslandDate, IslandCode, IslandName, Species, ScientificName, CommonName, SurveyYear) %>%
          dplyr::distinct(IslandDate, IslandCode, IslandName,Species, ScientificName, CommonName, SurveyYear, 
                          Island_Mean_Density, IslandSD, IslandSE, IslandQuads, IslandAreaSurveyed, IslandTotalCount) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SurveyYear) %>%
          dplyr::mutate(IslandDate = mean(IslandDate))
      })
      
      fiveM_yValue_Isl <- reactive({
        if(input$fiveM_BarOptions_Isl == "stack"){
          return({
            max(fiveM_Filter_Isl()$MaxSumBar)
          }) 
        }
        else if(input$fiveM_BarOptions_Isl == "dodge"){
          return({
            max(fiveM_Filter_Isl()$MeanDensity_sqm)
          })
        }
        else if(input$fiveM_BarOptions_Isl == "fill"){
          return(1)
        }
      })
      
      fiveM_yLabel_Isl <- reactive({
        if(input$fiveM_BarOptions_Isl == "stack"){
          y <- "Combined Densities"
        }
        else if(input$fiveM_BarOptions_Isl == "dodge"){
          y <- "Seperated Densities"
        }
        else if(input$fiveM_BarOptions_Isl == "fill"){
          y <- "Normalized Densities"
        }
        y
      })
      
      fiveM_alphaONI_Isl <- reactive({
        if(input$fiveM_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        else if(input$fiveM_GraphOptions_Isl == "With ONI"){
          return(1)
        }
        else if(input$fiveM_GraphOptions_Isl == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$fiveM_GraphOptions_Isl == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      fiveM_alphaPDO_NOAA_Isl <- reactive({
        if(input$fiveM_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        if(input$fiveM_GraphOptions_Isl == "With ONI"){
          return(0)
          
        }
        if(input$fiveM_GraphOptions_Isl == "With PDO (NOAA)"){
          return(1)
        }
        if(input$fiveM_GraphOptions_Isl == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      fiveM_alphaPDO_UW_Isl <- reactive({
        if(input$fiveM_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        if(input$fiveM_GraphOptions_Isl == "With ONI"){
          return(0)
          
        }
        if(input$fiveM_GraphOptions_Isl == "With PDO (NOAA)"){
          return(0)
        }
        if(input$fiveM_GraphOptions_Isl == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$fiveM_ONIpdoPIC_Isl <- renderImage({
        if(input$fiveM_GraphOptions_Isl == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$fiveM_GraphOptions_Isl == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$fiveM_GraphOptions_Isl == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      fiveM_AxisScale_Isl <- reactive({
        if(input$fiveM_FreeOrLock_Isl == "Locked Scales"){
          return("fixed")
        }
        if(input$fiveM_FreeOrLock_Isl == "Free Scales"){
          return("free")
        }
      }) # Facet Plot Axis Scale free or fixed 
      
      output$fiveM_Plot_Isl1 <- renderPlot({ # Facet plots    ---- 
        
        if (is.null(input$fiveM_Graph_Isl))
          return(NULL) 
        
        else if(input$fiveM_Graph_Isl == "Line" && input$fiveM_DataSummary_Isl == "Island Mean") { # Line   ----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(fiveM_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = fiveM_FilterByIsl_Isl(), 
                        aes(x = IslandDate, y = Island_Mean_Density, group = IslandName, color = IslandName),
                        size = 1) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(fiveM_FilterByIsl_Isl()$IslandDate))-365,
                                      max(as.Date(fiveM_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              geom_errorbar(data = fiveM_FilterByIsl_Isl(), 
                            aes(x = IslandDate, ymin = Island_Mean_Density - IslandSE, ymax = Island_Mean_Density + IslandSE),
                            width = 0, color = "black", alpha = as.numeric(input$fiveM_EB_Isl)) +
              labs(title = glue("{unique(fiveM_FilterByIsl_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Density") +
              facet_grid(rows = vars(IslandName), scales = fiveM_AxisScale_Isl()) +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        } 
        else if(input$fiveM_Graph_Isl == "Line" && input$fiveM_DataSummary_Isl == "Site Means (by Island)") {
          return({
            out <- by(data = fiveM_Filter_Isl(), INDICES = fiveM_Filter_Isl()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(fiveM_alphaONI_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_Isl()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_line(data = m, 
                          aes(Date, MeanDensity_sqm, group = SiteName, colour = SiteName, linetype = SiteName),
                          size = 1) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date),
                             limits = c(min(as.Date(m$Date))-365, max(as.Date(m$Date))+365),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(limits = c(0, ifelse(input$fiveM_FreeOrLock_Isl == "Locked Scales", 
                                                        max(fiveM_Filter_Isl()$MaxSum), max(m$MeanDensity_sqm))),
                                   expand = expansion(mult = c(0, .01))) +
                geom_errorbar(data = m, 
                              aes(x = Date, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                              width = 0, color = "black", alpha = as.numeric(input$fiveM_EB_Isl)) +
                labs(title = m$IslandName,
                     color = "Site Name",
                     linetype ="Site Name",
                     caption = "Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected",
                     x = NULL,
                     y = "Mean Density") +
                scale_color_manual(values = SiteColor, breaks = as.character(m$SiteName)) +
                scale_linetype_manual(values = SiteLine, breaks = as.character(m$SiteName)) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(fiveM_Filter_Isl()$ScientificName)}"),
                                          label_size = 20, label_fontface = "bold.italic"
            ))
          })
        } 
        else if(input$fiveM_Graph_Isl == "Bar" && input$fiveM_DataSummary_Isl == "Island Mean") { # Bar   ----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(fiveM_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = fiveM_FilterByIsl_Isl(), 
                       aes(x = IslandDate, y = Island_Mean_Density, fill = IslandName),
                       position = "dodge",
                       width = 280) +
              facet_grid(rows = vars(IslandName), scales = fiveM_AxisScale_Isl()) +
              geom_text(data = fiveM_FilterByIsl_Isl(),
                        aes(x = IslandDate, y = Island_Mean_Density, label = round(Island_Mean_Density, digits = 2)),
                        position = position_dodge(1), vjust = -.2, hjust = .5, angle = 0, alpha = as.numeric(input$fiveM_Bar_Text_Isl)) +
              geom_errorbar(data = fiveM_FilterByIsl_Isl(), 
                            aes(x = IslandDate, ymin = Island_Mean_Density - IslandSE, ymax = Island_Mean_Density + IslandSE),
                            width = 0, color = "black", alpha = as.numeric(input$fiveM_EB_Isl)) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              scale_x_date(date_labels = "%b %Y", date_breaks = "1 year", 
                           limits = c(min(as.Date(fiveM_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(fiveM_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(fiveM_FilterByIsl_Isl()$ScientificName)}"),
                   subtitle = glue("{unique(fiveM_FilterByIsl_Isl()$CommonName)}"),
                   color = "Common Name",
                   fill = "Common Name",
                   x = "Year",
                   y = "Mean Density") +
              scale_fill_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$fiveM_Graph_Isl == "Bar" && input$fiveM_DataSummary_Isl == "Site Means (by Island)") {
          return({
            out <- by(data = fiveM_Filter_Isl(), INDICES = fiveM_Filter_Isl()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() +
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(fiveM_alphaONI_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_Isl()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                new_scale_fill() +
                geom_col(data = m, aes(x = Date, y = MeanDensity_sqm, fill = SiteName),
                         position = input$fiveM_BarOptions_Isl, width = 280) +
                coord_cartesian(ylim = c(0, ifelse(input$fiveM_FreeOrLock_Isl == "Locked Scales", 
                                                   fiveM_yValue_Isl(), max(m$MaxSumBar)))) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date), expand = expansion(mult = c(0.01, .01)),
                             limits = c(min(as.Date(m$Date))-365, max(as.Date(m$Date))+365)) +
                labs(title = m$IslandName,
                     color = "Site Name",
                     fill = "Site Name",
                     x = "Year",
                     y = fiveM_yLabel_Isl()) +
                scale_fill_manual(values = SiteColor) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(fiveM_Filter_Isl()$ScientificName)}"),
                                          label_size = 20, label_fontface = "bold.italic"
            ))
          })
        } 
        else if(input$fiveM_Graph_Isl == "Smooth Line" && input$fiveM_DataSummary_Isl == "Island Mean") { # Smooth   -----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(fiveM_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_smooth(data = fiveM_FilterByIsl_Isl(), aes(x = IslandDate, y = Island_Mean_Density, color = IslandName),
                          se = as.logical(input$fiveM_SmoothSE_Isl),
                          span = input$fiveM_SmoothSlide_Isl) +
              geom_point(data = fiveM_FilterByIsl_Isl(), aes(x = IslandDate, y = Island_Mean_Density, color = IslandName),
                         size = 1, alpha = as.numeric(input$fiveM_SmoothPoint_Isl),inherit.aes = FALSE) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(fiveM_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(fiveM_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(fiveM_FilterByIsl_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Density") +
              facet_grid(rows = vars(IslandName), scales = fiveM_AxisScale_Isl()) +
              scale_color_manual(values = SpeciesColor, guide = guide_legend(nrow = 5)) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$fiveM_Graph_Isl == "Smooth Line" && input$fiveM_DataSummary_Isl == "Site Means (by Island)") { 
          return({
            out <- by(data = fiveM_Filter_Isl(), INDICES = fiveM_Filter_Isl()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() +
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(fiveM_alphaONI_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_Isl()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_point(data = m, aes(x = Date, y = MeanDensity_sqm, color = SiteName),
                           size = 1, alpha = as.numeric(input$fiveM_SmoothPoint_Isl), inherit.aes = FALSE) +
                geom_smooth(data = m, aes(x = Date, y = MeanDensity_sqm, color = SiteName),
                            se = as.logical(input$fiveM_SmoothSE_Isl),
                            span = input$fiveM_SmoothSlide_Isl) +
                scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                             limits = c(min(as.Date(fiveM_FilterByIsl_Isl()$IslandDate))-365, 
                                        max(as.Date(fiveM_FilterByIsl_Isl()$IslandDate))+365),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(limits = c(0, ifelse(input$fiveM_FreeOrLock_Isl == "Locked Scales", 
                                                        max(fiveM_Filter_Isl()$MaxSum), max(m$MeanDensity_sqm))),
                                   expand = expansion(mult = c(0, .01))) +
                labs(title = glue("{unique(m$IslandName)}"), 
                     color = "Site Name",
                     x = "Year",
                     y = "Mean Density") +
                scale_color_manual(values = SiteColor) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 13, colour = "black", face = "bold"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(fiveM_Filter_Isl()$ScientificName)}"),
                                          label_size = 20, label_fontface = "bold.italic"
            ))
          })
        }
        
      })
      
      output$fiveM_Plot_Isl2 <- renderPlot({  # Single plot    ----
        
        if (is.null(input$fiveM_Graph_Isl))
          return(NULL) 
        
        else if(input$fiveM_Graph_Isl == "Line" && input$fiveM_DataSummary_Isl == "Island Mean") { # Line   ----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(fiveM_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = fiveM_FilterByIsl_Isl(), 
                        aes(x = IslandDate, y = Island_Mean_Density, group = IslandName, color = IslandName),
                        size = 1) +
              scale_x_date(date_labels = "%Y", breaks = fiveM_FilterByIsl_Isl()$IslandDate, 
                           limits = c(min(as.Date(fiveM_FilterByIsl_Isl()$IslandDate))-365,
                                      max(as.Date(fiveM_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              geom_errorbar(data = fiveM_FilterByIsl_Isl(), 
                            aes(x = IslandDate, ymin = Island_Mean_Density - IslandSE, ymax = Island_Mean_Density + IslandSE),
                            width = 0, color = "black", alpha = as.numeric(input$fiveM_EB_Isl)) +
              labs(title = glue("{unique(fiveM_FilterByIsl_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Density") +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "right",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        } 
        else if(input$fiveM_Graph_Isl == "Line" && input$fiveM_DataSummary_Isl == "Site Means (by Island)") {
          return({
            ggplot() + 
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(fiveM_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = fiveM_Filter_Isl(), 
                        aes(Date, MeanDensity_sqm, group = SiteName, colour = SiteName, linetype = SiteName),
                        size = 1) +
              scale_x_date(date_labels = "%Y", date_breaks = "1 year",
                           limits = c(min(as.Date(fiveM_FilterByIsl_Isl()$IslandDate))-365,
                                      max(as.Date(fiveM_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              scale_y_continuous(limits = c(0, max(fiveM_Filter_Isl()$MaxSum)), expand = expansion(mult = c(0, .01))) +
              geom_errorbar(data = fiveM_Filter_Isl(), 
                            aes(x = Date, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                            width = 0, color = "black", alpha = as.numeric(input$fiveM_EB_Isl)) +
              labs(title = fiveM_Filter_Isl()$IslandName,
                   color = "Site Name",
                   linetype ="Site Name",
                   caption = "Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected",
                   x = NULL,
                   y = "Mean Density") +
              geom_vline(size = 1, xintercept = as.Date("2005-07-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2005-07-01", format = "%Y-%m-%d"), 
                        y= Inf, aes(label = "16 New Sites Added"),
                        hjust = 0,
                        vjust = 1,
                        inherit.aes = FALSE) +
              geom_vline(size = 1, xintercept = as.Date("2001-06-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2001-06-01", format = "%Y-%m-%d"), 
                        y= Inf, aes(label = "Miracle Mile Added"),
                        hjust = 1,
                        vjust = 1,
                        inherit.aes = FALSE) +
              scale_color_manual(values = SiteColor2, guide = guide_legend(ncol = 10)) +
              scale_linetype_manual(values = SiteLine, guide = guide_legend(ncol = 10)) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.key.width = unit(1.5, "cm"),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 12, colour = "black"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$fiveM_Graph_Isl == "Bar" && input$fiveM_DataSummary_Isl == "Island Mean") { # Bar -----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(fiveM_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = fiveM_FilterByIsl_Isl(), 
                       aes(x = IslandDate, y = Island_Mean_Density, fill = IslandName),
                       position = input$fiveM_BarOptions_Isl,
                       width = 280) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              scale_x_date(date_labels = "%Y", breaks = fiveM_FilterByIsl_Isl()$IslandDate, 
                           limits = c(min(as.Date(fiveM_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(fiveM_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(fiveM_FilterByIsl_Isl()$ScientificName)}"),
                   subtitle = glue("{unique(fiveM_FilterByIsl_Isl()$CommonName)}"),
                   color = "Common Name",
                   fill = "Common Name",
                   x = "Year",
                   y = fiveM_yLabel_Isl()) +
              scale_fill_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "right",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$fiveM_Graph_Isl == "Bar" && input$fiveM_DataSummary_Isl == "Site Means (by Island)") {
          return({
            ggplot() +
              geom_col(data = fiveM_Filter_Isl() %>% dplyr::group_by(SurveyYear) %>% dplyr::mutate(Date = mean(Date)), 
                       aes(x = Date-75, y = MeanDensity_sqm, fill = SiteName),
                       position = input$fiveM_BarOptions_Isl,
                       width = 280) +
              scale_x_date(date_labels = "%Y", date_breaks = "1 year",
                           limits = c(min(as.Date(fiveM_Filter_Isl()$Date))-365,
                                      max(as.Date(fiveM_Filter_Isl()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = fiveM_Filter_Isl()$IslandName,
                   color = "Site Name",
                   fill = "Site Name",
                   x = "Year",
                   y = fiveM_yLabel_Isl()) +
              geom_vline(size = 1, xintercept = as.Date("2005-01-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2005-01-01", format = "%Y-%m-%d"), 
                        y= Inf, aes(label = "16 New Sites Added"),
                        hjust = 0,
                        vjust = 1,
                        inherit.aes = FALSE) +
              geom_vline(size = 1, xintercept = as.Date("2001-01-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2001-01-01", format = "%Y-%m-%d"), 
                        y= Inf, aes(label = "Miracle Mile Added"),
                        hjust = 1,
                        vjust = 1,
                        inherit.aes = FALSE) +
              scale_fill_manual(values = SiteColor2, guide = guide_legend(ncol = 10)) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.key.width = unit(1, "cm"),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 12, colour = "black"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        } 
        else if(input$fiveM_Graph_Isl == "Smooth Line" && input$fiveM_DataSummary_Isl == "Island Mean") { # Smooth   ----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(fiveM_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_point(data = fiveM_FilterByIsl_Isl(), aes(x = IslandDate, y = Island_Mean_Density, color = IslandName), 
                         size = 2, alpha = as.numeric(input$fiveM_SmoothPoint_Isl)) +
              geom_smooth(data = fiveM_FilterByIsl_Isl(), aes(x= IslandDate, y = Island_Mean_Density, color = IslandName),
                          se = as.logical(input$fiveM_SmoothSE_Isl), span = input$fiveM_SmoothSlide_Isl) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(fiveM_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(fiveM_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(fiveM_FilterByIsl_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Density") +
              scale_color_manual(values = SpeciesColor, guide = guide_legend(nrow = 5)) +
              theme_classic() +
              theme(legend.position = "right",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$fiveM_Graph_Isl == "Smooth Line" && input$fiveM_DataSummary_Isl == "Site Means (by Island)") {
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(fiveM_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_point(data = fiveM_Filter_Isl(), aes(x = Date, y = MeanDensity_sqm, color = CommonName), 
                         size = 2, alpha = as.numeric(input$fiveM_SmoothPoint_Isl)) +
              geom_smooth(data = fiveM_Filter_Isl(), aes(x= Date, y = MeanDensity_sqm, color = SiteName),
                          se = as.logical(input$fiveM_SmoothSE_Isl), span = input$fiveM_SmoothSlide_Isl) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(fiveM_Filter_Isl()$Date))-365, 
                                      max(as.Date(fiveM_Filter_Isl()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(fiveM_Filter_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Density") +
              scale_color_manual(values = SiteColor2, guide = guide_legend(nrow = 5)) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
      })
      
    }
    
    { # fiveM_Server_byMPA ----
      
      fiveM_Filter_MPA <- reactive({
        fiveM_DFMPA %>%
          dplyr::filter(CommonName == input$fiveM_SpeciesName_MPA) %>%
          dplyr::group_by(IslandCode, SurveyYear) %>%
          dplyr::mutate(Date = mean(Date),
                        MaxSumBar = max(sum(MeanDensity_sqm))) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SiteName, SurveyYear) %>%
          dplyr::mutate(MaxSum = max(sum(MeanDensity_sqm))) %>%
          arrange(SiteName)
      })
      
      fiveM_FilterBarSite_MPA <-reactive({
        fiveM_DFMPA %>%
          dplyr::filter(CommonName == input$fiveM_SpeciesName_MPA,
                        SiteName != "Keyhole") %>%
          dplyr::group_by(IslandCode, SurveyYear) %>%
          dplyr::mutate(Date = mean(Date),
                        MaxSumBar = max(sum(MeanDensity_sqm))) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SiteName, SurveyYear) %>%
          dplyr::mutate(MaxSum = max(sum(MeanDensity_sqm)))
      })
      
      fiveM_Inside_MPA <- reactive({
        fiveM_DFMPA %>% 
          dplyr::filter(CommonName == input$fiveM_SpeciesName_MPA,
                        ReserveStatus == "Inside",
                        SiteName != "Keyhole") %>%
          dplyr::group_by(MPA_Date, IslandCode, IslandName, Species, ScientificName, CommonName, SurveyYear) %>%
          dplyr::distinct(MPA_Date, IslandCode, IslandName,Species, ScientificName, CommonName, SurveyYear,
                          MPA_TotalCount, MPA_Mean, MPA_SD, MPA_SE, MPA_Quadrats_Sampled, MPA_AreaSurveyed_sqm, .keep_all = TRUE)
      })
      
      fiveM_Outside_MPA <- reactive({
        fiveM_DFMPA %>%
          dplyr::filter(CommonName == input$fiveM_SpeciesName_MPA,
                        ReserveStatus == "Outside",
                        SiteName != "Keyhole") %>%
          dplyr::group_by(MPA_Date, IslandCode, IslandName, Species, ScientificName, CommonName, SurveyYear) %>%
          dplyr::distinct(MPA_Date, IslandCode, IslandName,Species, ScientificName, CommonName, SurveyYear,
                          MPA_TotalCount, MPA_Mean, MPA_SD, MPA_SE, MPA_Quadrats_Sampled, MPA_AreaSurveyed_sqm, .keep_all = TRUE)
      })
      
      fiveM_alphaONI_MPA <- reactive({
        if(input$fiveM_GraphOptions_MPA == "With No Index"){
          return(0)
        }
        else if(input$fiveM_GraphOptions_MPA == "With ONI"){
          return(1)
        }
        else if(input$fiveM_GraphOptions_MPA == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$fiveM_GraphOptions_MPA == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      fiveM_alphaPDO_NOAA_MPA <- reactive({
        if(input$fiveM_GraphOptions_MPA == "With No Index"){
          return(0)
        }
        if(input$fiveM_GraphOptions_MPA == "With ONI"){
          return(0)
          
        }
        if(input$fiveM_GraphOptions_MPA == "With PDO (NOAA)"){
          return(1)
        }
        if(input$fiveM_GraphOptions_MPA == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      fiveM_alphaPDO_UW_MPA <- reactive({
        if(input$fiveM_GraphOptions_MPA == "With No Index"){
          return(0)
        }
        if(input$fiveM_GraphOptions_MPA == "With ONI"){
          return(0)
          
        }
        if(input$fiveM_GraphOptions_MPA == "With PDO (NOAA)"){
          return(0)
        }
        if(input$fiveM_GraphOptions_MPA == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$fiveM_ONIpdoPIC_MPA <- renderImage({
        if(input$fiveM_GraphOptions_MPA == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$fiveM_GraphOptions_MPA == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$fiveM_GraphOptions_MPA == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      fiveM_AxisScale_MPA <- reactive({
        if(input$fiveM_FreeOrLock_MPA == "Locked Scales"){
          return("fixed")
        }
        if(input$fiveM_FreeOrLock_MPA == "Free Scales"){
          return("free")
        }
      }) # Facet Plot Axis Scale free or fixed 
      
      output$fiveM_Plot_MPA <- renderPlot({
        if (is.null(input$fiveM_Graph_MPA))
          return(NULL)
        
        else if(input$fiveM_Graph_MPA == "Line" && input$fiveM_DataSummary_MPA == "MPA Mean") {  # Line    ----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(fiveM_alphaONI_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = fiveM_Filter_MPA() %>% dplyr::filter(SiteName != "Keyhole"), 
                        aes(x = MPA_Date, y = MPA_Mean, group = ReserveStatus, color = ReserveStatus, linetype = ReserveStatus),
                        size = 1) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(fiveM_Filter_MPA()$MPA_Date)), 
                                      max(as.Date(fiveM_Filter_MPA()$MPA_Date))),
                           expand = expansion(mult = c(0.01, .01))) +
              geom_errorbar(data = fiveM_Filter_MPA(), 
                            aes(x = MPA_Date, ymin = MPA_Mean - MPA_SE, ymax = MPA_Mean + MPA_SE),
                            width = 0, color = "black", alpha = as.numeric(input$fiveM_EB_MPA)) +
              labs(title = glue("{unique(fiveM_Filter_MPA()$ScientificName)}"),
                   subtitle = glue("{unique(fiveM_Filter_MPA()$CommonName)}"),
                   color = "Reserve Status",
                   linetype = "Reserve Status",
                   x = "Year",
                   y = "Mean Density") +
              scale_color_manual(values=c(Inside = "green3", Outside = "red3")) +
              scale_linetype_manual(values = c(Inside = "dashed", Outside = "solid")) +
              facet_grid(rows = vars(IslandName), scales = fiveM_AxisScale_MPA()) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    legend.key.width = unit(2, "cm"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"),
                    strip.text = element_text(size = 12, colour = "Black", angle = 90, face = "bold"))
          })
        }
        else if(input$fiveM_Graph_MPA == "Line" && input$fiveM_DataSummary_MPA == "Site Means (by MPA)") {
          return({
            out <- by(data = fiveM_Filter_MPA(), INDICES = fiveM_Filter_MPA()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(fiveM_alphaONI_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_MPA()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_line(data = m, 
                          aes(x = Date, MeanDensity_sqm, group = SiteName, color = SiteName, linetype = SiteName),
                          size = 1) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date),
                             limits = c(min(as.Date(m$Date)), max(as.Date(m$Date))),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(limits = c(0, ifelse(input$fiveM_FreeOrLock_MPA == "Locked Scales", 
                                                        max(fiveM_Filter_MPA()$MaxSum), max(m$MeanDensity_sqm))), 
                                   expand = expansion(mult = c(0.01, .01))) +
                geom_errorbar(data = m, 
                              aes(x = Date, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                              width = 0, color = "black", alpha = as.numeric(input$fiveM_EB_MPA)) +
                labs(title = m$IslandName,
                     color = "Site Name",
                     linetype = "Site Name",
                     caption = "Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected",
                     x = "Year",
                     y = "Mean Density") +
                scale_color_manual(values = SiteColor, breaks = as.character(m$SiteName)) +
                scale_linetype_manual(values = SiteLine, breaks = as.character(m$SiteName)) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(fiveM_Filter_MPA()$ScientificName)}"),
                                          label_size = 20,
                                          label_fontface = "bold.italic"
            ))
          })
        }
        else if(input$fiveM_Graph_MPA == "Bar" && input$fiveM_DataSummary_MPA == "MPA Mean") { # Bar    -----
          return({ 
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(fiveM_alphaONI_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = fiveM_Inside_MPA(), 
                       aes(x = MPA_Date - 60, y = MPA_Mean, group = ReserveStatus, fill = ReserveStatus),
                       width = 120) +
              geom_text(data = fiveM_Inside_MPA(),
                        aes(x = MPA_Date - 60, y = MPA_Mean, label = round(MPA_Mean, digits = 2)),
                        vjust = -.2, hjust = .5, angle = 0, alpha = as.numeric(input$fiveM_Bar_Text_MPA)) +
              geom_errorbar(data = fiveM_Inside_MPA(), 
                            aes(x = MPA_Date - 60, ymin = MPA_Mean - MPA_SE, ymax = MPA_Mean + MPA_SE),
                            width = 0, color = "black", alpha = as.numeric(input$fiveM_EB_MPA)) +
              geom_col(data = fiveM_Outside_MPA(), 
                       aes(x = MPA_Date + 60, y = MPA_Mean, group = ReserveStatus, fill = ReserveStatus),
                       width = 120) +
              geom_text(data = fiveM_Outside_MPA(),
                        aes(x = MPA_Date + 60, y = MPA_Mean, label = round(MPA_Mean, digits = 2)),
                        vjust = -.2, hjust = .5, angle = 0, alpha = as.numeric(input$fiveM_Bar_Text_MPA)) +
              geom_errorbar(data = fiveM_Outside_MPA(), 
                            aes(x = MPA_Date + 60, ymin = MPA_Mean - MPA_SE, ymax = MPA_Mean + MPA_SE),
                            width = 0, color = "black", alpha = as.numeric(input$fiveM_EB_MPA)) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(fiveM_Filter_MPA()$MPA_Date)) - 150, 
                                      max(as.Date(fiveM_Filter_MPA()$MPA_Date))),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(fiveM_Filter_MPA()$ScientificName)}"),
                   subtitle = glue("{unique(fiveM_Filter_MPA()$CommonName)}"),
                   color = "Reserve Status",
                   linetype = "Reserve Status",
                   x = "Year",
                   y = "Mean Density") +
              scale_fill_manual(values = c(Inside = "green3", Outside = "red3")) +
              facet_grid(rows = vars(IslandName), scales = fiveM_AxisScale_MPA()) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    legend.key.width = unit(2, "cm"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"),
                    strip.text = element_text(size = 12, colour = "Black", angle = 90, face = "bold"))
          })
        }
        else if(input$fiveM_Graph_MPA == "Bar" &&  input$fiveM_DataSummary_MPA == "Site Means (by MPA)") {
          return({
            out <- by(data = fiveM_FilterBarSite_MPA(), INDICES = fiveM_FilterBarSite_MPA()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() +
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(fiveM_alphaONI_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_MPA()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                new_scale_fill() +
                geom_col(data = m %>% dplyr::filter(ReserveStatus == "Inside"), 
                         aes(x = Date - 70, y = MeanDensity_sqm, fill = SiteName),
                         position = "stack", width = 140) +
                geom_text(data = m %>% dplyr::filter(ReserveStatus == "Inside") %>% 
                            dplyr::group_by(IslandName, SurveyYear) %>% dplyr::mutate(SumBar = sum(MeanDensity_sqm)),
                          aes(x = Date - 70, y = SumBar, label = "In"),
                          vjust = -.2, hjust = .5, angle = 0) +
                scale_fill_manual(values = SiteColor) +
                labs(fill = "Inside") +
                new_scale_fill() +
                geom_col(data = m %>% dplyr::filter(ReserveStatus == "Outside") , 
                         aes(x = Date + 70, y = MeanDensity_sqm, fill = SiteName),
                         position = "stack", width = 140) +
                geom_text(data = m %>% dplyr::filter(ReserveStatus == "Outside") %>%
                            dplyr::group_by(IslandName, SurveyYear) %>%
                            dplyr::mutate(SumBar = sum(MeanDensity_sqm)),
                          aes(x = Date + 70, y = SumBar, label = "Out"),
                          vjust = -.2, hjust = .5, angle = 0) +
                scale_y_continuous(limits = c(0, ifelse(input$fiveM_FreeOrLock_MPA == "Locked Scales", 
                                                        max(fiveM_Filter_MPA()$MaxSumBar), max(m$MeanDensity_sqm))),
                                   expand = expansion(mult = c(0.01, .01))) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date), 
                             limits = c(min(as.Date(m$Date)) - 150, max(as.Date(m$Date))),
                             expand = expansion(mult = c(0.01, .01))) +
                labs(title = m$IslandName,
                     fill = "Outside",
                     x = "Year",
                     y = "Mean Density") +
                scale_fill_manual(values = SiteColor) +
                scale_color_manual(values = SiteColor) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(fiveM_Filter_MPA()$ScientificName)}"),
                                          label_size = 20,
                                          label_fontface = "bold.italic"
            ))
          })
        } 
        else if(input$fiveM_Graph_MPA == "Smooth Line" && input$fiveM_DataSummary_MPA == "MPA Mean") {  # Smooth       ----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(fiveM_alphaONI_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_point(data = fiveM_Filter_MPA() %>% dplyr::filter(SiteName != "Keyhole"), 
                         aes(x= MPA_Date, y = MPA_Mean, color = ReserveStatus),
                         size = 1, alpha = as.numeric(input$fiveM_SmoothPoint_MPA), show.legend = FALSE) +
              geom_smooth(data = fiveM_Filter_MPA() %>% dplyr::filter(SiteName != "Keyhole"), 
                          aes(x= MPA_Date, y = MPA_Mean, color = ReserveStatus),
                          se = as.logical(input$fiveM_SmoothSE_MPA),
                          span = input$fiveM_SmoothSlide_MPA) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(fiveM_Filter_MPA()$MPA_Date)), 
                                      max(as.Date(fiveM_Filter_MPA()$MPA_Date))),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(fiveM_Filter_MPA()$ScientificName)}"),
                   subtitle = glue("{unique(fiveM_Filter_MPA()$CommonName)}"),
                   color = "Reserve Status",
                   linetype = "Reserve Status",
                   x = "Year",
                   y = "Mean Density") +
              scale_color_manual(values=c(Inside = "green3", Outside = "red3")) +
              scale_linetype_manual(values = c(Inside = "dashed", Outside = "solid")) +
              facet_grid(rows = vars(IslandName), scales = fiveM_AxisScale_MPA()) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    legend.key.width = unit(2, "cm"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"),
                    strip.text = element_text(size = 12, colour = "Black", angle = 90, face = "bold"))
          })
        }
        else if(input$fiveM_Graph_MPA == "Smooth Line" && input$fiveM_DataSummary_MPA == "Site Means (by MPA)") {
          return({
            out <- by(data = fiveM_Filter_MPA(), INDICES = fiveM_Filter_MPA()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(fiveM_alphaONI_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_MPA()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_point(data = m, aes(x = Date, MeanDensity_sqm, color = SiteName),
                           size = 1, alpha = as.numeric(input$fiveM_SmoothPoint_MPA), show.legend = FALSE) +
                geom_smooth(data = m, aes(x = Date, MeanDensity_sqm, color = SiteName, linetype = SiteName),
                            se = as.logical(input$fiveM_SmoothSE_MPA),
                            span = input$fiveM_SmoothSlide_MPA) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date),
                             limits = c(min(as.Date(m$Date)) - 150, max(as.Date(m$Date))),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(limits = c(0, max(fiveM_Filter_MPA()$MaxSum)), expand = expansion(mult = c(0.01, .01))) +
                labs(title = m$IslandName,
                     color = "Site Name",
                     linetype = "Site Name",
                     caption = "Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected",
                     x = "Year",
                     y = "Mean Density") +
                scale_color_manual(values = SiteColor) +
                scale_linetype_manual(values = SiteLine) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(fiveM_Filter_MPA()$ScientificName)}"),
                                          label_size = 20,
                                          label_fontface = "bold.italic"
            ))
          })
        }
      })
      
    }
    
    { # fiveM_Server_Two_Species    ----
      
      fiveM_Filter_Two_One <- reactive({
        fiveM_DF %>%
          dplyr::filter(SiteName == input$fiveM_SiteName_Two,
                        CommonName == input$fiveM_SpeciesName_Two_One) %>%
          dplyr::select(SurveyYear, Date, SiteName, IslandName, ScientificName, CommonName, MeanDensity_sqm, 
                        StandardError, StandardError, TotalCount, AreaSurveyed_sqm, MeanDepth, Island_Mean_Density,
                        Species, SiteNumber, IslandCode, SiteCode) 
      })
      
      fiveM_Filter_Two_Two <- reactive({
        fiveM_DF %>%
          dplyr::filter(SiteName == input$fiveM_SiteName_Two,
                        CommonName == input$fiveM_SpeciesName_Two_Two) %>%
          dplyr::select(SurveyYear, Date, SiteName, IslandName, ScientificName, CommonName, MeanDensity_sqm, 
                        StandardError, StandardError, TotalCount, AreaSurveyed_sqm, MeanDepth, Island_Mean_Density,
                        Species, SiteNumber, IslandCode, SiteCode) 
      })
      
      output$fiveM_LargeSpPhoto_Two_1 <- renderImage({
        
        if (is.null(input$fiveM_SpeciesName_Two_One))
          return(NULL) 
        
        if (input$fiveM_SpeciesName_Two_One == unique(fiveM_Filter_Two_One()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(fiveM_Filter_Two_One()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(fiveM_Filter_Two_One()$CommonName)}"),
            width = 450,
            height = 450
          ))
        }
      }, deleteFile = FALSE)
      
      output$fiveM_LargeSpPhoto_Two_2 <- renderImage({
        
        if (input$fiveM_SpeciesName_Two_Two == unique(fiveM_Filter_Two_Two()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(fiveM_Filter_Two_Two()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(fiveM_Filter_Two_Two()$CommonName)}"),
            width = 450,
            height = 450
          ))
        }
      }, deleteFile = FALSE)
      
      output$fiveM_TopSitePhoto_Two <- renderImage({
        if (is.null(input$fiveM_SpeciesName_Two_One))
          return(NULL)
        
        if (input$fiveM_SiteName_Two == unique(fiveM_Filter_Two_One()$SiteName)) {
          return(list(
            src = glue("www/Sat_Imagery/{unique(fiveM_Filter_Two_One()$SiteCode)}.png"),
            contentType = "image/png",
            alt = glue("{unique(fiveM_Filter_Two_One()$SiteName)}"),
            width = 430,
            height = 210
          ))
        }
      }, deleteFile = FALSE)
      
      output$fiveM_LargeSitePhoto_Two <- renderImage({
        if (is.null(input$fiveM_SpeciesName_Two_One))
          return(NULL)
        
        if (input$fiveM_SiteName_Two == unique(fiveM_Filter_Two_One()$SiteName)) {
          return(list(
            src = glue("www/Sat_Imagery/{unique(fiveM_Filter_Two_One()$SiteCode)}.png"),
            contentType = "image/png",
            alt = glue("{unique(fiveM_Filter_Two_One()$SiteName)}"),
            width = 1250,
            height = 625
          ))
        }
      }, deleteFile = FALSE)
      
      fiveM_alphaONI_Two <- reactive({
        if(input$fiveM_GraphOptions_Two == "With No Index"){
          return(0)
        }
        else if(input$fiveM_GraphOptions_Two == "With ONI"){
          return(1)
        }
        else if(input$fiveM_GraphOptions_Two == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$fiveM_GraphOptions_Two == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      fiveM_alphaPDO_NOAA_Two <- reactive({
        if(input$fiveM_GraphOptions_Two == "With No Index"){
          return(0)
        }
        if(input$fiveM_GraphOptions_Two == "With ONI"){
          return(0)
          
        }
        if(input$fiveM_GraphOptions_Two == "With PDO (NOAA)"){
          return(1)
        }
        if(input$fiveM_GraphOptions_Two == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      fiveM_alphaPDO_UW_Two <- reactive({
        if(input$fiveM_GraphOptions_Two == "With No Index"){
          return(0)
        }
        if(input$fiveM_GraphOptions_Two == "With ONI"){
          return(0)
          
        }
        if(input$fiveM_GraphOptions_Two == "With PDO (NOAA)"){
          return(0)
        }
        if(input$fiveM_GraphOptions_Two == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$fiveM_ONIpdoPIC_Two <- renderImage({
        if(input$fiveM_GraphOptions_Two == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$fiveM_GraphOptions_Two == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$fiveM_GraphOptions_Two == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      output$fiveM_Plot_Two <- renderPlot({
        
        if (is.null(input$fiveM_Graph_Two))
          return(NULL) 
        
        else if(input$fiveM_Graph_Two == "Line"){
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(fiveM_alphaONI_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_Two()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = fiveM_Filter_Two_One(), 
                        aes(x = Date, y = MeanDensity_sqm, group = ScientificName, color = CommonName),
                        size = 1) +
              geom_errorbar(data = fiveM_Filter_Two_One(),
                            aes(x = Date, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                            width = 0, color = "black", alpha = as.numeric(input$fiveM_EB_Two)) + 
              geom_line(data = fiveM_Filter_Two_Two(), 
                        aes(x = Date, y = MeanDensity_sqm*input$fiveM_Y_Slide_Two, group = ScientificName, color = CommonName),
                        size = 1) +
              geom_errorbar(data = fiveM_Filter_Two_Two(),
                            aes(x = Date, ymin = MeanDensity_sqm*input$fiveM_Y_Slide_Two - StandardError*input$fiveM_Y_Slide_Two, 
                                ymax = MeanDensity_sqm*input$fiveM_Y_Slide_Two + StandardError*input$fiveM_Y_Slide_Two),
                            width = 0, color = "black", alpha = as.numeric(input$fiveM_EB_Two)) + 
              scale_y_continuous(sec.axis = sec_axis(~./input$fiveM_Y_Slide_Two, 
                                                     name = glue("{unique(fiveM_Filter_Two_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%b %Y", breaks = unique(fiveM_Filter_Two_One()$Date), 
                           limits = c(min(as.Date(fiveM_Filter_Two_One()$Date))-365, 
                                      max(as.Date(fiveM_Filter_Two_One()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(fiveM_Filter_Two_One()$ScientificName)
                              } and {unique(fiveM_Filter_Two_Two()$ScientificName)}"), 
                   subtitle = glue("{unique(fiveM_Filter_Two_One()$IslandName)} {unique(fiveM_Filter_Two_One()$SiteName)}"),
                   color = "Common Name",
                   caption = 
                     glue(
                       "{fiveM_Filter_Two_One()$SiteName} is typically surveyed in {
                     lubridate::month(round(mean(month(fiveM_Filter_Two_One()$Date)), 0), label = TRUE, abbr = FALSE)
                     } and has a mean depth of {round(mean(fiveM_Filter_Two_One()$MeanDepth), 2)} ft"),
                   x = "Year",
                   y = glue('{unique(fiveM_Filter_Two_One()$CommonName)} Mean Density')) +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
          })}
        else if(input$fiveM_Graph_Two == "Bar") {
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(fiveM_alphaONI_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_Two()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = fiveM_Filter_Two_One(), 
                       aes(x = Date - 50, y = MeanDensity_sqm, fill = CommonName),
                       position = "dodge",
                       width = 100) +
              geom_col(data = fiveM_Filter_Two_Two(), 
                       aes(x = Date + 50, y = MeanDensity_sqm*input$fiveM_Y_Slide_Two, fill = CommonName),
                       position = "dodge",
                       width = 100) +
              geom_errorbar(data = fiveM_Filter_Two_One(),
                            aes(x = Date - 50, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                            width = 0, color = "black", alpha = as.numeric(input$fiveM_EB_Two)) + 
              geom_errorbar(data = fiveM_Filter_Two_Two(),
                            aes(x = Date + 50, ymin = MeanDensity_sqm*input$fiveM_Y_Slide_Two - StandardError*input$fiveM_Y_Slide_Two, 
                                ymax = MeanDensity_sqm*input$fiveM_Y_Slide_Two + StandardError*input$fiveM_Y_Slide_Two),
                            width = 0, color = "black", alpha = as.numeric(input$fiveM_EB_Two)) + 
              scale_y_continuous(sec.axis = sec_axis(~./input$fiveM_Y_Slide_Two, 
                                                     name = glue("{unique(fiveM_Filter_Two_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%b %Y", breaks = unique(fiveM_Filter_Two_One()$Date),
                           limits = c(min(as.Date(fiveM_Filter_Two_One()$Date))-365,
                                      max(as.Date(fiveM_Filter_Two_One()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(fiveM_Filter_Two_One()$ScientificName)
                              } and {unique(fiveM_Filter_Two_Two()$ScientificName)}"),
                   subtitle = glue("{unique(fiveM_Filter_Two_One()$IslandName)} {unique(fiveM_Filter_Two_One()$SiteName)}"),
                   color = "Common Name",
                   caption =
                     glue(
                       "{fiveM_Filter_Two_One()$SiteName} is typically surveyed in {
                     lubridate::month(round(mean(month(fiveM_Filter_Two_One()$Date)), 0), label = TRUE, abbr = FALSE)
                     } and has a mean depth of {round(mean(fiveM_Filter_Two_One()$MeanDepth), 2)} ft"),
                   x = "Year",
                   y = "Mean Density") +
              scale_fill_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
          })}
        else if(input$fiveM_Graph_Two == "Smooth Line"){
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(fiveM_alphaONI_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_NOAA_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(fiveM_alphaPDO_UW_Two()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_smooth(data = fiveM_Filter_Two_One(), 
                          aes(x = Date, y = MeanDensity_sqm, group = ScientificName, color = CommonName),
                          size = 1,  span = input$fiveM_SmoothSlide_Two, se = as.logical(input$fiveM_SmoothSE_Two)) +
              geom_point(data = fiveM_Filter_Two_One(),
                         aes(x = Date, y = MeanDensity_sqm, color = CommonName),
                         size = 1, alpha = as.numeric(input$fiveM_SmoothPoint_Two)) +
              geom_smooth(data = fiveM_Filter_Two_Two(), 
                          aes(x = Date, y = MeanDensity_sqm*input$fiveM_Y_Slide_Two, group = ScientificName, color = CommonName),
                          size = 1,  span = input$fiveM_SmoothSlide_Two, se = as.logical(input$fiveM_SmoothSE_Two)) +
              geom_point(data = fiveM_Filter_Two_Two(),
                         aes(x = Date, y = MeanDensity_sqm*input$fiveM_Y_Slide_Two, color = CommonName),
                         size = 1, alpha = as.numeric(input$fiveM_SmoothPoint_Two)) +
              scale_y_continuous(sec.axis = sec_axis(~./input$fiveM_Y_Slide_Two, 
                                                     name = glue("{unique(fiveM_Filter_Two_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%b %Y", breaks = unique(fiveM_Filter_Two_One()$Date), 
                           limits = c(min(as.Date(fiveM_Filter_Two_One()$Date))-365, 
                                      max(as.Date(fiveM_Filter_Two_One()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(fiveM_Filter_Two_One()$ScientificName)
                              } and {unique(fiveM_Filter_Two_Two()$ScientificName)}"), 
                   subtitle = glue("{unique(fiveM_Filter_Two_One()$IslandName)} {unique(fiveM_Filter_Two_One()$SiteName)}"),
                   color = "Common Name",
                   caption = 
                     glue(
                       "{fiveM_Filter_Two_One()$SiteName} is typically surveyed in {
                     lubridate::month(round(mean(month(fiveM_Filter_Two_One()$Date)), 0), label = TRUE, abbr = FALSE)
                     } and has a mean depth of {round(mean(fiveM_Filter_Two_One()$MeanDepth), 2)} ft"),
                   x = "Year",
                   y = glue('{unique(fiveM_Filter_Two_One()$CommonName)} Mean Density')) +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
          })}
      })
      
      output$fiveM_DToutData_Two_1 <- renderDT({
        datatable(fiveM_Filter_Two_One(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "500px",
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = c(list(list(visible = FALSE, targets = c(1, 3, 4, 7, 8, 9, 10, 11, 12, 13, 14, 15))), 
                                   list(list(className = 'dt-center', targets = 0:6))),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(fiveM_Filter_Two_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      })
      
      output$fiveM_DToutData_Two_2 <- renderDT({
        datatable(fiveM_Filter_Two_Two(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "500px",
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = c(list(list(visible = FALSE, targets = c(1, 3, 4, 7, 8, 9, 10, 11, 12, 13, 14, 15))), 
                                   list(list(className = 'dt-center', targets = 0:6))),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(fiveM_Filter_Two_Two()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      })
      
    }
    
    { # fiveM_Server_all   ----
      
      fiveM_Filter_All <- reactive({
        fiveM_DF %>%
          dplyr::filter(SiteName == input$fiveM_SiteNameAll) %>%
          drop_na()
      })
      
      output$fiveM_Plot_All <- renderPlot({
        if (is.null(input$fiveM_GraphAll))
          return(NULL)
        
        if (input$fiveM_GraphAll == "Line") {
          return({
            out <- by(data = fiveM_Filter_All(), INDICES = fiveM_Filter_All()$CommonName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_line(data = m, 
                          aes(Date, MeanDensity_sqm, group = CommonName, colour = CommonName, linetype = SiteName),
                          size = 1) +
                scale_x_date(date_labels = "%b %Y", breaks = unique(m$Date),
                             expand = expansion(mult = c(0.01, .01))) +
                geom_errorbar(data = m, 
                              aes(x = Date, ymin = MeanDensity_sqm - StandardError,
                                  ymax = MeanDensity_sqm + StandardError),
                              width = 0.25,
                              color = "black") +
                labs(title = m$ScientificName, 
                     subtitle = glue("{m$IslandName} {m$SiteName}"),
                     color = "Common Name",
                     x = "Year",
                     y = "Mean Density") +
                scale_color_manual(values = SpeciesColor) +
                scale_linetype_manual(values = SiteLine, guide = FALSE) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 13, colour = "black", face = "bold"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
              
            })
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v'))
          })
        } 
        else if (input$fiveM_GraphAll == "Bar") {
          return({
            out <- by(data = fiveM_Filter_All(), INDICES = fiveM_Filter_All()$CommonName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_col(data = m, 
                         aes(x = Date, y = MeanDensity_sqm, group = CommonName, fill = CommonName, linetype = SiteName),
                         width = 250) +
                geom_text(data = m, 
                          aes(x = Date, y = MeanDensity_sqm, label = round(MeanDensity_sqm, digits = 2)),
                          position = position_dodge(1),
                          vjust = -.2,
                          hjust = .5,
                          angle = 0) +
                scale_x_date(date_labels = "%b %Y", breaks = unique(m$Date),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(expand = expansion(mult = c(0, .1))) +
                labs(title = m$ScientificName, 
                     subtitle = glue("{m$IslandName} {m$SiteName}"),
                     color = "Common Name",
                     x = "Year",
                     y = "Mean Density") +
                scale_fill_manual(values = SpeciesColor) +
                scale_linetype_manual(values = SiteLine, guide = FALSE) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 13, colour = "black", face = "bold"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
              
            })
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v'))
          })
        } 
      })
      
    }
    
  }
  
  output$bands_UIout <- renderUI({ # bands_UI   ----
    if (is.null(input$bands_allORone))
      return(NULL)
    
    else if(input$bands_allORone == "One Species by Site") { #  bands_TP_One     ----
      dyn_ui <- tabPanel("Band Transects", value = 'bands_TP',  
                         tags$hr(),
                         plotOutput(outputId = "bands_Plot_One",
                                    height = 500),
                         tags$hr(),
                         fluidRow(
                           column(3, conditionalPanel("input.bands_Graph_One == 'Line' || input.bands_Graph_One == 'Bar'",
                                                      radioButtons(inputId = "bands_EB_one",
                                                                   label = "Show error bars?",
                                                                   choices = c("Yes" = 1, "No" = 0),
                                                                   inline = TRUE))),
                           column(3, conditionalPanel("input.bands_Graph_One == 'Bar'",
                                                      radioButtons(inputId = "bands_Bar_Text_One",
                                                                   label = "Show density value?",
                                                                   choices = c("Yes" = 1, "No" = 0), selected = 0,
                                                                   inline = TRUE))),
                           column(6, conditionalPanel("input.bands_GraphOptions_One == 'With ONI' ||
                                                      input.bands_GraphOptions_One == 'With PDO (NOAA)' ||
                                                      input.bands_GraphOptions_One == 'With PDO (UW)'",
                                                      imageOutput(outputId = "bands_ONIpdoPIC_One",
                                                                  height = 75)))),
                         conditionalPanel("input.bands_Graph_One == 'Smooth Line'",
                                          sliderInput(inputId = "bands_SmoothSlide_One",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "bands_SmoothSE_One",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "bands_SmoothPoint_One",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE)))),
                         conditionalPanel("input.bands_GraphOptions_One == 'With ONI'",
                                          tags$hr(),
                                          ONI_tagList),
                         conditionalPanel("input.bands_GraphOptions_One == 'With PDO (NOAA)'",
                                          tags$hr(),
                                          PDO_NOAA_tagList),
                         conditionalPanel("input.bands_GraphOptions_One == 'With PDO (UW)'",
                                          tags$hr(),
                                          PDO_UW_tagList),
                         conditionalPanel("input.bands_Graph_One == 'Boxplot'",
                                          tags$hr(),
                                          imageOutput(outputId = "bands_BoxplotDescription_One")),
                         tags$hr(),
                         fluidRow(column(4, tags$h2(tags$strong(input$bands_SpeciesName_One)),
                                         imageOutput(outputId = "bands_LargeSpPhoto_One",
                                                     height = 500)),
                                  column(3, tags$h2(tags$strong("Species Classification")),
                                         DTOutput(outputId = "bands_DToutClass_One",
                                                  height = 500)),
                                  column(5, tags$h2(tags$strong("Species Description")),
                                         DTOutput(outputId = "bands_DToutDesc_One",
                                                  height = 500))),
                         
                         tags$hr(),
                         DTOutput(outputId = "bands_DToutData_One",
                                  height = 550),
                         tags$hr(), tags$hr(),
                         imageOutput(outputId = "bands_LargeSitePhoto_One",
                                     height = 625),
                         tags$hr()
      )
    } 
    else if(input$bands_allORone == "One Species by Island") { #  bands_TP_by_Isl      ---- 
      dyn_ui <- tabPanel("Band Transects", value = 'bands_TP',
                         tags$hr(),
                         conditionalPanel("input.bands_FreeOrLock_Isl == 'Locked Scales' ||
                                          input.bands_FreeOrLock_Isl == 'Free Scales'",
                                          plotOutput(outputId = "bands_Plot_Isl1",
                                                     height = 1000)),
                         conditionalPanel("input.bands_FreeOrLock_Isl == 'Single Plot'", 
                                          plotOutput(outputId = "bands_Plot_Isl2",
                                                     height = 500)),
                         tags$hr(),
                         fluidRow(conditionalPanel("input.bands_Graph_Isl == 'Line' || (input.bands_Graph_Isl == 'Bar' && 
                                                   input.bands_DataSummary_Isl == 'Island Mean' && 
                                                   input.bands_FreeOrLock_Isl != 'Single Plot')",
                                                   column(3, radioButtons(inputId = "bands_EB_Isl",
                                                                          label = "Show error bars?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                  conditionalPanel("input.bands_Graph_Isl == 'Bar' && 
                                                   input.bands_DataSummary_Isl == 'Island Mean' && 
                                                   input.bands_FreeOrLock_Isl != 'Single Plot'",
                                                   column(3, radioButtons(inputId = "bands_Bar_Text_Isl",
                                                                          label = "Show density value?",
                                                                          choices = c("Yes" = 1, "No" = 0), selected = 0,
                                                                          inline = TRUE))),
                                  conditionalPanel("(input.bands_Graph_Isl == 'Bar' && 
                                                   input.bands_DataSummary_Isl == 'Island Mean' && 
                                                   input.bands_FreeOrLock_Isl != 'Locked Scales' && 
                                                   input.bands_FreeOrLock_Isl != 'Free Scales') ||
                                                   (input.bands_Graph_Isl == 'Bar' && 
                                                   input.bands_DataSummary_Isl == 'Site Means (by Island)')",
                                                   column(3, radioButtons(inputId = "bands_BarOptions_Isl",
                                                                          label =  "Bar Graph Options:",
                                                                          choices = c("Stack" = "stack", "Fill" = "fill", "Dodge" = "dodge"),
                                                                          inline = TRUE))),
                                  conditionalPanel("input.bands_GraphOptions_Isl == 'With ONI' ||
                                                      input.bands_GraphOptions_Isl == 'With PDO (NOAA)' ||
                                                      input.bands_GraphOptions_Isl == 'With PDO (UW)'",
                                                   column(6, imageOutput(outputId = "bands_ONIpdoPIC_Isl",
                                                                         height = 75)))),
                         fluidRow(conditionalPanel("input.bands_Graph_Isl == 'Line' || input.bands_Graph_Isl == 'Bar'",
                                                   tags$hr())),
                         conditionalPanel("input.bands_Graph_Isl == 'Smooth Line'",
                                          sliderInput(inputId = "bands_SmoothSlide_Isl",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "bands_SmoothSE_Isl",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "bands_SmoothPoint_Isl",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                          tags$hr()),
                         conditionalPanel("input.bands_GraphOptions_Isl == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.bands_GraphOptions_Isl == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr())
      )
    } 
    else if(input$bands_allORone == "One Species by MPA") { #  bands_TP_byMPA     ---- 
      dyn_ui <- tabPanel("Band Transects", value = 'bands_TP',  
                         tags$hr(),
                         plotOutput(outputId = "bands_Plot_MPA",
                                    height = 850),
                         tags$hr(),
                         fluidRow(conditionalPanel("input.bands_Graph_MPA == 'Line' || (input.bands_Graph_MPA == 'Bar' && 
                                                   input.bands_DataSummary_MPA == 'MPA Mean')",
                                                   column(3, radioButtons(inputId = "bands_EB_MPA",
                                                                          label = "Show error bars?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                  conditionalPanel("input.bands_Graph_MPA == 'Bar' && input.bands_DataSummary_MPA == 'MPA Mean'",
                                                   column(3, radioButtons(inputId = "bands_Bar_Text_MPA",
                                                                          label = "Show density value?",
                                                                          choices = c("Yes" = 1, "No" = 0), selected = 0,
                                                                          inline = TRUE))),
                                  conditionalPanel("input.bands_GraphOptions_MPA == 'With ONI' ||
                                                      input.bands_GraphOptions_MPA == 'With PDO (NOAA)' ||
                                                      input.bands_GraphOptions_MPA == 'With PDO (UW)'",
                                                   column(6, imageOutput(outputId = "bands_ONIpdoPIC_MPA",
                                                                         height = 75)))),
                         fluidRow(conditionalPanel("input.bands_Graph_MPA == 'Line' || input.bands_Graph_MPA == 'Bar'",
                                                   tags$hr())),
                         conditionalPanel("input.bands_Graph_MPA == 'Smooth Line'",
                                          sliderInput(inputId = "bands_SmoothSlide_MPA",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "bands_SmoothSE_MPA",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "bands_SmoothPoint_MPA",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                          tags$hr()),
                         conditionalPanel("input.bands_GraphOptions_MPA == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.bands_GraphOptions_MPA == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr()),
                         MPA_tagList,
                         tags$hr())
    }
    else if(input$bands_allORone == "Two Species by Site") { #  bands_TP_Two     ----
      dyn_ui <- tabPanel("Band Transects", value = 'bands_TP',  
                         tags$hr(),
                         plotOutput(outputId = "bands_Plot_Two",
                                    height = 500),
                         tags$hr(),
                         sliderInput(inputId = "bands_Y_Slide_Two",
                                     label = "Adjust the second y-axis by a multiple of:",
                                     min = 1, max = 50, step = 1, value = 1, width = "100%", ticks = T),
                         conditionalPanel("input.bands_Graph_Two == 'Smooth Line'",
                                          sliderInput(inputId = "bands_SmoothSlide_Two",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "bands_SmoothSE_Two",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "bands_SmoothPoint_Two",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE)))),
                         fluidRow(
                           conditionalPanel("input.bands_Graph_Two == 'Line' || input.bands_Graph_Two == 'Bar'",
                                            column(3, radioButtons(inputId = "bands_EB_Two",
                                                                   label = "Show error bars?",
                                                                   choices = c("Yes" = 1, "No" = 0),
                                                                   inline = TRUE))),
                           conditionalPanel("input.bands_GraphOptions_Two == 'With ONI' ||
                                                      input.bands_GraphOptions_Two == 'With PDO (NOAA)' ||
                                                      input.bands_GraphOptions_Two == 'With PDO (UW)'",
                                            column(6, imageOutput(outputId = "bands_ONIpdoPIC_Two",
                                                                  height = 75)))),
                         tags$hr(),
                         conditionalPanel("input.bands_GraphOptions_Two == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.bands_GraphOptions_Two == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr()),
                         conditionalPanel("input.bands_GraphOptions_Two == 'With PDO (UW)'",
                                          PDO_UW_tagList,
                                          tags$hr()),
                         fluidRow(column(6, tags$h1(tags$strong(input$bands_SpeciesName_Two_One)),
                                         imageOutput(outputId = "bands_LargeSpPhoto_Two_1",
                                                     height = 450)),
                                  column(6, tags$h1(tags$strong(input$bands_SpeciesName_Two_Two)),
                                         imageOutput(outputId = "bands_LargeSpPhoto_Two_2",
                                                     height = 450))),
                         tags$hr(),
                         fluidRow(column(6, tags$h1(tags$strong(input$bands_SpeciesName_Two_One)),
                                         DTOutput(outputId = "bands_DToutData_Two_1")),
                                  column(6, tags$h1(tags$strong(input$bands_SpeciesName_Two_Two)),
                                         DTOutput(outputId = "bands_DToutData_Two_2"))),
                         tags$hr(),
                         imageOutput(outputId = "bands_LargeSitePhoto_Two",
                                     height = 625),
                         tags$hr()
      )
    }
    else if(input$bands_allORone == "All Species") { # bands_TP_all   ----
      dyn_ui <- tabPanel("Band Transects", value = 'bands_TP',  
                         fluidRow(column(12, tags$h1(tags$strong(
                           "This section has the species in the order they appear on the datasheet")))),
                         plotOutput(outputId = "bands_Plot_All",
                                    height = 7000))
    }
    return(dyn_ui)
  })
  
  { # ........ bands_SERVERS ........     ----
    
    { # bands_Server_One_Species   ----
      
      bands_Filter_One <- reactive({ 
        bands_DF %>%
          dplyr::filter(SiteName == input$bands_SiteName_One,
                        CommonName == input$bands_SpeciesName_One) %>%
          dplyr::select(SurveyYear, Date, SiteName, IslandName, ScientificName, CommonName, MeanDensity_sqm, 
                        StandardError, StandardError, TotalCount, AreaSurveyed_sqm, MeanDepth, Island_Mean_Density,
                        Species, SiteNumber, IslandCode, SiteCode, IslandSE) 
      }) # filtered one meter summary table
      
      bands_RawFilter_One <- reactive({ 
        bands_DFRaw %>%
          dplyr::filter(SiteName == input$bands_SiteName_One,
                        CommonName == input$bands_SpeciesName_One) %>% 
          dplyr::group_by(SurveyYear) %>% 
          dplyr::mutate(Mean = mean(Count))
      }) # filtered  one Meter raw table
      
      bands_SpeciesClass_One <- reactive({ 
        SpeciesName %>%
          dplyr::filter(CommonName == input$bands_SpeciesName_One) %>%
          dplyr::select(ScientificName, Kingdom, Phylum, Class, Order, Family, Genus, "Species (Used by KFM)",
                        Status, "Currently Accepted Name", "Authority (Accepted)", CommonName) %>%
          tidyr::pivot_longer(-ScientificName, names_to = "Rank", values_to = "Name") %>%
          dplyr::select(Rank, Name)
      }) # filtered Species classification table
      
      bands_SpeciesDescription_One <- reactive({
        SpeciesName %>%
          dplyr::filter(CommonName == input$bands_SpeciesName_One) %>%
          dplyr::select(ScientificName, "Geographic Range", Identification, Habitat, "Size Range", "Trophic Level", Abundance) %>%
          tidyr::pivot_longer(-ScientificName, names_to = "Category", values_to = "Information") %>%
          dplyr::select(Category, Information)
      }) # filtered Species Description table  
      
      output$bands_TopPhoto_One <- renderImage({
        
        if (input$bands_allORone ==  'One Species by Site' && input$bands_SpeciesName_One == unique(bands_Filter_One()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(bands_Filter_One()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(bands_Filter_One()$CommonName)}"),
            width = 200,
            height = 200
          ))
        }
        else if (input$bands_allORone ==  'One Species by Island' && input$bands_SpeciesName_Isl == unique(bands_FilterByIsl_Isl()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(bands_FilterByIsl_Isl()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(bands_FilterByIsl_Isl()$CommonName)}"),
            width = 200,
            height = 200
          ))
        }
        else if (input$bands_allORone ==  'One Species by MPA' && input$bands_SpeciesName_MPA == unique(bands_Filter_MPA()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(bands_Filter_MPA()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(bands_Filter_MPA()$CommonName)}"),
            width = 200,
            height = 200
          ))
        }
        else if (input$bands_allORone ==  'Two Species by Site' && input$bands_SpeciesName_Two_One == unique(bands_Filter_Two_One()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(bands_Filter_Two_One()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(bands_Filter_Two_One()$CommonName)}"),
            width = 200,
            height = 200
          ))
        }
      }, deleteFile = FALSE) # Small species photo above plot
      
      output$bands_TopPhoto_Two <- renderImage({
        
        if (input$bands_allORone ==  'Two Species by Site' && input$bands_SpeciesName_Two_Two == unique(bands_Filter_Two_Two()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(bands_Filter_Two_Two()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(bands_Filter_Two_Two()$CommonName)}"),
            width = 200,
            height = 200
          ))
        }
      }, deleteFile = FALSE) # 2nd Small species photo above plot
      
      output$bands_LargeSpPhoto_One <- renderImage({
        list(src = glue("www/Indicator_Species/{unique(bands_Filter_One()$Species)}.jpg"),
             contentType = "image/jpg", width = 400, height = 400)
      }, deleteFile = FALSE) # Large species photo below plot
      
      output$bands_TopSitePhoto_One <- renderImage({
        list(src = glue("www/Sat_Imagery/{unique(bands_Filter_One()$SiteCode)}.png"),
             contentType = "image/png", width = 430, height = 210)
      }, deleteFile = FALSE) # Small Site photo above plot
      
      output$bands_LargeSitePhoto_One <- renderImage({
        list(src = glue("www/Sat_Imagery/{unique(bands_Filter_One()$SiteCode)}.png"),
             contentType = "image/png", width = 1250, height = 625)
      }, deleteFile = FALSE) # Large Site photo below plot
      
      output$bands_DToutClass_One <- renderDT({
        datatable(bands_SpeciesClass_One(), 
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    searching = FALSE,
                    lengthChange = FALSE,
                    paging = FALSE,
                    ordering = FALSE,
                    info = FALSE),
                  rownames = FALSE) %>% 
          formatStyle(names(bands_SpeciesClass_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      }) # Species Classification data table
      
      output$bands_DToutDesc_One <- renderDT({
        datatable(bands_SpeciesDescription_One(), 
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    searching = FALSE,
                    lengthChange = FALSE,
                    paging = FALSE,
                    ordering = FALSE,
                    info = FALSE),
                  rownames = FALSE) %>% 
          formatStyle(names(bands_SpeciesDescription_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      }) # Species Description data table
      
      bands_alphaONI_one <- reactive({
        if(input$bands_GraphOptions_One == "With No Index"){
          return(0)
        }
        else if(input$bands_GraphOptions_One == "With ONI"){
          return(1)
        }
        else if(input$bands_GraphOptions_One == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$bands_GraphOptions_One == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      bands_alphaPDO_NOAA_one <- reactive({
        if(input$bands_GraphOptions_One == "With No Index"){
          return(0)
        }
        if(input$bands_GraphOptions_One == "With ONI"){
          return(0)
          
        }
        if(input$bands_GraphOptions_One == "With PDO (NOAA)"){
          return(1)
        }
        if(input$bands_GraphOptions_One == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      bands_alphaPDO_UW_one <- reactive({
        if(input$bands_GraphOptions_One == "With No Index"){
          return(0)
        }
        if(input$bands_GraphOptions_One == "With ONI"){
          return(0)
          
        }
        if(input$bands_GraphOptions_One == "With PDO (NOAA)"){
          return(0)
        }
        if(input$bands_GraphOptions_One == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$bands_ONIpdoPIC_One <- renderImage({
        if(input$bands_GraphOptions_One == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$bands_GraphOptions_One == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$bands_GraphOptions_One == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      bands_LinePlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(bands_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(bands_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          geom_line(data = bands_Filter_One(),
                    aes(x = Date, y = MeanDensity_sqm, group = ScientificName, color = CommonName), 
                    size = 1) +
          geom_errorbar(data = bands_Filter_One(),
                        aes(x = Date, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                        width = 0, color = "black", alpha = as.numeric(input$bands_EB_one)) +
          scale_x_date(date_labels = "%b %Y", breaks = unique(bands_Filter_One()$Date),
                       limits = c(min(as.Date(bands_Filter_One()$Date))-365, max(as.Date(bands_Filter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          labs(title = glue("{unique(bands_Filter_One()$ScientificName)}"),
               subtitle = glue("{unique(bands_Filter_One()$IslandName)} {unique(bands_Filter_One()$SiteName)}"),
               color = "Common Name",
               fill = "Oceanic Nino \nIndex Gradient",
               caption = glue("{bands_Filter_One()$SiteName} is typically surveyed in {
                       lubridate::month(round(mean(month(bands_Filter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                       } and has a mean depth of {round(mean(bands_Filter_One()$MeanDepth), 2)} ft"),
               x = "Year",
               y = "Mean Density") +
          scale_color_manual(values = SpeciesColor) +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
      }) # Main Line Plot
      
      bands_BarPlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(bands_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(bands_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          new_scale_fill() +
          geom_col(data = bands_Filter_One(), aes(x = Date - ifelse(input$bands_DataSummary_One == "One species at one site", 0, 50),
                                                  y = MeanDensity_sqm, fill = CommonName), 
                   position = "dodge", width = ifelse(input$bands_DataSummary_One == "One species at one site", 250, 100)) +
          geom_errorbar(data = bands_Filter_One(),
                        aes(x = Date - ifelse(input$bands_DataSummary_One == "One species at one site", 0, 50), 
                            ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                        width = 0, color = "black", alpha = as.numeric(input$bands_EB_one)) +
          geom_text(data = bands_Filter_One(),
                    aes(x = Date - ifelse(input$bands_DataSummary_One == "One species at one site", 0, 50),
                        y = MeanDensity_sqm, label = round(MeanDensity_sqm, digits = 2)),
                    vjust = -.2, hjust = .5, alpha = as.numeric(input$bands_Bar_Text_One)) +
          scale_x_date(date_labels = "%b %Y", breaks = unique(bands_Filter_One()$Date),
                       limits = c(min(as.Date(bands_Filter_One()$Date))-365,  max(as.Date(bands_Filter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          labs(title = glue("{unique(bands_Filter_One()$ScientificName)}"),
               subtitle = glue("{unique(bands_Filter_One()$IslandName)} {unique(bands_Filter_One()$SiteName)}"),
               color = "Common Name",
               fill = "Common Name",
               caption = glue("{bands_Filter_One()$SiteName} is typically surveyed in {
                 lubridate::month(round(mean(month(bands_Filter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                 } and has a mean depth of {round(mean(bands_Filter_One()$MeanDepth), 2)} ft"),
               x = "Year",
               y = "Mean Density") +
          scale_fill_manual(values = SpeciesColor) +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
      }) # Main Bar Plot
      
      bands_SmoothPlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(bands_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(bands_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          stat_smooth(data = bands_Filter_One(), 
                      aes(x = Date, y = MeanDensity_sqm, group = ScientificName, color = CommonName), 
                      size = 1, span = input$bands_SmoothSlide_One, se = as.logical(input$bands_SmoothSE_One)) +
          scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 1)) +
          geom_point(data = bands_Filter_One(), aes(x = Date, y = MeanDensity_sqm, color = CommonName), 
                     size = 2, alpha = as.numeric(input$bands_SmoothPoint_One)) +
          scale_x_date(date_labels = "%b %Y", breaks = unique(bands_Filter_One()$Date), 
                       limits = c(min(as.Date(bands_Filter_One()$Date))-365, 
                                  max(as.Date(bands_Filter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          labs(title = glue("{unique(bands_Filter_One()$ScientificName)}"), 
               subtitle = glue("{unique(bands_Filter_One()$IslandName)} {unique(bands_Filter_One()$SiteName)}"),
               color = "Common Name",
               caption = glue("{bands_Filter_One()$SiteName} is typically surveyed in {
                       lubridate::month(round(mean(month(bands_Filter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                       } and has a mean depth of {round(mean(bands_Filter_One()$MeanDepth), 2)} ft"),
               x = "Year", y = "Smoothed Conditional Mean Values") +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
      }) # Main Smooth Line Plot
      
      bands_BoxPlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(bands_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(bands_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          geom_boxplot(data = bands_RawFilter_One(), 
                       aes(x = Date, y = Count, group = SurveyYear, color = CommonName)) +
          scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 1)) +
          geom_point(data = bands_RawFilter_One(), aes(x = Date, y = Mean),
                     size = 2, color = "black") +
          scale_x_date(date_labels = "%b %Y", breaks = unique(bands_RawFilter_One()$Date), 
                       limits = c(min(as.Date(bands_RawFilter_One()$Date))-365, max(as.Date(bands_RawFilter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          labs(title = glue("{unique(bands_RawFilter_One()$ScientificName)}"), 
               subtitle = glue("{unique(bands_RawFilter_One()$IslandName)} {unique(bands_RawFilter_One()$SiteName)}"),
               color = "Common Name",
               caption = glue("{bands_RawFilter_One()$SiteName} is typically surveyed in {
                       lubridate::month(round(mean(month(bands_RawFilter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                       } and has a mean depth of {round(mean(bands_RawFilter_One()$MeanDepth), 2)} ft"),
               x = "Year",
               y = "Count per Quadrat") +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
      }) # Main Boxplot Plot
      
      output$bands_Plot_One <- renderPlot({
        
        if (is.null(input$bands_Graph_One))
          return(NULL) 
        
        else if(input$bands_Graph_One == "Line" && input$bands_DataSummary_One == "One species at one site")
        {
          p <- bands_LinePlot_One()
        } 
        else if(input$bands_Graph_One == "Line" && input$bands_DataSummary_One == "One species with island average")
        {
          p <- bands_LinePlot_One() +
            new_scale_color() +
            geom_line(data = bands_Filter_One(),
                      aes(x = Date, y = Island_Mean_Density, group = ScientificName, color = IslandName),
                      size = 1) +
            geom_errorbar(data = bands_Filter_One(),
                          aes(x = Date, ymin = Island_Mean_Density - IslandSE,ymax = Island_Mean_Density + IslandSE),
                          width = 0, color = "black", alpha = as.numeric(input$bands_EB_one)) +
            labs(color = "Island Average") +
            scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 2))
        }
        else if(input$bands_Graph_One == "Bar" && input$bands_DataSummary_One == "One species at one site") 
        {
          p <- bands_BarPlot_One()
        }
        else if(input$bands_Graph_One == "Bar" && input$bands_DataSummary_One == "One species with island average") 
        {
          p <- bands_BarPlot_One() +
            new_scale_fill() +
            geom_col(data = bands_Filter_One(),
                     aes(x = Date + 50, y = Island_Mean_Density, fill = IslandName),
                     position = "dodge",
                     width = 100) +
            geom_errorbar(data = bands_Filter_One(),
                          aes(x = Date + 50, ymin = Island_Mean_Density - IslandSE, ymax = Island_Mean_Density + IslandSE),
                          width = 0, color = "black", alpha = as.numeric(input$bands_EB_one)) +
            scale_fill_manual(values = SpeciesColor, guide = guide_legend(order = 2)) +
            labs(fill = "Island Mean")
        } 
        else if(input$bands_Graph_One == "Smooth Line" && input$bands_DataSummary_One == "One species at one site")
        {
          p <- bands_SmoothPlot_One()
        }
        else if(input$bands_Graph_One == "Smooth Line" && input$bands_DataSummary_One == "One species with island average")
        {
          p <- bands_SmoothPlot_One() +
            new_scale_color() +
            stat_smooth(data = bands_Filter_One(), 
                        aes(x = Date, y = Island_Mean_Density, group = ScientificName, color = IslandName), 
                        size = 1,
                        span = input$bands_SmoothSlide_One,
                        se = as.logical(input$bands_SmoothSE_One)) +
            geom_point(data = bands_Filter_One(), aes(x = Date, y = Island_Mean_Density, color = IslandName), 
                       size = 2, alpha = as.numeric(input$bands_SmoothPoint_One)) +
            labs(color = "Island Average") +
            scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 2)) 
        }
        else if(input$bands_Graph_One == "Boxplot" && input$bands_DataSummary_One == "One species at one site")
        {
          p <- bands_BoxPlot_One()  
        }
        else if(input$bands_Graph_One == "Boxplot" && input$bands_DataSummary_One == "One species with island average")
        {
          p <- bands_BoxPlot_One() +
            new_scale_color() +
            geom_point(data = bands_Filter_One(), aes(x = Date, y = Island_Mean_Density, color = IslandName), 
                       size = 2) +
            labs(color = "Island Average") +
            scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 2)) 
        }
        return(p)
      }) # Main Plot for bands_ Quadrats with one species 
      
      output$bands_BoxplotDescription_One <- renderImage({
        list(src = glue("www/Boxplot_Description.jpg"), contentType = "image/jpg", width = 550, height = 400)
      }, deleteFile = FALSE) # Boxplot drawing/explanation
      
      output$bands_DToutData_One <- renderDT({
        datatable(bands_Filter_One(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "500px",
                    scrollX = TRUE, 
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = c(list(list(visible = FALSE, targets = c(10, 12, 13, 14, 15))), 
                                   list(list(className = 'dt-center', targets = 0:11))),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(bands_Filter_One()),
                      color = "black",
                      backgroundColor = 'white'
          )
      }) # Filtered data table output
      
    }
    
    { # bands_Server_by_Island   ----
      
      bands_Filter_Isl <- reactive({
        bands_DF <- bands_DF %>%
          dplyr::filter(CommonName == input$bands_SpeciesName_Isl) %>%
          dplyr::group_by(SurveyYear, IslandName) %>%
          dplyr::mutate(Date = mean(Date),
                        MaxSumBar = sum(MeanDensity_sqm)) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SiteName, SurveyYear) %>%
          dplyr::mutate(MaxSum = max(sum(MeanDensity_sqm)))
        
      })
      
      bands_FilterByIsl_Isl <- reactive({
        bands_DF %>%
          dplyr::filter(CommonName == input$bands_SpeciesName_Isl) %>%
          dplyr::group_by(IslandDate, IslandCode, IslandName, Species, ScientificName, CommonName, SurveyYear) %>%
          dplyr::distinct(IslandDate, IslandCode, IslandName,Species, ScientificName, CommonName, SurveyYear, 
                          Island_Mean_Density, IslandSD, IslandSE, IslandQuads, IslandAreaSurveyed, IslandTotalCount) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SurveyYear) %>%
          dplyr::mutate(IslandDate = mean(IslandDate))
      })
      
      bands_yValue_Isl <- reactive({
        if(input$bands_BarOptions_Isl == "stack"){
          return({
            max(bands_Filter_Isl()$MaxSumBar)
          }) 
        }
        else if(input$bands_BarOptions_Isl == "dodge"){
          return({
            max(bands_Filter_Isl()$MeanDensity_sqm)
          })
        }
        else if(input$bands_BarOptions_Isl == "fill"){
          return(1)
        }
      })
      
      bands_yLabel_Isl <- reactive({
        if(input$bands_BarOptions_Isl == "stack"){
          y <- "Combined Densities"
        }
        else if(input$bands_BarOptions_Isl == "dodge"){
          y <- "Seperated Densities"
        }
        else if(input$bands_BarOptions_Isl == "fill"){
          y <- "Normalized Densities"
        }
        y
      })
      
      bands_alphaONI_Isl <- reactive({
        if(input$bands_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        else if(input$bands_GraphOptions_Isl == "With ONI"){
          return(1)
        }
        else if(input$bands_GraphOptions_Isl == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$bands_GraphOptions_Isl == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      bands_alphaPDO_NOAA_Isl <- reactive({
        if(input$bands_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        if(input$bands_GraphOptions_Isl == "With ONI"){
          return(0)
          
        }
        if(input$bands_GraphOptions_Isl == "With PDO (NOAA)"){
          return(1)
        }
        if(input$bands_GraphOptions_Isl == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      bands_alphaPDO_UW_Isl <- reactive({
        if(input$bands_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        if(input$bands_GraphOptions_Isl == "With ONI"){
          return(0)
          
        }
        if(input$bands_GraphOptions_Isl == "With PDO (NOAA)"){
          return(0)
        }
        if(input$bands_GraphOptions_Isl == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$bands_ONIpdoPIC_Isl <- renderImage({
        if(input$bands_GraphOptions_Isl == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$bands_GraphOptions_Isl == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$bands_GraphOptions_Isl == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      bands_AxisScale_Isl <- reactive({
        if(input$bands_FreeOrLock_Isl == "Locked Scales"){
          return("fixed")
        }
        if(input$bands_FreeOrLock_Isl == "Free Scales"){
          return("free")
        }
      }) # Facet Plot Axis Scale free or fixed 
      
      output$bands_Plot_Isl1 <- renderPlot({ # Facet plots    ---- 
        
        if (is.null(input$bands_Graph_Isl))
          return(NULL) 
        
        else if(input$bands_Graph_Isl == "Line" && input$bands_DataSummary_Isl == "Island Mean") { # Line   ----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(bands_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = bands_FilterByIsl_Isl(), 
                        aes(x = IslandDate, y = Island_Mean_Density, group = IslandName, color = IslandName),
                        size = 1) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(bands_FilterByIsl_Isl()$IslandDate))-365,
                                      max(as.Date(bands_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              geom_errorbar(data = bands_FilterByIsl_Isl(), 
                            aes(x = IslandDate, ymin = Island_Mean_Density - IslandSE, ymax = Island_Mean_Density + IslandSE),
                            width = 0, color = "black", alpha = as.numeric(input$bands_EB_Isl)) +
              labs(title = glue("{unique(bands_FilterByIsl_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Density") +
              facet_grid(rows = vars(IslandName), scales = bands_AxisScale_Isl()) +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        } 
        else if(input$bands_Graph_Isl == "Line" && input$bands_DataSummary_Isl == "Site Means (by Island)") {
          return({
            out <- by(data = bands_Filter_Isl(), INDICES = bands_Filter_Isl()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(bands_alphaONI_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(bands_alphaPDO_UW_Isl()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_line(data = m, 
                          aes(Date, MeanDensity_sqm, group = SiteName, colour = SiteName, linetype = SiteName),
                          size = 1) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date),
                             limits = c(min(as.Date(m$Date))-365, max(as.Date(m$Date))+365),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(limits = c(0, ifelse(input$bands_FreeOrLock_Isl == "Locked Scales", 
                                                        max(bands_Filter_Isl()$MaxSum), max(m$MeanDensity_sqm))),
                                   expand = expansion(mult = c(0.01, .01))) +
                geom_errorbar(data = m, 
                              aes(x = Date, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                              width = 0, color = "black", alpha = as.numeric(input$bands_EB_Isl)) +
                labs(title = m$IslandName,
                     color = "Site Name",
                     linetype ="Site Name",
                     caption = "Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected",
                     x = NULL,
                     y = "Mean Density") +
                scale_color_manual(values = SiteColor, breaks = as.character(m$SiteName)) +
                scale_linetype_manual(values = SiteLine, breaks = as.character(m$SiteName)) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(bands_Filter_Isl()$ScientificName)}"),
                                          label_size = 20, label_fontface = "bold.italic"
            ))
          })
        } 
        else if(input$bands_Graph_Isl == "Bar" && input$bands_DataSummary_Isl == "Island Mean") { # Bar   ----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(bands_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = bands_FilterByIsl_Isl(), 
                       aes(x = IslandDate, y = Island_Mean_Density, fill = IslandName),
                       position = "dodge",
                       width = 280) +
              facet_grid(rows = vars(IslandName), scales = bands_AxisScale_Isl()) +
              geom_text(data = bands_FilterByIsl_Isl(),
                        aes(x = IslandDate, y = Island_Mean_Density, label = round(Island_Mean_Density, digits = 2)),
                        position = position_dodge(1), vjust = -.2, hjust = .5, angle = 0, alpha = as.numeric(input$bands_Bar_Text_Isl)) +
              geom_errorbar(data = bands_FilterByIsl_Isl(), 
                            aes(x = IslandDate, ymin = Island_Mean_Density - IslandSE, ymax = Island_Mean_Density + IslandSE),
                            width = 0, color = "black", alpha = as.numeric(input$bands_EB_Isl)) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              scale_x_date(date_labels = "%b %Y", date_breaks = "1 year", 
                           limits = c(min(as.Date(bands_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(bands_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(bands_FilterByIsl_Isl()$ScientificName)}"),
                   subtitle = glue("{unique(bands_FilterByIsl_Isl()$CommonName)}"),
                   color = "Common Name",
                   fill = "Common Name",
                   x = "Year",
                   y = "Mean Density") +
              scale_fill_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$bands_Graph_Isl == "Bar" && input$bands_DataSummary_Isl == "Site Means (by Island)") {
          return({
            out <- by(data = bands_Filter_Isl(), INDICES = bands_Filter_Isl()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() +
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(bands_alphaONI_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(bands_alphaPDO_UW_Isl()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                new_scale_fill() +
                geom_col(data = m, aes(x = Date, y = MeanDensity_sqm, fill = SiteName),
                         position = input$bands_BarOptions_Isl, width = 280) +
                coord_cartesian(ylim = c(0, ifelse(input$bands_FreeOrLock_Isl == "Locked Scales", 
                                                   bands_yValue_Isl(), max(m$MaxSumBar)))) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date), expand = expansion(mult = c(0.01, .01)),
                             limits = c(min(as.Date(m$Date))-365, max(as.Date(m$Date))+365)) +
                labs(title = m$IslandName,
                     color = "Site Name",
                     fill = "Site Name",
                     x = "Year",
                     y = bands_yLabel_Isl()) +
                scale_fill_manual(values = SiteColor) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(bands_Filter_Isl()$ScientificName)}"),
                                          label_size = 20, label_fontface = "bold.italic"
            ))
          })
        } 
        else if(input$bands_Graph_Isl == "Smooth Line" && input$bands_DataSummary_Isl == "Island Mean") { # Smooth   -----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(bands_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_smooth(data = bands_FilterByIsl_Isl(), aes(x = IslandDate, y = Island_Mean_Density, color = IslandName),
                          se = as.logical(input$bands_SmoothSE_Isl),
                          span = input$bands_SmoothSlide_Isl) +
              geom_point(data = bands_FilterByIsl_Isl(), aes(x = IslandDate, y = Island_Mean_Density, color = IslandName),
                         size = 1, alpha = as.numeric(input$bands_SmoothPoint_Isl),inherit.aes = FALSE) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(bands_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(bands_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(bands_FilterByIsl_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Density") +
              facet_grid(rows = vars(IslandName), scales = bands_AxisScale_Isl()) +
              scale_color_manual(values = SpeciesColor, guide = guide_legend(nrow = 5)) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$bands_Graph_Isl == "Smooth Line" && input$bands_DataSummary_Isl == "Site Means (by Island)") { 
          return({
            out <- by(data = bands_Filter_Isl(), INDICES = bands_Filter_Isl()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() +
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(bands_alphaONI_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(bands_alphaPDO_UW_Isl()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_point(data = m, aes(x = Date, y = MeanDensity_sqm, color = SiteName),
                           size = 1, alpha = as.numeric(input$bands_SmoothPoint_Isl), inherit.aes = FALSE) +
                geom_smooth(data = m, aes(x = Date, y = MeanDensity_sqm, color = SiteName),
                            se = as.logical(input$bands_SmoothSE_Isl),
                            span = input$bands_SmoothSlide_Isl) +
                scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                             limits = c(min(as.Date(bands_FilterByIsl_Isl()$IslandDate))-365, 
                                        max(as.Date(bands_FilterByIsl_Isl()$IslandDate))+365),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(limits = c(0, ifelse(input$bands_FreeOrLock_Isl == "Locked Scales", 
                                                        max(bands_Filter_Isl()$MaxSum), max(m$MeanDensity_sqm))),
                                   expand = expansion(mult = c(0.01, .01))) +
                labs(title = glue("{unique(m$IslandName)}"), 
                     color = "Site Name",
                     x = "Year",
                     y = "Mean Density") +
                scale_color_manual(values = SiteColor) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 13, colour = "black", face = "bold"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(bands_Filter_Isl()$ScientificName)}"),
                                          label_size = 20, label_fontface = "bold.italic"
            ))
          })
        }
        
      })
      
      output$bands_Plot_Isl2 <- renderPlot({  # Single plot    ----
        
        if (is.null(input$bands_Graph_Isl))
          return(NULL) 
        
        else if(input$bands_Graph_Isl == "Line" && input$bands_DataSummary_Isl == "Island Mean") { # Line   ----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(bands_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = bands_FilterByIsl_Isl(), 
                        aes(x = IslandDate, y = Island_Mean_Density, group = IslandName, color = IslandName),
                        size = 1) +
              scale_x_date(date_labels = "%Y", breaks = bands_FilterByIsl_Isl()$IslandDate, 
                           limits = c(min(as.Date(bands_FilterByIsl_Isl()$IslandDate))-365,
                                      max(as.Date(bands_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              geom_errorbar(data = bands_FilterByIsl_Isl(), 
                            aes(x = IslandDate, ymin = Island_Mean_Density - IslandSE, ymax = Island_Mean_Density + IslandSE),
                            width = 0, color = "black", alpha = as.numeric(input$bands_EB_Isl)) +
              labs(title = glue("{unique(bands_FilterByIsl_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Density") +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "right",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        } 
        else if(input$bands_Graph_Isl == "Line" && input$bands_DataSummary_Isl == "Site Means (by Island)") {
          return({
            ggplot() + 
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(bands_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = bands_Filter_Isl(), 
                        aes(Date, MeanDensity_sqm, group = SiteName, colour = SiteName, linetype = SiteName),
                        size = 1) +
              scale_x_date(date_labels = "%Y", date_breaks = "1 year",
                           limits = c(min(as.Date(bands_FilterByIsl_Isl()$IslandDate))-365,
                                      max(as.Date(bands_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              scale_y_continuous(limits = c(0, max(bands_Filter_Isl()$MaxSum)), expand = expansion(mult = c(0.01, .01))) +
              geom_errorbar(data = bands_Filter_Isl(), 
                            aes(x = Date, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                            width = 0, color = "black", alpha = as.numeric(input$bands_EB_Isl)) +
              labs(title = bands_Filter_Isl()$IslandName,
                   color = "Site Name",
                   linetype ="Site Name",
                   caption = "Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected",
                   x = NULL,
                   y = "Mean Density") +
              geom_vline(size = 1, xintercept = as.Date("2005-07-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2005-07-01", format = "%Y-%m-%d"), 
                        y= Inf, aes(label = "16 New Sites Added"),
                        hjust = 0,
                        vjust = 1,
                        inherit.aes = FALSE) +
              geom_vline(size = 1, xintercept = as.Date("2001-06-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2001-06-01", format = "%Y-%m-%d"), 
                        y= Inf, aes(label = "Miracle Mile Added"),
                        hjust = 1,
                        vjust = 1,
                        inherit.aes = FALSE) +
              scale_color_manual(values = SiteColor2, guide = guide_legend(ncol = 10)) +
              scale_linetype_manual(values = SiteLine, guide = guide_legend(ncol = 10)) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.key.width = unit(1.5, "cm"),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 12, colour = "black"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$bands_Graph_Isl == "Bar" && input$bands_DataSummary_Isl == "Island Mean") { # Bar -----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(bands_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = bands_FilterByIsl_Isl(), 
                       aes(x = IslandDate, y = Island_Mean_Density, fill = IslandName),
                       position = input$bands_BarOptions_Isl,
                       width = 280) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              scale_x_date(date_labels = "%Y", breaks = bands_FilterByIsl_Isl()$IslandDate, 
                           limits = c(min(as.Date(bands_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(bands_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(bands_FilterByIsl_Isl()$ScientificName)}"),
                   subtitle = glue("{unique(bands_FilterByIsl_Isl()$CommonName)}"),
                   color = "Common Name",
                   fill = "Common Name",
                   x = "Year",
                   y = bands_yLabel_Isl()) +
              scale_fill_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "right",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$bands_Graph_Isl == "Bar" && input$bands_DataSummary_Isl == "Site Means (by Island)") {
          return({
            ggplot() +
              geom_col(data = bands_Filter_Isl() %>% dplyr::group_by(SurveyYear) %>% dplyr::mutate(Date = mean(Date)), 
                       aes(x = Date-75, y = MeanDensity_sqm, fill = SiteName),
                       position = input$bands_BarOptions_Isl,
                       width = 280) +
              scale_x_date(date_labels = "%Y", date_breaks = "1 year",
                           limits = c(min(as.Date(bands_Filter_Isl()$Date))-365,
                                      max(as.Date(bands_Filter_Isl()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = bands_Filter_Isl()$IslandName,
                   color = "Site Name",
                   fill = "Site Name",
                   x = "Year",
                   y = bands_yLabel_Isl()) +
              geom_vline(size = 1, xintercept = as.Date("2005-01-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2005-01-01", format = "%Y-%m-%d"), 
                        y= Inf, aes(label = "16 New Sites Added"),
                        hjust = 0,
                        vjust = 1,
                        inherit.aes = FALSE) +
              geom_vline(size = 1, xintercept = as.Date("2001-01-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2001-01-01", format = "%Y-%m-%d"), 
                        y= Inf, aes(label = "Miracle Mile Added"),
                        hjust = 1,
                        vjust = 1,
                        inherit.aes = FALSE) +
              scale_fill_manual(values = SiteColor2, guide = guide_legend(ncol = 10)) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.key.width = unit(1, "cm"),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 12, colour = "black"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        } 
        else if(input$bands_Graph_Isl == "Smooth Line" && input$bands_DataSummary_Isl == "Island Mean") { # Smooth   ----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(bands_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_point(data = bands_FilterByIsl_Isl(), aes(x = IslandDate, y = Island_Mean_Density, color = IslandName), 
                         size = 2, alpha = as.numeric(input$bands_SmoothPoint_Isl)) +
              geom_smooth(data = bands_FilterByIsl_Isl(), aes(x= IslandDate, y = Island_Mean_Density, color = IslandName),
                          se = as.logical(input$bands_SmoothSE_Isl), span = input$bands_SmoothSlide_Isl) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(bands_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(bands_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(bands_FilterByIsl_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Density") +
              scale_color_manual(values = SpeciesColor, guide = guide_legend(nrow = 5)) +
              theme_classic() +
              theme(legend.position = "right",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$bands_Graph_Isl == "Smooth Line" && input$bands_DataSummary_Isl == "Site Means (by Island)") {
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(bands_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_point(data = bands_Filter_Isl(), aes(x = Date, y = MeanDensity_sqm, color = CommonName), 
                         size = 2, alpha = as.numeric(input$bands_SmoothPoint_Isl)) +
              geom_smooth(data = bands_Filter_Isl(), aes(x= Date, y = MeanDensity_sqm, color = SiteName),
                          se = as.logical(input$bands_SmoothSE_Isl), span = input$bands_SmoothSlide_Isl) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(bands_Filter_Isl()$Date))-365, 
                                      max(as.Date(bands_Filter_Isl()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(bands_Filter_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Density") +
              scale_color_manual(values = SiteColor2, guide = guide_legend(nrow = 5)) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
      })
      
    }
    
    { # bands_Server_byMPA ----
      
      bands_Filter_MPA <- reactive({
        bands_DFMPA %>%
          dplyr::filter(CommonName == input$bands_SpeciesName_MPA) %>%
          dplyr::group_by(IslandCode, SurveyYear) %>%
          dplyr::mutate(Date = mean(Date),
                        MaxSumBar = max(sum(MeanDensity_sqm))) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SiteName, SurveyYear) %>%
          dplyr::mutate(MaxSum = max(sum(MeanDensity_sqm))) %>%
          arrange(SiteName)
      })
      
      bands_FilterBarSite_MPA <-reactive({
        bands_DFMPA %>%
          dplyr::filter(CommonName == input$bands_SpeciesName_MPA,
                        SiteName != "Keyhole") %>%
          dplyr::group_by(IslandCode, SurveyYear) %>%
          dplyr::mutate(Date = mean(Date),
                        MaxSumBar = max(sum(MeanDensity_sqm))) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SiteName, SurveyYear) %>%
          dplyr::mutate(MaxSum = max(sum(MeanDensity_sqm)))
      })
      
      bands_Inside_MPA <- reactive({
        bands_DFMPA %>% 
          dplyr::filter(CommonName == input$bands_SpeciesName_MPA,
                        ReserveStatus == "Inside",
                        SiteName != "Keyhole") %>%
          dplyr::group_by(MPA_Date, IslandCode, IslandName, Species, ScientificName, CommonName, SurveyYear) %>%
          dplyr::distinct(MPA_Date, IslandCode, IslandName,Species, ScientificName, CommonName, SurveyYear,
                          MPA_TotalCount, MPA_Mean, MPA_SD, MPA_SE, MPA_Quadrats_Sampled, MPA_AreaSurveyed_sqm, .keep_all = TRUE)
      })
      
      bands_Outside_MPA <- reactive({
        bands_DFMPA %>%
          dplyr::filter(CommonName == input$bands_SpeciesName_MPA,
                        ReserveStatus == "Outside",
                        SiteName != "Keyhole") %>%
          dplyr::group_by(MPA_Date, IslandCode, IslandName, Species, ScientificName, CommonName, SurveyYear) %>%
          dplyr::distinct(MPA_Date, IslandCode, IslandName,Species, ScientificName, CommonName, SurveyYear,
                          MPA_TotalCount, MPA_Mean, MPA_SD, MPA_SE, MPA_Quadrats_Sampled, MPA_AreaSurveyed_sqm, .keep_all = TRUE)
      })
      
      bands_alphaONI_MPA <- reactive({
        if(input$bands_GraphOptions_MPA == "With No Index"){
          return(0)
        }
        else if(input$bands_GraphOptions_MPA == "With ONI"){
          return(1)
        }
        else if(input$bands_GraphOptions_MPA == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$bands_GraphOptions_MPA == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      bands_alphaPDO_NOAA_MPA <- reactive({
        if(input$bands_GraphOptions_MPA == "With No Index"){
          return(0)
        }
        if(input$bands_GraphOptions_MPA == "With ONI"){
          return(0)
          
        }
        if(input$bands_GraphOptions_MPA == "With PDO (NOAA)"){
          return(1)
        }
        if(input$bands_GraphOptions_MPA == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      bands_alphaPDO_UW_MPA <- reactive({
        if(input$bands_GraphOptions_MPA == "With No Index"){
          return(0)
        }
        if(input$bands_GraphOptions_MPA == "With ONI"){
          return(0)
          
        }
        if(input$bands_GraphOptions_MPA == "With PDO (NOAA)"){
          return(0)
        }
        if(input$bands_GraphOptions_MPA == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$bands_ONIpdoPIC_MPA <- renderImage({
        if(input$bands_GraphOptions_MPA == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$bands_GraphOptions_MPA == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$bands_GraphOptions_MPA == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      bands_AxisScale_MPA <- reactive({
        if(input$bands_FreeOrLock_MPA == "Locked Scales"){
          return("fixed")
        }
        if(input$bands_FreeOrLock_MPA == "Free Scales"){
          return("free")
        }
      }) # Facet Plot Axis Scale free or fixed 
      
      output$bands_Plot_MPA <- renderPlot({
        if (is.null(input$bands_Graph_MPA))
          return(NULL)
        
        else if(input$bands_Graph_MPA == "Line" && input$bands_DataSummary_MPA == "MPA Mean") {  # Line    ----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(bands_alphaONI_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_UW_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = bands_Filter_MPA() %>% dplyr::filter(SiteName != "Keyhole"), 
                        aes(x = MPA_Date, y = MPA_Mean, group = ReserveStatus, color = ReserveStatus, linetype = ReserveStatus),
                        size = 1) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(bands_Filter_MPA()$MPA_Date)), 
                                      max(as.Date(bands_Filter_MPA()$MPA_Date))),
                           expand = expansion(mult = c(0.01, .01))) +
              geom_errorbar(data = bands_Filter_MPA(), 
                            aes(x = MPA_Date, ymin = MPA_Mean - MPA_SE, ymax = MPA_Mean + MPA_SE),
                            width = 0, color = "black", alpha = as.numeric(input$bands_EB_MPA)) +
              labs(title = glue("{unique(bands_Filter_MPA()$ScientificName)}"),
                   subtitle = glue("{unique(bands_Filter_MPA()$CommonName)}"),
                   color = "Reserve Status",
                   linetype = "Reserve Status",
                   x = "Year",
                   y = "Mean Density") +
              scale_color_manual(values = c(Inside = "green3", Outside = "red3")) +
              scale_linetype_manual(values = c(Inside = "dashed", Outside = "solid")) +
              facet_grid(rows = vars(IslandName), scales = bands_AxisScale_MPA()) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    legend.key.width = unit(2, "cm"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"),
                    strip.text = element_text(size = 12, colour = "Black", angle = 90, face = "bold"))
          })
        }
        else if(input$bands_Graph_MPA == "Line" && input$bands_DataSummary_MPA == "Site Means (by MPA)") {
          return({
            out <- by(data = bands_Filter_MPA(), INDICES = bands_Filter_MPA()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(bands_alphaONI_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(bands_alphaPDO_UW_MPA()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_line(data = m, 
                          aes(x = Date, MeanDensity_sqm, group = SiteName, color = SiteName, linetype = SiteName),
                          size = 1) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date),
                             limits = c(min(as.Date(m$Date)), max(as.Date(m$Date))),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(limits = c(0, ifelse(input$bands_FreeOrLock_MPA == "Locked Scales", 
                                                        max(bands_Filter_MPA()$MaxSum), max(m$MeanDensity_sqm))), 
                                   expand = expansion(mult = c(0.01, .01))) +
                geom_errorbar(data = m, 
                              aes(x = Date, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                              width = 0, color = "black", alpha = as.numeric(input$bands_EB_MPA)) +
                labs(title = m$IslandName,
                     color = "Site Name",
                     linetype = "Site Name",
                     caption = "Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected",
                     x = "Year",
                     y = "Mean Density") +
                scale_color_manual(values = SiteColor, breaks = as.character(m$SiteName)) +
                scale_linetype_manual(values = SiteLine, breaks = as.character(m$SiteName)) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(bands_Filter_MPA()$ScientificName)}"),
                                          label_size = 20,
                                          label_fontface = "bold.italic"
            ))
          })
        }
        else if(input$bands_Graph_MPA == "Bar" && input$bands_DataSummary_MPA == "MPA Mean") { # Bar    -----
          return({ 
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(bands_alphaONI_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_UW_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = bands_Inside_MPA(), 
                       aes(x = MPA_Date - 60, y = MPA_Mean, group = ReserveStatus, fill = ReserveStatus),
                       width = 120) +
              geom_text(data = bands_Inside_MPA(),
                        aes(x = MPA_Date - 60, y = MPA_Mean, label = round(MPA_Mean, digits = 2)),
                        vjust = -.2, hjust = .5, angle = 0, alpha = as.numeric(input$bands_Bar_Text_MPA)) +
              geom_errorbar(data = bands_Inside_MPA(), 
                            aes(x = MPA_Date - 60, ymin = MPA_Mean - MPA_SE, ymax = MPA_Mean + MPA_SE),
                            width = 0, color = "black", alpha = as.numeric(input$bands_EB_MPA)) +
              geom_col(data = bands_Outside_MPA(), 
                       aes(x = MPA_Date + 60, y = MPA_Mean, group = ReserveStatus, fill = ReserveStatus),
                       width = 120) +
              geom_text(data = bands_Outside_MPA(),
                        aes(x = MPA_Date + 60, y = MPA_Mean, label = round(MPA_Mean, digits = 2)),
                        vjust = -.2, hjust = .5, angle = 0, alpha = as.numeric(input$bands_Bar_Text_MPA)) +
              geom_errorbar(data = bands_Outside_MPA(), 
                            aes(x = MPA_Date + 60, ymin = MPA_Mean - MPA_SE, ymax = MPA_Mean + MPA_SE),
                            width = 0, color = "black", alpha = as.numeric(input$bands_EB_MPA)) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(bands_Filter_MPA()$MPA_Date)) - 150, 
                                      max(as.Date(bands_Filter_MPA()$MPA_Date))),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(bands_Filter_MPA()$ScientificName)}"),
                   subtitle = glue("{unique(bands_Filter_MPA()$CommonName)}"),
                   color = "Reserve Status",
                   linetype = "Reserve Status",
                   x = "Year",
                   y = "Mean Density") +
              scale_fill_manual(values = c(Inside = "green3", Outside = "red3")) +
              facet_grid(rows = vars(IslandName), scales = bands_AxisScale_MPA()) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    legend.key.width = unit(2, "cm"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"),
                    strip.text = element_text(size = 12, colour = "Black", angle = 90, face = "bold"))
          })
        }
        else if(input$bands_Graph_MPA == "Bar" &&  input$bands_DataSummary_MPA == "Site Means (by MPA)") {
          return({
            out <- by(data = bands_FilterBarSite_MPA(), INDICES = bands_FilterBarSite_MPA()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() +
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(bands_alphaONI_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(bands_alphaPDO_UW_MPA()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                new_scale_fill() +
                geom_col(data = m %>% dplyr::filter(ReserveStatus == "Inside"), 
                         aes(x = Date - 70, y = MeanDensity_sqm, fill = SiteName),
                         position = "stack", width = 140) +
                geom_text(data = m %>% dplyr::filter(ReserveStatus == "Inside") %>% 
                            dplyr::group_by(IslandName, SurveyYear) %>% dplyr::mutate(SumBar = sum(MeanDensity_sqm)),
                          aes(x = Date - 70, y = SumBar, label = "In"),
                          vjust = -.2, hjust = .5, angle = 0) +
                scale_fill_manual(values = SiteColor) +
                labs(fill = "Inside") +
                new_scale_fill() +
                geom_col(data = m %>% dplyr::filter(ReserveStatus == "Outside") , 
                         aes(x = Date + 70, y = MeanDensity_sqm, fill = SiteName),
                         position = "stack", width = 140) +
                geom_text(data = m %>% dplyr::filter(ReserveStatus == "Outside") %>%
                            dplyr::group_by(IslandName, SurveyYear) %>%
                            dplyr::mutate(SumBar = sum(MeanDensity_sqm)),
                          aes(x = Date + 70, y = SumBar, label = "Out"),
                          vjust = -.2, hjust = .5, angle = 0) +
                scale_y_continuous(limits = c(0, ifelse(input$bands_FreeOrLock_MPA == "Locked Scales", 
                                                        max(bands_Filter_MPA()$MaxSumBar), max(m$MeanDensity_sqm))),
                                   expand = expansion(mult = c(0, .1))) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date), 
                             limits = c(min(as.Date(m$Date)) - 150, max(as.Date(m$Date))),
                             expand = expansion(mult = c(0.01, .01))) +
                labs(title = m$IslandName,
                     fill = "Outside",
                     x = "Year",
                     y = "Mean Density") +
                scale_fill_manual(values = SiteColor) +
                scale_color_manual(values = SiteColor) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(bands_Filter_MPA()$ScientificName)}"),
                                          label_size = 20,
                                          label_fontface = "bold.italic"
            ))
          })
        } 
        else if(input$bands_Graph_MPA == "Smooth Line" && input$bands_DataSummary_MPA == "MPA Mean") {  # Smooth       ----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(bands_alphaONI_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_UW_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_point(data = bands_Filter_MPA() %>% dplyr::filter(SiteName != "Keyhole"), 
                         aes(x= MPA_Date, y = MPA_Mean, color = ReserveStatus),
                         size = 1, alpha = as.numeric(input$bands_SmoothPoint_MPA), show.legend = FALSE) +
              geom_smooth(data = bands_Filter_MPA() %>% dplyr::filter(SiteName != "Keyhole"), 
                          aes(x= MPA_Date, y = MPA_Mean, color = ReserveStatus),
                          se = as.logical(input$bands_SmoothSE_MPA),
                          span = input$bands_SmoothSlide_MPA) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(bands_Filter_MPA()$MPA_Date)), 
                                      max(as.Date(bands_Filter_MPA()$MPA_Date))),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(bands_Filter_MPA()$ScientificName)}"),
                   subtitle = glue("{unique(bands_Filter_MPA()$CommonName)}"),
                   color = "Reserve Status",
                   linetype = "Reserve Status",
                   x = "Year",
                   y = "Mean Density") +
              scale_color_manual(values=c(Inside = "green3", Outside = "red3")) +
              scale_linetype_manual(values = c(Inside = "dashed", Outside = "solid")) +
              facet_grid(rows = vars(IslandName), scales = bands_AxisScale_MPA()) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    legend.key.width = unit(2, "cm"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"),
                    strip.text = element_text(size = 12, colour = "Black", angle = 90, face = "bold"))
          })
        }
        else if(input$bands_Graph_MPA == "Smooth Line" && input$bands_DataSummary_MPA == "Site Means (by MPA)") {
          return({
            out <- by(data = bands_Filter_MPA(), INDICES = bands_Filter_MPA()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(bands_alphaONI_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(bands_alphaPDO_UW_MPA()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_point(data = m, aes(x = Date, MeanDensity_sqm, color = SiteName),
                           size = 1, alpha = as.numeric(input$bands_SmoothPoint_MPA), show.legend = FALSE) +
                geom_smooth(data = m, aes(x = Date, MeanDensity_sqm, color = SiteName, linetype = SiteName),
                            se = as.logical(input$bands_SmoothSE_MPA),
                            span = input$bands_SmoothSlide_MPA) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date),
                             limits = c(min(as.Date(m$Date)) - 150, max(as.Date(m$Date))),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(limits = c(0, max(bands_Filter_MPA()$MaxSum)), expand = expansion(mult = c(0.01, .01))) +
                labs(title = m$IslandName,
                     color = "Site Name",
                     linetype = "Site Name",
                     caption = "Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected",
                     x = "Year",
                     y = "Mean Density") +
                scale_color_manual(values = SiteColor) +
                scale_linetype_manual(values = SiteLine) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(bands_Filter_MPA()$ScientificName)}"),
                                          label_size = 20,
                                          label_fontface = "bold.italic"
            ))
          })
        }
      })
      
    }
    
    { # bands_Server_Two_Species    ----
      
      bands_Filter_Two_One <- reactive({
        bands_DF %>%
          dplyr::filter(SiteName == input$bands_SiteName_Two,
                        CommonName == input$bands_SpeciesName_Two_One) %>%
          dplyr::select(SurveyYear, Date, SiteName, IslandName, ScientificName, CommonName, MeanDensity_sqm, 
                        StandardError, StandardError, TotalCount, AreaSurveyed_sqm, MeanDepth, Island_Mean_Density,
                        Species, SiteNumber, IslandCode, SiteCode) 
      })
      
      bands_Filter_Two_Two <- reactive({
        bands_DF %>%
          dplyr::filter(SiteName == input$bands_SiteName_Two,
                        CommonName == input$bands_SpeciesName_Two_Two) %>%
          dplyr::select(SurveyYear, Date, SiteName, IslandName, ScientificName, CommonName, MeanDensity_sqm, 
                        StandardError, StandardError, TotalCount, AreaSurveyed_sqm, MeanDepth, Island_Mean_Density,
                        Species, SiteNumber, IslandCode, SiteCode) 
      })
      
      output$bands_LargeSpPhoto_Two_1 <- renderImage({
        
        if (is.null(input$bands_SpeciesName_Two_One))
          return(NULL) 
        
        if (input$bands_SpeciesName_Two_One == unique(bands_Filter_Two_One()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(bands_Filter_Two_One()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(bands_Filter_Two_One()$CommonName)}"),
            width = 450,
            height = 450
          ))
        }
      }, deleteFile = FALSE)
      
      output$bands_LargeSpPhoto_Two_2 <- renderImage({
        
        if (input$bands_SpeciesName_Two_Two == unique(bands_Filter_Two_Two()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(bands_Filter_Two_Two()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(bands_Filter_Two_Two()$CommonName)}"),
            width = 450,
            height = 450
          ))
        }
      }, deleteFile = FALSE)
      
      output$bands_TopSitePhoto_Two <- renderImage({
        if (is.null(input$bands_SpeciesName_Two_One))
          return(NULL)
        
        if (input$bands_SiteName_Two == unique(bands_Filter_Two_One()$SiteName)) {
          return(list(
            src = glue("www/Sat_Imagery/{unique(bands_Filter_Two_One()$SiteCode)}.png"),
            contentType = "image/png",
            alt = glue("{unique(bands_Filter_Two_One()$SiteName)}"),
            width = 430,
            height = 210
          ))
        }
      }, deleteFile = FALSE)
      
      output$bands_LargeSitePhoto_Two <- renderImage({
        if (is.null(input$bands_SpeciesName_Two_One))
          return(NULL)
        
        if (input$bands_SiteName_Two == unique(bands_Filter_Two_One()$SiteName)) {
          return(list(
            src = glue("www/Sat_Imagery/{unique(bands_Filter_Two_One()$SiteCode)}.png"),
            contentType = "image/png",
            alt = glue("{unique(bands_Filter_Two_One()$SiteName)}"),
            width = 1250,
            height = 625
          ))
        }
      }, deleteFile = FALSE)
      
      bands_alphaONI_Two <- reactive({
        if(input$bands_GraphOptions_Two == "With No Index"){
          return(0)
        }
        else if(input$bands_GraphOptions_Two == "With ONI"){
          return(1)
        }
        else if(input$bands_GraphOptions_Two == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$bands_GraphOptions_Two == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      bands_alphaPDO_NOAA_Two <- reactive({
        if(input$bands_GraphOptions_Two == "With No Index"){
          return(0)
        }
        if(input$bands_GraphOptions_Two == "With ONI"){
          return(0)
          
        }
        if(input$bands_GraphOptions_Two == "With PDO (NOAA)"){
          return(1)
        }
        if(input$bands_GraphOptions_Two == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      bands_alphaPDO_UW_Two <- reactive({
        if(input$bands_GraphOptions_Two == "With No Index"){
          return(0)
        }
        if(input$bands_GraphOptions_Two == "With ONI"){
          return(0)
          
        }
        if(input$bands_GraphOptions_Two == "With PDO (NOAA)"){
          return(0)
        }
        if(input$bands_GraphOptions_Two == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$bands_ONIpdoPIC_Two <- renderImage({
        if(input$bands_GraphOptions_Two == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$bands_GraphOptions_Two == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$bands_GraphOptions_Two == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      output$bands_Plot_Two <- renderPlot({
        
        if (is.null(input$bands_Graph_Two))
          return(NULL) 
        
        else if(input$bands_Graph_Two == "Line"){
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(bands_alphaONI_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_UW_Two()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = bands_Filter_Two_One(), 
                        aes(x = Date, y = MeanDensity_sqm, group = ScientificName, color = CommonName),
                        size = 1) +
              geom_errorbar(data = bands_Filter_Two_One(),
                            aes(x = Date, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                            width = 0, color = "black", alpha = as.numeric(input$bands_EB_Two)) + 
              geom_line(data = bands_Filter_Two_Two(), 
                        aes(x = Date, y = MeanDensity_sqm*input$bands_Y_Slide_Two, group = ScientificName, color = CommonName),
                        size = 1) +
              geom_errorbar(data = bands_Filter_Two_Two(),
                            aes(x = Date, ymin = MeanDensity_sqm*input$bands_Y_Slide_Two - StandardError*input$bands_Y_Slide_Two, 
                                ymax = MeanDensity_sqm*input$bands_Y_Slide_Two + StandardError*input$bands_Y_Slide_Two),
                            width = 0, color = "black", alpha = as.numeric(input$bands_EB_Two)) + 
              scale_y_continuous(sec.axis = sec_axis(~./input$bands_Y_Slide_Two, 
                                                     name = glue("{unique(bands_Filter_Two_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%b %Y", breaks = unique(bands_Filter_Two_One()$Date), 
                           limits = c(min(as.Date(bands_Filter_Two_One()$Date))-365, 
                                      max(as.Date(bands_Filter_Two_One()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(bands_Filter_Two_One()$ScientificName)
                              } and {unique(bands_Filter_Two_Two()$ScientificName)}"), 
                   subtitle = glue("{unique(bands_Filter_Two_One()$IslandName)} {unique(bands_Filter_Two_One()$SiteName)}"),
                   color = "Common Name",
                   caption = 
                     glue(
                       "{bands_Filter_Two_One()$SiteName} is typically surveyed in {
                     lubridate::month(round(mean(month(bands_Filter_Two_One()$Date)), 0), label = TRUE, abbr = FALSE)
                     } and has a mean depth of {round(mean(bands_Filter_Two_One()$MeanDepth), 2)} ft"),
                   x = "Year",
                   y = glue('{unique(bands_Filter_Two_One()$CommonName)} Mean Density')) +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
          })}
        else if(input$bands_Graph_Two == "Bar") {
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(bands_alphaONI_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_UW_Two()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = bands_Filter_Two_One(), 
                       aes(x = Date - 50, y = MeanDensity_sqm, fill = CommonName),
                       position = "dodge",
                       width = 100) +
              geom_col(data = bands_Filter_Two_Two(), 
                       aes(x = Date + 50, y = MeanDensity_sqm*input$bands_Y_Slide_Two, fill = CommonName),
                       position = "dodge",
                       width = 100) +
              geom_errorbar(data = bands_Filter_Two_One(),
                            aes(x = Date - 50, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                            width = 0, color = "black", alpha = as.numeric(input$bands_EB_Two)) + 
              geom_errorbar(data = bands_Filter_Two_Two(),
                            aes(x = Date + 50, ymin = MeanDensity_sqm*input$bands_Y_Slide_Two - StandardError*input$bands_Y_Slide_Two, 
                                ymax = MeanDensity_sqm*input$bands_Y_Slide_Two + StandardError*input$bands_Y_Slide_Two),
                            width = 0, color = "black", alpha = as.numeric(input$bands_EB_Two)) + 
              scale_y_continuous(sec.axis = sec_axis(~./input$bands_Y_Slide_Two, 
                                                     name = glue("{unique(bands_Filter_Two_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%b %Y", breaks = unique(bands_Filter_Two_One()$Date),
                           limits = c(min(as.Date(bands_Filter_Two_One()$Date))-365,
                                      max(as.Date(bands_Filter_Two_One()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(bands_Filter_Two_One()$ScientificName)
                              } and {unique(bands_Filter_Two_Two()$ScientificName)}"),
                   subtitle = glue("{unique(bands_Filter_Two_One()$IslandName)} {unique(bands_Filter_Two_One()$SiteName)}"),
                   color = "Common Name",
                   caption =
                     glue(
                       "{bands_Filter_Two_One()$SiteName} is typically surveyed in {
                     lubridate::month(round(mean(month(bands_Filter_Two_One()$Date)), 0), label = TRUE, abbr = FALSE)
                     } and has a mean depth of {round(mean(bands_Filter_Two_One()$MeanDepth), 2)} ft"),
                   x = "Year",
                   y = "Mean Density") +
              scale_fill_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
          })}
        else if(input$bands_Graph_Two == "Smooth Line"){
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(bands_alphaONI_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_NOAA_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(bands_alphaPDO_UW_Two()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_smooth(data = bands_Filter_Two_One(), 
                          aes(x = Date, y = MeanDensity_sqm, group = ScientificName, color = CommonName),
                          size = 1,  span = input$bands_SmoothSlide_Two, se = as.logical(input$bands_SmoothSE_Two)) +
              geom_point(data = bands_Filter_Two_One(),
                         aes(x = Date, y = MeanDensity_sqm, color = CommonName),
                         size = 1, alpha = as.numeric(input$bands_SmoothPoint_Two)) +
              geom_smooth(data = bands_Filter_Two_Two(), 
                          aes(x = Date, y = MeanDensity_sqm*input$bands_Y_Slide_Two, group = ScientificName, color = CommonName),
                          size = 1,  span = input$bands_SmoothSlide_Two, se = as.logical(input$bands_SmoothSE_Two)) +
              geom_point(data = bands_Filter_Two_Two(),
                         aes(x = Date, y = MeanDensity_sqm*input$bands_Y_Slide_Two, color = CommonName),
                         size = 1, alpha = as.numeric(input$bands_SmoothPoint_Two)) +
              scale_y_continuous(sec.axis = sec_axis(~./input$bands_Y_Slide_Two, 
                                                     name = glue("{unique(bands_Filter_Two_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%b %Y", breaks = unique(bands_Filter_Two_One()$Date), 
                           limits = c(min(as.Date(bands_Filter_Two_One()$Date))-365, 
                                      max(as.Date(bands_Filter_Two_One()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(bands_Filter_Two_One()$ScientificName)
                              } and {unique(bands_Filter_Two_Two()$ScientificName)}"), 
                   subtitle = glue("{unique(bands_Filter_Two_One()$IslandName)} {unique(bands_Filter_Two_One()$SiteName)}"),
                   color = "Common Name",
                   caption = 
                     glue(
                       "{bands_Filter_Two_One()$SiteName} is typically surveyed in {
                     lubridate::month(round(mean(month(bands_Filter_Two_One()$Date)), 0), label = TRUE, abbr = FALSE)
                     } and has a mean depth of {round(mean(bands_Filter_Two_One()$MeanDepth), 2)} ft"),
                   x = "Year",
                   y = glue('{unique(bands_Filter_Two_One()$CommonName)} Mean Density')) +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
          })}
      })
      
      output$bands_DToutData_Two_1 <- renderDT({
        datatable(bands_Filter_Two_One(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "500px",
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = c(list(list(visible = FALSE, targets = c(1, 3, 4, 7, 8, 9, 10, 11, 12, 13, 14, 15))), 
                                   list(list(className = 'dt-center', targets = 0:6))),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(bands_Filter_Two_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      })
      
      output$bands_DToutData_Two_2 <- renderDT({
        datatable(bands_Filter_Two_Two(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "500px",
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = c(list(list(visible = FALSE, targets = c(1, 3, 4, 7, 8, 9, 10, 11, 12, 13, 14, 15))), 
                                   list(list(className = 'dt-center', targets = 0:6))),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(bands_Filter_Two_Two()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      })
      
    }
    
    { # bands_Server_all   ----
      
      bands_Filter_All <- reactive({
        bands_DF %>%
          dplyr::filter(SiteName == input$bands_SiteNameAll) %>%
          drop_na()
      })
      
      output$bands_Plot_All <- renderPlot({
        if (is.null(input$bands_GraphAll))
          return(NULL)
        
        if (input$bands_GraphAll == "Line") {
          return({
            out <- by(data = bands_Filter_All(), INDICES = bands_Filter_All()$CommonName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_line(data = m, 
                          aes(Date, MeanDensity_sqm, group = CommonName, colour = CommonName, linetype = SiteName),
                          size = 1) +
                scale_x_date(date_labels = "%b %Y", breaks = unique(m$Date),
                             expand = expansion(mult = c(0.01, .01))) +
                geom_errorbar(data = m, 
                              aes(x = Date, ymin = MeanDensity_sqm - StandardError,
                                  ymax = MeanDensity_sqm + StandardError),
                              width = 0.25,
                              color = "black") +
                labs(title = m$ScientificName, 
                     subtitle = glue("{m$IslandName} {m$SiteName}"),
                     color = "Common Name",
                     x = "Year",
                     y = "Mean Density") +
                scale_color_manual(values = SpeciesColor) +
                scale_linetype_manual(values = SiteLine, guide = FALSE) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 13, colour = "black", face = "bold"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
              
            })
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v'))
          })
        } 
        else if (input$bands_GraphAll == "Bar") {
          return({
            out <- by(data = bands_Filter_All(), INDICES = bands_Filter_All()$CommonName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_col(data = m, 
                         aes(x = Date, y = MeanDensity_sqm, group = CommonName, fill = CommonName, linetype = SiteName),
                         width = 250) +
                geom_text(data = m, 
                          aes(x = Date, y = MeanDensity_sqm, label = round(MeanDensity_sqm, digits = 2)),
                          position = position_dodge(1),
                          vjust = -.2,
                          hjust = .5,
                          angle = 0) +
                scale_x_date(date_labels = "%b %Y", breaks = unique(m$Date),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(expand = expansion(mult = c(0, .1))) +
                labs(title = m$ScientificName, 
                     subtitle = glue("{m$IslandName} {m$SiteName}"),
                     color = "Common Name",
                     x = "Year",
                     y = "Mean Density") +
                scale_fill_manual(values = SpeciesColor) +
                scale_linetype_manual(values = SiteLine, guide = FALSE) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 13, colour = "black", face = "bold"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
              
            })
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v'))
          })
        } 
      })
      
    }
    
  }
  
  output$core_UIout <- renderUI({ # Core_UI   ----
    if (is.null(input$core_allORone))
      return(NULL)
    
    else if(input$core_allORone == "Two Species by Site") { #  Core_TP_Two     ----
      dyn_ui <- tabPanel("Core Densities", value = "core_TP",  
                         tags$hr(),
                         plotOutput(outputId = "core_Plot_Two",
                                    height = 500),
                         tags$hr(),
                         sliderInput(inputId = "core_Y_Slide_Two",
                                     label = "Adjust the second y-axis by a multiple of:",
                                     min = 1, max = 40, step = 1, value = 1, width = "100%"),
                         conditionalPanel("input.core_Graph_Two == 'Line' || input.core_Graph_Two == 'Bar'",
                                          radioButtons(inputId = "core_EB_Two",
                                                       label = "Show error bars?",
                                                       choices = c("Yes" = 1, "No" = 0),
                                                       inline = TRUE),
                                          tags$hr()),
                         conditionalPanel("input.core_Graph_Two == 'Smooth Line'",
                                          sliderInput(inputId = "core_SmoothSlide_Two",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0,
                                                      max = 1,
                                                      step = .05,
                                                      value = .5,
                                                      width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "core_SmoothSE_Two",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "core_SmoothPoint_Two",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                          tags$hr()),
                         fluidRow(column(4, tags$h1(tags$strong(input$core_SpeciesName_Two_One)),
                                         imageOutput(outputId = "core_SpeciesPhoto_Two_One",
                                                     height = 450)),
                                  column(4, offset = 2, tags$h1(tags$strong(input$core_SpeciesName_Two_Two)),
                                         imageOutput(outputId = "core_SpeciesPhoto_Two_Two",
                                                     height = 450))),
                         tags$hr(),
                         fluidRow(column(6, tags$h1(tags$strong(input$core_SpeciesName_Two_One)),
                                         DTOutput(outputId = "core_DTout_Two_One")),
                                  column(6, tags$h1(tags$strong(input$core_SpeciesName_Two_Two)),
                                         DTOutput(outputId = "core_DTout_Two_Two"))),
                         tags$hr()
      )
    }
    else if(input$core_allORone == "Two Species by Island") { #  core_TP_by_Isl      ---- 
      dyn_ui <- tabPanel("Core Densities", value = 'core_TP',
                         tags$hr(),
                         plotOutput(outputId = "core_Plot_Isl",
                                    height = 500),
                         tags$hr(),
                         sliderInput(inputId = "core_Y_Slide_Isl",
                                     label = "Adjust the second y-axis by a multiple of:",
                                     min = 1, max = 40, step = 1, value = 1, width = "100%"),
                         fluidRow(conditionalPanel("input.core_Graph_Isl == 'Line' || input.core_Graph_Isl == 'Bar'",
                                                   column(3, radioButtons(inputId = "core_EB_Isl",
                                                                          label = "Show error bars?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                  conditionalPanel("input.core_GraphOptions_Isl == 'With ONI' ||
                                                      input.core_GraphOptions_Isl == 'With PDO (NOAA)' ||
                                                      input.core_GraphOptions_Isl == 'With PDO (UW)'",
                                                   column(6, imageOutput(outputId = "core_ONIpdoPIC_Isl",
                                                                         height = 75)))),
                         fluidRow(conditionalPanel("input.core_Graph_Isl == 'Line' || input.core_Graph_Isl == 'Bar'",
                                                   tags$hr())),
                         conditionalPanel("input.core_Graph_Isl == 'Smooth Line'",
                                          sliderInput(inputId = "core_SmoothSlide_Isl",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "core_SmoothSE_Isl",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "core_SmoothPoint_Isl",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                          tags$hr()),
                         conditionalPanel("input.core_GraphOptions_Isl == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.core_GraphOptions_Isl == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr())
      )
    }
    else if(input$core_allORone == "Two Species by MPA") { #  core_TP_by_MPA      ---- 
      dyn_ui <- tabPanel("Core Densities", value = 'core_TP',
                         tags$hr(),
                         plotOutput(outputId = "core_Plot_MPA",
                                    height = 500),
                         tags$hr(),
                         sliderInput(inputId = "core_Y_Slide_MPA",
                                     label = "Adjust the second y-axis by a multiple of:",
                                     min = 1, max = 40, step = 1, value = 1, width = "100%"),
                         fluidRow(conditionalPanel("input.core_Graph_MPA == 'Line' || input.core_Graph_MPA == 'Bar'",
                                                   column(3, radioButtons(inputId = "core_EB_MPA",
                                                                          label = "Show error bars?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                  conditionalPanel("input.core_GraphOptions_MPA == 'With ONI' ||
                                                      input.core_GraphOptions_MPA == 'With PDO (NOAA)' ||
                                                      input.core_GraphOptions_MPA == 'With PDO (UW)'",
                                                   column(6, imageOutput(outputId = "core_ONIpdoPIC_MPA",
                                                                         height = 75)))),
                         fluidRow(conditionalPanel("input.core_Graph_MPA == 'Line' || input.core_Graph_MPA == 'Bar'",
                                                   tags$hr())),
                         conditionalPanel("input.core_Graph_MPA == 'Smooth Line'",
                                          sliderInput(inputId = "core_SmoothSlide_MPA",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "core_SmoothSE_MPA",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "core_SmoothPoint_MPA",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                          tags$hr()),
                         conditionalPanel("input.core_GraphOptions_MPA == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.core_GraphOptions_MPA == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr())
      )
    }
    return(dyn_ui)
  })
  
  { # ........ Core Servers ........  ------
    
    { # Core_Two_Species    ----
      
      core_Filter_Two_One <- reactive({
        core_DF %>%
          dplyr::filter(SiteName == input$core_SiteName_Two,
                        CommonName == input$core_SpeciesName_Two_One) %>%
          dplyr::select(SurveyYear, Date, SiteName, IslandName, ScientificName, CommonName, MeanDensity_sqm, 
                        StandardError, StandardError, TotalCount, AreaSurveyed_sqm, MeanDepth, Island_Mean_Density,
                        Species, SiteNumber, IslandCode, SiteCode, SurveyType) 
      })
      
      core_Filter_Two_Two <- reactive({
        core_DF %>%
          dplyr::filter(SiteName == input$core_SiteName_Two,
                        CommonName == input$core_SpeciesName_Two_Two) %>%
          dplyr::select(SurveyYear, Date, SiteName, IslandName, ScientificName, CommonName, MeanDensity_sqm, 
                        StandardError, StandardError, TotalCount, AreaSurveyed_sqm, MeanDepth, Island_Mean_Density,
                        Species, SiteNumber, IslandCode, SiteCode, SurveyType) 
      })
      
      output$core_TopPhoto_One <- renderImage({ # species image - small one at the top
        if (is.null(input$core_allORone))
          return(NULL)
        
        if (input$core_allORone ==  'Two Species by Site' && input$core_SpeciesName_Two_One == unique(core_Filter_Two_One()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(core_Filter_Two_One()$Species)}.jpg"),
            contentType = "image/jpg",
            width = 200,
            height = 200
          ))
        }
        else if (input$core_allORone ==  'Two Species by Island' && input$core_SpeciesName_Isl_One == unique(core_Filter_Isl_One()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(core_Filter_Isl_One()$Species)}.jpg"),
            contentType = "image/jpg",
            width = 200,
            height = 200
          ))
        }
        else if (input$core_allORone ==  'Two Species by MPA' && input$core_SpeciesName_MPA_One == unique(core_Filter_MPA_One()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(core_Filter_MPA_One()$Species)}.jpg"),
            contentType = "image/jpg",
            width = 200,
            height = 200
          ))
        }
      }, deleteFile = FALSE)
      
      output$core_TopPhoto_Two <- renderImage({ # 2nd species image - small one at the top
        if (is.null(input$core_allORone))
          return(NULL)
        
        if (input$core_allORone ==  'Two Species by Site' && input$core_SpeciesName_Two_Two == unique(core_Filter_Two_Two()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(core_Filter_Two_Two()$Species)}.jpg"),
            contentType = "image/jpg",
            width = 200,
            height = 200
          ))
        }
        else if (input$core_allORone ==  'Two Species by Island' && input$core_SpeciesName_Isl_Two == unique(core_Filter_Isl_Two()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(core_Filter_Isl_Two()$Species)}.jpg"),
            contentType = "image/jpg",
            width = 200,
            height = 200
          ))
        }
        else if (input$core_allORone ==  'Two Species by MPA' && input$core_SpeciesName_MPA_Two == unique(core_Filter_MPA_Two()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(core_Filter_MPA_Two()$Species)}.jpg"),
            contentType = "image/jpg",
            width = 200,
            height = 200
          ))
        }
      }, deleteFile = FALSE)
      
      output$core_TopSitePhoto_Two <- renderImage({
        if (is.null(input$core_allORone))
          return(NULL)
        
        if (input$core_allORone ==  'Two Species by Site') {
          return(list(
            src = glue("www/Sat_Imagery/{unique(core_Filter_Two_One()$SiteCode)}.png"),
            contentType = "image/png",
            width = 430,
            height = 210))
        }
        else if (input$core_allORone ==  'Two Species by Island') {
          return(list(
            src = glue("www/Sat_Imagery/{unique(core_Filter_Isl_One()$IslandCode)}.png"),
            contentType = "image/png",
            width = 430,
            height = 210))
        }
        else if (input$core_allORone ==  'Two Species by MPA') {
          return(list(
            src = glue("www/Sat_Imagery/{unique(core_Filter_MPA_One()$IslandCode)}.png"),
            contentType = "image/png",
            width = 430,
            height = 210))
        }
      }, deleteFile = FALSE)
      
      output$core_LargeSitePhoto_One <- renderImage({
        if (is.null(input$core_allORone))
          return(NULL)
        
        if (input$core_allORone ==  'Two Species by Site') {
          return(list(
            src = glue("www/Sat_Imagery/{unique(core_Filter_Two_One()$SiteCode)}.png"),
            contentType = "image/png",
            width = 1250,
            height = 625))
        }
        else if (input$core_allORone ==  'Two Species by Island') {
          return(list(
            src = glue("www/Sat_Imagery/{unique(core_Filter_Isl_One()$IslandCode)}.png"),
            contentType = "image/png",
            width = 1250,
            height = 625))
        }
        else if (input$core_allORone ==  'Two Species by MPA') {
          return(list(
            src = glue("www/Sat_Imagery/{unique(core_Filter_MPA_One()$IslandCode)}.png"),
            contentType = "image/png",
            width = 1250,
            height = 625))
        }
      }, deleteFile = FALSE)
      
      output$core_SpeciesPhoto_Two_One <- renderImage({
        
        if (is.null(input$core_SpeciesName_Two_One))
          return(NULL) 
        
        if (input$core_SpeciesName_Two_One == unique(core_Filter_Two_One()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(core_Filter_Two_One()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(core_Filter_Two_One()$CommonName)}"),
            width = 450,
            height = 450
          ))
        }
      }, deleteFile = FALSE)
      
      output$core_SpeciesPhoto_Two_Two <- renderImage({
        
        if (input$core_SpeciesName_Two_Two == unique(core_Filter_Two_Two()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(core_Filter_Two_Two()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(core_Filter_Two_Two()$CommonName)}"),
            width = 450,
            height = 450
          ))
        }
      }, deleteFile = FALSE)
      
      core_alphaONI_Two <- reactive({
        if(input$core_GraphOptions_Two == "With No Index"){
          return(0)
        }
        else if(input$core_GraphOptions_Two == "With ONI"){
          return(1)
        }
        else if(input$core_GraphOptions_Two == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$core_GraphOptions_Two == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      core_alphaPDO_NOAA_Two <- reactive({
        if(input$core_GraphOptions_Two == "With No Index"){
          return(0)
        }
        if(input$core_GraphOptions_Two == "With ONI"){
          return(0)
          
        }
        if(input$core_GraphOptions_Two == "With PDO (NOAA)"){
          return(1)
        }
        if(input$core_GraphOptions_Two == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      core_alphaPDO_UW_Two <- reactive({
        if(input$core_GraphOptions_Two == "With No Index"){
          return(0)
        }
        if(input$core_GraphOptions_Two == "With ONI"){
          return(0)
          
        }
        if(input$core_GraphOptions_Two == "With PDO (NOAA)"){
          return(0)
        }
        if(input$core_GraphOptions_Two == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$core_ONIpdoPIC_Two <- renderImage({
        if(input$core_GraphOptions_Two == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$core_GraphOptions_Two == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$core_GraphOptions_Two == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      output$core_Plot_Two <- renderPlot({
        
        if (is.null(input$core_Graph_Two))
          return(NULL) 
        
        else if(input$core_Graph_Two == "Line"){
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(core_alphaONI_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(core_alphaPDO_NOAA_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(core_alphaPDO_UW_Two()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = core_Filter_Two_One(), 
                        aes(x = Date, y = MeanDensity_sqm, group = ScientificName, color = CommonName),
                        size = 1) +
              geom_line(data = core_Filter_Two_Two(), 
                        aes(x = Date, y = MeanDensity_sqm*input$core_Y_Slide_Two, group = ScientificName, color = CommonName),
                        size = 1) +
              geom_errorbar(data = core_Filter_Two_One(),
                            aes(x = Date, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                            width = 2, color = "black", alpha = as.numeric(input$core_EB_Two)) +
              geom_errorbar(data = core_Filter_Two_Two(),
                            aes(x = Date, ymin = MeanDensity_sqm*input$core_Y_Slide_Two - StandardError*input$core_Y_Slide_Two, 
                                ymax = MeanDensity_sqm*input$core_Y_Slide_Two + StandardError*input$core_Y_Slide_Two),
                            width = 2, color = "black", alpha = as.numeric(input$core_EB_Two)) +
              scale_y_continuous(sec.axis = sec_axis(~./input$core_Y_Slide_Two, 
                                                     name = glue("{unique(core_Filter_Two_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%b %Y", breaks = unique(core_Filter_Two_One()$Date), 
                           limits = c(min(as.Date(core_Filter_Two_One()$Date))-365, 
                                      max(as.Date(core_Filter_Two_One()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(core_Filter_Two_One()$ScientificName)
                              } and {unique(core_Filter_Two_Two()$ScientificName)}"), 
                   subtitle = glue("{unique(core_Filter_Two_One()$IslandName)} {unique(core_Filter_Two_One()$SiteName)}"),
                   color = "Common Name",
                   caption = 
                     glue(
                       "{core_Filter_Two_One()$SiteName} is typically surveyed in {
                     lubridate::month(round(mean(month(core_Filter_Two_One()$Date)), 0), label = TRUE, abbr = FALSE)
                     } and has a mean depth of {round(mean(core_Filter_Two_One()$MeanDepth), 2)} ft"),
                   x = "Year",
                   y = glue('{unique(core_Filter_Two_One()$CommonName)} Mean Density')) +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
          })}
        else if(input$core_Graph_Two == "Bar") {
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(core_alphaONI_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(core_alphaPDO_NOAA_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(core_alphaPDO_UW_Two()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = core_Filter_Two_One(), 
                       aes(x = Date - 50, y = MeanDensity_sqm, fill = CommonName),
                       position = "dodge",
                       width = 100) +
              geom_col(data = core_Filter_Two_Two(), 
                       aes(x = Date + 50, y = MeanDensity_sqm*input$core_Y_Slide_Two, fill = CommonName),
                       position = "dodge",
                       width = 100) +
              geom_errorbar(data = core_Filter_Two_One(),
                            aes(x = Date - 50, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                            width = 2, color = "black", alpha = as.numeric(input$core_EB_Two)) +
              geom_errorbar(data = core_Filter_Two_Two(),
                            aes(x = Date + 50, ymin = MeanDensity_sqm*input$core_Y_Slide_Two - StandardError*input$core_Y_Slide_Two, 
                                ymax = MeanDensity_sqm*input$core_Y_Slide_Two + StandardError*input$core_Y_Slide_Two),
                            width = 2, color = "black", alpha = as.numeric(input$core_EB_Two)) +
              scale_y_continuous(sec.axis = sec_axis(~./input$core_Y_Slide_Two, 
                                                     name = glue("{unique(core_Filter_Two_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%b %Y", breaks = unique(core_Filter_Two_One()$Date),
                           limits = c(min(as.Date(core_Filter_Two_One()$Date))-365,
                                      max(as.Date(core_Filter_Two_One()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(core_Filter_Two_One()$ScientificName)
                              } and {unique(core_Filter_Two_Two()$ScientificName)}"),
                   subtitle = glue("{unique(core_Filter_Two_One()$IslandName)} {unique(core_Filter_Two_One()$SiteName)}"),
                   color = "Common Name",
                   caption =
                     glue(
                       "{core_Filter_Two_One()$SiteName} is typically surveyed in {
                     lubridate::month(round(mean(month(core_Filter_Two_One()$Date)), 0), label = TRUE, abbr = FALSE)
                     } and has a mean depth of {round(mean(core_Filter_Two_One()$MeanDepth), 2)} ft"),
                   x = "Year",
                   y = "Mean Density") +
              scale_fill_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
          })}
        if(input$core_Graph_Two == "Smooth Line"){
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(core_alphaONI_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(core_alphaPDO_NOAA_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(core_alphaPDO_UW_Two()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              stat_smooth(data = core_Filter_Two_One(), 
                          aes(x = Date, y = MeanDensity_sqm, group = ScientificName, color = CommonName),
                          size = 1, span = input$core_SmoothSlide_Two, se = as.logical(input$core_SmoothSE_Two)) +
              geom_point(data = core_Filter_Two_One(),
                         aes(x = Date, y = MeanDensity_sqm, color = CommonName),
                         size = 1, alpha = as.numeric(input$core_SmoothPoint_Two)) +
              stat_smooth(data = core_Filter_Two_Two(), 
                          aes(x = Date, y = MeanDensity_sqm * input$core_Y_Slide_Two, group = ScientificName, color = CommonName),
                          size = 1,
                          span = input$core_SmoothSlide_Two,
                          se = as.logical(input$core_SmoothSE_Two)) +
              geom_point(data = core_Filter_Two_Two(),
                         aes(x = Date, y = MeanDensity_sqm * input$core_Y_Slide_Two, color = CommonName),
                         size = 1, alpha = as.numeric(input$core_SmoothPoint_Two)) +
              scale_y_continuous(sec.axis = sec_axis(~./input$core_Y_Slide_Two, 
                                                     name = glue("{unique(core_Filter_Two_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%b %Y", breaks = unique(core_Filter_Two_One()$Date), 
                           limits = c(min(as.Date(core_Filter_Two_One()$Date))-365, 
                                      max(as.Date(core_Filter_Two_One()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(core_Filter_Two_One()$ScientificName)
                              } and {unique(core_Filter_Two_Two()$ScientificName)}"), 
                   subtitle = glue("{unique(core_Filter_Two_One()$IslandName)} {unique(core_Filter_Two_One()$SiteName)}"),
                   color = "Common Name",
                   caption = glue("{core_Filter_Two_One()$SiteName} is typically surveyed in {
                     lubridate::month(round(mean(month(core_Filter_Two_One()$Date)), 0), label = TRUE, abbr = FALSE)
                     } and has a mean depth of {round(mean(core_Filter_Two_One()$MeanDepth), 2)} ft"),
                   x = "Year",
                   y = glue('{unique(core_Filter_Two_One()$CommonName)} Mean Density')) +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
          })}
        
      })
      
      output$core_DTout_Two_One <- renderDT({
        datatable(core_Filter_Two_One(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "500px",
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = c(list(list(visible = FALSE, targets = c(1, 3, 4, 7, 8, 9, 10, 11, 12, 13, 14, 15))), 
                                   list(list(className = 'dt-center', targets = 0:6))),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(core_Filter_Two_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      })
      
      output$core_DTout_Two_Two <- renderDT({
        datatable(core_Filter_Two_Two(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "500px",
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = c(list(list(visible = FALSE, targets = c(1, 3, 4, 7, 8, 9, 10, 11, 12, 13, 14, 15))), 
                                   list(list(className = 'dt-center', targets = 0:6))),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(core_Filter_Two_Two()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      })
      
    }
    
    { # core_Server_by_Island   ----
      
      core_Filter_Isl_One <- reactive({
        core_DF <- core_DF %>%
          dplyr::filter(CommonName == input$core_SpeciesName_Isl_One,
                        IslandName == input$core_IslandName_Isl) %>%
          dplyr::group_by(SurveyYear) %>%
          dplyr::mutate(Date = mean(Date))
      })
      
      core_Filter_Isl_Two <- reactive({
        core_DF <- core_DF %>%
          dplyr::filter(CommonName == input$core_SpeciesName_Isl_Two,
                        IslandName == input$core_IslandName_Isl) %>%
          dplyr::group_by(SurveyYear) %>%
          dplyr::mutate(Date = mean(Date)) 
      })
      
      core_alphaONI_Isl <- reactive({
        if(input$core_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        else if(input$core_GraphOptions_Isl == "With ONI"){
          return(1)
        }
        else if(input$core_GraphOptions_Isl == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$core_GraphOptions_Isl == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      core_alphaPDO_NOAA_Isl <- reactive({
        if(input$core_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        if(input$core_GraphOptions_Isl == "With ONI"){
          return(0)
          
        }
        if(input$core_GraphOptions_Isl == "With PDO (NOAA)"){
          return(1)
        }
        if(input$core_GraphOptions_Isl == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      core_alphaPDO_UW_Isl <- reactive({
        if(input$core_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        if(input$core_GraphOptions_Isl == "With ONI"){
          return(0)
          
        }
        if(input$core_GraphOptions_Isl == "With PDO (NOAA)"){
          return(0)
        }
        if(input$core_GraphOptions_Isl == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$core_ONIpdoPIC_Isl <- renderImage({
        if(input$core_GraphOptions_Isl == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$core_GraphOptions_Isl == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$core_GraphOptions_Isl == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      core_AxisScale_Isl <- reactive({
        if(input$core_FreeOrLock_Isl == "Locked Scales"){
          return("fixed")
        }
        if(input$core_FreeOrLock_Isl == "Free Scales"){
          return("free")
        }
      }) # Facet Plot Axis Scale free or fixed 
      
      output$core_Plot_Isl <- renderPlot({  # Single plot    ----
        
        if (is.null(input$core_Graph_Isl))
          return(NULL) 
        
        else if(input$core_Graph_Isl == "Line") { # Line   ----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(core_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(core_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(core_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = core_Filter_Isl_One(), 
                        aes(x = IslandDate, y = Island_Mean_Density, group = IslandName, color = CommonName),
                        size = 1) +
              geom_line(data = core_Filter_Isl_Two(), 
                        aes(x = IslandDate, y = Island_Mean_Density * input$core_Y_Slide_Isl, group = IslandName, color = CommonName),
                        size = 1) +
              geom_errorbar(data = core_Filter_Isl_One(), 
                            aes(x = IslandDate, ymin = Island_Mean_Density - IslandSE, ymax = Island_Mean_Density + IslandSE),
                            width = 0, color = "black", alpha = as.numeric(input$core_EB_Isl)) +
              geom_errorbar(data = core_Filter_Isl_Two(), 
                            aes(x = IslandDate, ymin = Island_Mean_Density * input$core_Y_Slide_Isl - IslandSE * input$core_Y_Slide_Isl,
                                ymax = Island_Mean_Density * input$core_Y_Slide_Isl + IslandSE * input$core_Y_Slide_Isl),
                            width = 0, color = "black", alpha = as.numeric(input$core_EB_Isl)) +
              scale_y_continuous(sec.axis = sec_axis(~./input$core_Y_Slide_Isl, 
                                                     name = glue("{unique(core_Filter_Isl_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%Y", breaks = core_Filter_Isl_One()$IslandDate, 
                           limits = c(min(as.Date(core_Filter_Isl_One()$IslandDate))-365,
                                      max(as.Date(core_Filter_Isl_One()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(core_Filter_Isl_One()$ScientificName)} and {unique(core_Filter_Isl_Two()$ScientificName)}"),
                   subtitle = glue("{unique(core_Filter_Isl_One()$IslandName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Density") +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        } 
        else if(input$core_Graph_Isl == "Bar") { # Bar -----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(core_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(core_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(core_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = core_Filter_Isl_One(), 
                       aes(x = IslandDate - 50, y = Island_Mean_Density, fill = CommonName),
                       position = "dodge", width = 100) +
              geom_col(data = core_Filter_Isl_Two(), 
                       aes(x = IslandDate + 50, y = Island_Mean_Density * input$core_Y_Slide_Isl, fill = CommonName),
                       position = "dodge", width = 100) +
              geom_errorbar(data = core_Filter_Isl_One(), 
                            aes(x = IslandDate - 50, ymin = Island_Mean_Density - IslandSE, ymax = Island_Mean_Density + IslandSE),
                            width = 0, color = "black", alpha = as.numeric(input$core_EB_Isl)) +
              geom_errorbar(data = core_Filter_Isl_Two(), 
                            aes(x = IslandDate + 50, ymin = Island_Mean_Density * input$core_Y_Slide_Isl - IslandSE * input$core_Y_Slide_Isl,
                                ymax = Island_Mean_Density * input$core_Y_Slide_Isl + IslandSE * input$core_Y_Slide_Isl),
                            width = 0, color = "black", alpha = as.numeric(input$core_EB_Isl)) +
              scale_y_continuous(sec.axis = sec_axis(~./input$core_Y_Slide_Isl, 
                                                     name = glue("{unique(core_Filter_Isl_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%Y", breaks = core_Filter_Isl_One()$IslandDate, 
                           limits = c(min(as.Date(core_Filter_Isl_One()$IslandDate))-365, 
                                      max(as.Date(core_Filter_Isl_One()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(core_Filter_Isl_One()$ScientificName)} and {unique(core_Filter_Isl_Two()$ScientificName)}"),
                   subtitle = glue("{unique(core_Filter_Isl_One()$IslandName)}"),
                   color = "Common Name",
                   fill = "Common Name",
                   x = "Year",
                   y = "Mean Density") +
              scale_fill_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$core_Graph_Isl == "Smooth Line") { # Smooth   ----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(core_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(core_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(core_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_smooth(data = core_Filter_Isl_One(), aes(x= IslandDate, y = Island_Mean_Density, color = CommonName),
                          se = as.logical(input$core_SmoothSE_Isl), span = input$core_SmoothSlide_Isl) +
              geom_smooth(data = core_Filter_Isl_Two(), 
                          aes(x= IslandDate, y = Island_Mean_Density * input$core_Y_Slide_Isl, color = CommonName),
                          se = as.logical(input$core_SmoothSE_Isl), span = input$core_SmoothSlide_Isl) +
              geom_point(data = core_Filter_Isl_One(), aes(x = IslandDate, y = Island_Mean_Density, color = CommonName), 
                         size = 2, alpha = as.numeric(input$core_SmoothPoint_Isl)) +
              geom_point(data = core_Filter_Isl_Two(), 
                         aes(x = IslandDate, y = Island_Mean_Density* input$core_Y_Slide_Isl, color = CommonName), 
                         size = 2, alpha = as.numeric(input$core_SmoothPoint_Isl)) +
              scale_y_continuous(sec.axis = sec_axis(~./input$core_Y_Slide_Isl, 
                                                     name = glue("{unique(core_Filter_Isl_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(core_Filter_Isl_One()$IslandDate))-365, 
                                      max(as.Date(core_Filter_Isl_One()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(core_Filter_Isl_One()$ScientificName)} and {unique(core_Filter_Isl_Two()$ScientificName)}"),
                   subtitle = glue("{unique(core_Filter_Isl_One()$IslandName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Density") +
              scale_color_manual(values = SpeciesColor, guide = guide_legend(nrow = 5)) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
      })
      
    } 
    
    { # core_Server_by_MPA   ----
      
      core_Filter_MPA_One <- reactive({
        core_DFMPA <- core_DFMPA %>%
          dplyr::filter(CommonName == input$core_SpeciesName_MPA_One,
                        IslandName == input$core_IslandName_MPA) %>%
          dplyr::group_by(SurveyYear) %>%
          dplyr::mutate(Date = mean(Date))
      })
      
      core_Filter_MPA_Two <- reactive({
        core_DFMPA <- core_DFMPA %>%
          dplyr::filter(CommonName == input$core_SpeciesName_MPA_Two,
                        IslandName == input$core_IslandName_MPA) %>%
          dplyr::group_by(SurveyYear) %>%
          dplyr::mutate(Date = mean(Date)) 
      })
      
      core_alphaONI_MPA <- reactive({
        if(input$core_GraphOptions_MPA == "With No Index"){
          return(0)
        }
        else if(input$core_GraphOptions_MPA == "With ONI"){
          return(1)
        }
        else if(input$core_GraphOptions_MPA == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$core_GraphOptions_MPA == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      core_alphaPDO_NOAA_MPA <- reactive({
        if(input$core_GraphOptions_MPA == "With No Index"){
          return(0)
        }
        if(input$core_GraphOptions_MPA == "With ONI"){
          return(0)
          
        }
        if(input$core_GraphOptions_MPA == "With PDO (NOAA)"){
          return(1)
        }
        if(input$core_GraphOptions_MPA == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      core_alphaPDO_UW_MPA <- reactive({
        if(input$core_GraphOptions_MPA == "With No Index"){
          return(0)
        }
        if(input$core_GraphOptions_MPA == "With ONI"){
          return(0)
          
        }
        if(input$core_GraphOptions_MPA == "With PDO (NOAA)"){
          return(0)
        }
        if(input$core_GraphOptions_MPA == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$core_ONIpdoPIC_MPA <- renderImage({
        if(input$core_GraphOptions_MPA == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$core_GraphOptions_MPA == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$core_GraphOptions_MPA == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      output$core_Plot_MPA <- renderPlot({  # Single plot    ----
        
        if (is.null(input$core_Graph_MPA))
          return(NULL) 
        
        else if(input$core_Graph_MPA == "Line") { # Line   ----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(core_alphaONI_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(core_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(core_alphaPDO_UW_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = core_Filter_MPA_One(), 
                        aes(x = MPA_Date, y = MPA_Mean, group = ReserveStatus, color = CommonName, linetype = ReserveStatus),
                        size = 1) +
              geom_line(data = core_Filter_MPA_Two(), 
                        aes(x = MPA_Date, y = MPA_Mean * input$core_Y_Slide_MPA, 
                            group = ReserveStatus, color = CommonName, linetype = ReserveStatus),
                        size = 1) +
              geom_errorbar(data = core_Filter_MPA_One(), 
                            aes(x = MPA_Date, ymin = MPA_Mean - MPA_SE, ymax = MPA_Mean + MPA_SE),
                            width = 0, color = "black", alpha = as.numeric(input$core_EB_MPA)) +
              geom_errorbar(data = core_Filter_MPA_Two(), 
                            aes(x = MPA_Date, ymin = MPA_Mean * input$core_Y_Slide_MPA - MPA_SE * input$core_Y_Slide_MPA,
                                ymax = MPA_Mean * input$core_Y_Slide_MPA + MPA_SE * input$core_Y_Slide_MPA),
                            width = 0, color = "black", alpha = as.numeric(input$core_EB_MPA)) +
              scale_y_continuous(sec.axis = sec_axis(~./input$core_Y_Slide_MPA, 
                                                     name = glue("{unique(core_Filter_MPA_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%Y", breaks = core_Filter_MPA_One()$MPA_Date, 
                           limits = c(min(as.Date(core_Filter_MPA_One()$MPA_Date))-365,
                                      max(as.Date(core_Filter_MPA_One()$MPA_Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(core_Filter_MPA_One()$ScientificName)} and {unique(core_Filter_MPA_Two()$ScientificName)}"),
                   subtitle = glue("{unique(core_Filter_MPA_One()$MPA_Name)}"), 
                   color = "Common Name",
                   linetype = "Reserve Status",
                   x = "Year",
                   y = "Mean Density") +
              scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 1)) +
              scale_linetype_manual(values = c("Inside" = "dashed", "Outside" = "solid"), 
                                    guide = guide_legend(order = 2)) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    legend.key.width = unit(2, "cm"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        } 
        else if(input$core_Graph_MPA == "Bar") { # Bar -----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(core_alphaONI_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(core_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(core_alphaPDO_UW_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = core_Filter_MPA_One(), 
                       aes(x = MPA_Date - 50, y = MPA_Mean, fill = CommonName),
                       position = "dodge", width = 100) +
              geom_col(data = core_Filter_MPA_Two(), 
                       aes(x = MPA_Date + 50, y = MPA_Mean * input$core_Y_Slide_MPA, fill = CommonName),
                       position = "dodge", width = 100) +
              geom_errorbar(data = core_Filter_MPA_One(), 
                            aes(x = MPA_Date - 50, ymin = MPA_Mean - MPA_SE, ymax = MPA_Mean + MPA_SE),
                            width = 0, color = "black", alpha = as.numeric(input$core_EB_MPA)) +
              geom_errorbar(data = core_Filter_MPA_Two(), 
                            aes(x = MPA_Date + 50, ymin = MPA_Mean * input$core_Y_Slide_MPA - MPA_SE * input$core_Y_Slide_MPA,
                                ymax = MPA_Mean * input$core_Y_Slide_MPA + MPA_SE * input$core_Y_Slide_MPA),
                            width = 0, color = "black", alpha = as.numeric(input$core_EB_MPA)) +
              scale_y_continuous(sec.axis = sec_axis(~./input$core_Y_Slide_MPA, 
                                                     name = glue("{unique(core_Filter_MPA_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%Y", breaks = core_Filter_MPA_One()$MPA_Date, 
                           limits = c(min(as.Date(core_Filter_MPA_One()$MPA_Date))-365, 
                                      max(as.Date(core_Filter_MPA_One()$MPA_Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              facet_grid(rows = vars(ReserveStatus), scales = "fixed") +
              labs(title = glue("{unique(core_Filter_MPA_One()$ScientificName)} and {unique(core_Filter_MPA_Two()$ScientificName)}"),
                   subtitle = glue("{unique(core_Filter_MPA_One()$MPA_Name)}"),
                   color = "Common Name",
                   fill = "Common Name",
                   x = "Year",
                   y = "Mean Density") +
              scale_fill_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$core_Graph_MPA == "Smooth Line") { # Smooth   ----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(core_alphaONI_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(core_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(core_alphaPDO_UW_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_smooth(data = core_Filter_MPA_One(), 
                          aes(x= MPA_Date, y = MPA_Mean, group = ReserveStatus, 
                              color = CommonName, linetype = ReserveStatus),
                          se = as.logical(input$core_SmoothSE_MPA), span = input$core_SmoothSlide_MPA) +
              geom_smooth(data = core_Filter_MPA_Two(), 
                          aes(x= MPA_Date, y = MPA_Mean * input$core_Y_Slide_MPA, group = ReserveStatus, 
                              color = CommonName, linetype = ReserveStatus),
                          se = as.logical(input$core_SmoothSE_MPA), span = input$core_SmoothSlide_MPA) +
              geom_point(data = core_Filter_MPA_One(), aes(x = MPA_Date, y = MPA_Mean, color = CommonName), 
                         size = 2, alpha = as.numeric(input$core_SmoothPoint_MPA)) +
              geom_point(data = core_Filter_MPA_Two(), 
                         aes(x = MPA_Date, y = MPA_Mean* input$core_Y_Slide_MPA, color = CommonName), 
                         size = 2, alpha = as.numeric(input$core_SmoothPoint_MPA)) +
              scale_y_continuous(sec.axis = sec_axis(~./input$core_Y_Slide_MPA, 
                                                     name = glue("{unique(core_Filter_MPA_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(core_Filter_MPA_One()$MPA_Date))-365, 
                                      max(as.Date(core_Filter_MPA_One()$MPA_Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(core_Filter_MPA_One()$ScientificName)} and {unique(core_Filter_MPA_Two()$ScientificName)}"),
                   subtitle = glue("{unique(core_Filter_MPA_One()$IslandName)}"), 
                   color = "Common Name",
                   linetype = "Reserve Status",
                   x = "Year",
                   y = "Mean Density") +
              scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 1)) +
              scale_linetype_manual(values = c("Inside" = "dashed", "Outside" = "solid"), 
                                    guide = guide_legend(order = 2)) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    legend.key.width = unit(2, "cm"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
      })
      
    }
    
  }
  
  output$Biodiversity_Benthic <- renderPlot({
    p1 <- ggplot2::ggplot(Benthic_Diversity, aes(x = SurveyYear, y = ShannonIndex, color = ReserveStatus)) +
      ggplot2::geom_smooth(method = 'loess', formula='y~x') +
      ggplot2::labs(title = "Shannon Index Time Series",
                    subtitle = "A Measure of Benthic Diversity in Select MPA Reference Sites",
                    x = NULL,
                    y = "Shannon Index (Diversity)",
                    color = "Reserve Status",
                    caption = "Fig 1. Diversity by reserve status across all reference sites") +
      ggplot2::theme_classic() +
      ggplot2::theme(plot.title = element_text(hjust = .5),
                     plot.subtitle = element_text(hjust = .5),
                     plot.caption = element_text(hjust = 0),
                     legend.justification = c(0, 0.5))
    
    p2 <- ggplot2::ggplot(Benthic_Diversity, aes(x = SurveyYear, y = ShannonIndex, color = IslandCode)) +
      ggplot2::geom_smooth(method = 'loess', formula='y~x') +
      ggplot2::labs(x = NULL,
                    y = "Shannon Index (Diversity)",
                    color = "Island Code",
                    caption = "Fig 2. Diversity by island across all reference sites") +
      ggplot2::theme_classic() +
      ggplot2::theme(plot.caption = element_text(hjust = 0),
                     legend.justification = c(0, 0.5))
    
    p3 <- ggplot2::ggplot(Benthic_Diversity, aes(x = SurveyYear, y = ShannonIndex, color = IslandCode, linetype = ReserveStatus)) +
      ggplot2::geom_smooth(method = 'loess', formula = 'y~x', se = F) +
      ggplot2::labs(x = "Survey Year",
                    y = "Shannon Index (Diversity)",
                    color = "Island Code", 
                    linetype = "Reserve Status",
                    caption = "Fig 3. Diversity by island and reserve status") +
      ggplot2::theme_classic() +
      ggplot2::theme(plot.caption = element_text(hjust = 0),
                     legend.justification = c(0, 0.5))
    ggarrange(p1, p2, p3, ncol = 1, align = "v")
  })
  
  output$rpcs_UIout <- renderUI({ # rpcs_UI   ----
    if (is.null(input$rpcs_allORone))
      return(NULL)
    
    else if(input$rpcs_allORone == "One Species by Site") { #  rpcs_TP_One     ----
      dyn_ui <- tabPanel("RPCs", value = 'rpcs_TP',  
                         tags$hr(),
                         plotOutput(outputId = "rpcs_Plot_One",
                                    height = 500),
                         tags$hr(),
                         fluidRow(
                           column(3, conditionalPanel("input.rpcs_Graph_One == 'Line' || input.rpcs_Graph_One == 'Bar'",
                                                      radioButtons(inputId = "rpcs_EB_one",
                                                                   label = "Show error bars?",
                                                                   choices = c("Yes" = 1, "No" = 0),
                                                                   inline = TRUE))),
                           column(3, conditionalPanel("input.rpcs_Graph_One == 'Bar'",
                                                      radioButtons(inputId = "rpcs_Bar_Text_One",
                                                                   label = "Show density value?",
                                                                   choices = c("Yes" = 1, "No" = 0), selected = 0,
                                                                   inline = TRUE))),
                           column(6, conditionalPanel("input.rpcs_GraphOptions_One == 'With ONI' ||
                                                      input.rpcs_GraphOptions_One == 'With PDO (NOAA)' ||
                                                      input.rpcs_GraphOptions_One == 'With PDO (UW)'",
                                                      imageOutput(outputId = "rpcs_ONIpdoPIC_One",
                                                                  height = 75)))),
                         conditionalPanel("input.rpcs_Graph_One == 'Smooth Line'",
                                          sliderInput(inputId = "rpcs_SmoothSlide_One",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "rpcs_SmoothSE_One",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "rpcs_SmoothPoint_One",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE)))),
                         conditionalPanel("input.rpcs_GraphOptions_One == 'With ONI'",
                                          tags$hr(),
                                          ONI_tagList),
                         conditionalPanel("input.rpcs_GraphOptions_One == 'With PDO (NOAA)'",
                                          tags$hr(),
                                          PDO_NOAA_tagList),
                         conditionalPanel("input.rpcs_GraphOptions_One == 'With PDO (UW)'",
                                          tags$hr(),
                                          PDO_UW_tagList),
                         conditionalPanel("input.rpcs_Graph_One == 'Boxplot'",
                                          tags$hr(),
                                          imageOutput(outputId = "rpcs_BoxplotDescription_One")),
                         tags$hr(),
                         fluidRow(column(4, tags$h2(tags$strong(input$rpcs_SpeciesName_One)),
                                         imageOutput(outputId = "rpcs_LargeSpPhoto_One",
                                                     height = 500)),
                                  column(3, tags$h2(tags$strong("Species Classification")),
                                         DTOutput(outputId = "rpcs_DToutClass_One",
                                                  height = 500)),
                                  column(5, tags$h2(tags$strong("Species Description")),
                                         DTOutput(outputId = "rpcs_DToutDesc_One",
                                                  height = 500))),
                         
                         tags$hr(),
                         DTOutput(outputId = "rpcs_DToutData_One",
                                  height = 550),
                         tags$hr(), tags$hr(),
                         imageOutput(outputId = "rpcs_LargeSitePhoto_One",
                                     height = 625),
                         tags$hr()
      )
    } 
    else if(input$rpcs_allORone == "One Species by Island") { #  rpcs_TP_by_Isl      ---- 
      dyn_ui <- tabPanel("RPCs", value = 'rpcs_TP',
                         tags$hr(),
                         conditionalPanel("input.rpcs_FreeOrLock_Isl == 'Locked Scales' ||
                                          input.rpcs_FreeOrLock_Isl == 'Free Scales'",
                                          plotOutput(outputId = "rpcs_Plot_Isl1",
                                                     height = 1000)),
                         conditionalPanel("input.rpcs_FreeOrLock_Isl == 'Single Plot'", 
                                          plotOutput(outputId = "rpcs_Plot_Isl2",
                                                     height = 500)),
                         tags$hr(),
                         fluidRow(conditionalPanel("input.rpcs_Graph_Isl == 'Line' || (input.rpcs_Graph_Isl == 'Bar' && 
                                                   input.rpcs_DataSummary_Isl == 'Island Mean' && 
                                                   input.rpcs_FreeOrLock_Isl != 'Single Plot')",
                                                   column(3, radioButtons(inputId = "rpcs_EB_Isl",
                                                                          label = "Show error bars?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                  conditionalPanel("input.rpcs_Graph_Isl == 'Bar' && 
                                                   input.rpcs_DataSummary_Isl == 'Island Mean' && 
                                                   input.rpcs_FreeOrLock_Isl != 'Single Plot'",
                                                   column(3, radioButtons(inputId = "rpcs_Bar_Text_Isl",
                                                                          label = "Show density value?",
                                                                          choices = c("Yes" = 1, "No" = 0), selected = 0,
                                                                          inline = TRUE))),
                                  conditionalPanel("(input.rpcs_Graph_Isl == 'Bar' && 
                                                   input.rpcs_DataSummary_Isl == 'Island Mean' && 
                                                   input.rpcs_FreeOrLock_Isl != 'Locked Scales' && 
                                                   input.rpcs_FreeOrLock_Isl != 'Free Scales') ||
                                                   (input.rpcs_Graph_Isl == 'Bar' && 
                                                   input.rpcs_DataSummary_Isl == 'Site Means (by Island)')",
                                                   column(3, radioButtons(inputId = "rpcs_BarOptions_Isl",
                                                                          label =  "Bar Graph Options:",
                                                                          choices = c("Stack" = "stack", "Fill" = "fill", "Dodge" = "dodge"),
                                                                          inline = TRUE))),
                                  conditionalPanel("input.rpcs_GraphOptions_Isl == 'With ONI' ||
                                                      input.rpcs_GraphOptions_Isl == 'With PDO (NOAA)' ||
                                                      input.rpcs_GraphOptions_Isl == 'With PDO (UW)'",
                                                   column(6, imageOutput(outputId = "rpcs_ONIpdoPIC_Isl",
                                                                         height = 75)))),
                         fluidRow(conditionalPanel("input.rpcs_Graph_Isl == 'Line' || input.rpcs_Graph_Isl == 'Bar'",
                                                   tags$hr())),
                         conditionalPanel("input.rpcs_Graph_Isl == 'Smooth Line'",
                                          sliderInput(inputId = "rpcs_SmoothSlide_Isl",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "rpcs_SmoothSE_Isl",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "rpcs_SmoothPoint_Isl",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                          tags$hr()),
                         conditionalPanel("input.rpcs_GraphOptions_Isl == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.rpcs_GraphOptions_Isl == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr())
      )
    } 
    else if(input$rpcs_allORone == "One Species by MPA") { #  rpcs_TP_byMPA     ---- 
      dyn_ui <- tabPanel("RPCs", value = 'rpcs_TP',  
                         tags$hr(),
                         plotOutput(outputId = "rpcs_Plot_MPA",
                                    height = 850),
                         tags$hr(),
                         fluidRow(conditionalPanel("input.rpcs_Graph_MPA == 'Line' || (input.rpcs_Graph_MPA == 'Bar' && 
                                                   input.rpcs_DataSummary_MPA == 'MPA Mean')",
                                                   column(3, radioButtons(inputId = "rpcs_EB_MPA",
                                                                          label = "Show error bars?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                  conditionalPanel("input.rpcs_Graph_MPA == 'Bar' && input.rpcs_DataSummary_MPA == 'MPA Mean'",
                                                   column(3, radioButtons(inputId = "rpcs_Bar_Text_MPA",
                                                                          label = "Show density value?",
                                                                          choices = c("Yes" = 1, "No" = 0), selected = 0,
                                                                          inline = TRUE))),
                                  conditionalPanel("input.rpcs_GraphOptions_MPA == 'With ONI' ||
                                                      input.rpcs_GraphOptions_MPA == 'With PDO (NOAA)' ||
                                                      input.rpcs_GraphOptions_MPA == 'With PDO (UW)'",
                                                   column(6, imageOutput(outputId = "rpcs_ONIpdoPIC_MPA",
                                                                         height = 75)))),
                         fluidRow(conditionalPanel("input.rpcs_Graph_MPA == 'Line' || input.rpcs_Graph_MPA == 'Bar'",
                                                   tags$hr())),
                         conditionalPanel("input.rpcs_Graph_MPA == 'Smooth Line'",
                                          sliderInput(inputId = "rpcs_SmoothSlide_MPA",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "rpcs_SmoothSE_MPA",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "rpcs_SmoothPoint_MPA",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                          tags$hr()),
                         conditionalPanel("input.rpcs_GraphOptions_MPA == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.rpcs_GraphOptions_MPA == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr()),
                         MPA_tagList,
                         tags$hr())
    }
    else if(input$rpcs_allORone == "Two Species by Site") { #  rpcs_TP_Two     ----
      dyn_ui <- tabPanel("RPCs", value = 'rpcs_TP',  
                         tags$hr(),
                         plotOutput(outputId = "rpcs_Plot_Two",
                                    height = 500),
                         tags$hr(),
                         sliderInput(inputId = "rpcs_Y_Slide_Two",
                                     label = "Adjust the second y-axis by a multiple of:",
                                     min = 1, max = 50, step = 1, value = 1, width = "100%", ticks = T),
                         conditionalPanel("input.rpcs_Graph_Two == 'Smooth Line'",
                                          sliderInput(inputId = "rpcs_SmoothSlide_Two",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "rpcs_SmoothSE_Two",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "rpcs_SmoothPoint_Two",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE)))),
                         fluidRow(
                           conditionalPanel("input.rpcs_Graph_Two == 'Line' || input.rpcs_Graph_Two == 'Bar'",
                                            column(3, radioButtons(inputId = "rpcs_EB_Two",
                                                                   label = "Show error bars?",
                                                                   choices = c("Yes" = 1, "No" = 0),
                                                                   inline = TRUE))),
                           conditionalPanel("input.rpcs_GraphOptions_Two == 'With ONI' ||
                                                      input.rpcs_GraphOptions_Two == 'With PDO (NOAA)' ||
                                                      input.rpcs_GraphOptions_Two == 'With PDO (UW)'",
                                            column(6, imageOutput(outputId = "rpcs_ONIpdoPIC_Two",
                                                                  height = 75)))),
                         tags$hr(),
                         conditionalPanel("input.rpcs_GraphOptions_Two == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.rpcs_GraphOptions_Two == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr()),
                         conditionalPanel("input.rpcs_GraphOptions_Two == 'With PDO (UW)'",
                                          PDO_UW_tagList,
                                          tags$hr()),
                         fluidRow(column(6, tags$h1(tags$strong(input$rpcs_SpeciesName_Two_One)),
                                         imageOutput(outputId = "rpcs_LargeSpPhoto_Two_1",
                                                     height = 450)),
                                  column(6, tags$h1(tags$strong(input$rpcs_SpeciesName_Two_Two)),
                                         imageOutput(outputId = "rpcs_LargeSpPhoto_Two_2",
                                                     height = 450))),
                         tags$hr(),
                         fluidRow(column(6, tags$h1(tags$strong(input$rpcs_SpeciesName_Two_One)),
                                         DTOutput(outputId = "rpcs_DToutData_Two_1")),
                                  column(6, tags$h1(tags$strong(input$rpcs_SpeciesName_Two_Two)),
                                         DTOutput(outputId = "rpcs_DToutData_Two_2"))),
                         tags$hr(),
                         imageOutput(outputId = "rpcs_LargeSitePhoto_Two",
                                     height = 625),
                         tags$hr()
      )
    }
    else if(input$rpcs_allORone == "All Species") { # rpcs_TP_all   ----
      dyn_ui <- tabPanel("RPCs", value = 'rpcs_TP',  
                         fluidRow(column(12, tags$h1(tags$strong(
                           "This section has the species in the order they appear on the datasheet")))),
                         plotOutput(outputId = "rpcs_Plot_All",
                                    height = 7000))
    }
    return(dyn_ui)
  })
  
  { # ........ rpcs_SERVERS ........     ----
    
    { # rpcs_Server_One_Species   ----
      
      rpcs_Filter_One <- reactive({ 
        rpcs_DF %>%
          dplyr::filter(SiteName == input$rpcs_SiteName_One,
                        CommonName == input$rpcs_SpeciesName_One) %>%
          dplyr::select(SurveyYear, Date, SiteName, IslandName, ScientificName, CommonName, MeanDensity_sqm, 
                        StandardError, StandardError, TotalCount, AreaSurveyed_sqm, MeanDepth, Island_Mean_Density,
                        Species, SiteNumber, IslandCode, SiteCode, IslandSE) 
      }) # filtered one meter summary table
      
      rpcs_RawFilter_One <- reactive({ 
        rpcs_DFRaw %>%
          dplyr::filter(SiteName == input$rpcs_SiteName_One,
                        CommonName == input$rpcs_SpeciesName_One) %>% 
          dplyr::group_by(SurveyYear) %>% 
          dplyr::mutate(Mean = mean(Count))
      }) # filtered  one Meter raw table
      
      rpcs_SpeciesClass_One <- reactive({ 
        SpeciesName %>%
          dplyr::filter(CommonName == input$rpcs_SpeciesName_One) %>%
          dplyr::select(ScientificName, Kingdom, Phylum, Class, Order, Family, Genus, "Species (Used by KFM)",
                        Status, "Currently Accepted Name", "Authority (Accepted)", CommonName) %>%
          tidyr::pivot_longer(-ScientificName, names_to = "Rank", values_to = "Name") %>%
          dplyr::select(Rank, Name)
      }) # filtered Species classification table
      
      rpcs_SpeciesDescription_One <- reactive({
        SpeciesName %>%
          dplyr::filter(CommonName == input$rpcs_SpeciesName_One) %>%
          dplyr::select(ScientificName, "Geographic Range", Identification, Habitat, "Size Range", "Trophic Level", Abundance) %>%
          tidyr::pivot_longer(-ScientificName, names_to = "Category", values_to = "Information") %>%
          dplyr::select(Category, Information)
      }) # filtered Species Description table  
      
      output$rpcs_TopPhoto_One <- renderImage({
        
        if (input$rpcs_allORone ==  'One Species by Site' && input$rpcs_SpeciesName_One == unique(rpcs_Filter_One()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(rpcs_Filter_One()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(rpcs_Filter_One()$CommonName)}"),
            width = 200,
            height = 200
          ))
        }
        else if (input$rpcs_allORone ==  'One Species by Island' && input$rpcs_SpeciesName_Isl == unique(rpcs_FilterByIsl_Isl()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(rpcs_FilterByIsl_Isl()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(rpcs_FilterByIsl_Isl()$CommonName)}"),
            width = 200,
            height = 200
          ))
        }
        else if (input$rpcs_allORone ==  'One Species by MPA' && input$rpcs_SpeciesName_MPA == unique(rpcs_Filter_MPA()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(rpcs_Filter_MPA()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(rpcs_Filter_MPA()$CommonName)}"),
            width = 200,
            height = 200
          ))
        }
        else if (input$rpcs_allORone ==  'Two Species by Site' && input$rpcs_SpeciesName_Two_One == unique(rpcs_Filter_Two_One()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(rpcs_Filter_Two_One()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(rpcs_Filter_Two_One()$CommonName)}"),
            width = 200,
            height = 200
          ))
        }
      }, deleteFile = FALSE) # Small species photo above plot
      
      output$rpcs_TopPhoto_Two <- renderImage({
        
        if (input$rpcs_allORone ==  'Two Species by Site' && input$rpcs_SpeciesName_Two_Two == unique(rpcs_Filter_Two_Two()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(rpcs_Filter_Two_Two()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(rpcs_Filter_Two_Two()$CommonName)}"),
            width = 200,
            height = 200
          ))
        }
      }, deleteFile = FALSE) # 2nd Small species photo above plot
      
      output$rpcs_LargeSpPhoto_One <- renderImage({
        list(src = glue("www/Indicator_Species/{unique(rpcs_Filter_One()$Species)}.jpg"),
             contentType = "image/jpg", width = 400, height = 400)
      }, deleteFile = FALSE) # Large species photo below plot
      
      output$rpcs_TopSitePhoto_One <- renderImage({
        list(src = glue("www/Sat_Imagery/{unique(rpcs_Filter_One()$SiteCode)}.png"),
             contentType = "image/png", width = 430, height = 210)
      }, deleteFile = FALSE) # Small Site photo above plot
      
      output$rpcs_LargeSitePhoto_One <- renderImage({
        list(src = glue("www/Sat_Imagery/{unique(rpcs_Filter_One()$SiteCode)}.png"),
             contentType = "image/png", width = 1250, height = 625)
      }, deleteFile = FALSE) # Large Site photo below plot
      
      output$rpcs_DToutClass_One <- renderDT({
        datatable(rpcs_SpeciesClass_One(), 
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    searching = FALSE,
                    lengthChange = FALSE,
                    paging = FALSE,
                    ordering = FALSE,
                    info = FALSE),
                  rownames = FALSE) %>% 
          formatStyle(names(rpcs_SpeciesClass_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      }) # Species Classification data table
      
      output$rpcs_DToutDesc_One <- renderDT({
        datatable(rpcs_SpeciesDescription_One(), 
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    searching = FALSE,
                    lengthChange = FALSE,
                    paging = FALSE,
                    ordering = FALSE,
                    info = FALSE),
                  rownames = FALSE) %>% 
          formatStyle(names(rpcs_SpeciesDescription_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      }) # Species Description data table
      
      rpcs_alphaONI_one <- reactive({
        if(input$rpcs_GraphOptions_One == "With No Index"){
          return(0)
        }
        else if(input$rpcs_GraphOptions_One == "With ONI"){
          return(1)
        }
        else if(input$rpcs_GraphOptions_One == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$rpcs_GraphOptions_One == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      rpcs_alphaPDO_NOAA_one <- reactive({
        if(input$rpcs_GraphOptions_One == "With No Index"){
          return(0)
        }
        if(input$rpcs_GraphOptions_One == "With ONI"){
          return(0)
          
        }
        if(input$rpcs_GraphOptions_One == "With PDO (NOAA)"){
          return(1)
        }
        if(input$rpcs_GraphOptions_One == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      rpcs_alphaPDO_UW_one <- reactive({
        if(input$rpcs_GraphOptions_One == "With No Index"){
          return(0)
        }
        if(input$rpcs_GraphOptions_One == "With ONI"){
          return(0)
          
        }
        if(input$rpcs_GraphOptions_One == "With PDO (NOAA)"){
          return(0)
        }
        if(input$rpcs_GraphOptions_One == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$rpcs_ONIpdoPIC_One <- renderImage({
        if(input$rpcs_GraphOptions_One == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$rpcs_GraphOptions_One == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$rpcs_GraphOptions_One == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      rpcs_LinePlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(rpcs_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          geom_line(data = rpcs_Filter_One(),
                    aes(x = Date, y = MeanDensity_sqm, group = ScientificName, color = CommonName), 
                    size = 1) +
          geom_errorbar(data = rpcs_Filter_One(),
                        aes(x = Date, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                        width = 0, color = "black", alpha = as.numeric(input$rpcs_EB_one)) +
          scale_x_date(date_labels = "%b %Y", breaks = unique(rpcs_Filter_One()$Date),
                       limits = c(min(as.Date(rpcs_Filter_One()$Date))-365, max(as.Date(rpcs_Filter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          labs(title = glue("{unique(rpcs_Filter_One()$ScientificName)}"),
               subtitle = glue("{unique(rpcs_Filter_One()$IslandName)} {unique(rpcs_Filter_One()$SiteName)}"),
               color = "Common Name",
               fill = "Oceanic Nino \nIndex Gradient",
               caption = glue("{rpcs_Filter_One()$SiteName} is typically surveyed in {
                       lubridate::month(round(mean(month(rpcs_Filter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                       } and has a mean depth of {round(mean(rpcs_Filter_One()$MeanDepth), 2)} ft"),
               x = "Year",
               y = "Percent Cover") +
          scale_color_manual(values = SpeciesColor) +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
      }) # Main Line Plot
      
      rpcs_BarPlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(rpcs_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          new_scale_fill() +
          geom_col(data = rpcs_Filter_One(), aes(x = Date - ifelse(input$rpcs_DataSummary_One == "One species at one site", 0, 50),
                                                 y = MeanDensity_sqm, fill = CommonName), 
                   position = "dodge", width = ifelse(input$rpcs_DataSummary_One == "One species at one site", 250, 100)) +
          geom_errorbar(data = rpcs_Filter_One(),
                        aes(x = Date - ifelse(input$rpcs_DataSummary_One == "One species at one site", 0, 50), 
                            ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                        width = 0, color = "black", alpha = as.numeric(input$rpcs_EB_one)) +
          geom_text(data = rpcs_Filter_One(),
                    aes(x = Date - ifelse(input$rpcs_DataSummary_One == "One species at one site", 0, 50),
                        y = MeanDensity_sqm, label = round(MeanDensity_sqm, digits = 2)),
                    vjust = -.2, hjust = .5, alpha = as.numeric(input$rpcs_Bar_Text_One)) +
          scale_x_date(date_labels = "%b %Y", breaks = unique(rpcs_Filter_One()$Date),
                       limits = c(min(as.Date(rpcs_Filter_One()$Date))-365,  max(as.Date(rpcs_Filter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          labs(title = glue("{unique(rpcs_Filter_One()$ScientificName)}"),
               subtitle = glue("{unique(rpcs_Filter_One()$IslandName)} {unique(rpcs_Filter_One()$SiteName)}"),
               color = "Common Name",
               fill = "Common Name",
               caption = glue("{rpcs_Filter_One()$SiteName} is typically surveyed in {
                 lubridate::month(round(mean(month(rpcs_Filter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                 } and has a mean depth of {round(mean(rpcs_Filter_One()$MeanDepth), 2)} ft"),
               x = "Year",
               y = "Percent Cover") +
          scale_fill_manual(values = SpeciesColor) +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
      }) # Main Bar Plot
      
      rpcs_SmoothPlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(rpcs_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          stat_smooth(data = rpcs_Filter_One(), 
                      aes(x = Date, y = MeanDensity_sqm, group = ScientificName, color = CommonName), 
                      size = 1, span = input$rpcs_SmoothSlide_One, se = as.logical(input$rpcs_SmoothSE_One)) +
          scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 1)) +
          geom_point(data = rpcs_Filter_One(), aes(x = Date, y = MeanDensity_sqm, color = CommonName), 
                     size = 2, alpha = as.numeric(input$rpcs_SmoothPoint_One)) +
          scale_x_date(date_labels = "%b %Y", breaks = unique(rpcs_Filter_One()$Date), 
                       limits = c(min(as.Date(rpcs_Filter_One()$Date))-365, 
                                  max(as.Date(rpcs_Filter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          labs(title = glue("{unique(rpcs_Filter_One()$ScientificName)}"), 
               subtitle = glue("{unique(rpcs_Filter_One()$IslandName)} {unique(rpcs_Filter_One()$SiteName)}"),
               color = "Common Name",
               caption = glue("{rpcs_Filter_One()$SiteName} is typically surveyed in {
                       lubridate::month(round(mean(month(rpcs_Filter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                       } and has a mean depth of {round(mean(rpcs_Filter_One()$MeanDepth), 2)} ft"),
               x = "Year", y = "Smoothed Conditional Mean Values") +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
      }) # Main Smooth Line Plot
      
      rpcs_BoxPlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(rpcs_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          geom_boxplot(data = rpcs_RawFilter_One(), 
                       aes(x = Date, y = Count, group = SurveyYear, color = CommonName)) +
          scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 1)) +
          geom_point(data = rpcs_RawFilter_One(), aes(x = Date, y = Mean),
                     size = 2, color = "black") +
          scale_x_date(date_labels = "%b %Y", breaks = unique(rpcs_RawFilter_One()$Date), 
                       limits = c(min(as.Date(rpcs_RawFilter_One()$Date))-365, max(as.Date(rpcs_RawFilter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          labs(title = glue("{unique(rpcs_RawFilter_One()$ScientificName)}"), 
               subtitle = glue("{unique(rpcs_RawFilter_One()$IslandName)} {unique(rpcs_RawFilter_One()$SiteName)}"),
               color = "Common Name",
               caption = glue("{rpcs_RawFilter_One()$SiteName} is typically surveyed in {
                       lubridate::month(round(mean(month(rpcs_RawFilter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                       } and has a mean depth of {round(mean(rpcs_RawFilter_One()$MeanDepth), 2)} ft"),
               x = "Year",
               y = "Count per Quadrat") +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
      }) # Main Boxplot Plot
      
      output$rpcs_Plot_One <- renderPlot({
        
        if (is.null(input$rpcs_Graph_One))
          return(NULL) 
        
        else if(input$rpcs_Graph_One == "Line" && input$rpcs_DataSummary_One == "One species at one site")
        {
          p <- rpcs_LinePlot_One()
        } 
        else if(input$rpcs_Graph_One == "Line" && input$rpcs_DataSummary_One == "One species with island average")
        {
          p <- rpcs_LinePlot_One() +
            new_scale_color() +
            geom_line(data = rpcs_Filter_One(),
                      aes(x = Date, y = Island_Mean_Density, group = ScientificName, color = IslandName),
                      size = 1) +
            geom_errorbar(data = rpcs_Filter_One(),
                          aes(x = Date, ymin = Island_Mean_Density - IslandSE,ymax = Island_Mean_Density + IslandSE),
                          width = 0, color = "black", alpha = as.numeric(input$rpcs_EB_one)) +
            labs(color = "Island Average") +
            scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 2))
        }
        else if(input$rpcs_Graph_One == "Bar" && input$rpcs_DataSummary_One == "One species at one site") 
        {
          p <- rpcs_BarPlot_One()
        }
        else if(input$rpcs_Graph_One == "Bar" && input$rpcs_DataSummary_One == "One species with island average") 
        {
          p <- rpcs_BarPlot_One() +
            new_scale_fill() +
            geom_col(data = rpcs_Filter_One(),
                     aes(x = Date + 50, y = Island_Mean_Density, fill = IslandName),
                     position = "dodge",
                     width = 100) +
            geom_errorbar(data = rpcs_Filter_One(),
                          aes(x = Date + 50, ymin = Island_Mean_Density - IslandSE, ymax = Island_Mean_Density + IslandSE),
                          width = 0, color = "black", alpha = as.numeric(input$rpcs_EB_one)) +
            scale_fill_manual(values = SpeciesColor, guide = guide_legend(order = 2)) +
            labs(fill = "Island Mean")
        } 
        else if(input$rpcs_Graph_One == "Smooth Line" && input$rpcs_DataSummary_One == "One species at one site")
        {
          p <- rpcs_SmoothPlot_One()
        }
        else if(input$rpcs_Graph_One == "Smooth Line" && input$rpcs_DataSummary_One == "One species with island average")
        {
          p <- rpcs_SmoothPlot_One() +
            new_scale_color() +
            stat_smooth(data = rpcs_Filter_One(), 
                        aes(x = Date, y = Island_Mean_Density, group = ScientificName, color = IslandName), 
                        size = 1,
                        span = input$rpcs_SmoothSlide_One,
                        se = as.logical(input$rpcs_SmoothSE_One)) +
            geom_point(data = rpcs_Filter_One(), aes(x = Date, y = Island_Mean_Density, color = IslandName), 
                       size = 2, alpha = as.numeric(input$rpcs_SmoothPoint_One)) +
            labs(color = "Island Average") +
            scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 2)) 
        }
        else if(input$rpcs_Graph_One == "Boxplot" && input$rpcs_DataSummary_One == "One species at one site")
        {
          p <- rpcs_BoxPlot_One()  
        }
        else if(input$rpcs_Graph_One == "Boxplot" && input$rpcs_DataSummary_One == "One species with island average")
        {
          p <- rpcs_BoxPlot_One() +
            new_scale_color() +
            geom_point(data = rpcs_Filter_One(), aes(x = Date, y = Island_Mean_Density, color = IslandName), 
                       size = 2) +
            labs(color = "Island Average") +
            scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 2)) 
        }
        return(p)
      }) # Main Plot for rpcs_Quadrats with one species 
      
      output$rpcs_BoxplotDescription_One <- renderImage({
        list(src = glue("www/Boxplot_Description.jpg"), contentType = "image/jpg", width = 550, height = 400)
      }, deleteFile = FALSE) # Boxplot drawing/explanation
      
      output$rpcs_DToutData_One <- renderDT({
        datatable(rpcs_Filter_One(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "500px",
                    scrollX = TRUE, 
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = c(list(list(visible = FALSE, targets = c(10, 12, 13, 14, 15))), 
                                   list(list(className = 'dt-center', targets = 0:11))),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(rpcs_Filter_One()),
                      color = "black",
                      backgroundColor = 'white'
          )
      }) # Filtered data table output
      
    }
    
    { # rpcs_Server_by_Island   ----
      
      rpcs_Filter_Isl <- reactive({
        rpcs_DF <- rpcs_DF %>%
          dplyr::filter(CommonName == input$rpcs_SpeciesName_Isl) %>%
          dplyr::group_by(SurveyYear, IslandName) %>%
          dplyr::mutate(Date = mean(Date),
                        MaxSumBar = sum(MeanDensity_sqm)) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SiteName, SurveyYear) %>%
          dplyr::mutate(MaxSum = max(sum(MeanDensity_sqm)))
        
      })
      
      rpcs_FilterByIsl_Isl <- reactive({
        rpcs_DF %>%
          dplyr::filter(CommonName == input$rpcs_SpeciesName_Isl) %>%
          dplyr::group_by(IslandDate, IslandCode, IslandName, Species, ScientificName, CommonName, SurveyYear) %>%
          dplyr::distinct(IslandDate, IslandCode, IslandName,Species, ScientificName, CommonName, SurveyYear, 
                          Island_Mean_Density, IslandSD, IslandSE, IslandQuads, IslandAreaSurveyed, IslandTotalCount) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SurveyYear) %>%
          dplyr::mutate(IslandDate = mean(IslandDate))
      })
      
      rpcs_yValue_Isl <- reactive({
        if(input$rpcs_BarOptions_Isl == "stack"){
          return({
            max(rpcs_Filter_Isl()$MaxSumBar)
          }) 
        }
        else if(input$rpcs_BarOptions_Isl == "dodge"){
          return({
            max(rpcs_Filter_Isl()$MeanDensity_sqm)
          })
        }
        else if(input$rpcs_BarOptions_Isl == "fill"){
          return(1)
        }
      })
      
      rpcs_yLabel_Isl <- reactive({
        if(input$rpcs_BarOptions_Isl == "stack"){
          y <- "Combined Densities"
        }
        else if(input$rpcs_BarOptions_Isl == "dodge"){
          y <- "Seperated Densities"
        }
        else if(input$rpcs_BarOptions_Isl == "fill"){
          y <- "Normalized Densities"
        }
        y
      })
      
      rpcs_alphaONI_Isl <- reactive({
        if(input$rpcs_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        else if(input$rpcs_GraphOptions_Isl == "With ONI"){
          return(1)
        }
        else if(input$rpcs_GraphOptions_Isl == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$rpcs_GraphOptions_Isl == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      rpcs_alphaPDO_NOAA_Isl <- reactive({
        if(input$rpcs_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        if(input$rpcs_GraphOptions_Isl == "With ONI"){
          return(0)
          
        }
        if(input$rpcs_GraphOptions_Isl == "With PDO (NOAA)"){
          return(1)
        }
        if(input$rpcs_GraphOptions_Isl == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      rpcs_alphaPDO_UW_Isl <- reactive({
        if(input$rpcs_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        if(input$rpcs_GraphOptions_Isl == "With ONI"){
          return(0)
          
        }
        if(input$rpcs_GraphOptions_Isl == "With PDO (NOAA)"){
          return(0)
        }
        if(input$rpcs_GraphOptions_Isl == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$rpcs_ONIpdoPIC_Isl <- renderImage({
        if(input$rpcs_GraphOptions_Isl == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$rpcs_GraphOptions_Isl == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$rpcs_GraphOptions_Isl == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      rpcs_AxisScale_Isl <- reactive({
        if(input$rpcs_FreeOrLock_Isl == "Locked Scales"){
          return("fixed")
        }
        if(input$rpcs_FreeOrLock_Isl == "Free Scales"){
          return("free")
        }
      }) # Facet Plot Axis Scale free or fixed 
      
      output$rpcs_Plot_Isl1 <- renderPlot({ # Facet plots    ---- 
        
        if (is.null(input$rpcs_Graph_Isl))
          return(NULL) 
        
        else if(input$rpcs_Graph_Isl == "Line" && input$rpcs_DataSummary_Isl == "Island Mean") { # Line   ----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(rpcs_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = rpcs_FilterByIsl_Isl(), 
                        aes(x = IslandDate, y = Island_Mean_Density, group = IslandName, color = IslandName),
                        size = 1) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(rpcs_FilterByIsl_Isl()$IslandDate))-365,
                                      max(as.Date(rpcs_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              geom_errorbar(data = rpcs_FilterByIsl_Isl(), 
                            aes(x = IslandDate, ymin = Island_Mean_Density - IslandSE, ymax = Island_Mean_Density + IslandSE),
                            width = 0, color = "black", alpha = as.numeric(input$rpcs_EB_Isl)) +
              labs(title = glue("{unique(rpcs_FilterByIsl_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Percent Cover") +
              facet_grid(rows = vars(IslandName), scales = rpcs_AxisScale_Isl()) +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        } 
        else if(input$rpcs_Graph_Isl == "Line" && input$rpcs_DataSummary_Isl == "Site Means (by Island)") {
          return({
            out <- by(data = rpcs_Filter_Isl(), INDICES = rpcs_Filter_Isl()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(rpcs_alphaONI_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_Isl()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_line(data = m, 
                          aes(Date, MeanDensity_sqm, group = SiteName, colour = SiteName, linetype = SiteName),
                          size = 1) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date),
                             limits = c(min(as.Date(m$Date))-365, max(as.Date(m$Date))+365),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(limits = c(0, ifelse(input$rpcs_FreeOrLock_Isl == "Locked Scales", 
                                                        max(rpcs_Filter_Isl()$MaxSum), max(m$MeanDensity_sqm))),
                                   expand = expansion(mult = c(0.01, .01))) +
                geom_errorbar(data = m, 
                              aes(x = Date, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                              width = 0, color = "black", alpha = as.numeric(input$rpcs_EB_Isl)) +
                labs(title = m$IslandName,
                     color = "Site Name",
                     linetype ="Site Name",
                     caption = "Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected",
                     x = NULL,
                     y = "Mean Density") +
                scale_color_manual(values = SiteColor, breaks = as.character(m$SiteName)) +
                scale_linetype_manual(values = SiteLine, breaks = as.character(m$SiteName)) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(rpcs_Filter_Isl()$ScientificName)}"),
                                          label_size = 20, label_fontface = "bold.italic"
            ))
          })
        } 
        else if(input$rpcs_Graph_Isl == "Bar" && input$rpcs_DataSummary_Isl == "Island Mean") { # Bar   ----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(rpcs_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = rpcs_FilterByIsl_Isl(), 
                       aes(x = IslandDate, y = Island_Mean_Density, fill = IslandName),
                       position = "dodge",
                       width = 280) +
              facet_grid(rows = vars(IslandName), scales = rpcs_AxisScale_Isl()) +
              geom_text(data = rpcs_FilterByIsl_Isl(),
                        aes(x = IslandDate, y = Island_Mean_Density, label = round(Island_Mean_Density, digits = 2)),
                        position = position_dodge(1), vjust = -.2, hjust = .5, angle = 0, alpha = as.numeric(input$rpcs_Bar_Text_Isl)) +
              geom_errorbar(data = rpcs_FilterByIsl_Isl(), 
                            aes(x = IslandDate, ymin = Island_Mean_Density - IslandSE, ymax = Island_Mean_Density + IslandSE),
                            width = 0, color = "black", alpha = as.numeric(input$rpcs_EB_Isl)) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              scale_x_date(date_labels = "%b %Y", date_breaks = "1 year", 
                           limits = c(min(as.Date(rpcs_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(rpcs_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(rpcs_FilterByIsl_Isl()$ScientificName)}"),
                   subtitle = glue("{unique(rpcs_FilterByIsl_Isl()$CommonName)}"),
                   color = "Common Name",
                   fill = "Common Name",
                   x = "Year",
                   y = "Mean Density") +
              scale_fill_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$rpcs_Graph_Isl == "Bar" && input$rpcs_DataSummary_Isl == "Site Means (by Island)") {
          return({
            out <- by(data = rpcs_Filter_Isl(), INDICES = rpcs_Filter_Isl()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() +
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(rpcs_alphaONI_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_Isl()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                new_scale_fill() +
                geom_col(data = m, aes(x = Date, y = MeanDensity_sqm, fill = SiteName),
                         position = input$rpcs_BarOptions_Isl, width = 280) +
                coord_cartesian(ylim = c(0, ifelse(input$rpcs_FreeOrLock_Isl == "Locked Scales", 
                                                   rpcs_yValue_Isl(), max(m$MaxSumBar)))) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date), expand = expansion(mult = c(0.01, .01)),
                             limits = c(min(as.Date(m$Date))-365, max(as.Date(m$Date))+365)) +
                labs(title = m$IslandName,
                     color = "Site Name",
                     fill = "Site Name",
                     x = "Year",
                     y = rpcs_yLabel_Isl()) +
                scale_fill_manual(values = SiteColor) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(rpcs_Filter_Isl()$ScientificName)}"),
                                          label_size = 20, label_fontface = "bold.italic"
            ))
          })
        } 
        else if(input$rpcs_Graph_Isl == "Smooth Line" && input$rpcs_DataSummary_Isl == "Island Mean") { # Smooth   -----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(rpcs_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_smooth(data = rpcs_FilterByIsl_Isl(), aes(x = IslandDate, y = Island_Mean_Density, color = IslandName),
                          se = as.logical(input$rpcs_SmoothSE_Isl),
                          span = input$rpcs_SmoothSlide_Isl) +
              geom_point(data = rpcs_FilterByIsl_Isl(), aes(x = IslandDate, y = Island_Mean_Density, color = IslandName),
                         size = 1, alpha = as.numeric(input$rpcs_SmoothPoint_Isl),inherit.aes = FALSE) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(rpcs_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(rpcs_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(rpcs_FilterByIsl_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Percent Cover") +
              facet_grid(rows = vars(IslandName), scales = rpcs_AxisScale_Isl()) +
              scale_color_manual(values = SpeciesColor, guide = guide_legend(nrow = 5)) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$rpcs_Graph_Isl == "Smooth Line" && input$rpcs_DataSummary_Isl == "Site Means (by Island)") { 
          return({
            out <- by(data = rpcs_Filter_Isl(), INDICES = rpcs_Filter_Isl()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() +
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(rpcs_alphaONI_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_Isl()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_point(data = m, aes(x = Date, y = MeanDensity_sqm, color = SiteName),
                           size = 1, alpha = as.numeric(input$rpcs_SmoothPoint_Isl), inherit.aes = FALSE) +
                geom_smooth(data = m, aes(x = Date, y = MeanDensity_sqm, color = SiteName),
                            se = as.logical(input$rpcs_SmoothSE_Isl),
                            span = input$rpcs_SmoothSlide_Isl) +
                scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                             limits = c(min(as.Date(rpcs_FilterByIsl_Isl()$IslandDate))-365, 
                                        max(as.Date(rpcs_FilterByIsl_Isl()$IslandDate))+365),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(limits = c(0, ifelse(input$rpcs_FreeOrLock_Isl == "Locked Scales", 
                                                        max(rpcs_Filter_Isl()$MaxSum), max(m$MeanDensity_sqm))),
                                   expand = expansion(mult = c(0.01, .01))) +
                labs(title = glue("{unique(m$IslandName)}"), 
                     color = "Site Name",
                     x = "Year",
                     y = "Percent Cover") +
                scale_color_manual(values = SiteColor) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 13, colour = "black", face = "bold"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(rpcs_Filter_Isl()$ScientificName)}"),
                                          label_size = 20, label_fontface = "bold.italic"
            ))
          })
        }
        
      })
      
      output$rpcs_Plot_Isl2 <- renderPlot({  # Single plot    ----
        
        if (is.null(input$rpcs_Graph_Isl))
          return(NULL) 
        
        else if(input$rpcs_Graph_Isl == "Line" && input$rpcs_DataSummary_Isl == "Island Mean") { # Line   ----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(rpcs_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = rpcs_FilterByIsl_Isl(), 
                        aes(x = IslandDate, y = Island_Mean_Density, group = IslandName, color = IslandName),
                        size = 1) +
              scale_x_date(date_labels = "%Y", breaks = rpcs_FilterByIsl_Isl()$IslandDate, 
                           limits = c(min(as.Date(rpcs_FilterByIsl_Isl()$IslandDate))-365,
                                      max(as.Date(rpcs_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              geom_errorbar(data = rpcs_FilterByIsl_Isl(), 
                            aes(x = IslandDate, ymin = Island_Mean_Density - IslandSE, ymax = Island_Mean_Density + IslandSE),
                            width = 0, color = "black", alpha = as.numeric(input$rpcs_EB_Isl)) +
              labs(title = glue("{unique(rpcs_FilterByIsl_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Percent Cover") +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "right",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        } 
        else if(input$rpcs_Graph_Isl == "Line" && input$rpcs_DataSummary_Isl == "Site Means (by Island)") {
          return({
            ggplot() + 
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(rpcs_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = rpcs_Filter_Isl(), 
                        aes(Date, MeanDensity_sqm, group = SiteName, colour = SiteName, linetype = SiteName),
                        size = 1) +
              scale_x_date(date_labels = "%Y", date_breaks = "1 year",
                           limits = c(min(as.Date(rpcs_FilterByIsl_Isl()$IslandDate))-365,
                                      max(as.Date(rpcs_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              scale_y_continuous(limits = c(0, max(rpcs_Filter_Isl()$MaxSum)), expand = expansion(mult = c(0.01, .01))) +
              geom_errorbar(data = rpcs_Filter_Isl(), 
                            aes(x = Date, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                            width = 0, color = "black", alpha = as.numeric(input$rpcs_EB_Isl)) +
              labs(title = rpcs_Filter_Isl()$IslandName,
                   color = "Site Name",
                   linetype ="Site Name",
                   caption = "Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected",
                   x = NULL,
                   y = "Mean Density") +
              geom_vline(size = 1, xintercept = as.Date("2005-07-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2005-07-01", format = "%Y-%m-%d"), 
                        y= Inf, aes(label = "16 New Sites Added"),
                        hjust = 0,
                        vjust = 1,
                        inherit.aes = FALSE) +
              geom_vline(size = 1, xintercept = as.Date("2001-06-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2001-06-01", format = "%Y-%m-%d"), 
                        y= Inf, aes(label = "Miracle Mile Added"),
                        hjust = 1,
                        vjust = 1,
                        inherit.aes = FALSE) +
              scale_color_manual(values = SiteColor2, guide = guide_legend(ncol = 10)) +
              scale_linetype_manual(values = SiteLine, guide = guide_legend(ncol = 10)) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.key.width = unit(1.5, "cm"),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 12, colour = "black"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$rpcs_Graph_Isl == "Bar" && input$rpcs_DataSummary_Isl == "Island Mean") { # Bar -----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(rpcs_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = rpcs_FilterByIsl_Isl(), 
                       aes(x = IslandDate, y = Island_Mean_Density, fill = IslandName),
                       position = input$rpcs_BarOptions_Isl,
                       width = 280) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              scale_x_date(date_labels = "%Y", breaks = rpcs_FilterByIsl_Isl()$IslandDate, 
                           limits = c(min(as.Date(rpcs_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(rpcs_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(rpcs_FilterByIsl_Isl()$ScientificName)}"),
                   subtitle = glue("{unique(rpcs_FilterByIsl_Isl()$CommonName)}"),
                   color = "Common Name",
                   fill = "Common Name",
                   x = "Year",
                   y = rpcs_yLabel_Isl()) +
              scale_fill_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "right",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$rpcs_Graph_Isl == "Bar" && input$rpcs_DataSummary_Isl == "Site Means (by Island)") {
          return({
            ggplot() +
              geom_col(data = rpcs_Filter_Isl() %>% dplyr::group_by(SurveyYear) %>% dplyr::mutate(Date = mean(Date)), 
                       aes(x = Date-75, y = MeanDensity_sqm, fill = SiteName),
                       position = input$rpcs_BarOptions_Isl,
                       width = 280) +
              scale_x_date(date_labels = "%Y", date_breaks = "1 year",
                           limits = c(min(as.Date(rpcs_Filter_Isl()$Date))-365,
                                      max(as.Date(rpcs_Filter_Isl()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = rpcs_Filter_Isl()$IslandName,
                   color = "Site Name",
                   fill = "Site Name",
                   x = "Year",
                   y = rpcs_yLabel_Isl()) +
              geom_vline(size = 1, xintercept = as.Date("2005-01-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2005-01-01", format = "%Y-%m-%d"), 
                        y= Inf, aes(label = "16 New Sites Added"),
                        hjust = 0,
                        vjust = 1,
                        inherit.aes = FALSE) +
              geom_vline(size = 1, xintercept = as.Date("2001-01-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2001-01-01", format = "%Y-%m-%d"), 
                        y= Inf, aes(label = "Miracle Mile Added"),
                        hjust = 1,
                        vjust = 1,
                        inherit.aes = FALSE) +
              scale_fill_manual(values = SiteColor2, guide = guide_legend(ncol = 10)) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.key.width = unit(1, "cm"),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 12, colour = "black"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        } 
        else if(input$rpcs_Graph_Isl == "Smooth Line" && input$rpcs_DataSummary_Isl == "Island Mean") { # Smooth   ----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(rpcs_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_point(data = rpcs_FilterByIsl_Isl(), aes(x = IslandDate, y = Island_Mean_Density, color = IslandName), 
                         size = 2, alpha = as.numeric(input$rpcs_SmoothPoint_Isl)) +
              geom_smooth(data = rpcs_FilterByIsl_Isl(), aes(x= IslandDate, y = Island_Mean_Density, color = IslandName),
                          se = as.logical(input$rpcs_SmoothSE_Isl), span = input$rpcs_SmoothSlide_Isl) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(rpcs_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(rpcs_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(rpcs_FilterByIsl_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Percent Cover") +
              scale_color_manual(values = SpeciesColor, guide = guide_legend(nrow = 5)) +
              theme_classic() +
              theme(legend.position = "right",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$rpcs_Graph_Isl == "Smooth Line" && input$rpcs_DataSummary_Isl == "Site Means (by Island)") {
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(rpcs_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_point(data = rpcs_Filter_Isl(), aes(x = Date, y = MeanDensity_sqm, color = CommonName), 
                         size = 2, alpha = as.numeric(input$rpcs_SmoothPoint_Isl)) +
              geom_smooth(data = rpcs_Filter_Isl(), aes(x= Date, y = MeanDensity_sqm, color = SiteName),
                          se = as.logical(input$rpcs_SmoothSE_Isl), span = input$rpcs_SmoothSlide_Isl) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(rpcs_Filter_Isl()$Date))-365, 
                                      max(as.Date(rpcs_Filter_Isl()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(rpcs_Filter_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Percent Cover") +
              scale_color_manual(values = SiteColor2, guide = guide_legend(nrow = 5)) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
      })
      
    }
    
    { # rpcs_Server_byMPA ----
      
      rpcs_Filter_MPA <- reactive({
        rpcs_DFMPA %>%
          dplyr::filter(CommonName == input$rpcs_SpeciesName_MPA) %>%
          dplyr::group_by(IslandCode, SurveyYear) %>%
          dplyr::mutate(Date = mean(Date),
                        MaxSumBar = max(sum(MeanDensity_sqm))) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SiteName, SurveyYear) %>%
          dplyr::mutate(MaxSum = max(sum(MeanDensity_sqm))) %>%
          arrange(SiteName)
      })
      
      rpcs_FilterBarSite_MPA <-reactive({
        rpcs_DFMPA %>%
          dplyr::filter(CommonName == input$rpcs_SpeciesName_MPA,
                        SiteName != "Keyhole") %>%
          dplyr::group_by(IslandCode, SurveyYear) %>%
          dplyr::mutate(Date = mean(Date),
                        MaxSumBar = max(sum(MeanDensity_sqm))) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SiteName, SurveyYear) %>%
          dplyr::mutate(MaxSum = max(sum(MeanDensity_sqm)))
      })
      
      rpcs_Inside_MPA <- reactive({
        rpcs_DFMPA %>% 
          dplyr::filter(CommonName == input$rpcs_SpeciesName_MPA,
                        ReserveStatus == "Inside",
                        SiteName != "Keyhole") %>%
          dplyr::group_by(MPA_Date, IslandCode, IslandName, Species, ScientificName, CommonName, SurveyYear) %>%
          dplyr::distinct(MPA_Date, IslandCode, IslandName,Species, ScientificName, CommonName, SurveyYear,
                          MPA_TotalCount, MPA_Mean, MPA_SD, MPA_SE, MPA_Quadrats_Sampled, MPA_AreaSurveyed_sqm, .keep_all = TRUE)
      })
      
      rpcs_Outside_MPA <- reactive({
        rpcs_DFMPA %>%
          dplyr::filter(CommonName == input$rpcs_SpeciesName_MPA,
                        ReserveStatus == "Outside",
                        SiteName != "Keyhole") %>%
          dplyr::group_by(MPA_Date, IslandCode, IslandName, Species, ScientificName, CommonName, SurveyYear) %>%
          dplyr::distinct(MPA_Date, IslandCode, IslandName,Species, ScientificName, CommonName, SurveyYear,
                          MPA_TotalCount, MPA_Mean, MPA_SD, MPA_SE, MPA_Quadrats_Sampled, MPA_AreaSurveyed_sqm, .keep_all = TRUE)
      })
      
      rpcs_alphaONI_MPA <- reactive({
        if(input$rpcs_GraphOptions_MPA == "With No Index"){
          return(0)
        }
        else if(input$rpcs_GraphOptions_MPA == "With ONI"){
          return(1)
        }
        else if(input$rpcs_GraphOptions_MPA == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$rpcs_GraphOptions_MPA == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      rpcs_alphaPDO_NOAA_MPA <- reactive({
        if(input$rpcs_GraphOptions_MPA == "With No Index"){
          return(0)
        }
        if(input$rpcs_GraphOptions_MPA == "With ONI"){
          return(0)
          
        }
        if(input$rpcs_GraphOptions_MPA == "With PDO (NOAA)"){
          return(1)
        }
        if(input$rpcs_GraphOptions_MPA == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      rpcs_alphaPDO_UW_MPA <- reactive({
        if(input$rpcs_GraphOptions_MPA == "With No Index"){
          return(0)
        }
        if(input$rpcs_GraphOptions_MPA == "With ONI"){
          return(0)
          
        }
        if(input$rpcs_GraphOptions_MPA == "With PDO (NOAA)"){
          return(0)
        }
        if(input$rpcs_GraphOptions_MPA == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$rpcs_ONIpdoPIC_MPA <- renderImage({
        if(input$rpcs_GraphOptions_MPA == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$rpcs_GraphOptions_MPA == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$rpcs_GraphOptions_MPA == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      rpcs_AxisScale_MPA <- reactive({
        if(input$rpcs_FreeOrLock_MPA == "Locked Scales"){
          return("fixed")
        }
        if(input$rpcs_FreeOrLock_MPA == "Free Scales"){
          return("free")
        }
      }) # Facet Plot Axis Scale free or fixed 
      
      output$rpcs_Plot_MPA <- renderPlot({
        if (is.null(input$rpcs_Graph_MPA))
          return(NULL)
        
        else if(input$rpcs_Graph_MPA == "Line" && input$rpcs_DataSummary_MPA == "MPA Mean") {  # Line    ----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(rpcs_alphaONI_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = rpcs_Filter_MPA() %>% dplyr::filter(SiteName != "Keyhole"), 
                        aes(x = MPA_Date, y = MPA_Mean, group = ReserveStatus, color = ReserveStatus, linetype = ReserveStatus),
                        size = 1) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(rpcs_Filter_MPA()$MPA_Date)), 
                                      max(as.Date(rpcs_Filter_MPA()$MPA_Date))),
                           expand = expansion(mult = c(0.01, .01))) +
              geom_errorbar(data = rpcs_Filter_MPA(), 
                            aes(x = MPA_Date, ymin = MPA_Mean - MPA_SE, ymax = MPA_Mean + MPA_SE),
                            width = 0, color = "black", alpha = as.numeric(input$rpcs_EB_MPA)) +
              labs(title = glue("{unique(rpcs_Filter_MPA()$ScientificName)}"),
                   subtitle = glue("{unique(rpcs_Filter_MPA()$CommonName)}"),
                   color = "Reserve Status",
                   linetype = "Reserve Status",
                   x = "Year",
                   y = "Percent Cover") +
              scale_color_manual(values=c(Inside = "green3", Outside = "red3")) +
              scale_linetype_manual(values = c(Inside = "dashed", Outside = "solid")) +
              facet_grid(rows = vars(IslandName), scales = rpcs_AxisScale_MPA()) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    legend.key.width = unit(2, "cm"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"),
                    strip.text = element_text(size = 12, colour = "Black", angle = 90, face = "bold"))
          })
        }
        else if(input$rpcs_Graph_MPA == "Line" && input$rpcs_DataSummary_MPA == "Site Means (by MPA)") {
          return({
            out <- by(data = rpcs_Filter_MPA(), INDICES = rpcs_Filter_MPA()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(rpcs_alphaONI_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_MPA()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_line(data = m, 
                          aes(x = Date, MeanDensity_sqm, group = SiteName, color = SiteName, linetype = SiteName),
                          size = 1) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date),
                             limits = c(min(as.Date(m$Date)), max(as.Date(m$Date))),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(limits = c(0, ifelse(input$rpcs_FreeOrLock_MPA == "Locked Scales", 
                                                        max(rpcs_Filter_MPA()$MaxSum), max(m$MeanDensity_sqm))), 
                                   expand = expansion(mult = c(0.01, .01))) +
                geom_errorbar(data = m, 
                              aes(x = Date, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                              width = 0, color = "black", alpha = as.numeric(input$rpcs_EB_MPA)) +
                labs(title = m$IslandName,
                     color = "Site Name",
                     linetype = "Site Name",
                     caption = "Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected",
                     x = "Year",
                     y = "Percent Cover") +
                scale_color_manual(values = SiteColor, breaks = as.character(m$SiteName)) +
                scale_linetype_manual(values = SiteLine, breaks = as.character(m$SiteName)) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(rpcs_Filter_MPA()$ScientificName)}"),
                                          label_size = 20,
                                          label_fontface = "bold.italic"
            ))
          })
        }
        else if(input$rpcs_Graph_MPA == "Bar" && input$rpcs_DataSummary_MPA == "MPA Mean") { # Bar    -----
          return({ 
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(rpcs_alphaONI_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = rpcs_Inside_MPA(), 
                       aes(x = MPA_Date - 60, y = MPA_Mean, group = ReserveStatus, fill = ReserveStatus),
                       width = 120) +
              geom_text(data = rpcs_Inside_MPA(),
                        aes(x = MPA_Date - 60, y = MPA_Mean, label = round(MPA_Mean, digits = 2)),
                        vjust = -.2, hjust = .5, angle = 0, alpha = as.numeric(input$rpcs_Bar_Text_MPA)) +
              geom_errorbar(data = rpcs_Inside_MPA(), 
                            aes(x = MPA_Date - 60, ymin = MPA_Mean - MPA_SE, ymax = MPA_Mean + MPA_SE),
                            width = 0, color = "black", alpha = as.numeric(input$rpcs_EB_MPA)) +
              geom_col(data = rpcs_Outside_MPA(), 
                       aes(x = MPA_Date + 60, y = MPA_Mean, group = ReserveStatus, fill = ReserveStatus),
                       width = 120) +
              geom_text(data = rpcs_Outside_MPA(),
                        aes(x = MPA_Date + 60, y = MPA_Mean, label = round(MPA_Mean, digits = 2)),
                        vjust = -.2, hjust = .5, angle = 0, alpha = as.numeric(input$rpcs_Bar_Text_MPA)) +
              geom_errorbar(data = rpcs_Outside_MPA(), 
                            aes(x = MPA_Date + 60, ymin = MPA_Mean - MPA_SE, ymax = MPA_Mean + MPA_SE),
                            width = 0, color = "black", alpha = as.numeric(input$rpcs_EB_MPA)) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(rpcs_Filter_MPA()$MPA_Date)) - 150, 
                                      max(as.Date(rpcs_Filter_MPA()$MPA_Date))),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(rpcs_Filter_MPA()$ScientificName)}"),
                   subtitle = glue("{unique(rpcs_Filter_MPA()$CommonName)}"),
                   color = "Reserve Status",
                   linetype = "Reserve Status",
                   x = "Year",
                   y = "Percent Cover") +
              scale_fill_manual(values = c(Inside = "green3", Outside = "red3")) +
              facet_grid(rows = vars(IslandName), scales = rpcs_AxisScale_MPA()) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    legend.key.width = unit(2, "cm"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"),
                    strip.text = element_text(size = 12, colour = "Black", angle = 90, face = "bold"))
          })
        }
        else if(input$rpcs_Graph_MPA == "Bar" &&  input$rpcs_DataSummary_MPA == "Site Means (by MPA)") {
          return({
            out <- by(data = rpcs_FilterBarSite_MPA(), INDICES = rpcs_FilterBarSite_MPA()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() +
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(rpcs_alphaONI_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_MPA()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                new_scale_fill() +
                geom_col(data = m %>% dplyr::filter(ReserveStatus == "Inside"), 
                         aes(x = Date - 70, y = MeanDensity_sqm, fill = SiteName),
                         position = "stack", width = 140) +
                geom_text(data = m %>% dplyr::filter(ReserveStatus == "Inside") %>% 
                            dplyr::group_by(IslandName, SurveyYear) %>% dplyr::mutate(SumBar = sum(MeanDensity_sqm)),
                          aes(x = Date - 70, y = SumBar, label = "In"),
                          vjust = -.2, hjust = .5, angle = 0) +
                scale_fill_manual(values = SiteColor) +
                labs(fill = "Inside") +
                new_scale_fill() +
                geom_col(data = m %>% dplyr::filter(ReserveStatus == "Outside") , 
                         aes(x = Date + 70, y = MeanDensity_sqm, fill = SiteName),
                         position = "stack", width = 140) +
                geom_text(data = m %>% dplyr::filter(ReserveStatus == "Outside") %>%
                            dplyr::group_by(IslandName, SurveyYear) %>%
                            dplyr::mutate(SumBar = sum(MeanDensity_sqm)),
                          aes(x = Date + 70, y = SumBar, label = "Out"),
                          vjust = -.2, hjust = .5, angle = 0) +
                scale_y_continuous(limits = c(0, ifelse(input$rpcs_FreeOrLock_MPA == "Locked Scales", 
                                                        max(rpcs_Filter_MPA()$MaxSumBar), max(m$MeanDensity_sqm))),
                                   expand = expansion(mult = c(0.01, .01))) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date), 
                             limits = c(min(as.Date(m$Date)) - 150, max(as.Date(m$Date))),
                             expand = expansion(mult = c(0.01, .01))) +
                labs(title = m$IslandName,
                     fill = "Outside",
                     x = "Year",
                     y = "Percent Cover") +
                scale_fill_manual(values = SiteColor) +
                scale_color_manual(values = SiteColor) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(rpcs_Filter_MPA()$ScientificName)}"),
                                          label_size = 20,
                                          label_fontface = "bold.italic"
            ))
          })
        } 
        else if(input$rpcs_Graph_MPA == "Smooth Line" && input$rpcs_DataSummary_MPA == "MPA Mean") {  # Smooth       ----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(rpcs_alphaONI_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_point(data = rpcs_Filter_MPA() %>% dplyr::filter(SiteName != "Keyhole"), 
                         aes(x= MPA_Date, y = MPA_Mean, color = ReserveStatus),
                         size = 1, alpha = as.numeric(input$rpcs_SmoothPoint_MPA), show.legend = FALSE) +
              geom_smooth(data = rpcs_Filter_MPA() %>% dplyr::filter(SiteName != "Keyhole"), 
                          aes(x= MPA_Date, y = MPA_Mean, color = ReserveStatus),
                          se = as.logical(input$rpcs_SmoothSE_MPA),
                          span = input$rpcs_SmoothSlide_MPA) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(rpcs_Filter_MPA()$MPA_Date)), 
                                      max(as.Date(rpcs_Filter_MPA()$MPA_Date))),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(rpcs_Filter_MPA()$ScientificName)}"),
                   subtitle = glue("{unique(rpcs_Filter_MPA()$CommonName)}"),
                   color = "Reserve Status",
                   linetype = "Reserve Status",
                   x = "Year",
                   y = "Percent Cover") +
              scale_color_manual(values=c(Inside = "green3", Outside = "red3")) +
              scale_linetype_manual(values = c(Inside = "dashed", Outside = "solid")) +
              facet_grid(rows = vars(IslandName), scales = rpcs_AxisScale_MPA()) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    legend.key.width = unit(2, "cm"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"),
                    strip.text = element_text(size = 12, colour = "Black", angle = 90, face = "bold"))
          })
        }
        else if(input$rpcs_Graph_MPA == "Smooth Line" && input$rpcs_DataSummary_MPA == "Site Means (by MPA)") {
          return({
            out <- by(data = rpcs_Filter_MPA(), INDICES = rpcs_Filter_MPA()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(rpcs_alphaONI_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_MPA()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_point(data = m, aes(x = Date, MeanDensity_sqm, color = SiteName),
                           size = 1, alpha = as.numeric(input$rpcs_SmoothPoint_MPA), show.legend = FALSE) +
                geom_smooth(data = m, aes(x = Date, MeanDensity_sqm, color = SiteName, linetype = SiteName),
                            se = as.logical(input$rpcs_SmoothSE_MPA),
                            span = input$rpcs_SmoothSlide_MPA) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date),
                             limits = c(min(as.Date(m$Date)) - 150, max(as.Date(m$Date))),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(limits = c(0, max(rpcs_Filter_MPA()$MaxSum)), expand = expansion(mult = c(0.01, .01))) +
                labs(title = m$IslandName,
                     color = "Site Name",
                     linetype = "Site Name",
                     caption = "Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected",
                     x = "Year",
                     y = "Percent Cover") +
                scale_color_manual(values = SiteColor) +
                scale_linetype_manual(values = SiteLine) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(rpcs_Filter_MPA()$ScientificName)}"),
                                          label_size = 20,
                                          label_fontface = "bold.italic"
            ))
          })
        }
      })
      
    }
    
    { # rpcs_Server_Two_Species    ----
      
      rpcs_Filter_Two_One <- reactive({
        rpcs_DF %>%
          dplyr::filter(SiteName == input$rpcs_SiteName_Two,
                        CommonName == input$rpcs_SpeciesName_Two_One) %>%
          dplyr::select(SurveyYear, Date, SiteName, IslandName, ScientificName, CommonName, MeanDensity_sqm, 
                        StandardError, StandardError, TotalCount, AreaSurveyed_sqm, MeanDepth, Island_Mean_Density,
                        Species, SiteNumber, IslandCode, SiteCode) 
      })
      
      rpcs_Filter_Two_Two <- reactive({
        rpcs_DF %>%
          dplyr::filter(SiteName == input$rpcs_SiteName_Two,
                        CommonName == input$rpcs_SpeciesName_Two_Two) %>%
          dplyr::select(SurveyYear, Date, SiteName, IslandName, ScientificName, CommonName, MeanDensity_sqm, 
                        StandardError, StandardError, TotalCount, AreaSurveyed_sqm, MeanDepth, Island_Mean_Density,
                        Species, SiteNumber, IslandCode, SiteCode) 
      })
      
      output$rpcs_LargeSpPhoto_Two_1 <- renderImage({
        
        if (is.null(input$rpcs_SpeciesName_Two_One))
          return(NULL) 
        
        if (input$rpcs_SpeciesName_Two_One == unique(rpcs_Filter_Two_One()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(rpcs_Filter_Two_One()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(rpcs_Filter_Two_One()$CommonName)}"),
            width = 450,
            height = 450
          ))
        }
      }, deleteFile = FALSE)
      
      output$rpcs_LargeSpPhoto_Two_2 <- renderImage({
        
        if (input$rpcs_SpeciesName_Two_Two == unique(rpcs_Filter_Two_Two()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(rpcs_Filter_Two_Two()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(rpcs_Filter_Two_Two()$CommonName)}"),
            width = 450,
            height = 450
          ))
        }
      }, deleteFile = FALSE)
      
      output$rpcs_TopSitePhoto_Two <- renderImage({
        if (is.null(input$rpcs_SpeciesName_Two_One))
          return(NULL)
        
        if (input$rpcs_SiteName_Two == unique(rpcs_Filter_Two_One()$SiteName)) {
          return(list(
            src = glue("www/Sat_Imagery/{unique(rpcs_Filter_Two_One()$SiteCode)}.png"),
            contentType = "image/png",
            alt = glue("{unique(rpcs_Filter_Two_One()$SiteName)}"),
            width = 430,
            height = 210
          ))
        }
      }, deleteFile = FALSE)
      
      output$rpcs_LargeSitePhoto_Two <- renderImage({
        if (is.null(input$rpcs_SpeciesName_Two_One))
          return(NULL)
        
        if (input$rpcs_SiteName_Two == unique(rpcs_Filter_Two_One()$SiteName)) {
          return(list(
            src = glue("www/Sat_Imagery/{unique(rpcs_Filter_Two_One()$SiteCode)}.png"),
            contentType = "image/png",
            alt = glue("{unique(rpcs_Filter_Two_One()$SiteName)}"),
            width = 1250,
            height = 625
          ))
        }
      }, deleteFile = FALSE)
      
      rpcs_alphaONI_Two <- reactive({
        if(input$rpcs_GraphOptions_Two == "With No Index"){
          return(0)
        }
        else if(input$rpcs_GraphOptions_Two == "With ONI"){
          return(1)
        }
        else if(input$rpcs_GraphOptions_Two == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$rpcs_GraphOptions_Two == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      rpcs_alphaPDO_NOAA_Two <- reactive({
        if(input$rpcs_GraphOptions_Two == "With No Index"){
          return(0)
        }
        if(input$rpcs_GraphOptions_Two == "With ONI"){
          return(0)
          
        }
        if(input$rpcs_GraphOptions_Two == "With PDO (NOAA)"){
          return(1)
        }
        if(input$rpcs_GraphOptions_Two == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      rpcs_alphaPDO_UW_Two <- reactive({
        if(input$rpcs_GraphOptions_Two == "With No Index"){
          return(0)
        }
        if(input$rpcs_GraphOptions_Two == "With ONI"){
          return(0)
          
        }
        if(input$rpcs_GraphOptions_Two == "With PDO (NOAA)"){
          return(0)
        }
        if(input$rpcs_GraphOptions_Two == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$rpcs_ONIpdoPIC_Two <- renderImage({
        if(input$rpcs_GraphOptions_Two == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$rpcs_GraphOptions_Two == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$rpcs_GraphOptions_Two == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      output$rpcs_Plot_Two <- renderPlot({
        
        if (is.null(input$rpcs_Graph_Two))
          return(NULL) 
        
        else if(input$rpcs_Graph_Two == "Line"){
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(rpcs_alphaONI_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_Two()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = rpcs_Filter_Two_One(), 
                        aes(x = Date, y = MeanDensity_sqm, group = ScientificName, color = CommonName),
                        size = 1) +
              geom_errorbar(data = rpcs_Filter_Two_One(),
                            aes(x = Date, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                            width = 0, color = "black", alpha = as.numeric(input$rpcs_EB_Two)) + 
              geom_line(data = rpcs_Filter_Two_Two(), 
                        aes(x = Date, y = MeanDensity_sqm*input$rpcs_Y_Slide_Two, group = ScientificName, color = CommonName),
                        size = 1) +
              geom_errorbar(data = rpcs_Filter_Two_Two(),
                            aes(x = Date, ymin = MeanDensity_sqm*input$rpcs_Y_Slide_Two - StandardError*input$rpcs_Y_Slide_Two, 
                                ymax = MeanDensity_sqm*input$rpcs_Y_Slide_Two + StandardError*input$rpcs_Y_Slide_Two),
                            width = 0, color = "black", alpha = as.numeric(input$rpcs_EB_Two)) + 
              scale_y_continuous(sec.axis = sec_axis(~./input$rpcs_Y_Slide_Two, 
                                                     name = glue("{unique(rpcs_Filter_Two_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%b %Y", breaks = unique(rpcs_Filter_Two_One()$Date), 
                           limits = c(min(as.Date(rpcs_Filter_Two_One()$Date))-365, 
                                      max(as.Date(rpcs_Filter_Two_One()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(rpcs_Filter_Two_One()$ScientificName)
                              } and {unique(rpcs_Filter_Two_Two()$ScientificName)}"), 
                   subtitle = glue("{unique(rpcs_Filter_Two_One()$IslandName)} {unique(rpcs_Filter_Two_One()$SiteName)}"),
                   color = "Common Name",
                   caption = 
                     glue(
                       "{rpcs_Filter_Two_One()$SiteName} is typically surveyed in {
                     lubridate::month(round(mean(month(rpcs_Filter_Two_One()$Date)), 0), label = TRUE, abbr = FALSE)
                     } and has a mean depth of {round(mean(rpcs_Filter_Two_One()$MeanDepth), 2)} ft"),
                   x = "Year",
                   y = glue('{unique(rpcs_Filter_Two_One()$CommonName)} Mean Density')) +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
          })}
        else if(input$rpcs_Graph_Two == "Bar") {
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(rpcs_alphaONI_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_Two()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = rpcs_Filter_Two_One(), 
                       aes(x = Date - 50, y = MeanDensity_sqm, fill = CommonName),
                       position = "dodge",
                       width = 100) +
              geom_col(data = rpcs_Filter_Two_Two(), 
                       aes(x = Date + 50, y = MeanDensity_sqm*input$rpcs_Y_Slide_Two, fill = CommonName),
                       position = "dodge",
                       width = 100) +
              geom_errorbar(data = rpcs_Filter_Two_One(),
                            aes(x = Date - 50, ymin = MeanDensity_sqm - StandardError, ymax = MeanDensity_sqm + StandardError),
                            width = 0, color = "black", alpha = as.numeric(input$rpcs_EB_Two)) + 
              geom_errorbar(data = rpcs_Filter_Two_Two(),
                            aes(x = Date + 50, ymin = MeanDensity_sqm*input$rpcs_Y_Slide_Two - StandardError*input$rpcs_Y_Slide_Two, 
                                ymax = MeanDensity_sqm*input$rpcs_Y_Slide_Two + StandardError*input$rpcs_Y_Slide_Two),
                            width = 0, color = "black", alpha = as.numeric(input$rpcs_EB_Two)) + 
              scale_y_continuous(sec.axis = sec_axis(~./input$rpcs_Y_Slide_Two, 
                                                     name = glue("{unique(rpcs_Filter_Two_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%b %Y", breaks = unique(rpcs_Filter_Two_One()$Date),
                           limits = c(min(as.Date(rpcs_Filter_Two_One()$Date))-365,
                                      max(as.Date(rpcs_Filter_Two_One()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(rpcs_Filter_Two_One()$ScientificName)
                              } and {unique(rpcs_Filter_Two_Two()$ScientificName)}"),
                   subtitle = glue("{unique(rpcs_Filter_Two_One()$IslandName)} {unique(rpcs_Filter_Two_One()$SiteName)}"),
                   color = "Common Name",
                   caption =
                     glue(
                       "{rpcs_Filter_Two_One()$SiteName} is typically surveyed in {
                     lubridate::month(round(mean(month(rpcs_Filter_Two_One()$Date)), 0), label = TRUE, abbr = FALSE)
                     } and has a mean depth of {round(mean(rpcs_Filter_Two_One()$MeanDepth), 2)} ft"),
                   x = "Year",
                   y = "Percent Cover") +
              scale_fill_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
          })}
        else if(input$rpcs_Graph_Two == "Smooth Line"){
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(rpcs_alphaONI_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_NOAA_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(rpcs_alphaPDO_UW_Two()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_smooth(data = rpcs_Filter_Two_One(), 
                          aes(x = Date, y = MeanDensity_sqm, group = ScientificName, color = CommonName),
                          size = 1,  span = input$rpcs_SmoothSlide_Two, se = as.logical(input$rpcs_SmoothSE_Two)) +
              geom_point(data = rpcs_Filter_Two_One(),
                         aes(x = Date, y = MeanDensity_sqm, color = CommonName),
                         size = 1, alpha = as.numeric(input$rpcs_SmoothPoint_Two)) +
              geom_smooth(data = rpcs_Filter_Two_Two(), 
                          aes(x = Date, y = MeanDensity_sqm*input$rpcs_Y_Slide_Two, group = ScientificName, color = CommonName),
                          size = 1,  span = input$rpcs_SmoothSlide_Two, se = as.logical(input$rpcs_SmoothSE_Two)) +
              geom_point(data = rpcs_Filter_Two_Two(),
                         aes(x = Date, y = MeanDensity_sqm*input$rpcs_Y_Slide_Two, color = CommonName),
                         size = 1, alpha = as.numeric(input$rpcs_SmoothPoint_Two)) +
              scale_y_continuous(sec.axis = sec_axis(~./input$rpcs_Y_Slide_Two, 
                                                     name = glue("{unique(rpcs_Filter_Two_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%b %Y", breaks = unique(rpcs_Filter_Two_One()$Date), 
                           limits = c(min(as.Date(rpcs_Filter_Two_One()$Date))-365, 
                                      max(as.Date(rpcs_Filter_Two_One()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(rpcs_Filter_Two_One()$ScientificName)
                              } and {unique(rpcs_Filter_Two_Two()$ScientificName)}"), 
                   subtitle = glue("{unique(rpcs_Filter_Two_One()$IslandName)} {unique(rpcs_Filter_Two_One()$SiteName)}"),
                   color = "Common Name",
                   caption = 
                     glue(
                       "{rpcs_Filter_Two_One()$SiteName} is typically surveyed in {
                     lubridate::month(round(mean(month(rpcs_Filter_Two_One()$Date)), 0), label = TRUE, abbr = FALSE)
                     } and has a mean depth of {round(mean(rpcs_Filter_Two_One()$MeanDepth), 2)} ft"),
                   x = "Year",
                   y = glue('{unique(rpcs_Filter_Two_One()$CommonName)} Mean Density')) +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
          })}
      })
      
      output$rpcs_DToutData_Two_1 <- renderDT({
        datatable(rpcs_Filter_Two_One(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "500px",
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = c(list(list(visible = FALSE, targets = c(1, 3, 4, 7, 8, 9, 10, 11, 12, 13, 14, 15))), 
                                   list(list(className = 'dt-center', targets = 0:6))),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(rpcs_Filter_Two_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      })
      
      output$rpcs_DToutData_Two_2 <- renderDT({
        datatable(rpcs_Filter_Two_Two(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "500px",
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = c(list(list(visible = FALSE, targets = c(1, 3, 4, 7, 8, 9, 10, 11, 12, 13, 14, 15))), 
                                   list(list(className = 'dt-center', targets = 0:6))),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(rpcs_Filter_Two_Two()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      })
      
    }
    
    { # rpcs_Server_all   ----
      
      rpcs_Filter_All <- reactive({
        rpcs_DF %>%
          dplyr::filter(SiteName == input$rpcs_SiteNameAll) %>%
          drop_na()
      })
      
      output$rpcs_Plot_All <- renderPlot({
        if (is.null(input$rpcs_GraphAll))
          return(NULL)
        
        if (input$rpcs_GraphAll == "Line") {
          return({
            out <- by(data = rpcs_Filter_All(), INDICES = rpcs_Filter_All()$CommonName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_line(data = m, 
                          aes(Date, MeanDensity_sqm, group = CommonName, colour = CommonName, linetype = SiteName),
                          size = 1) +
                scale_x_date(date_labels = "%b %Y", breaks = unique(m$Date),
                             expand = expansion(mult = c(0.01, .01))) +
                geom_errorbar(data = m, 
                              aes(x = Date, ymin = MeanDensity_sqm - StandardError,
                                  ymax = MeanDensity_sqm + StandardError),
                              width = 0.25,
                              color = "black") +
                labs(title = m$ScientificName, 
                     subtitle = glue("{m$IslandName} {m$SiteName}"),
                     color = "Common Name",
                     x = "Year",
                     y = "Mean Density") +
                scale_color_manual(values = SpeciesColor) +
                scale_linetype_manual(values = SiteLine, guide = FALSE) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 13, colour = "black", face = "bold"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
              
            })
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v'))
          })
        } 
        else if (input$rpcs_GraphAll == "Bar") {
          return({
            out <- by(data = rpcs_Filter_All(), INDICES = rpcs_Filter_All()$CommonName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_col(data = m, 
                         aes(x = Date, y = MeanDensity_sqm, group = CommonName, fill = CommonName, linetype = SiteName),
                         width = 250) +
                geom_text(data = m, 
                          aes(x = Date, y = MeanDensity_sqm, label = round(MeanDensity_sqm, digits = 2)),
                          position = position_dodge(1),
                          vjust = -.2,
                          hjust = .5,
                          angle = 0) +
                scale_x_date(date_labels = "%b %Y", breaks = unique(m$Date),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(expand = expansion(mult = c(0, .1))) +
                labs(title = m$ScientificName, 
                     subtitle = glue("{m$IslandName} {m$SiteName}"),
                     color = "Common Name",
                     x = "Year",
                     y = "Mean Density") +
                scale_fill_manual(values = SpeciesColor) +
                scale_linetype_manual(values = SiteLine, guide = FALSE) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 13, colour = "black", face = "bold"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
              
            })
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v'))
          })
        } 
      })
      
    }
    
  }
  
  output$NHSF_UIout <- renderUI({ # NHSF_UI   ----
    if (is.null(input$NHSF_allORone_MS))
      return(NULL)
    
    else if(input$NHSF_allORone_SD == "One Species by Site" &&
            input$NHSF_distORmean_One=='Size Distribution') { #  NHSF_TP_One     ----
      dyn_ui <- tabPanel("NHSF", value = 'NHSF_TP',  
                         tags$hr(),
                         plotOutput(outputId = "NHSF_Plot_SD_One",
                                    height = ifelse(input$NHSF_Graph_SD_One == "Joy Plot", 1000, 500),
                                    width = ifelse(input$NHSF_Graph_SD_One == "Joy Plot", '75%', '100%')),
                         tags$hr(),
                         conditionalPanel("input.NHSF_GraphOptions_SD_One == 'With ONI' ||
                                           input.NHSF_GraphOptions_SD_One == 'With PDO (NOAA)' ||
                                           input.NHSF_GraphOptions_SD_One == 'With PDO (UW)'",
                                          imageOutput(outputId = "NHSF_ONIpdoPIC_SD_One",
                                                      height = 75),
                                          tags$hr()),
                         conditionalPanel("input.NHSF_GraphOptions_SD_One == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.NHSF_GraphOptions_SD_One == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr()),
                         conditionalPanel("input.NHSF_GraphOptions_SD_One == 'With PDO (UW)'",
                                          PDO_UW_tagList,
                                          tags$hr()),
                         conditionalPanel("input.NHSF_Graph_SD_One == 'Boxplot'",
                                          imageOutput(outputId = "NHSF_BoxplotDescription_SD_One"),
                                          tags$hr()),
                         fluidRow(column(4, tags$h2(tags$strong(input$NHSF_SpeciesName_One)),
                                         imageOutput(outputId = "NHSF_LargeSpPhoto_SD_One",
                                                     height = 500)),
                                  column(3, tags$h2(tags$strong("Species Classification")),
                                         DTOutput(outputId = "NHSF_DToutClass_SD_One",
                                                  height = 500)),
                                  column(5, tags$h2(tags$strong("Species Description")),
                                         DTOutput(outputId = "NHSF_DToutDesc_SD_One",
                                                  height = 500))),
                         
                         tags$hr(),
                         DTOutput(outputId = "NHSF_DToutData_SD_One",
                                  height = 550),
                         tags$hr(), tags$hr()
      )
    } 
    else if(input$NHSF_allORone_SD == "One Species by Island" &&
            input$NHSF_distORmean_One=='Size Distribution') { #  NHSF_TP_by_Isl      ---- 
      dyn_ui <- tabPanel("NHSF", value = 'NHSF_TP',
                         tags$hr(),
                         plotOutput(outputId = "NHSF_Plot_SD_Isl",
                                    height = 1000),
                         tags$hr(),
                         conditionalPanel("input.NHSF_GraphOptions_SD_Isl == 'With ONI' ||
                                           input.NHSF_GraphOptions_SD_Isl == 'With PDO (NOAA)' ||
                                           input.NHSF_GraphOptions_SD_Isl == 'With PDO (UW)'",
                                          imageOutput(outputId = "NHSF_ONIpdoPIC_SD_Isl",
                                                      height = 75),
                                          tags$hr()),
                         conditionalPanel("input.NHSF_GraphOptions_SD_Isl == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.NHSF_GraphOptions_SD_Isl == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr()),
                         conditionalPanel("input.NHSF_GraphOptions_SD_Isl == 'With PDO (UW)'",
                                          PDO_UW_tagList,
                                          tags$hr())
      )
    } 
    else if(input$NHSF_allORone_SD == "One Species by MPA" &&
            input$NHSF_distORmean_One=='Size Distribution') { #  NHSF_TP_byMPA     ---- 
      dyn_ui <- tabPanel("NHSF", value = 'NHSF_TP',  
                         tags$hr(),
                         plotOutput(outputId = "NHSF_Plot_SD_MPA",
                                    height = 500),
                         tags$hr(),
                         conditionalPanel("input.NHSF_GraphOptions_SD_MPA == 'With ONI' ||
                                           input.NHSF_GraphOptions_SD_MPA == 'With PDO (NOAA)' ||
                                           input.NHSF_GraphOptions_SD_MPA == 'With PDO (UW)'",
                                          imageOutput(outputId = "NHSF_ONIpdoPIC_SD_MPA",
                                                      height = 75),
                                          tags$hr()),
                         conditionalPanel("input.NHSF_GraphOptions_SD_MPA == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.NHSF_GraphOptions_SD_MPA == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr()),
                         conditionalPanel("input.NHSF_GraphOptions_SD_MPA == 'With PDO (UW)'",
                                          PDO_UW_tagList,
                                          tags$hr()),
                         MPA_tagList,
                         tags$hr())
    }
    else if(input$NHSF_allORone_MS == "One Species by Site" &&
            input$NHSF_distORmean_One=='Mean Sizes') { #  NHSF_TP_One     ----
      dyn_ui <- tabPanel("NHSF", value = 'NHSF_TP',  
                         tags$hr(),
                         plotOutput(outputId = "NHSF_Plot_One",
                                    height = 500),
                         tags$hr(),
                         fluidRow(
                           column(3, conditionalPanel("input.NHSF_Graph_One == 'Line' || input.NHSF_Graph_One == 'Bar'",
                                                      radioButtons(inputId = "NHSF_EB_one",
                                                                   label = "Show error bars?",
                                                                   choices = c("Yes" = 1, "No" = 0),
                                                                   inline = TRUE))),
                           column(3, conditionalPanel("input.NHSF_Graph_One == 'Bar'",
                                                      radioButtons(inputId = "NHSF_Bar_Text_One",
                                                                   label = "Show density value?",
                                                                   choices = c("Yes" = 1, "No" = 0), selected = 0,
                                                                   inline = TRUE))),
                           column(6, conditionalPanel("input.NHSF_GraphOptions_One == 'With ONI' ||
                                                      input.NHSF_GraphOptions_One == 'With PDO (NOAA)' ||
                                                      input.NHSF_GraphOptions_One == 'With PDO (UW)'",
                                                      imageOutput(outputId = "NHSF_ONIpdoPIC_One",
                                                                  height = 75)))),
                         conditionalPanel("input.NHSF_Graph_One == 'Smooth Line'",
                                          sliderInput(inputId = "NHSF_SmoothSlide_One",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "NHSF_SmoothSE_One",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "NHSF_SmoothPoint_One",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE)))),
                         conditionalPanel("input.NHSF_GraphOptions_One == 'With ONI'",
                                          tags$hr(),
                                          ONI_tagList),
                         conditionalPanel("input.NHSF_GraphOptions_One == 'With PDO (NOAA)'",
                                          tags$hr(),
                                          PDO_NOAA_tagList),
                         conditionalPanel("input.NHSF_GraphOptions_One == 'With PDO (UW)'",
                                          tags$hr(),
                                          PDO_UW_tagList),
                         conditionalPanel("input.NHSF_Graph_One == 'Boxplot'",
                                          tags$hr(),
                                          imageOutput(outputId = "NHSF_BoxplotDescription_One")),
                         tags$hr(),
                         fluidRow(column(4, tags$h2(tags$strong(input$NHSF_SpeciesName_One)),
                                         imageOutput(outputId = "NHSF_LargeSpPhoto_One",
                                                     height = 500)),
                                  column(3, tags$h2(tags$strong("Species Classification")),
                                         DTOutput(outputId = "NHSF_DToutClass_One",
                                                  height = 500)),
                                  column(5, tags$h2(tags$strong("Species Description")),
                                         DTOutput(outputId = "NHSF_DToutDesc_One",
                                                  height = 500))),
                         
                         tags$hr(),
                         DTOutput(outputId = "NHSF_DToutData_One",
                                  height = 550),
                         tags$hr(), tags$hr(),
                         imageOutput(outputId = "NHSF_LargeSitePhoto_One",
                                     height = 625),
                         tags$hr()
      )
    } 
    else if(input$NHSF_allORone_MS == "One Species by Island" &&
            input$NHSF_distORmean_One=='Mean Sizes') { #  NHSF_TP_by_Isl      ---- 
      dyn_ui <- tabPanel("NHSF", value = 'NHSF_TP',
                         tags$hr(),
                         conditionalPanel("input.NHSF_FreeOrLock_Isl == 'Locked Scales' ||
                                          input.NHSF_FreeOrLock_Isl == 'Free Scales'",
                                          plotOutput(outputId = "NHSF_Plot_Isl1",
                                                     height = 1000)),
                         conditionalPanel("input.NHSF_FreeOrLock_Isl == 'Single Plot'", 
                                          plotOutput(outputId = "NHSF_Plot_Isl2",
                                                     height = 500)),
                         tags$hr(),
                         fluidRow(conditionalPanel("input.NHSF_Graph_Isl == 'Line' || (input.NHSF_Graph_Isl == 'Bar' && 
                                                   input.NHSF_DataSummary_Isl == 'Island Mean' && 
                                                   input.NHSF_FreeOrLock_Isl != 'Single Plot')",
                                                   column(3, radioButtons(inputId = "NHSF_EB_Isl",
                                                                          label = "Show error bars?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                  conditionalPanel("input.NHSF_Graph_Isl == 'Bar' && 
                                                   input.NHSF_DataSummary_Isl == 'Island Mean' && 
                                                   input.NHSF_FreeOrLock_Isl != 'Single Plot'",
                                                   column(3, radioButtons(inputId = "NHSF_Bar_Text_Isl",
                                                                          label = "Show density value?",
                                                                          choices = c("Yes" = 1, "No" = 0), selected = 0,
                                                                          inline = TRUE))),
                                  conditionalPanel("(input.NHSF_Graph_Isl == 'Bar' && 
                                                   input.NHSF_DataSummary_Isl == 'Island Mean' && 
                                                   input.NHSF_FreeOrLock_Isl != 'Locked Scales' && 
                                                   input.NHSF_FreeOrLock_Isl != 'Free Scales') ||
                                                   (input.NHSF_Graph_Isl == 'Bar' && 
                                                   input.NHSF_DataSummary_Isl == 'Site Means (by Island)')",
                                                   column(3, radioButtons(inputId = "NHSF_BarOptions_Isl",
                                                                          label =  "Bar Graph Options:",
                                                                          choices = c("Stack" = "stack", "Fill" = "fill", "Dodge" = "dodge"),
                                                                          inline = TRUE))),
                                  conditionalPanel("input.NHSF_GraphOptions_Isl == 'With ONI' ||
                                                      input.NHSF_GraphOptions_Isl == 'With PDO (NOAA)' ||
                                                      input.NHSF_GraphOptions_Isl == 'With PDO (UW)'",
                                                   column(6, imageOutput(outputId = "NHSF_ONIpdoPIC_Isl",
                                                                         height = 75)))),
                         fluidRow(conditionalPanel("input.NHSF_Graph_Isl == 'Line' || input.NHSF_Graph_Isl == 'Bar'",
                                                   tags$hr())),
                         conditionalPanel("input.NHSF_Graph_Isl == 'Smooth Line'",
                                          sliderInput(inputId = "NHSF_SmoothSlide_Isl",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "NHSF_SmoothSE_Isl",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "NHSF_SmoothPoint_Isl",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                          tags$hr()),
                         conditionalPanel("input.NHSF_GraphOptions_Isl == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.NHSF_GraphOptions_Isl == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr())
      )
    } 
    else if(input$NHSF_allORone_MS == "One Species by MPA" &&
            input$NHSF_distORmean_One=='Mean Sizes') { #  NHSF_TP_byMPA     ---- 
      dyn_ui <- tabPanel("NHSF", value = 'NHSF_TP',  
                         tags$hr(),
                         plotOutput(outputId = "NHSF_Plot_MPA",
                                    height = 850),
                         tags$hr(),
                         fluidRow(conditionalPanel("input.NHSF_Graph_MPA == 'Line' || (input.NHSF_Graph_MPA == 'Bar' && 
                                                   input.NHSF_DataSummary_MPA == 'MPA Mean')",
                                                   column(3, radioButtons(inputId = "NHSF_EB_MPA",
                                                                          label = "Show error bars?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                  conditionalPanel("input.NHSF_Graph_MPA == 'Bar' && input.NHSF_DataSummary_MPA == 'MPA Mean'",
                                                   column(3, radioButtons(inputId = "NHSF_Bar_Text_MPA",
                                                                          label = "Show density value?",
                                                                          choices = c("Yes" = 1, "No" = 0), selected = 0,
                                                                          inline = TRUE))),
                                  conditionalPanel("input.NHSF_GraphOptions_MPA == 'With ONI' ||
                                                      input.NHSF_GraphOptions_MPA == 'With PDO (NOAA)' ||
                                                      input.NHSF_GraphOptions_MPA == 'With PDO (UW)'",
                                                   column(6, imageOutput(outputId = "NHSF_ONIpdoPIC_MPA",
                                                                         height = 75)))),
                         fluidRow(conditionalPanel("input.NHSF_Graph_MPA == 'Line' || input.NHSF_Graph_MPA == 'Bar'",
                                                   tags$hr())),
                         conditionalPanel("input.NHSF_Graph_MPA == 'Smooth Line'",
                                          sliderInput(inputId = "NHSF_SmoothSlide_MPA",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "NHSF_SmoothSE_MPA",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "NHSF_SmoothPoint_MPA",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                          tags$hr()),
                         conditionalPanel("input.NHSF_GraphOptions_MPA == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.NHSF_GraphOptions_MPA == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr()),
                         MPA_tagList,
                         tags$hr())
    }
    else if(input$NHSF_allORone_MS == "Two Species by Site" &&
            input$NHSF_distORmean_One=='Mean Sizes') { #  NHSF_TP_Two     ----
      dyn_ui <- tabPanel("NHSF", value = 'NHSF_TP',  
                         tags$hr(),
                         plotOutput(outputId = "NHSF_Plot_Two",
                                    height = 500),
                         tags$hr(),
                         sliderInput(inputId = "NHSF_Y_Slide_Two",
                                     label = "Adjust the second y-axis by a multiple of:",
                                     min = 1, max = 50, step = 1, value = 1, width = "100%", ticks = T),
                         conditionalPanel("input.NHSF_Graph_Two == 'Smooth Line'",
                                          sliderInput(inputId = "NHSF_SmoothSlide_Two",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "NHSF_SmoothSE_Two",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "NHSF_SmoothPoint_Two",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE)))),
                         fluidRow(
                           conditionalPanel("input.NHSF_Graph_Two == 'Line' || input.NHSF_Graph_Two == 'Bar'",
                                            column(3, radioButtons(inputId = "NHSF_EB_Two",
                                                                   label = "Show error bars?",
                                                                   choices = c("Yes" = 1, "No" = 0),
                                                                   inline = TRUE))),
                           conditionalPanel("input.NHSF_GraphOptions_Two == 'With ONI' ||
                                                      input.NHSF_GraphOptions_Two == 'With PDO (NOAA)' ||
                                                      input.NHSF_GraphOptions_Two == 'With PDO (UW)'",
                                            column(6, imageOutput(outputId = "NHSF_ONIpdoPIC_Two",
                                                                  height = 75)))),
                         tags$hr(),
                         conditionalPanel("input.NHSF_GraphOptions_Two == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.NHSF_GraphOptions_Two == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr()),
                         conditionalPanel("input.NHSF_GraphOptions_Two == 'With PDO (UW)'",
                                          PDO_UW_tagList,
                                          tags$hr()),
                         fluidRow(column(6, tags$h1(tags$strong(input$NHSF_SpeciesName_Two_One)),
                                         imageOutput(outputId = "NHSF_LargeSpPhoto_Two_1",
                                                     height = 450)),
                                  column(6, tags$h1(tags$strong(input$NHSF_SpeciesName_Two_Two)),
                                         imageOutput(outputId = "NHSF_LargeSpPhoto_Two_2",
                                                     height = 450))),
                         tags$hr(),
                         fluidRow(column(6, tags$h1(tags$strong(input$NHSF_SpeciesName_Two_One)),
                                         DTOutput(outputId = "NHSF_DToutData_Two_1")),
                                  column(6, tags$h1(tags$strong(input$NHSF_SpeciesName_Two_Two)),
                                         DTOutput(outputId = "NHSF_DToutData_Two_2"))),
                         tags$hr(),
                         imageOutput(outputId = "NHSF_LargeSitePhoto_Two",
                                     height = 625),
                         tags$hr()
      )
    }
    else if(input$NHSF_allORone_MS == "All Species" &&
            input$NHSF_distORmean_One=='Mean Sizes') { # NHSF_TP_all   ----
      dyn_ui <- tabPanel("NHSF", value = 'NHSF_TP',  
                         fluidRow(column(12, tags$h1(tags$strong(
                           "This section has the species in the order they appear on the datasheet")))),
                         plotOutput(outputId = "NHSF_Plot_All",
                                    height = 7000))
    }
    return(dyn_ui)
  })
  
  { # ........ NHSF_SizeDist ........     ----
    
    { # NHSF_SD_One_Species   ----
      
      NHSF_RawFilter_One <- reactive({ 
        NHSF_DFRaw %>%
          expandRows(count = "NoOfInd") %>%
          dplyr::filter(SiteName == input$NHSF_SiteName_SD_One,
                        CommonName == input$NHSF_SpeciesName_SD_One) %>% 
          dplyr::group_by(SurveyYear) %>%
          dplyr::mutate(TotalCount = length(Size_mm)) %>%
          dplyr::select(SiteNumber, SurveyYear, Date, IslandName, SiteName, ScientificName, CommonName, 
                        Size_mm, TotalCount, IslandCode, SiteCode, Species, ReserveStatus, MeanDepth)
      }) # filtered  NHSF raw table
      
      NHSF_RawFilterSummary_One <- reactive({ 
        NHSF_DFRaw %>%
          dplyr::filter(SiteName == input$NHSF_SiteName_SD_One,
                        CommonName == input$NHSF_SpeciesName_SD_One) %>% 
          dplyr::group_by(SurveyYear) %>%
          dplyr::mutate(TotalCount = length(Size_mm)) %>%
          dplyr::select(SiteNumber, SurveyYear, Date, IslandName, SiteName, ScientificName, CommonName, 
                        Size_mm, NoOfInd, TotalCount, IslandCode, SiteCode, Species, ReserveStatus, MeanDepth)
      }) # filtered  NHSF raw table
      
      NHSF_SpeciesClass_SD_One <- reactive({ 
        SpeciesName %>%
          dplyr::filter(CommonName == input$NHSF_SpeciesName_SD_One) %>%
          dplyr::select(ScientificName, Kingdom, Phylum, Class, Order, Family, Genus, "Species (Used by KFM)",
                        Status, "Currently Accepted Name", "Authority (Accepted)", CommonName) %>%
          tidyr::pivot_longer(-ScientificName, names_to = "Rank", values_to = "Name") %>%
          dplyr::select(Rank, Name)
      }) # filtered Species classification table
      
      NHSF_SpeciesDescription_SD_One <- reactive({
        SpeciesName %>%
          dplyr::filter(CommonName == input$NHSF_SpeciesName_SD_One) %>%
          dplyr::select(ScientificName, "Geographic Range", Identification, Habitat, "Size Range", "Trophic Level", Abundance) %>%
          tidyr::pivot_longer(-ScientificName, names_to = "Category", values_to = "Information") %>%
          dplyr::select(Category, Information)
      }) # filtered Species Description table  
      
      output$NHSF_TopPhoto_SD_One <- renderImage({
        
        if (input$NHSF_allORone_SD == 'One Species by Site') {
          return(list(src = glue("www/Indicator_Species/{unique(NHSF_RawFilter_One()$Species)}.jpg"),
                      contentType = "image/jpg", width = 210, height = 210))
        }
        else if (input$NHSF_allORone_SD == "One Species by Island") {
          return(list(src = glue("www/Indicator_Species/{unique(NHSF_RawFilter_Isl()$Species)}.jpg"),
                      contentType = "image/jpg", width = 210, height = 210))
        }
        else if (input$NHSF_allORone_SD == 'One Species by MPA') {
          return(list(src = glue("www/Indicator_Species/{unique(NHSF_RawFilter_MPA()$Species)}.jpg"),
                      contentType = "image/jpg", width = 210, height = 210))
        }
      }, deleteFile = FALSE) # Small species photo above plot
      
      output$NHSF_LargeSpPhoto_SD_One <- renderImage({
        list(src = glue("www/Indicator_Species/{unique(NHSF_RawFilter_One()$Species)}.jpg"),
             contentType = "image/jpg", width = 400, height = 400)
      }, deleteFile = FALSE) # Large species photo below plot
      
      output$NHSF_TopSitePhoto_SD_One <- renderImage({
        if (input$NHSF_allORone_SD == 'One Species by Site') {
          return(list(src = glue("www/Sat_Imagery/{unique(NHSF_RawFilter_One()$SiteCode)}.png"),
                      contentType = "image/png", width = 430, height = 210))
        }
        else if (input$NHSF_allORone_SD == "One Species by Island") {
          return(list(src = "www/Sat_Imagery/CHISisl.png",
                      contentType = "image/png", width = 430, height = 210))
        }
        else if (input$NHSF_allORone_SD == 'One Species by MPA') {
          return(list(src = "www/Sat_Imagery/CHISmpa.png",
                      contentType = "image/png", width = 430, height = 210))
        }
        
      }, deleteFile = FALSE) # Small Site photo above plot
      
      output$NHSF_LargeSitePhoto_SD_One <- renderImage({
        if (input$NHSF_allORone_SD == 'One Species by Site') {
          return(list(src = glue("www/Sat_Imagery/{unique(NHSF_RawFilter_One()$SiteCode)}.png"),
                      contentType = "image/png", width = 1250, height = 625))
        }
        else if (input$NHSF_allORone_SD == "One Species by Island") {
          return(list(src = "www/Sat_Imagery/CHISisl.png",
                      contentType = "image/png", width = 1250, height = 625))
        }
        else if (input$NHSF_allORone_SD == 'One Species by MPA') {
          return(list(src = "www/Sat_Imagery/CHISmpa.png",
                      contentType = "image/png", width = 1250, height = 625))
        }
      }, deleteFile = FALSE) # Large Site photo below plot
      
      output$NHSF_DToutClass_SD_One <- renderDT({
        datatable(NHSF_SpeciesClass_SD_One(), 
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    searching = FALSE,
                    lengthChange = FALSE,
                    paging = FALSE,
                    ordering = FALSE,
                    info = FALSE),
                  rownames = FALSE) %>% 
          formatStyle(names(NHSF_SpeciesClass_SD_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      }) # Species Classification data table
      
      output$NHSF_DToutDesc_SD_One <- renderDT({
        datatable(NHSF_SpeciesDescription_One(), 
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    searching = FALSE,
                    lengthChange = FALSE,
                    paging = FALSE,
                    ordering = FALSE,
                    info = FALSE),
                  rownames = FALSE) %>% 
          formatStyle(names(NHSF_SpeciesDescription_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      }) # Species Description data table
      
      NHSF_alphaONI_SD_one <- reactive({
        if(input$NHSF_GraphOptions_SD_One == "With No Index"){
          return(0)
        }
        else if(input$NHSF_GraphOptions_SD_One == "With ONI"){
          return(1)
        }
        else if(input$NHSF_GraphOptions_SD_One == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$NHSF_GraphOptions_SD_One == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      NHSF_alphaPDO_NOAA_SD_one <- reactive({
        if(input$NHSF_GraphOptions_SD_One == "With No Index"){
          return(0)
        }
        if(input$NHSF_GraphOptions_SD_One == "With ONI"){
          return(0)
          
        }
        if(input$NHSF_GraphOptions_SD_One == "With PDO (NOAA)"){
          return(1)
        }
        if(input$NHSF_GraphOptions_SD_One == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      NHSF_alphaPDO_UW_SD_one <- reactive({
        if(input$NHSF_GraphOptions_SD_One == "With No Index"){
          return(0)
        }
        if(input$NHSF_GraphOptions_SD_One == "With ONI"){
          return(0)
          
        }
        if(input$NHSF_GraphOptions_SD_One == "With PDO (NOAA)"){
          return(0)
        }
        if(input$NHSF_GraphOptions_SD_One == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$NHSF_ONIpdoPIC_SD_One <- renderImage({
        if(input$NHSF_GraphOptions_SD_One == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$NHSF_GraphOptions_SD_One == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$NHSF_GraphOptions_SD_One == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      output$NHSF_Plot_SD_One <- renderPlot({
        
        if (is.null(input$NHSF_Graph_SD_One))
          return(NULL) 
        
        else if(input$NHSF_Graph_SD_One == "Boxplot"){
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(NHSF_alphaONI_SD_one()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_SD_one()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_SD_one()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_boxplot(data = NHSF_RawFilter_One(), width = 150,
                           aes(x = Date, y = Size_mm, group = SurveyYear, color = CommonName)) +
              geom_point(data = NHSF_RawFilter_One(), size = 1, color = "black",
                         aes(x = Date, y = mean(Size_mm), group = SurveyYear)) +
              geom_text(data = NHSF_RawFilter_One(), size = 4, fontface = "plain",
                        aes(x = Date, y = -1, group = Date, label = paste(' n = \n', NHSF_RawFilter_One()$TotalCount))) +
              scale_x_date(date_labels = "%Y", breaks = unique(NHSF_RawFilter_One()$Date), expand = expansion(mult = c(0.01, .01)),
                           limits = c(min(NHSF_RawFilter_One()$Date) - 150, max(NHSF_RawFilter_One()$Date) + 150)) +
              labs(title = glue("{unique(NHSF_RawFilter_One()$ScientificName)}"),
                   subtitle= glue("{unique(NHSF_RawFilter_One()$IslandName)} {unique(NHSF_RawFilter_One()$SiteName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Size Distribution (mm)") +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$NHSF_Graph_SD_One == "Violin Plot"){
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(NHSF_alphaONI_SD_one()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_SD_one()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_SD_one()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_violin(data = NHSF_RawFilter_One(), width = 150,
                          aes(x = Date, y = Size_mm, group = SurveyYear, color = CommonName, fill = CommonName)) +
              geom_point(data = NHSF_RawFilter_One(), size = 1, color = "black",
                         aes(x = Date, y = mean(Size_mm), group = SurveyYear)) +
              geom_text(data = NHSF_RawFilter_One(), aes(x = Date, y = -1, group = Date, 
                                                         label = paste(' n = \n', NHSF_RawFilter_One()$TotalCount)), size = 4) +
              scale_x_date(date_labels = "%Y", breaks = unique(NHSF_RawFilter_One()$Date), expand = expansion(mult = c(0.01, .01)),
                           limits = c(min(NHSF_RawFilter_One()$Date) - 150, max(NHSF_RawFilter_One()$Date) + 150)) +
              labs(title = glue("{unique(NHSF_RawFilter_One()$ScientificName)}"),
                   subtitle= glue("{unique(NHSF_RawFilter_One()$IslandName)} {unique(NHSF_RawFilter_One()$SiteName)}"), 
                   color = "Common Name",
                   fill = "Common Name",
                   x = "Year",
                   y = "Size Distribution (mm)") +
              scale_color_manual(values = SpeciesColor) +
              scale_fill_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$NHSF_Graph_SD_One == "Joy Plot"){
          return({
            ggplot() +
              geom_rect(data = oni, aes(ymin= DateStart, ymax = DateEnd,xmin = 0, xmax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(NHSF_alphaONI_SD_one()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(ymin= DateStart, ymax = DateEnd, xmin = 0, xmax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_SD_one()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(ymin= DateStart, ymax = DateEnd, xmin = 0, xmax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_SD_one()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_density_ridges(data = NHSF_RawFilter_One(), 
                                  aes(x = Size_mm, y = Date, group = SurveyYear, fill = CommonName, height = ..density..),
                                  rel_min_height = .01, alpha = .9, stat = "density", scale = 1) +
              scale_y_date(date_labels = "%Y", breaks = NHSF_RawFilter_One()$Date, expand = c(0.05, 0),
                           limits = c(min(NHSF_RawFilter_One()$Date) - 150, max(NHSF_RawFilter_One()$Date) + 360)) +
              scale_x_continuous(limits = c(0, max(NHSF_RawFilter_One()$Size_mm))) +
              labs(title = glue("{unique(NHSF_RawFilter_One()$ScientificName)}"),
                   subtitle= glue("{unique(NHSF_RawFilter_One()$IslandName)} {unique(NHSF_RawFilter_One()$SiteCode)}"),
                   fill = "Common Name",
                   x = "Size Distribution (mm)",
                   y = "Year") +
              scale_fill_manual(values = SpeciesColor) +
              theme_minimal() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
          })
        }
        
      }) # Main Plot for NHSF_SD Quadrats with one species 
      
      output$NHSF_BoxplotDescription_SD_One <- renderImage({
        list(src = glue("www/Boxplot_Description.jpg"), contentType = "image/jpg", width = 550, height = 400)
      }, deleteFile = FALSE) # Boxplot drawing/explanation
      
      output$NHSF_DToutData_SD_One <- renderDT({
        datatable(NHSF_RawFilterSummary_One(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "500px",
                    scrollX = TRUE, 
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = c(list(list(className = 'dt-center', targets = 0:11))),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(NHSF_RawFilterSummary_One()),
                      color = "black",
                      backgroundColor = 'white')
      }) # Filtered data table output
      
    }
    
    { # NHSF_SD_by_Island   ----
      
      NHSF_RawFilter_Isl <- reactive({
        NHSF_DFRaw %>%
          expandRows(count = "NoOfInd") %>%
          dplyr::filter(CommonName == input$NHSF_SpeciesName_SD_Isl) %>%
          dplyr::group_by(SurveyYear) %>% 
          dplyr::mutate(Date = mean(as.Date(Date))) %>% 
          dplyr::ungroup() %>% 
          dplyr::group_by(SurveyYear, IslandName, CommonName) %>%
          dplyr::mutate(TotalCount = length(Size_mm),
                        MeanSize = mean(Size_mm))
      })
      
      NHSF_alphaONI_SD_Isl <- reactive({
        if(input$NHSF_GraphOptions_SD_Isl == "With No Index"){
          return(0)
        }
        else if(input$NHSF_GraphOptions_SD_Isl == "With ONI"){
          return(1)
        }
        else if(input$NHSF_GraphOptions_SD_Isl == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$NHSF_GraphOptions_SD_Isl == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      NHSF_alphaPDO_NOAA_SD_Isl <- reactive({
        if(input$NHSF_GraphOptions_SD_Isl == "With No Index"){
          return(0)
        }
        if(input$NHSF_GraphOptions_SD_Isl == "With ONI"){
          return(0)
          
        }
        if(input$NHSF_GraphOptions_SD_Isl == "With PDO (NOAA)"){
          return(1)
        }
        if(input$NHSF_GraphOptions_SD_Isl == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      NHSF_alphaPDO_UW_SD_Isl <- reactive({
        if(input$NHSF_GraphOptions_SD_Isl == "With No Index"){
          return(0)
        }
        if(input$NHSF_GraphOptions_SD_Isl == "With ONI"){
          return(0)
          
        }
        if(input$NHSF_GraphOptions_SD_Isl == "With PDO (NOAA)"){
          return(0)
        }
        if(input$NHSF_GraphOptions_SD_Isl == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$NHSF_ONIpdoPIC_SD_Isl <- renderImage({
        if(input$NHSF_GraphOptions_SD_Isl == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$NHSF_GraphOptions_SD_Isl == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$NHSF_GraphOptions_SD_Isl == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      NHSF_AxisScale_SD_Isl <- reactive({
        if(input$NHSF_FreeOrLock_SD_Isl == "Locked Scales"){
          return("fixed")
        }
        if(input$NHSF_FreeOrLock_SD_Isl == "Free Scales"){
          return("free")
        }
      }) # Facet Plot Axis Scale free or fixed 
      
      output$NHSF_Plot_SD_Isl <- renderPlot({  
        
        if (is.null(input$NHSF_Graph_Isl))
          return(NULL) 
        
        else if(input$NHSF_Graph_SD_Isl == "Boxplot") { 
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(NHSF_alphaONI_SD_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_SD_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_SD_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_boxplot(data = NHSF_RawFilter_Isl(), width = 150,
                           aes(x = Date, y = Size_mm, group = SurveyYear, color = CommonName)) +
              geom_point(data = NHSF_RawFilter_Isl(), size = 1, color = "black",
                         aes(x = Date, y = MeanSize, group = SurveyYear)) +
              scale_x_date(date_labels = "%Y", breaks = unique(NHSF_RawFilter_Isl()$Date), expand = expansion(mult = c(0.01, .01)),
                           limits = c(min(NHSF_RawFilter_Isl()$Date) - 150, max(NHSF_RawFilter_Isl()$Date) + 150)) +
              labs(title = glue("{unique(NHSF_RawFilter_Isl()$ScientificName)}"),
                   subtitle = glue("{unique(NHSF_RawFilter_Isl()$CommonName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Size Distribution (mm)") +
              facet_grid(rows = vars(IslandName), scales = NHSF_AxisScale_SD_Isl()) +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        } 
        else if(input$NHSF_Graph_SD_Isl == "Violin Plot") { 
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(NHSF_alphaONI_SD_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_SD_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_SD_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_violin(data = NHSF_RawFilter_Isl(), width = 150,
                          aes(x = Date, y = Size_mm, group = SurveyYear, fill = CommonName)) +
              geom_point(data = NHSF_RawFilter_Isl(), size = 1, color = "black",
                         aes(x = Date, y = MeanSize, group = SurveyYear)) +
              scale_x_date(date_labels = "%Y", breaks = unique(NHSF_RawFilter_Isl()$Date), expand = expansion(mult = c(0.01, .01)),
                           limits = c(min(NHSF_RawFilter_Isl()$Date) - 150, max(NHSF_RawFilter_Isl()$Date) + 150)) +
              labs(title = glue("{unique(NHSF_RawFilter_Isl()$ScientificName)}"),
                   subtitle = glue("{unique(NHSF_RawFilter_Isl()$CommonName)}"),
                   color = "Common Name",
                   x = "Year",
                   y = "Size Distribution (mm)") +
              facet_grid(rows = vars(IslandName), scales = NHSF_AxisScale_SD_Isl()) +
              scale_fill_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
      })
      
    }
    
    { # NHSF_MS_Server_byMPA ----
      
      NHSF_RawFilter_MPA <- reactive({
        NHSF_DFRawMPA %>%
          dplyr::filter(IslandName == input$NHSF_IslandName_MPA,
                        CommonName == input$NHSF_SpeciesName_SD_MPA) %>%
          dplyr::group_by(SurveyYear, ReserveStatus) %>%
          dplyr::mutate(TotalCount = length(Size_mm),
                        MeanSize = mean(Size_mm)) %>% 
          dplyr::ungroup() %>% 
          dplyr::group_by(SurveyYear) %>% 
          dplyr::mutate(Date =  mean(as.Date(Date)))
      })
      
      NHSF_alphaONI_SD_MPA <- reactive({
        if(input$NHSF_GraphOptions_SD_MPA == "With No Index"){
          return(0)
        }
        else if(input$NHSF_GraphOptions_SD_MPA == "With ONI"){
          return(1)
        }
        else if(input$NHSF_GraphOptions_SD_MPA == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$NHSF_GraphOptions_SD_MPA == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      NHSF_alphaPDO_NOAA_SD_MPA <- reactive({
        if(input$NHSF_GraphOptions_SD_MPA == "With No Index"){
          return(0)
        }
        if(input$NHSF_GraphOptions_SD_MPA == "With ONI"){
          return(0)
          
        }
        if(input$NHSF_GraphOptions_SD_MPA == "With PDO (NOAA)"){
          return(1)
        }
        if(input$NHSF_GraphOptions_SD_MPA == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      NHSF_alphaPDO_UW_SD_MPA <- reactive({
        if(input$NHSF_GraphOptions_SD_MPA == "With No Index"){
          return(0)
        }
        if(input$NHSF_GraphOptions_SD_MPA == "With ONI"){
          return(0)
          
        }
        if(input$NHSF_GraphOptions_SD_MPA == "With PDO (NOAA)"){
          return(0)
        }
        if(input$NHSF_GraphOptions_SD_MPA == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$NHSF_ONIpdoPIC_SD_MPA <- renderImage({
        if(input$NHSF_GraphOptions_SD_MPA == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$NHSF_GraphOptions_SD_MPA == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$NHSF_GraphOptions_SD_MPA == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      NHSF_AxisScale_SD_MPA <- reactive({
        if(input$NHSF_FreeOrLock_SD_MPA == "Locked Scales"){
          return("fixed")
        }
        if(input$NHSF_FreeOrLock_SD_MPA == "Free Scales"){
          return("free")
        }
      }) # Facet Plot Axis Scale free or fixed 
      
      output$NHSF_Plot_SD_MPA <- renderPlot({
        if (is.null(input$NHSF_Graph_SD_MPA))
          return(NULL)
        
        else if(input$NHSF_Graph_SD_MPA == "Boxplot") { 
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(NHSF_alphaONI_SD_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_SD_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_SD_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_boxplot(data = NHSF_RawFilter_MPA(), width = 150,
                           aes(x = Date, y = Size_mm, group = SurveyYear, color = CommonName)) +
              geom_point(data = NHSF_RawFilter_MPA(), size = 1, color = "black",
                         aes(x = Date, y = MeanSize, group = SurveyYear, color = CommonName)) +
              scale_x_date(date_labels = "%Y", breaks = unique(NHSF_RawFilter_MPA()$Date), expand = expansion(mult = c(0.01, .01)),
                           limits = c(min(NHSF_RawFilter_MPA()$Date) - 150, max(NHSF_RawFilter_MPA()$Date) + 150)) +
              labs(title = glue("{unique(NHSF_RawFilter_MPA()$ScientificName)}"),
                   subtitle = NHSF_RawFilter_MPA()$MPA_Name, 
                   colour = "Common Name",
                   x = "Year",
                   y = "Size Distribution (mm)") +
              facet_grid(rows = vars(ReserveStatus), scales = NHSF_AxisScale_SD_MPA()) +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold")) 
          })
        } 
        else if(input$NHSF_Graph_SD_MPA == "Violin Plot") { 
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(NHSF_alphaONI_SD_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_SD_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_SD_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_violin(data = NHSF_RawFilter_MPA(), width = 150,
                          aes(x = Date, y = Size_mm, group = SurveyYear, fill = CommonName)) +
              geom_point(data = NHSF_RawFilter_MPA(), size = 1, color = "black",
                         aes(x = Date, y = MeanSize, group = SurveyYear)) +
              scale_x_date(date_labels = "%Y", breaks = unique(NHSF_RawFilter_MPA()$Date), expand = expansion(mult = c(0.01, .01)),
                           limits = c(min(NHSF_RawFilter_MPA()$Date) - 150, max(NHSF_RawFilter_MPA()$Date) + 150)) +
              labs(title = glue("{unique(NHSF_RawFilter_MPA()$ScientificName)}"),
                   subtitle = NHSF_RawFilter_MPA()$MPA_Name,
                   color = "Common Name",
                   x = "Year",
                   y = "Size Distribution (mm)") +
              facet_grid(rows = vars(ReserveStatus), scales = NHSF_AxisScale_SD_MPA()) +
              scale_fill_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold")) 
          })
        }
      })
      
    }
    
  }
  
  { # ........ NHSF_MeanSizes ........   ----
    
    { # NHSF_MS_One_Species   ----
      
      NHSF_Filter_One <- reactive({ 
        NHSF_DF %>%
          dplyr::filter(SiteName == input$NHSF_SiteName_One,
                        CommonName == input$NHSF_SpeciesName_One) %>%
          dplyr::select(SurveyYear, Date, SiteName, IslandName, ScientificName, CommonName, MeanSize, 
                        StandardError, StandardError, TotalCount, MeanDepth, Island_Mean,
                        Species, SiteNumber, IslandCode, SiteCode, IslandSE) 
      }) # filtered one meter summary table
      
      NHSF_SpeciesClass_One <- reactive({ 
        SpeciesName %>%
          dplyr::filter(CommonName == input$NHSF_SpeciesName_One) %>%
          dplyr::select(ScientificName, Kingdom, Phylum, Class, Order, Family, Genus, "Species (Used by KFM)",
                        Status, "Currently Accepted Name", "Authority (Accepted)", CommonName) %>%
          tidyr::pivot_longer(-ScientificName, names_to = "Rank", values_to = "Name") %>%
          dplyr::select(Rank, Name)
      }) # filtered Species classification table
      
      NHSF_SpeciesDescription_One <- reactive({
        SpeciesName %>%
          dplyr::filter(CommonName == input$NHSF_SpeciesName_One) %>%
          dplyr::select(ScientificName, "Geographic Range", Identification, Habitat, "Size Range", "Trophic Level", Abundance) %>%
          tidyr::pivot_longer(-ScientificName, names_to = "Category", values_to = "Information") %>%
          dplyr::select(Category, Information)
      }) # filtered Species Description table  
      
      output$NHSF_TopPhoto_One <- renderImage({
        
        if (input$NHSF_allORone_MS ==  'One Species by Site' && input$NHSF_SpeciesName_One == unique(NHSF_Filter_One()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(NHSF_Filter_One()$Species)}.jpg"),
            contentType = "image/jpg", width = 210, height = 210))
        }
        else if (input$NHSF_allORone_MS ==  'One Species by Island' && input$NHSF_SpeciesName_Isl == unique(NHSF_FilterByIsl_Isl()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(NHSF_FilterByIsl_Isl()$Species)}.jpg"),
            contentType = "image/jpg", width = 210, height = 210))
        }
        else if (input$NHSF_allORone_MS ==  'One Species by MPA' && input$NHSF_SpeciesName_MPA == unique(NHSF_Filter_MPA()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(NHSF_Filter_MPA()$Species)}.jpg"),
            contentType = "image/jpg", width = 210, height = 210))
        }
        else if (input$NHSF_allORone_MS ==  'Two Species by Site' && input$NHSF_SpeciesName_Two_One == unique(NHSF_Filter_Two_One()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(NHSF_Filter_Two_One()$Species)}.jpg"),
            contentType = "image/jpg", width = 210, height = 210))
        }
      }, deleteFile = FALSE) # Small species photo above plot
      
      output$NHSF_TopPhoto_Two <- renderImage({
        
        if (input$NHSF_allORone_MS ==  'Two Species by Site' && input$NHSF_SpeciesName_Two_Two == unique(NHSF_Filter_Two_Two()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(NHSF_Filter_Two_Two()$Species)}.jpg"),
            contentType = "image/jpg", width = 210, height = 210))
        }
      }, deleteFile = FALSE) # 2nd Small species photo above plot
      
      output$NHSF_LargeSpPhoto_One <- renderImage({
        list(src = glue("www/Indicator_Species/{unique(NHSF_Filter_One()$Species)}.jpg"),
             contentType = "image/jpg", width = 400, height = 400)
      }, deleteFile = FALSE) # Large species photo below plot
      
      output$NHSF_TopSitePhoto_One <- renderImage({
        list(src = glue("www/Sat_Imagery/{unique(NHSF_Filter_One()$SiteCode)}.png"),
             contentType = "image/png", width = 430, height = 210)
      }, deleteFile = FALSE) # Small Site photo above plot
      
      output$NHSF_LargeSitePhoto_One <- renderImage({
        list(src = glue("www/Sat_Imagery/{unique(NHSF_Filter_One()$SiteCode)}.png"),
             contentType = "image/png", width = 1250, height = 625)
      }, deleteFile = FALSE) # Large Site photo below plot
      
      output$NHSF_DToutClass_One <- renderDT({
        datatable(NHSF_SpeciesClass_One(), 
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    searching = FALSE,
                    lengthChange = FALSE,
                    paging = FALSE,
                    ordering = FALSE,
                    info = FALSE),
                  rownames = FALSE) %>% 
          formatStyle(names(NHSF_SpeciesClass_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      }) # Species Classification data table
      
      output$NHSF_DToutDesc_One <- renderDT({
        datatable(NHSF_SpeciesDescription_One(), 
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    searching = FALSE,
                    lengthChange = FALSE,
                    paging = FALSE,
                    ordering = FALSE,
                    info = FALSE),
                  rownames = FALSE) %>% 
          formatStyle(names(NHSF_SpeciesDescription_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      }) # Species Description data table
      
      NHSF_alphaONI_one <- reactive({
        if(input$NHSF_GraphOptions_One == "With No Index"){
          return(0)
        }
        else if(input$NHSF_GraphOptions_One == "With ONI"){
          return(1)
        }
        else if(input$NHSF_GraphOptions_One == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$NHSF_GraphOptions_One == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      NHSF_alphaPDO_NOAA_one <- reactive({
        if(input$NHSF_GraphOptions_One == "With No Index"){
          return(0)
        }
        if(input$NHSF_GraphOptions_One == "With ONI"){
          return(0)
          
        }
        if(input$NHSF_GraphOptions_One == "With PDO (NOAA)"){
          return(1)
        }
        if(input$NHSF_GraphOptions_One == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      NHSF_alphaPDO_UW_one <- reactive({
        if(input$NHSF_GraphOptions_One == "With No Index"){
          return(0)
        }
        if(input$NHSF_GraphOptions_One == "With ONI"){
          return(0)
          
        }
        if(input$NHSF_GraphOptions_One == "With PDO (NOAA)"){
          return(0)
        }
        if(input$NHSF_GraphOptions_One == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$NHSF_ONIpdoPIC_One <- renderImage({
        if(input$NHSF_GraphOptions_One == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$NHSF_GraphOptions_One == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$NHSF_GraphOptions_One == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      NHSF_LinePlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(NHSF_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          geom_line(data = NHSF_Filter_One(),
                    aes(x = Date, y = MeanSize, group = ScientificName, color = CommonName), 
                    size = 1) +
          geom_errorbar(data = NHSF_Filter_One(),
                        aes(x = Date, ymin = MeanSize - StandardError, ymax = MeanSize + StandardError),
                        width = 0, color = "black", alpha = as.numeric(input$NHSF_EB_one)) +
          scale_x_date(date_labels = "%b %Y", breaks = unique(NHSF_Filter_One()$Date),
                       limits = c(min(as.Date(NHSF_Filter_One()$Date))-365, max(as.Date(NHSF_Filter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          labs(title = glue("{unique(NHSF_Filter_One()$ScientificName)}"),
               subtitle = glue("{unique(NHSF_Filter_One()$IslandName)} {unique(NHSF_Filter_One()$SiteName)}"),
               color = "Common Name",
               fill = "Oceanic Nino \nIndex Gradient",
               caption = glue("{NHSF_Filter_One()$SiteName} is typically surveyed in {
                       lubridate::month(round(mean(month(NHSF_Filter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                       } and has a mean depth of {round(mean(NHSF_Filter_One()$MeanDepth), 2)} ft"),
               x = "Year",
               y = "Mean Size (mm)") +
          scale_color_manual(values = SpeciesColor) +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
      }) # Main Line Plot
      
      NHSF_BarPlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(NHSF_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          new_scale_fill() +
          geom_col(data = NHSF_Filter_One(), aes(x = Date - ifelse(input$NHSF_DataSummary_One == "One species at one site", 0, 50),
                                                 y = MeanSize, fill = CommonName), 
                   position = "dodge", width = ifelse(input$NHSF_DataSummary_One == "One species at one site", 250, 100)) +
          geom_errorbar(data = NHSF_Filter_One(),
                        aes(x = Date - ifelse(input$NHSF_DataSummary_One == "One species at one site", 0, 50), 
                            ymin = MeanSize - StandardError, ymax = MeanSize + StandardError),
                        width = 0, color = "black", alpha = as.numeric(input$NHSF_EB_one)) +
          geom_text(data = NHSF_Filter_One(),
                    aes(x = Date - ifelse(input$NHSF_DataSummary_One == "One species at one site", 0, 50),
                        y = MeanSize, label = round(MeanSize, digits = 2)),
                    vjust = -.2, hjust = .5, alpha = as.numeric(input$NHSF_Bar_Text_One)) +
          scale_x_date(date_labels = "%b %Y", breaks = unique(NHSF_Filter_One()$Date),
                       limits = c(min(as.Date(NHSF_Filter_One()$Date))-365,  max(as.Date(NHSF_Filter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          labs(title = glue("{unique(NHSF_Filter_One()$ScientificName)}"),
               subtitle = glue("{unique(NHSF_Filter_One()$IslandName)} {unique(NHSF_Filter_One()$SiteName)}"),
               color = "Common Name",
               fill = "Common Name",
               caption = glue("{NHSF_Filter_One()$SiteName} is typically surveyed in {
                 lubridate::month(round(mean(month(NHSF_Filter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                 } and has a mean depth of {round(mean(NHSF_Filter_One()$MeanDepth), 2)} ft"),
               x = "Year",
               y = "Mean Size (mm)") +
          scale_fill_manual(values = SpeciesColor) +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
      }) # Main Bar Plot
      
      NHSF_SmoothPlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(NHSF_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          stat_smooth(data = NHSF_Filter_One(), 
                      aes(x = Date, y = MeanSize, group = ScientificName, color = CommonName), 
                      size = 1, span = input$NHSF_SmoothSlide_One, se = as.logical(input$NHSF_SmoothSE_One)) +
          scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 1)) +
          geom_point(data = NHSF_Filter_One(), aes(x = Date, y = MeanSize, color = CommonName), 
                     size = 2, alpha = as.numeric(input$NHSF_SmoothPoint_One)) +
          scale_x_date(date_labels = "%b %Y", breaks = unique(NHSF_Filter_One()$Date), 
                       limits = c(min(as.Date(NHSF_Filter_One()$Date))-365, 
                                  max(as.Date(NHSF_Filter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          labs(title = glue("{unique(NHSF_Filter_One()$ScientificName)}"), 
               subtitle = glue("{unique(NHSF_Filter_One()$IslandName)} {unique(NHSF_Filter_One()$SiteName)}"),
               color = "Common Name",
               caption = glue("{NHSF_Filter_One()$SiteName} is typically surveyed in {
                       lubridate::month(round(mean(month(NHSF_Filter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                       } and has a mean depth of {round(mean(NHSF_Filter_One()$MeanDepth), 2)} ft"),
               x = "Year", y = "Smoothed Conditional Mean Values") +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
      }) # Main Smooth Line Plot
      
      output$NHSF_Plot_One <- renderPlot({
        
        if (is.null(input$NHSF_Graph_One))
          return(NULL) 
        
        else if(input$NHSF_Graph_One == "Line" && input$NHSF_DataSummary_One == "One species at one site")
        {
          p <- NHSF_LinePlot_One()
        } 
        else if(input$NHSF_Graph_One == "Line" && input$NHSF_DataSummary_One == "One species with island average")
        {
          p <- NHSF_LinePlot_One() +
            new_scale_color() +
            geom_line(data = NHSF_Filter_One(),
                      aes(x = Date, y = Island_Mean, group = ScientificName, color = IslandName),
                      size = 1) +
            geom_errorbar(data = NHSF_Filter_One(),
                          aes(x = Date, ymin = Island_Mean - IslandSE,ymax = Island_Mean + IslandSE),
                          width = 0, color = "black", alpha = as.numeric(input$NHSF_EB_one)) +
            labs(color = "Island Average") +
            scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 2))
        }
        else if(input$NHSF_Graph_One == "Bar" && input$NHSF_DataSummary_One == "One species at one site") 
        {
          p <- NHSF_BarPlot_One()
        }
        else if(input$NHSF_Graph_One == "Bar" && input$NHSF_DataSummary_One == "One species with island average") 
        {
          p <- NHSF_BarPlot_One() +
            new_scale_fill() +
            geom_col(data = NHSF_Filter_One(),
                     aes(x = Date + 50, y = Island_Mean, fill = IslandName),
                     position = "dodge",
                     width = 100) +
            geom_errorbar(data = NHSF_Filter_One(),
                          aes(x = Date + 50, ymin = Island_Mean - IslandSE, ymax = Island_Mean + IslandSE),
                          width = 0, color = "black", alpha = as.numeric(input$NHSF_EB_one)) +
            scale_fill_manual(values = SpeciesColor, guide = guide_legend(order = 2)) +
            labs(fill = "Island Mean")
        } 
        else if(input$NHSF_Graph_One == "Smooth Line" && input$NHSF_DataSummary_One == "One species at one site")
        {
          p <- NHSF_SmoothPlot_One()
        }
        else if(input$NHSF_Graph_One == "Smooth Line" && input$NHSF_DataSummary_One == "One species with island average")
        {
          p <- NHSF_SmoothPlot_One() +
            new_scale_color() +
            stat_smooth(data = NHSF_Filter_One(), 
                        aes(x = Date, y = Island_Mean, group = ScientificName, color = IslandName), 
                        size = 1,
                        span = input$NHSF_SmoothSlide_One,
                        se = as.logical(input$NHSF_SmoothSE_One)) +
            geom_point(data = NHSF_Filter_One(), aes(x = Date, y = Island_Mean, color = IslandName), 
                       size = 2, alpha = as.numeric(input$NHSF_SmoothPoint_One)) +
            labs(color = "Island Average") +
            scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 2)) 
        }
        return(p)
      }) # Main Plot for NHSF_ Quadrats with one species 
      
      output$NHSF_BoxplotDescription_One <- renderImage({
        list(src = glue("www/Boxplot_Description.jpg"), contentType = "image/jpg", width = 550, height = 400)
      }, deleteFile = FALSE) # Boxplot drawing/explanation
      
      output$NHSF_DToutData_One <- renderDT({
        datatable(NHSF_Filter_One(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "500px",
                    scrollX = TRUE, 
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = c(list(list(visible = FALSE, targets = c(10, 12, 13, 14, 15))), 
                                   list(list(className = 'dt-center', targets = 0:11))),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(NHSF_Filter_One()),
                      color = "black",
                      backgroundColor = 'white'
          )
      }) # Filtered data table output
      
    }
    
    { # NHSF_MS_by_Island   ----
      
      NHSF_Filter_Isl <- reactive({
        NHSF_DF <- NHSF_DF %>%
          dplyr::filter(CommonName == input$NHSF_SpeciesName_Isl) %>%
          dplyr::group_by(SurveyYear, IslandName) %>%
          dplyr::mutate(Date = mean(Date),
                        MaxSumBar = sum(MeanSize)) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SiteName, SurveyYear) %>%
          dplyr::mutate(MaxSum = max(sum(MeanSize)))
        
      })
      
      NHSF_FilterByIsl_Isl <- reactive({
        NHSF_DF %>%
          dplyr::filter(CommonName == input$NHSF_SpeciesName_Isl) %>%
          dplyr::group_by(IslandDate, IslandCode, IslandName, Species, ScientificName, CommonName, SurveyYear) %>%
          dplyr::distinct(IslandDate, IslandCode, IslandName,Species, ScientificName, CommonName, SurveyYear, 
                          Island_Mean, IslandSD, IslandSE, IslandTotalCount) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SurveyYear) %>%
          dplyr::mutate(IslandDate = mean(IslandDate))
      })
      
      NHSF_yValue_Isl <- reactive({
        if(input$NHSF_BarOptions_Isl == "stack"){
          return({
            max(NHSF_Filter_Isl()$MaxSumBar)
          }) 
        }
        else if(input$NHSF_BarOptions_Isl == "dodge"){
          return({
            max(NHSF_Filter_Isl()$MeanSize)
          })
        }
        else if(input$NHSF_BarOptions_Isl == "fill"){
          return(1)
        }
      })
      
      NHSF_yLabel_Isl <- reactive({
        if(input$NHSF_BarOptions_Isl == "stack"){
          y <- "Combined Densities"
        }
        else if(input$NHSF_BarOptions_Isl == "dodge"){
          y <- "Seperated Densities"
        }
        else if(input$NHSF_BarOptions_Isl == "fill"){
          y <- "Normalized Densities"
        }
        y
      })
      
      NHSF_alphaONI_Isl <- reactive({
        if(input$NHSF_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        else if(input$NHSF_GraphOptions_Isl == "With ONI"){
          return(1)
        }
        else if(input$NHSF_GraphOptions_Isl == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$NHSF_GraphOptions_Isl == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      NHSF_alphaPDO_NOAA_Isl <- reactive({
        if(input$NHSF_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        if(input$NHSF_GraphOptions_Isl == "With ONI"){
          return(0)
          
        }
        if(input$NHSF_GraphOptions_Isl == "With PDO (NOAA)"){
          return(1)
        }
        if(input$NHSF_GraphOptions_Isl == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      NHSF_alphaPDO_UW_Isl <- reactive({
        if(input$NHSF_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        if(input$NHSF_GraphOptions_Isl == "With ONI"){
          return(0)
          
        }
        if(input$NHSF_GraphOptions_Isl == "With PDO (NOAA)"){
          return(0)
        }
        if(input$NHSF_GraphOptions_Isl == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$NHSF_ONIpdoPIC_Isl <- renderImage({
        if(input$NHSF_GraphOptions_Isl == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$NHSF_GraphOptions_Isl == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$NHSF_GraphOptions_Isl == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      NHSF_AxisScale_Isl <- reactive({
        if(input$NHSF_FreeOrLock_Isl == "Locked Scales"){
          return("fixed")
        }
        if(input$NHSF_FreeOrLock_Isl == "Free Scales"){
          return("free")
        }
      }) # Facet Plot Axis Scale free or fixed 
      
      output$NHSF_Plot_Isl1 <- renderPlot({ # Facet plots    ---- 
        
        if (is.null(input$NHSF_Graph_Isl))
          return(NULL) 
        
        else if(input$NHSF_Graph_Isl == "Line" && input$NHSF_DataSummary_Isl == "Island Mean") { # Line   ----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(NHSF_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = NHSF_FilterByIsl_Isl(), 
                        aes(x = IslandDate, y = Island_Mean, group = IslandName, color = IslandName),
                        size = 1) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(NHSF_FilterByIsl_Isl()$IslandDate))-365,
                                      max(as.Date(NHSF_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              geom_errorbar(data = NHSF_FilterByIsl_Isl(), 
                            aes(x = IslandDate, ymin = Island_Mean - IslandSE, ymax = Island_Mean + IslandSE),
                            width = 0, color = "black", alpha = as.numeric(input$NHSF_EB_Isl)) +
              labs(title = glue("{unique(NHSF_FilterByIsl_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Size (mm)") +
              facet_grid(rows = vars(IslandName), scales = NHSF_AxisScale_Isl()) +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        } 
        else if(input$NHSF_Graph_Isl == "Line" && input$NHSF_DataSummary_Isl == "Site Means (by Island)") {
          return({
            out <- by(data = NHSF_Filter_Isl(), INDICES = NHSF_Filter_Isl()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(NHSF_alphaONI_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_Isl()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_line(data = m, 
                          aes(Date, MeanSize, group = SiteName, colour = SiteName, linetype = SiteName),
                          size = 1) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date),
                             limits = c(min(as.Date(m$Date))-365, max(as.Date(m$Date))+365),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(limits = c(0, ifelse(input$NHSF_FreeOrLock_Isl == "Locked Scales", 
                                                        max(NHSF_Filter_Isl()$MaxSum), max(m$MeanSize))),
                                   expand = expansion(mult = c(0.01, .01))) +
                geom_errorbar(data = m, 
                              aes(x = Date, ymin = MeanSize - StandardError, ymax = MeanSize + StandardError),
                              width = 0, color = "black", alpha = as.numeric(input$NHSF_EB_Isl)) +
                labs(title = m$IslandName,
                     color = "Site Name",
                     linetype ="Site Name",
                     caption = "Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected",
                     x = NULL,
                     y = "Mean Size (mm)") +
                scale_color_manual(values = SiteColor, breaks = as.character(m$SiteName)) +
                scale_linetype_manual(values = SiteLine, breaks = as.character(m$SiteName)) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(NHSF_Filter_Isl()$ScientificName)}"),
                                          label_size = 20, label_fontface = "bold.italic"
            ))
          })
        } 
        else if(input$NHSF_Graph_Isl == "Bar" && input$NHSF_DataSummary_Isl == "Island Mean") { # Bar   ----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(NHSF_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = NHSF_FilterByIsl_Isl(), 
                       aes(x = IslandDate, y = Island_Mean, fill = IslandName),
                       position = "dodge",
                       width = 280) +
              facet_grid(rows = vars(IslandName), scales = NHSF_AxisScale_Isl()) +
              geom_text(data = NHSF_FilterByIsl_Isl(),
                        aes(x = IslandDate, y = Island_Mean, label = round(Island_Mean, digits = 2)),
                        position = position_dodge(1), vjust = -.2, hjust = .5, angle = 0, alpha = as.numeric(input$NHSF_Bar_Text_Isl)) +
              geom_errorbar(data = NHSF_FilterByIsl_Isl(), 
                            aes(x = IslandDate, ymin = Island_Mean - IslandSE, ymax = Island_Mean + IslandSE),
                            width = 0, color = "black", alpha = as.numeric(input$NHSF_EB_Isl)) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              scale_x_date(date_labels = "%b %Y", date_breaks = "1 year", 
                           limits = c(min(as.Date(NHSF_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(NHSF_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(NHSF_FilterByIsl_Isl()$ScientificName)}"),
                   subtitle = glue("{unique(NHSF_FilterByIsl_Isl()$CommonName)}"),
                   color = "Common Name",
                   fill = "Common Name",
                   x = "Year",
                   y = "Mean Size (mm)") +
              scale_fill_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$NHSF_Graph_Isl == "Bar" && input$NHSF_DataSummary_Isl == "Site Means (by Island)") {
          return({
            out <- by(data = NHSF_Filter_Isl(), INDICES = NHSF_Filter_Isl()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() +
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(NHSF_alphaONI_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_Isl()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                new_scale_fill() +
                geom_col(data = m, aes(x = Date, y = MeanSize, fill = SiteName),
                         position = input$NHSF_BarOptions_Isl, width = 280) +
                coord_cartesian(ylim = c(0, ifelse(input$NHSF_FreeOrLock_Isl == "Locked Scales", 
                                                   NHSF_yValue_Isl(), max(m$MaxSumBar)))) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date), expand = expansion(mult = c(0.01, .01)),
                             limits = c(min(as.Date(m$Date))-365, max(as.Date(m$Date))+365)) +
                labs(title = m$IslandName,
                     color = "Site Name",
                     fill = "Site Name",
                     x = "Year",
                     y = NHSF_yLabel_Isl()) +
                scale_fill_manual(values = SiteColor) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(NHSF_Filter_Isl()$ScientificName)}"),
                                          label_size = 20, label_fontface = "bold.italic"
            ))
          })
        } 
        else if(input$NHSF_Graph_Isl == "Smooth Line" && input$NHSF_DataSummary_Isl == "Island Mean") { # Smooth   -----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(NHSF_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_smooth(data = NHSF_FilterByIsl_Isl(), aes(x = IslandDate, y = Island_Mean, color = IslandName),
                          se = as.logical(input$NHSF_SmoothSE_Isl),
                          span = input$NHSF_SmoothSlide_Isl) +
              geom_point(data = NHSF_FilterByIsl_Isl(), aes(x = IslandDate, y = Island_Mean, color = IslandName),
                         size = 1, alpha = as.numeric(input$NHSF_SmoothPoint_Isl),inherit.aes = FALSE) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(NHSF_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(NHSF_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(NHSF_FilterByIsl_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Size (mm)") +
              facet_grid(rows = vars(IslandName), scales = NHSF_AxisScale_Isl()) +
              scale_color_manual(values = SpeciesColor, guide = guide_legend(nrow = 5)) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$NHSF_Graph_Isl == "Smooth Line" && input$NHSF_DataSummary_Isl == "Site Means (by Island)") { 
          return({
            out <- by(data = NHSF_Filter_Isl(), INDICES = NHSF_Filter_Isl()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() +
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(NHSF_alphaONI_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_Isl()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_point(data = m, aes(x = Date, y = MeanSize, color = SiteName),
                           size = 1, alpha = as.numeric(input$NHSF_SmoothPoint_Isl), inherit.aes = FALSE) +
                geom_smooth(data = m, aes(x = Date, y = MeanSize, color = SiteName),
                            se = as.logical(input$NHSF_SmoothSE_Isl),
                            span = input$NHSF_SmoothSlide_Isl) +
                scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                             limits = c(min(as.Date(NHSF_FilterByIsl_Isl()$IslandDate))-365, 
                                        max(as.Date(NHSF_FilterByIsl_Isl()$IslandDate))+365),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(limits = c(0, ifelse(input$NHSF_FreeOrLock_Isl == "Locked Scales", 
                                                        max(NHSF_Filter_Isl()$MaxSum), max(m$MeanSize))),
                                   expand = expansion(mult = c(0.01, .01))) +
                labs(title = glue("{unique(m$IslandName)}"), 
                     color = "Site Name",
                     x = "Year",
                     y = "Mean Size (mm)") +
                scale_color_manual(values = SiteColor) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 13, colour = "black", face = "bold"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(NHSF_Filter_Isl()$ScientificName)}"),
                                          label_size = 20, label_fontface = "bold.italic"
            ))
          })
        }
        
      })
      
      output$NHSF_Plot_Isl2 <- renderPlot({  # Single plot    ----
        
        if (is.null(input$NHSF_Graph_Isl))
          return(NULL) 
        
        else if(input$NHSF_Graph_Isl == "Line" && input$NHSF_DataSummary_Isl == "Island Mean") { # Line   ----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(NHSF_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = NHSF_FilterByIsl_Isl(), 
                        aes(x = IslandDate, y = Island_Mean, group = IslandName, color = IslandName),
                        size = 1) +
              scale_x_date(date_labels = "%Y", breaks = NHSF_FilterByIsl_Isl()$IslandDate, 
                           limits = c(min(as.Date(NHSF_FilterByIsl_Isl()$IslandDate))-365,
                                      max(as.Date(NHSF_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              geom_errorbar(data = NHSF_FilterByIsl_Isl(), 
                            aes(x = IslandDate, ymin = Island_Mean - IslandSE, ymax = Island_Mean + IslandSE),
                            width = 0, color = "black", alpha = as.numeric(input$NHSF_EB_Isl)) +
              labs(title = glue("{unique(NHSF_FilterByIsl_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Size (mm)") +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "right",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        } 
        else if(input$NHSF_Graph_Isl == "Line" && input$NHSF_DataSummary_Isl == "Site Means (by Island)") {
          return({
            ggplot() + 
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(NHSF_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = NHSF_Filter_Isl(), 
                        aes(Date, MeanSize, group = SiteName, colour = SiteName, linetype = SiteName),
                        size = 1) +
              scale_x_date(date_labels = "%Y", date_breaks = "1 year",
                           limits = c(min(as.Date(NHSF_FilterByIsl_Isl()$IslandDate))-365,
                                      max(as.Date(NHSF_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              scale_y_continuous(limits = c(0, max(NHSF_Filter_Isl()$MaxSum)), expand = expansion(mult = c(0.01, .01))) +
              geom_errorbar(data = NHSF_Filter_Isl(), 
                            aes(x = Date, ymin = MeanSize - StandardError, ymax = MeanSize + StandardError),
                            width = 0, color = "black", alpha = as.numeric(input$NHSF_EB_Isl)) +
              labs(title = NHSF_Filter_Isl()$IslandName,
                   color = "Site Name",
                   linetype ="Site Name",
                   caption = "Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected",
                   x = NULL,
                   y = "Mean Size (mm)") +
              geom_vline(size = 1, xintercept = as.Date("2005-07-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2005-07-01", format = "%Y-%m-%d"), 
                        y= Inf, aes(label = "16 New Sites Added"),
                        hjust = 0,
                        vjust = 1,
                        inherit.aes = FALSE) +
              geom_vline(size = 1, xintercept = as.Date("2001-06-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2001-06-01", format = "%Y-%m-%d"), 
                        y= Inf, aes(label = "Miracle Mile Added"),
                        hjust = 1,
                        vjust = 1,
                        inherit.aes = FALSE) +
              scale_color_manual(values = SiteColor2, guide = guide_legend(ncol = 10)) +
              scale_linetype_manual(values = SiteLine, guide = guide_legend(ncol = 10)) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.key.width = unit(1.5, "cm"),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 12, colour = "black"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$NHSF_Graph_Isl == "Bar" && input$NHSF_DataSummary_Isl == "Island Mean") { # Bar -----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(NHSF_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = NHSF_FilterByIsl_Isl(), 
                       aes(x = IslandDate, y = Island_Mean, fill = IslandName),
                       position = input$NHSF_BarOptions_Isl,
                       width = 280) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              scale_x_date(date_labels = "%Y", breaks = NHSF_FilterByIsl_Isl()$IslandDate, 
                           limits = c(min(as.Date(NHSF_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(NHSF_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(NHSF_FilterByIsl_Isl()$ScientificName)}"),
                   subtitle = glue("{unique(NHSF_FilterByIsl_Isl()$CommonName)}"),
                   color = "Common Name",
                   fill = "Common Name",
                   x = "Year",
                   y = NHSF_yLabel_Isl()) +
              scale_fill_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "right",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$NHSF_Graph_Isl == "Bar" && input$NHSF_DataSummary_Isl == "Site Means (by Island)") {
          return({
            ggplot() +
              geom_col(data = NHSF_Filter_Isl() %>% dplyr::group_by(SurveyYear) %>% dplyr::mutate(Date = mean(Date)), 
                       aes(x = Date-75, y = MeanSize, fill = SiteName),
                       position = input$NHSF_BarOptions_Isl,
                       width = 280) +
              scale_x_date(date_labels = "%Y", date_breaks = "1 year",
                           limits = c(min(as.Date(NHSF_Filter_Isl()$Date))-365,
                                      max(as.Date(NHSF_Filter_Isl()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = NHSF_Filter_Isl()$IslandName,
                   color = "Site Name",
                   fill = "Site Name",
                   x = "Year",
                   y = NHSF_yLabel_Isl()) +
              geom_vline(size = 1, xintercept = as.Date("2005-01-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2005-01-01", format = "%Y-%m-%d"), 
                        y= Inf, aes(label = "16 New Sites Added"),
                        hjust = 0,
                        vjust = 1,
                        inherit.aes = FALSE) +
              geom_vline(size = 1, xintercept = as.Date("2001-01-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2001-01-01", format = "%Y-%m-%d"), 
                        y= Inf, aes(label = "Miracle Mile Added"),
                        hjust = 1,
                        vjust = 1,
                        inherit.aes = FALSE) +
              scale_fill_manual(values = SiteColor2, guide = guide_legend(ncol = 10)) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.key.width = unit(1, "cm"),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 12, colour = "black"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        } 
        else if(input$NHSF_Graph_Isl == "Smooth Line" && input$NHSF_DataSummary_Isl == "Island Mean") { # Smooth   ----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(NHSF_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_point(data = NHSF_FilterByIsl_Isl(), aes(x = IslandDate, y = Island_Mean, color = IslandName), 
                         size = 2, alpha = as.numeric(input$NHSF_SmoothPoint_Isl)) +
              geom_smooth(data = NHSF_FilterByIsl_Isl(), aes(x= IslandDate, y = Island_Mean, color = IslandName),
                          se = as.logical(input$NHSF_SmoothSE_Isl), span = input$NHSF_SmoothSlide_Isl) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(NHSF_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(NHSF_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(NHSF_FilterByIsl_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Size (mm)") +
              scale_color_manual(values = SpeciesColor, guide = guide_legend(nrow = 5)) +
              theme_classic() +
              theme(legend.position = "right",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$NHSF_Graph_Isl == "Smooth Line" && input$NHSF_DataSummary_Isl == "Site Means (by Island)") {
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(NHSF_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_point(data = NHSF_Filter_Isl(), aes(x = Date, y = MeanSize, color = CommonName), 
                         size = 2, alpha = as.numeric(input$NHSF_SmoothPoint_Isl)) +
              geom_smooth(data = NHSF_Filter_Isl(), aes(x= Date, y = MeanSize, color = SiteName),
                          se = as.logical(input$NHSF_SmoothSE_Isl), span = input$NHSF_SmoothSlide_Isl) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(NHSF_Filter_Isl()$Date))-365, 
                                      max(as.Date(NHSF_Filter_Isl()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(NHSF_Filter_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Size (mm)") +
              scale_color_manual(values = SiteColor2, guide = guide_legend(nrow = 5)) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
      })
      
    }
    
    { # NHSF_MS__byMPA ----
      
      NHSF_Filter_MPA <- reactive({
        NHSF_DFMPA %>%
          dplyr::filter(CommonName == input$NHSF_SpeciesName_MPA) %>%
          dplyr::group_by(IslandCode, SurveyYear) %>%
          dplyr::mutate(Date = mean(Date),
                        MaxSumBar = max(sum(MeanSize))) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SiteName, SurveyYear) %>%
          dplyr::mutate(MaxSum = max(sum(MeanSize))) %>%
          arrange(SiteName)
      })
      
      NHSF_FilterBarSite_MPA <-reactive({
        NHSF_DFMPA %>%
          dplyr::filter(CommonName == input$NHSF_SpeciesName_MPA,
                        SiteName != "Keyhole") %>%
          dplyr::group_by(IslandCode, SurveyYear) %>%
          dplyr::mutate(Date = mean(Date),
                        MaxSumBar = max(sum(MeanSize))) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SiteName, SurveyYear) %>%
          dplyr::mutate(MaxSum = max(sum(MeanSize)))
      })
      
      NHSF_Inside_MPA <- reactive({
        NHSF_DFMPA %>% 
          dplyr::filter(CommonName == input$NHSF_SpeciesName_MPA,
                        ReserveStatus == "Inside",
                        SiteName != "Keyhole") %>%
          dplyr::group_by(MPA_Date, IslandCode, IslandName, Species, ScientificName, CommonName, SurveyYear) %>%
          dplyr::distinct(MPA_Date, IslandCode, IslandName,Species, ScientificName, CommonName, SurveyYear,
                          MPA_TotalCount, MPA_Mean, MPA_SD, MPA_SE, .keep_all = TRUE)
      })
      
      NHSF_Outside_MPA <- reactive({
        NHSF_DFMPA %>%
          dplyr::filter(CommonName == input$NHSF_SpeciesName_MPA,
                        ReserveStatus == "Outside",
                        SiteName != "Keyhole") %>%
          dplyr::group_by(MPA_Date, IslandCode, IslandName, Species, ScientificName, CommonName, SurveyYear) %>%
          dplyr::distinct(MPA_Date, IslandCode, IslandName,Species, ScientificName, CommonName, SurveyYear,
                          MPA_TotalCount, MPA_Mean, MPA_SD, MPA_SE, .keep_all = TRUE)
      })
      
      NHSF_alphaONI_MPA <- reactive({
        if(input$NHSF_GraphOptions_MPA == "With No Index"){
          return(0)
        }
        else if(input$NHSF_GraphOptions_MPA == "With ONI"){
          return(1)
        }
        else if(input$NHSF_GraphOptions_MPA == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$NHSF_GraphOptions_MPA == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      NHSF_alphaPDO_NOAA_MPA <- reactive({
        if(input$NHSF_GraphOptions_MPA == "With No Index"){
          return(0)
        }
        if(input$NHSF_GraphOptions_MPA == "With ONI"){
          return(0)
          
        }
        if(input$NHSF_GraphOptions_MPA == "With PDO (NOAA)"){
          return(1)
        }
        if(input$NHSF_GraphOptions_MPA == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      NHSF_alphaPDO_UW_MPA <- reactive({
        if(input$NHSF_GraphOptions_MPA == "With No Index"){
          return(0)
        }
        if(input$NHSF_GraphOptions_MPA == "With ONI"){
          return(0)
          
        }
        if(input$NHSF_GraphOptions_MPA == "With PDO (NOAA)"){
          return(0)
        }
        if(input$NHSF_GraphOptions_MPA == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$NHSF_ONIpdoPIC_MPA <- renderImage({
        if(input$NHSF_GraphOptions_MPA == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$NHSF_GraphOptions_MPA == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$NHSF_GraphOptions_MPA == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      NHSF_AxisScale_MPA <- reactive({
        if(input$NHSF_FreeOrLock_MPA == "Locked Scales"){
          return("fixed")
        }
        if(input$NHSF_FreeOrLock_MPA == "Free Scales"){
          return("free")
        }
      }) # Facet Plot Axis Scale free or fixed 
      
      output$NHSF_Plot_MPA <- renderPlot({
        if (is.null(input$NHSF_Graph_MPA))
          return(NULL)
        
        else if(input$NHSF_Graph_MPA == "Line" && input$NHSF_DataSummary_MPA == "MPA Mean") {  # Line    ----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(NHSF_alphaONI_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = NHSF_Filter_MPA() %>% dplyr::filter(SiteName != "Keyhole"), 
                        aes(x = MPA_Date, y = MPA_Mean, group = ReserveStatus, color = ReserveStatus, linetype = ReserveStatus),
                        size = 1) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(NHSF_Filter_MPA()$MPA_Date)), 
                                      max(as.Date(NHSF_Filter_MPA()$MPA_Date))),
                           expand = expansion(mult = c(0.01, .01))) +
              geom_errorbar(data = NHSF_Filter_MPA(), 
                            aes(x = MPA_Date, ymin = MPA_Mean - MPA_SE, ymax = MPA_Mean + MPA_SE),
                            width = 0, color = "black", alpha = as.numeric(input$NHSF_EB_MPA)) +
              labs(title = glue("{unique(NHSF_Filter_MPA()$ScientificName)}"),
                   subtitle = NHSF_Filter_MPA()$CommonName,
                   color = "Reserve Status",
                   linetype = "Reserve Status",
                   x = "Year",
                   y = "Mean Size (mm)") +
              scale_color_manual(values=c(Inside = "green3", Outside = "red3")) +
              scale_linetype_manual(values = c(Inside = "dashed", Outside = "solid")) +
              facet_grid(rows = vars(IslandName), scales = NHSF_AxisScale_MPA()) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    legend.key.width = unit(2, "cm"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"),
                    strip.text = element_text(size = 12, colour = "Black", angle = 90, face = "bold"))
          })
        }
        else if(input$NHSF_Graph_MPA == "Line" && input$NHSF_DataSummary_MPA == "Site Means (by MPA)") {
          return({
            out <- by(data = NHSF_Filter_MPA(), INDICES = NHSF_Filter_MPA()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(NHSF_alphaONI_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_MPA()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_line(data = m, 
                          aes(x = Date, MeanSize, group = SiteName, color = SiteName, linetype = SiteName),
                          size = 1) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date),
                             limits = c(min(as.Date(m$Date)), max(as.Date(m$Date))),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(limits = c(0, ifelse(input$NHSF_FreeOrLock_MPA == "Locked Scales", 
                                                        max(NHSF_Filter_MPA()$MaxSum), max(m$MeanSize))), 
                                   expand = expansion(mult = c(0.01, .01))) +
                geom_errorbar(data = m, 
                              aes(x = Date, ymin = MeanSize - StandardError, ymax = MeanSize + StandardError),
                              width = 0, color = "black", alpha = as.numeric(input$NHSF_EB_MPA)) +
                labs(title = m$MPA_Name,
                     color = "Site Name",
                     linetype = "Site Name",
                     caption = "Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected",
                     x = "Year",
                     y = "Mean Size (mm)") +
                scale_color_manual(values = SiteColor, breaks = as.character(m$SiteName)) +
                scale_linetype_manual(values = SiteLine, breaks = as.character(m$SiteName)) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(NHSF_Filter_MPA()$ScientificName)}"),
                                          label_size = 16,
                                          label_fontface = "bold.italic"
            ))
          })
        }
        else if(input$NHSF_Graph_MPA == "Bar" && input$NHSF_DataSummary_MPA == "MPA Mean") { # Bar    -----
          return({ 
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(NHSF_alphaONI_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = NHSF_Inside_MPA(), 
                       aes(x = MPA_Date - 60, y = MPA_Mean, group = ReserveStatus, fill = ReserveStatus),
                       width = 120) +
              geom_text(data = NHSF_Inside_MPA(),
                        aes(x = MPA_Date - 60, y = MPA_Mean, label = round(MPA_Mean, digits = 2)),
                        vjust = -.2, hjust = .5, angle = 0, alpha = as.numeric(input$NHSF_Bar_Text_MPA)) +
              geom_errorbar(data = NHSF_Inside_MPA(), 
                            aes(x = MPA_Date - 60, ymin = MPA_Mean - MPA_SE, ymax = MPA_Mean + MPA_SE),
                            width = 0, color = "black", alpha = as.numeric(input$NHSF_EB_MPA)) +
              geom_col(data = NHSF_Outside_MPA(), 
                       aes(x = MPA_Date + 60, y = MPA_Mean, group = ReserveStatus, fill = ReserveStatus),
                       width = 120) +
              geom_text(data = NHSF_Outside_MPA(),
                        aes(x = MPA_Date + 60, y = MPA_Mean, label = round(MPA_Mean, digits = 2)),
                        vjust = -.2, hjust = .5, angle = 0, alpha = as.numeric(input$NHSF_Bar_Text_MPA)) +
              geom_errorbar(data = NHSF_Outside_MPA(), 
                            aes(x = MPA_Date + 60, ymin = MPA_Mean - MPA_SE, ymax = MPA_Mean + MPA_SE),
                            width = 0, color = "black", alpha = as.numeric(input$NHSF_EB_MPA)) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(NHSF_Filter_MPA()$MPA_Date)) - 150, 
                                      max(as.Date(NHSF_Filter_MPA()$MPA_Date)) + 360),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(NHSF_Filter_MPA()$ScientificName)}"),
                   subtitle = NHSF_Filter_MPA()$CommonName,
                   color = "Reserve Status",
                   linetype = "Reserve Status",
                   x = "Year",
                   y = "Mean Size (mm)") +
              scale_fill_manual(values = c(Inside = "green3", Outside = "red3")) +
              facet_grid(rows = vars(IslandName), scales = NHSF_AxisScale_MPA()) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    legend.key.width = unit(2, "cm"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"),
                    strip.text = element_text(size = 12, colour = "Black", angle = 90, face = "bold"))
          })
        }
        else if(input$NHSF_Graph_MPA == "Bar" &&  input$NHSF_DataSummary_MPA == "Site Means (by MPA)") {
          return({
            out <- by(data = NHSF_FilterBarSite_MPA(), INDICES = NHSF_FilterBarSite_MPA()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() +
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(NHSF_alphaONI_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_MPA()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                new_scale_fill() +
                geom_col(data = m %>% dplyr::filter(ReserveStatus == "Inside"), 
                         aes(x = Date - 70, y = MeanSize, fill = SiteName),
                         position = "stack", width = 140) +
                geom_text(data = m %>% dplyr::filter(ReserveStatus == "Inside") %>% 
                            dplyr::group_by(IslandName, SurveyYear) %>% dplyr::mutate(SumBar = sum(MeanSize)),
                          aes(x = Date - 70, y = SumBar, label = "In"),
                          vjust = -.2, hjust = .5, angle = 0) +
                scale_fill_manual(values = SiteColor) +
                labs(fill = "Inside") +
                new_scale_fill() +
                geom_col(data = m %>% dplyr::filter(ReserveStatus == "Outside") , 
                         aes(x = Date + 70, y = MeanSize, fill = SiteName),
                         position = "stack", width = 140) +
                geom_text(data = m %>% dplyr::filter(ReserveStatus == "Outside") %>%
                            dplyr::group_by(IslandName, SurveyYear) %>%
                            dplyr::mutate(SumBar = sum(MeanSize)),
                          aes(x = Date + 70, y = SumBar, label = "Out"),
                          vjust = -.2, hjust = .5, angle = 0) +
                scale_y_continuous(limits = c(0, ifelse(input$NHSF_FreeOrLock_MPA == "Locked Scales", 
                                                        max(NHSF_Filter_MPA()$MaxSumBar), max(m$MeanSize))),
                                   expand = expansion(mult = c(0.01, .01))) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date), 
                             limits = c(min(as.Date(m$Date)) - 150, max(as.Date(m$Date))),
                             expand = expansion(mult = c(0.01, .01))) +
                labs(title = m$MPA_Name,
                     fill = "Outside",
                     x = "Year",
                     y = "Mean Size (mm)") +
                scale_fill_manual(values = SiteColor) +
                scale_color_manual(values = SiteColor) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(NHSF_Filter_MPA()$ScientificName)}"),
                                          label_size = 16,
                                          label_fontface = "bold.italic"
            ))
          })
        } 
        else if(input$NHSF_Graph_MPA == "Smooth Line" && input$NHSF_DataSummary_MPA == "MPA Mean") {  # Smooth       ----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(NHSF_alphaONI_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_point(data = NHSF_Filter_MPA() %>% dplyr::filter(SiteName != "Keyhole"), 
                         aes(x= MPA_Date, y = MPA_Mean, color = ReserveStatus),
                         size = 1, alpha = as.numeric(input$NHSF_SmoothPoint_MPA), show.legend = FALSE) +
              geom_smooth(data = NHSF_Filter_MPA() %>% dplyr::filter(SiteName != "Keyhole"), 
                          aes(x= MPA_Date, y = MPA_Mean, color = ReserveStatus),
                          se = as.logical(input$NHSF_SmoothSE_MPA),
                          span = input$NHSF_SmoothSlide_MPA) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(NHSF_Filter_MPA()$MPA_Date)), 
                                      max(as.Date(NHSF_Filter_MPA()$MPA_Date))),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(NHSF_Filter_MPA()$ScientificName)}"),
                   subtitle = NHSF_Filter_MPA()$CommonName,
                   color = "Reserve Status",
                   linetype = "Reserve Status",
                   x = "Year",
                   y = "Mean Size (mm)") +
              scale_color_manual(values=c(Inside = "green3", Outside = "red3")) +
              scale_linetype_manual(values = c(Inside = "dashed", Outside = "solid")) +
              facet_grid(rows = vars(IslandName), scales = NHSF_AxisScale_MPA()) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    legend.key.width = unit(2, "cm"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"),
                    strip.text = element_text(size = 12, colour = "Black", angle = 90, face = "bold"))
          })
        }
        else if(input$NHSF_Graph_MPA == "Smooth Line" && input$NHSF_DataSummary_MPA == "Site Means (by MPA)") {
          return({
            out <- by(data = NHSF_Filter_MPA(), INDICES = NHSF_Filter_MPA()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(NHSF_alphaONI_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_MPA()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_point(data = m, aes(x = Date, MeanSize, color = SiteName),
                           size = 1, alpha = as.numeric(input$NHSF_SmoothPoint_MPA), show.legend = FALSE) +
                geom_smooth(data = m, aes(x = Date, MeanSize, color = SiteName, linetype = SiteName),
                            se = as.logical(input$NHSF_SmoothSE_MPA),
                            span = input$NHSF_SmoothSlide_MPA) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date),
                             limits = c(min(as.Date(m$Date)) - 150, max(as.Date(m$Date))),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(limits = c(0, max(NHSF_Filter_MPA()$MaxSum)), expand = expansion(mult = c(0.01, .01))) +
                labs(title = m$MPA_Name,
                     color = "Site Name",
                     linetype = "Site Name",
                     caption = "Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected",
                     x = "Year",
                     y = "Mean Size (mm)") +
                scale_color_manual(values = SiteColor) +
                scale_linetype_manual(values = SiteLine) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(NHSF_Filter_MPA()$ScientificName)}"),
                                          label_size = 16,
                                          label_fontface = "bold.italic"
            ))
          })
        }
      })
      
    }
    
    { # NHSF_MS_Two_Species    ----
      
      NHSF_Filter_Two_One <- reactive({
        NHSF_DF %>%
          dplyr::filter(SiteName == input$NHSF_SiteName_Two,
                        CommonName == input$NHSF_SpeciesName_Two_One) %>%
          dplyr::select(SurveyYear, Date, SiteName, IslandName, ScientificName, CommonName, MeanSize, 
                        StandardError, StandardError, TotalCount, MeanDepth, Island_Mean,
                        Species, SiteNumber, IslandCode, SiteCode) 
      })
      
      NHSF_Filter_Two_Two <- reactive({
        NHSF_DF %>%
          dplyr::filter(SiteName == input$NHSF_SiteName_Two,
                        CommonName == input$NHSF_SpeciesName_Two_Two) %>%
          dplyr::select(SurveyYear, Date, SiteName, IslandName, ScientificName, CommonName, MeanSize, 
                        StandardError, StandardError, TotalCount, MeanDepth, Island_Mean,
                        Species, SiteNumber, IslandCode, SiteCode) 
      })
      
      output$NHSF_LargeSpPhoto_Two_1 <- renderImage({
        
        if (is.null(input$NHSF_SpeciesName_Two_One))
          return(NULL) 
        
        if (input$NHSF_SpeciesName_Two_One == unique(NHSF_Filter_Two_One()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(NHSF_Filter_Two_One()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(NHSF_Filter_Two_One()$CommonName)}"),
            width = 450,
            height = 450
          ))
        }
      }, deleteFile = FALSE)
      
      output$NHSF_LargeSpPhoto_Two_2 <- renderImage({
        
        if (input$NHSF_SpeciesName_Two_Two == unique(NHSF_Filter_Two_Two()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(NHSF_Filter_Two_Two()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(NHSF_Filter_Two_Two()$CommonName)}"),
            width = 450,
            height = 450
          ))
        }
      }, deleteFile = FALSE)
      
      output$NHSF_TopSitePhoto_Two <- renderImage({
        if (is.null(input$NHSF_SpeciesName_Two_One))
          return(NULL)
        
        if (input$NHSF_SiteName_Two == unique(NHSF_Filter_Two_One()$SiteName)) {
          return(list(
            src = glue("www/Sat_Imagery/{unique(NHSF_Filter_Two_One()$SiteCode)}.png"),
            contentType = "image/png",
            alt = glue("{unique(NHSF_Filter_Two_One()$SiteName)}"),
            width = 430,
            height = 210
          ))
        }
      }, deleteFile = FALSE)
      
      output$NHSF_LargeSitePhoto_Two <- renderImage({
        if (is.null(input$NHSF_SpeciesName_Two_One))
          return(NULL)
        
        if (input$NHSF_SiteName_Two == unique(NHSF_Filter_Two_One()$SiteName)) {
          return(list(
            src = glue("www/Sat_Imagery/{unique(NHSF_Filter_Two_One()$SiteCode)}.png"),
            contentType = "image/png",
            alt = glue("{unique(NHSF_Filter_Two_One()$SiteName)}"),
            width = 1250,
            height = 625
          ))
        }
      }, deleteFile = FALSE)
      
      NHSF_alphaONI_Two <- reactive({
        if(input$NHSF_GraphOptions_Two == "With No Index"){
          return(0)
        }
        else if(input$NHSF_GraphOptions_Two == "With ONI"){
          return(1)
        }
        else if(input$NHSF_GraphOptions_Two == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$NHSF_GraphOptions_Two == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      NHSF_alphaPDO_NOAA_Two <- reactive({
        if(input$NHSF_GraphOptions_Two == "With No Index"){
          return(0)
        }
        if(input$NHSF_GraphOptions_Two == "With ONI"){
          return(0)
          
        }
        if(input$NHSF_GraphOptions_Two == "With PDO (NOAA)"){
          return(1)
        }
        if(input$NHSF_GraphOptions_Two == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      NHSF_alphaPDO_UW_Two <- reactive({
        if(input$NHSF_GraphOptions_Two == "With No Index"){
          return(0)
        }
        if(input$NHSF_GraphOptions_Two == "With ONI"){
          return(0)
          
        }
        if(input$NHSF_GraphOptions_Two == "With PDO (NOAA)"){
          return(0)
        }
        if(input$NHSF_GraphOptions_Two == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$NHSF_ONIpdoPIC_Two <- renderImage({
        if(input$NHSF_GraphOptions_Two == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$NHSF_GraphOptions_Two == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$NHSF_GraphOptions_Two == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      output$NHSF_Plot_Two <- renderPlot({
        
        if (is.null(input$NHSF_Graph_Two))
          return(NULL) 
        
        else if(input$NHSF_Graph_Two == "Line"){
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(NHSF_alphaONI_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_Two()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = NHSF_Filter_Two_One(), 
                        aes(x = Date, y = MeanSize, group = ScientificName, color = CommonName),
                        size = 1) +
              geom_errorbar(data = NHSF_Filter_Two_One(),
                            aes(x = Date, ymin = MeanSize - StandardError, ymax = MeanSize + StandardError),
                            width = 0, color = "black", alpha = as.numeric(input$NHSF_EB_Two)) + 
              geom_line(data = NHSF_Filter_Two_Two(), 
                        aes(x = Date, y = MeanSize*input$NHSF_Y_Slide_Two, group = ScientificName, color = CommonName),
                        size = 1) +
              geom_errorbar(data = NHSF_Filter_Two_Two(),
                            aes(x = Date, ymin = MeanSize*input$NHSF_Y_Slide_Two - StandardError*input$NHSF_Y_Slide_Two, 
                                ymax = MeanSize*input$NHSF_Y_Slide_Two + StandardError*input$NHSF_Y_Slide_Two),
                            width = 0, color = "black", alpha = as.numeric(input$NHSF_EB_Two)) + 
              scale_y_continuous(sec.axis = sec_axis(~./input$NHSF_Y_Slide_Two, 
                                                     name = glue("{unique(NHSF_Filter_Two_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%b %Y", breaks = unique(NHSF_Filter_Two_One()$Date), 
                           limits = c(min(as.Date(NHSF_Filter_Two_One()$Date))-365, 
                                      max(as.Date(NHSF_Filter_Two_One()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(NHSF_Filter_Two_One()$ScientificName)
                              } and {unique(NHSF_Filter_Two_Two()$ScientificName)}"), 
                   subtitle = glue("{unique(NHSF_Filter_Two_One()$IslandName)} {unique(NHSF_Filter_Two_One()$SiteName)}"),
                   color = "Common Name",
                   caption = 
                     glue(
                       "{NHSF_Filter_Two_One()$SiteName} is typically surveyed in {
                     lubridate::month(round(mean(month(NHSF_Filter_Two_One()$Date)), 0), label = TRUE, abbr = FALSE)
                     } and has a mean depth of {round(mean(NHSF_Filter_Two_One()$MeanDepth), 2)} ft"),
                   x = "Year",
                   y = glue('{unique(NHSF_Filter_Two_One()$CommonName)} Mean Density')) +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
          })}
        else if(input$NHSF_Graph_Two == "Bar") {
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(NHSF_alphaONI_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_Two()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = NHSF_Filter_Two_One(), 
                       aes(x = Date - 50, y = MeanSize, fill = CommonName),
                       position = "dodge",
                       width = 100) +
              geom_col(data = NHSF_Filter_Two_Two(), 
                       aes(x = Date + 50, y = MeanSize*input$NHSF_Y_Slide_Two, fill = CommonName),
                       position = "dodge",
                       width = 100) +
              geom_errorbar(data = NHSF_Filter_Two_One(),
                            aes(x = Date - 50, ymin = MeanSize - StandardError, ymax = MeanSize + StandardError),
                            width = 0, color = "black", alpha = as.numeric(input$NHSF_EB_Two)) + 
              geom_errorbar(data = NHSF_Filter_Two_Two(),
                            aes(x = Date + 50, ymin = MeanSize*input$NHSF_Y_Slide_Two - StandardError*input$NHSF_Y_Slide_Two, 
                                ymax = MeanSize*input$NHSF_Y_Slide_Two + StandardError*input$NHSF_Y_Slide_Two),
                            width = 0, color = "black", alpha = as.numeric(input$NHSF_EB_Two)) + 
              scale_y_continuous(sec.axis = sec_axis(~./input$NHSF_Y_Slide_Two, 
                                                     name = glue("{unique(NHSF_Filter_Two_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%b %Y", breaks = unique(NHSF_Filter_Two_One()$Date),
                           limits = c(min(as.Date(NHSF_Filter_Two_One()$Date))-365,
                                      max(as.Date(NHSF_Filter_Two_One()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(NHSF_Filter_Two_One()$ScientificName)
                              } and {unique(NHSF_Filter_Two_Two()$ScientificName)}"),
                   subtitle = glue("{unique(NHSF_Filter_Two_One()$IslandName)} {unique(NHSF_Filter_Two_One()$SiteName)}"),
                   color = "Common Name",
                   caption =
                     glue(
                       "{NHSF_Filter_Two_One()$SiteName} is typically surveyed in {
                     lubridate::month(round(mean(month(NHSF_Filter_Two_One()$Date)), 0), label = TRUE, abbr = FALSE)
                     } and has a mean depth of {round(mean(NHSF_Filter_Two_One()$MeanDepth), 2)} ft"),
                   x = "Year",
                   y = "Mean Size (mm)") +
              scale_fill_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
          })}
        else if(input$NHSF_Graph_Two == "Smooth Line"){
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(NHSF_alphaONI_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_NOAA_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(NHSF_alphaPDO_UW_Two()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_smooth(data = NHSF_Filter_Two_One(), 
                          aes(x = Date, y = MeanSize, group = ScientificName, color = CommonName),
                          size = 1,  span = input$NHSF_SmoothSlide_Two, se = as.logical(input$NHSF_SmoothSE_Two)) +
              geom_point(data = NHSF_Filter_Two_One(),
                         aes(x = Date, y = MeanSize, color = CommonName),
                         size = 1, alpha = as.numeric(input$NHSF_SmoothPoint_Two)) +
              geom_smooth(data = NHSF_Filter_Two_Two(), 
                          aes(x = Date, y = MeanSize*input$NHSF_Y_Slide_Two, group = ScientificName, color = CommonName),
                          size = 1,  span = input$NHSF_SmoothSlide_Two, se = as.logical(input$NHSF_SmoothSE_Two)) +
              geom_point(data = NHSF_Filter_Two_Two(),
                         aes(x = Date, y = MeanSize*input$NHSF_Y_Slide_Two, color = CommonName),
                         size = 1, alpha = as.numeric(input$NHSF_SmoothPoint_Two)) +
              scale_y_continuous(sec.axis = sec_axis(~./input$NHSF_Y_Slide_Two, 
                                                     name = glue("{unique(NHSF_Filter_Two_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%b %Y", breaks = unique(NHSF_Filter_Two_One()$Date), 
                           limits = c(min(as.Date(NHSF_Filter_Two_One()$Date))-365, 
                                      max(as.Date(NHSF_Filter_Two_One()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(NHSF_Filter_Two_One()$ScientificName)
                              } and {unique(NHSF_Filter_Two_Two()$ScientificName)}"), 
                   subtitle = glue("{unique(NHSF_Filter_Two_One()$IslandName)} {unique(NHSF_Filter_Two_One()$SiteName)}"),
                   color = "Common Name",
                   caption = 
                     glue(
                       "{NHSF_Filter_Two_One()$SiteName} is typically surveyed in {
                     lubridate::month(round(mean(month(NHSF_Filter_Two_One()$Date)), 0), label = TRUE, abbr = FALSE)
                     } and has a mean depth of {round(mean(NHSF_Filter_Two_One()$MeanDepth), 2)} ft"),
                   x = "Year",
                   y = glue('{unique(NHSF_Filter_Two_One()$CommonName)} Mean Density')) +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
          })}
      })
      
      output$NHSF_DToutData_Two_1 <- renderDT({
        datatable(NHSF_Filter_Two_One(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "500px",
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = c(list(list(visible = FALSE, targets = c(1, 3, 4, 7, 8, 9, 10, 11, 12, 13, 14, 15))), 
                                   list(list(className = 'dt-center', targets = 0:6))),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(NHSF_Filter_Two_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      })
      
      output$NHSF_DToutData_Two_2 <- renderDT({
        datatable(NHSF_Filter_Two_Two(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "500px",
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = c(list(list(visible = FALSE, targets = c(1, 3, 4, 7, 8, 9, 10, 11, 12, 13, 14, 15))), 
                                   list(list(className = 'dt-center', targets = 0:6))),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(NHSF_Filter_Two_Two()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      })
      
    }
    
    { # NHSF_MS_all   ----
      
      NHSF_Filter_All <- reactive({
        NHSF_DF %>%
          dplyr::filter(SiteName == input$NHSF_SiteNameAll) %>%
          drop_na()
      })
      
      output$NHSF_Plot_All <- renderPlot({
        if (is.null(input$NHSF_GraphAll))
          return(NULL)
        
        if (input$NHSF_GraphAll == "Line") {
          return({
            out <- by(data = NHSF_Filter_All(), INDICES = NHSF_Filter_All()$CommonName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_line(data = m, 
                          aes(Date, MeanSize, group = CommonName, colour = CommonName, linetype = SiteName),
                          size = 1) +
                scale_x_date(date_labels = "%b %Y", breaks = unique(m$Date),
                             expand = expansion(mult = c(0.01, .01))) +
                geom_errorbar(data = m, 
                              aes(x = Date, ymin = MeanSize - StandardError,
                                  ymax = MeanSize + StandardError),
                              width = 0.25,
                              color = "black") +
                labs(title = m$ScientificName, 
                     subtitle = glue("{m$IslandName} {m$SiteName}"),
                     color = "Common Name",
                     x = "Year",
                     y = "Mean Size (mm)") +
                scale_color_manual(values = SpeciesColor) +
                scale_linetype_manual(values = SiteLine, guide = FALSE) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 13, colour = "black", face = "bold"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
              
            })
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v'))
          })
        } 
        else if (input$NHSF_GraphAll == "Bar") {
          return({
            out <- by(data = NHSF_Filter_All(), INDICES = NHSF_Filter_All()$CommonName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_col(data = m, 
                         aes(x = Date, y = MeanSize, group = CommonName, fill = CommonName, linetype = SiteName),
                         width = 250) +
                geom_text(data = m, 
                          aes(x = Date, y = MeanSize, label = round(MeanSize, digits = 2)),
                          position = position_dodge(1),
                          vjust = -.2,
                          hjust = .5,
                          angle = 0) +
                scale_x_date(date_labels = "%b %Y", breaks = unique(m$Date),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(expand = expansion(mult = c(0, .1))) +
                labs(title = m$ScientificName, 
                     subtitle = glue("{m$IslandName} {m$SiteName}"),
                     color = "Common Name",
                     x = "Year",
                     y = "Mean Size (mm)") +
                scale_fill_manual(values = SpeciesColor) +
                scale_linetype_manual(values = SiteLine, guide = FALSE) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 13, colour = "black", face = "bold"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
              
            })
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v'))
          })
        } 
      })
      
    }
    
  }
  
  output$FSF_UIout <- renderUI({ # FSF_UI   ----
    if (is.null(input$FSF_allORone_MS))
      return(NULL)
    
    else if(input$FSF_allORone_SD == "One Species by Site" &&
            input$FSF_distORmean_One=='Size Distribution') { #  FSF_TP_One     ----
      dyn_ui <- tabPanel("Fish Sizes", value = 'FSF_TP',  
                         tags$hr(),
                         plotOutput(outputId = "FSF_Plot_SD_One",
                                    height = ifelse(input$FSF_Graph_SD_One == "Joy Plot", 1000, 500),
                                    width = ifelse(input$FSF_Graph_SD_One == "Joy Plot", '75%', '100%')),
                         tags$hr(),
                         conditionalPanel("input.FSF_GraphOptions_SD_One == 'With ONI' ||
                                           input.FSF_GraphOptions_SD_One == 'With PDO (NOAA)' ||
                                           input.FSF_GraphOptions_SD_One == 'With PDO (UW)'",
                                          imageOutput(outputId = "FSF_ONIpdoPIC_SD_One",
                                                      height = 75),
                                          tags$hr()),
                         conditionalPanel("input.FSF_GraphOptions_SD_One == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.FSF_GraphOptions_SD_One == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr()),
                         conditionalPanel("input.FSF_GraphOptions_SD_One == 'With PDO (UW)'",
                                          PDO_UW_tagList,
                                          tags$hr()),
                         conditionalPanel("input.FSF_Graph_SD_One == 'Boxplot'",
                                          imageOutput(outputId = "FSF_BoxplotDescription_SD_One"),
                                          tags$hr()),
                         fluidRow(column(4, tags$h2(tags$strong(input$FSF_SpeciesName_One)),
                                         imageOutput(outputId = "FSF_LargeSpPhoto_SD_One",
                                                     height = 500)),
                                  column(3, tags$h2(tags$strong("Species Classification")),
                                         DTOutput(outputId = "FSF_DToutClass_SD_One",
                                                  height = 500)),
                                  column(5, tags$h2(tags$strong("Species Description")),
                                         DTOutput(outputId = "FSF_DToutDesc_SD_One",
                                                  height = 500))),
                         
                         tags$hr(),
                         DTOutput(outputId = "FSF_DToutData_SD_One",
                                  height = 550),
                         tags$hr(), tags$hr()
      )
    } 
    else if(input$FSF_allORone_SD == "One Species by Island" &&
            input$FSF_distORmean_One=='Size Distribution') { #  FSF_TP_by_Isl      ---- 
      dyn_ui <- tabPanel("Fish Sizes", value = 'FSF_TP',
                         tags$hr(),
                         plotOutput(outputId = "FSF_Plot_SD_Isl",
                                    height = 1000),
                         tags$hr(),
                         conditionalPanel("input.FSF_GraphOptions_SD_Isl == 'With ONI' ||
                                           input.FSF_GraphOptions_SD_Isl == 'With PDO (NOAA)' ||
                                           input.FSF_GraphOptions_SD_Isl == 'With PDO (UW)'",
                                          imageOutput(outputId = "FSF_ONIpdoPIC_SD_Isl",
                                                      height = 75),
                                          tags$hr()),
                         conditionalPanel("input.FSF_GraphOptions_SD_Isl == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.FSF_GraphOptions_SD_Isl == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr()),
                         conditionalPanel("input.FSF_GraphOptions_SD_Isl == 'With PDO (UW)'",
                                          PDO_UW_tagList,
                                          tags$hr())
      )
    } 
    else if(input$FSF_allORone_SD == "One Species by MPA" &&
            input$FSF_distORmean_One=='Size Distribution') { #  FSF_TP_byMPA     ---- 
      dyn_ui <- tabPanel("Fish Sizes", value = 'FSF_TP',  
                         tags$hr(),
                         plotOutput(outputId = "FSF_Plot_SD_MPA",
                                    height = 500),
                         tags$hr(),
                         conditionalPanel("input.FSF_GraphOptions_SD_MPA == 'With ONI' ||
                                           input.FSF_GraphOptions_SD_MPA == 'With PDO (NOAA)' ||
                                           input.FSF_GraphOptions_SD_MPA == 'With PDO (UW)'",
                                          imageOutput(outputId = "FSF_ONIpdoPIC_SD_MPA",
                                                      height = 75),
                                          tags$hr()),
                         conditionalPanel("input.FSF_GraphOptions_SD_MPA == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.FSF_GraphOptions_SD_MPA == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr()),
                         conditionalPanel("input.FSF_GraphOptions_SD_MPA == 'With PDO (UW)'",
                                          PDO_UW_tagList,
                                          tags$hr()),
                         MPA_tagList,
                         tags$hr())
    }
    else if(input$FSF_allORone_MS == "One Species by Site" &&
            input$FSF_distORmean_One=='Mean Sizes') { #  FSF_TP_One     ----
      dyn_ui <- tabPanel("Fish Sizes", value = 'FSF_TP',  
                         tags$hr(),
                         plotOutput(outputId = "FSF_Plot_One",
                                    height = 500),
                         tags$hr(),
                         fluidRow(
                           column(3, conditionalPanel("input.FSF_Graph_One == 'Line' || input.FSF_Graph_One == 'Bar'",
                                                      radioButtons(inputId = "FSF_EB_one",
                                                                   label = "Show error bars?",
                                                                   choices = c("Yes" = 1, "No" = 0),
                                                                   inline = TRUE))),
                           column(3, conditionalPanel("input.FSF_Graph_One == 'Bar'",
                                                      radioButtons(inputId = "FSF_Bar_Text_One",
                                                                   label = "Show density value?",
                                                                   choices = c("Yes" = 1, "No" = 0), selected = 0,
                                                                   inline = TRUE))),
                           column(6, conditionalPanel("input.FSF_GraphOptions_One == 'With ONI' ||
                                                      input.FSF_GraphOptions_One == 'With PDO (NOAA)' ||
                                                      input.FSF_GraphOptions_One == 'With PDO (UW)'",
                                                      imageOutput(outputId = "FSF_ONIpdoPIC_One",
                                                                  height = 75)))),
                         conditionalPanel("input.FSF_Graph_One == 'Smooth Line'",
                                          sliderInput(inputId = "FSF_SmoothSlide_One",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "FSF_SmoothSE_One",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "FSF_SmoothPoint_One",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE)))),
                         conditionalPanel("input.FSF_GraphOptions_One == 'With ONI'",
                                          tags$hr(),
                                          ONI_tagList),
                         conditionalPanel("input.FSF_GraphOptions_One == 'With PDO (NOAA)'",
                                          tags$hr(),
                                          PDO_NOAA_tagList),
                         conditionalPanel("input.FSF_GraphOptions_One == 'With PDO (UW)'",
                                          tags$hr(),
                                          PDO_UW_tagList),
                         conditionalPanel("input.FSF_Graph_One == 'Boxplot'",
                                          tags$hr(),
                                          imageOutput(outputId = "FSF_BoxplotDescription_One")),
                         tags$hr(),
                         fluidRow(column(4, tags$h2(tags$strong(input$FSF_SpeciesName_One)),
                                         imageOutput(outputId = "FSF_LargeSpPhoto_One",
                                                     height = 500)),
                                  column(3, tags$h2(tags$strong("Species Classification")),
                                         DTOutput(outputId = "FSF_DToutClass_One",
                                                  height = 500)),
                                  column(5, tags$h2(tags$strong("Species Description")),
                                         DTOutput(outputId = "FSF_DToutDesc_One",
                                                  height = 500))),
                         
                         tags$hr(),
                         DTOutput(outputId = "FSF_DToutData_One",
                                  height = 550),
                         tags$hr(), tags$hr(),
                         imageOutput(outputId = "FSF_LargeSitePhoto_One",
                                     height = 625),
                         tags$hr()
      )
    } 
    else if(input$FSF_allORone_MS == "One Species by Island" &&
            input$FSF_distORmean_One=='Mean Sizes') { #  FSF_TP_by_Isl      ---- 
      dyn_ui <- tabPanel("Fish Sizes", value = 'FSF_TP',
                         tags$hr(),
                         conditionalPanel("input.FSF_FreeOrLock_Isl == 'Locked Scales' ||
                                          input.FSF_FreeOrLock_Isl == 'Free Scales'",
                                          plotOutput(outputId = "FSF_Plot_Isl1",
                                                     height = 1000)),
                         conditionalPanel("input.FSF_FreeOrLock_Isl == 'Single Plot'", 
                                          plotOutput(outputId = "FSF_Plot_Isl2",
                                                     height = 500)),
                         tags$hr(),
                         fluidRow(conditionalPanel("input.FSF_Graph_Isl == 'Line' || (input.FSF_Graph_Isl == 'Bar' && 
                                                   input.FSF_DataSummary_Isl == 'Island Mean' && 
                                                   input.FSF_FreeOrLock_Isl != 'Single Plot')",
                                                   column(3, radioButtons(inputId = "FSF_EB_Isl",
                                                                          label = "Show error bars?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                  conditionalPanel("input.FSF_Graph_Isl == 'Bar' && 
                                                   input.FSF_DataSummary_Isl == 'Island Mean' && 
                                                   input.FSF_FreeOrLock_Isl != 'Single Plot'",
                                                   column(3, radioButtons(inputId = "FSF_Bar_Text_Isl",
                                                                          label = "Show density value?",
                                                                          choices = c("Yes" = 1, "No" = 0), selected = 0,
                                                                          inline = TRUE))),
                                  conditionalPanel("(input.FSF_Graph_Isl == 'Bar' && 
                                                   input.FSF_DataSummary_Isl == 'Island Mean' && 
                                                   input.FSF_FreeOrLock_Isl != 'Locked Scales' && 
                                                   input.FSF_FreeOrLock_Isl != 'Free Scales') ||
                                                   (input.FSF_Graph_Isl == 'Bar' && 
                                                   input.FSF_DataSummary_Isl == 'Site Means (by Island)')",
                                                   column(3, radioButtons(inputId = "FSF_BarOptions_Isl",
                                                                          label =  "Bar Graph Options:",
                                                                          choices = c("Stack" = "stack", "Fill" = "fill", "Dodge" = "dodge"),
                                                                          inline = TRUE))),
                                  conditionalPanel("input.FSF_GraphOptions_Isl == 'With ONI' ||
                                                      input.FSF_GraphOptions_Isl == 'With PDO (NOAA)' ||
                                                      input.FSF_GraphOptions_Isl == 'With PDO (UW)'",
                                                   column(6, imageOutput(outputId = "FSF_ONIpdoPIC_Isl",
                                                                         height = 75)))),
                         fluidRow(conditionalPanel("input.FSF_Graph_Isl == 'Line' || input.FSF_Graph_Isl == 'Bar'",
                                                   tags$hr())),
                         conditionalPanel("input.FSF_Graph_Isl == 'Smooth Line'",
                                          sliderInput(inputId = "FSF_SmoothSlide_Isl",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "FSF_SmoothSE_Isl",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "FSF_SmoothPoint_Isl",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                          tags$hr()),
                         conditionalPanel("input.FSF_GraphOptions_Isl == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.FSF_GraphOptions_Isl == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr())
      )
    } 
    else if(input$FSF_allORone_MS == "One Species by MPA" &&
            input$FSF_distORmean_One=='Mean Sizes') { #  FSF_TP_byMPA     ---- 
      dyn_ui <- tabPanel("Fish Sizes", value = 'FSF_TP',  
                         tags$hr(),
                         plotOutput(outputId = "FSF_Plot_MPA",
                                    height = 850),
                         tags$hr(),
                         fluidRow(conditionalPanel("input.FSF_Graph_MPA == 'Line' || (input.FSF_Graph_MPA == 'Bar' && 
                                                   input.FSF_DataSummary_MPA == 'MPA Mean')",
                                                   column(3, radioButtons(inputId = "FSF_EB_MPA",
                                                                          label = "Show error bars?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                  conditionalPanel("input.FSF_Graph_MPA == 'Bar' && input.FSF_DataSummary_MPA == 'MPA Mean'",
                                                   column(3, radioButtons(inputId = "FSF_Bar_Text_MPA",
                                                                          label = "Show density value?",
                                                                          choices = c("Yes" = 1, "No" = 0), selected = 0,
                                                                          inline = TRUE))),
                                  conditionalPanel("input.FSF_GraphOptions_MPA == 'With ONI' ||
                                                      input.FSF_GraphOptions_MPA == 'With PDO (NOAA)' ||
                                                      input.FSF_GraphOptions_MPA == 'With PDO (UW)'",
                                                   column(6, imageOutput(outputId = "FSF_ONIpdoPIC_MPA",
                                                                         height = 75)))),
                         fluidRow(conditionalPanel("input.FSF_Graph_MPA == 'Line' || input.FSF_Graph_MPA == 'Bar'",
                                                   tags$hr())),
                         conditionalPanel("input.FSF_Graph_MPA == 'Smooth Line'",
                                          sliderInput(inputId = "FSF_SmoothSlide_MPA",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "FSF_SmoothSE_MPA",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "FSF_SmoothPoint_MPA",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE))),
                                          tags$hr()),
                         conditionalPanel("input.FSF_GraphOptions_MPA == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.FSF_GraphOptions_MPA == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr()),
                         MPA_tagList,
                         tags$hr())
    }
    else if(input$FSF_allORone_MS == "Two Species by Site" &&
            input$FSF_distORmean_One=='Mean Sizes') { #  FSF_TP_Two     ----
      dyn_ui <- tabPanel("Fish Sizes", value = 'FSF_TP',  
                         tags$hr(),
                         plotOutput(outputId = "FSF_Plot_Two",
                                    height = 500),
                         tags$hr(),
                         sliderInput(inputId = "FSF_Y_Slide_Two",
                                     label = "Adjust the second y-axis by a multiple of:",
                                     min = 1, max = 50, step = 1, value = 1, width = "100%", ticks = T),
                         conditionalPanel("input.FSF_Graph_Two == 'Smooth Line'",
                                          sliderInput(inputId = "FSF_SmoothSlide_Two",
                                                      label = "Span: Controls the amount of smoothing for the loess smoother. 
                                                      Smaller numbers produce wigglier lines, larger numbers produce smoother lines.",
                                                      min = 0, max = 1, step = .05, value = .5, width = "100%"),
                                          fluidRow(column(3, radioButtons(inputId = "FSF_SmoothSE_Two",
                                                                          label = "Show the standard error?",
                                                                          choices = c("Yes" = TRUE, "No" = FALSE),
                                                                          inline = TRUE)),
                                                   column(3, radioButtons(inputId = "FSF_SmoothPoint_Two",
                                                                          label = "Show the mean values?",
                                                                          choices = c("Yes" = 1, "No" = 0),
                                                                          inline = TRUE)))),
                         fluidRow(
                           conditionalPanel("input.FSF_Graph_Two == 'Line' || input.FSF_Graph_Two == 'Bar'",
                                            column(3, radioButtons(inputId = "FSF_EB_Two",
                                                                   label = "Show error bars?",
                                                                   choices = c("Yes" = 1, "No" = 0),
                                                                   inline = TRUE))),
                           conditionalPanel("input.FSF_GraphOptions_Two == 'With ONI' ||
                                                      input.FSF_GraphOptions_Two == 'With PDO (NOAA)' ||
                                                      input.FSF_GraphOptions_Two == 'With PDO (UW)'",
                                            column(6, imageOutput(outputId = "FSF_ONIpdoPIC_Two",
                                                                  height = 75)))),
                         tags$hr(),
                         conditionalPanel("input.FSF_GraphOptions_Two == 'With ONI'",
                                          ONI_tagList,
                                          tags$hr()),
                         conditionalPanel("input.FSF_GraphOptions_Two == 'With PDO (NOAA)'",
                                          PDO_NOAA_tagList,
                                          tags$hr()),
                         conditionalPanel("input.FSF_GraphOptions_Two == 'With PDO (UW)'",
                                          PDO_UW_tagList,
                                          tags$hr()),
                         fluidRow(column(6, tags$h1(tags$strong(input$FSF_SpeciesName_Two_One)),
                                         imageOutput(outputId = "FSF_LargeSpPhoto_Two_1",
                                                     height = 450)),
                                  column(6, tags$h1(tags$strong(input$FSF_SpeciesName_Two_Two)),
                                         imageOutput(outputId = "FSF_LargeSpPhoto_Two_2",
                                                     height = 450))),
                         tags$hr(),
                         fluidRow(column(6, tags$h1(tags$strong(input$FSF_SpeciesName_Two_One)),
                                         DTOutput(outputId = "FSF_DToutData_Two_1")),
                                  column(6, tags$h1(tags$strong(input$FSF_SpeciesName_Two_Two)),
                                         DTOutput(outputId = "FSF_DToutData_Two_2"))),
                         tags$hr(),
                         imageOutput(outputId = "FSF_LargeSitePhoto_Two",
                                     height = 625),
                         tags$hr()
      )
    }
    else if(input$FSF_allORone_MS == "All Species" &&
            input$FSF_distORmean_One=='Mean Sizes') { # FSF_TP_all   ----
      dyn_ui <- tabPanel("Fish Sizes", value = 'FSF_TP',  
                         fluidRow(column(12, tags$h1(tags$strong(
                           "This section has the species in the order they appear on the datasheet")))),
                         plotOutput(outputId = "FSF_Plot_All",
                                    height = 7000))
    }
    return(dyn_ui)
  })
  
  { # ........ FSF_SizeDist ........     ----
    
    { # FSF_SD_One_Species   ----
      
      FSF_RawFilter_One <- reactive({ 
        FSF_DFRaw %>%
          dplyr::filter(SiteName == input$FSF_SiteName_SD_One,
                        CommonName == input$FSF_SpeciesName_SD_One) %>% 
          expandRows(count = "Count") %>% 
          dplyr::group_by(SurveyYear) %>%
          dplyr::mutate(TotalCount = length(Size_cm),
                        MeanSize = mean(Size_cm)) %>%
          dplyr::select(SiteNumber, SurveyYear, Date, IslandName, SiteName, ScientificName, CommonName, 
                        Size_cm, TotalCount, MeanSize, IslandCode, SiteCode, ReserveStatus, MeanDepth, Species)
      }) # filtered  FSF_ raw table
      
      FSF_RawFilterSummary_One <- reactive({ 
        FSF_DFRaw %>%
          dplyr::filter(SiteName == input$FSF_SiteName_SD_One,
                        CommonName == input$FSF_SpeciesName_SD_One) %>% 
          dplyr::group_by(SurveyYear) %>%
          dplyr::mutate(TotalCount = length(Size_cm)) %>%
          dplyr::select(SiteNumber, SurveyYear, Date, IslandName, SiteName, ScientificName, CommonName, 
                        Size_cm, TotalCount, IslandCode, SiteCode, ReserveStatus, MeanDepth, Species)
      }) # filtered  FSF_ raw table
      
      FSF_SpeciesClass_SD_One <- reactive({ 
        SpeciesFish %>%
          dplyr::filter(CommonName == input$FSF_SpeciesName_SD_One) %>%
          dplyr::select(ScientificName, Kingdom, Phylum, Class, Order, Family, Genus, "Species (Used by KFM)",
                        Status, "Currently Accepted Name", "Authority (Accepted)", CommonName) %>%
          tidyr::pivot_longer(-ScientificName, names_to = "Rank", values_to = "Name") %>%
          dplyr::select(Rank, Name)
      }) # filtered Species classification table
      
      FSF_SpeciesDescription_SD_One <- reactive({
        SpeciesFish %>%
          dplyr::filter(CommonName == input$FSF_SpeciesName_SD_One) %>%
          dplyr::select(ScientificName, "Geographic Range", Identification, Habitat, "Size Range", "Trophic Level", Abundance) %>%
          tidyr::pivot_longer(-ScientificName, names_to = "Category", values_to = "Information") %>%
          dplyr::select(Category, Information)
      }) # filtered Species Description table  
      
      output$FSF_TopPhoto_SD_One <- renderImage({
        
        if (input$FSF_allORone_SD == 'One Species by Site') {
          return(list(src = glue("www/Indicator_Species/{unique(FSF_RawFilter_One()$Species)}.jpg"),
                      contentType = "image/jpg", width = 210, height = 210))
        }
        else if (input$FSF_allORone_SD == "One Species by Island") {
          return(list(src = glue("www/Indicator_Species/{unique(FSF_RawFilter_Isl()$Species)}.jpg"),
                      contentType = "image/jpg", width = 210, height = 210))
        }
        else if (input$FSF_allORone_SD == 'One Species by MPA') {
          return(list(src = glue("www/Indicator_Species/{unique(FSF_RawFilter_MPA()$Species)}.jpg"),
                      contentType = "image/jpg", width = 210, height = 210))
        }
      }, deleteFile = FALSE) # Small species photo above plot
      
      output$FSF_LargeSpPhoto_SD_One <- renderImage({
        list(src = glue("www/Indicator_Species/{unique(FSF_RawFilter_One()$Species)}.jpg"),
             contentType = "image/jpg", width = 400, height = 400)
      }, deleteFile = FALSE) # Large species photo below plot
      
      output$FSF_TopSitePhoto_SD_One <- renderImage({
        if (input$FSF_allORone_SD == 'One Species by Site') {
          return(list(src = glue("www/Sat_Imagery/{unique(FSF_RawFilter_One()$SiteCode)}.png"),
                      contentType = "image/png", width = 430, height = 210))
        }
        else if (input$FSF_allORone_SD == "One Species by Island") {
          return(list(src = "www/Sat_Imagery/CHISisl.png",
                      contentType = "image/png", width = 430, height = 210))
        }
        else if (input$FSF_allORone_SD == 'One Species by MPA') {
          return(list(src = "www/Sat_Imagery/CHISmpa.png",
                      contentType = "image/png", width = 430, height = 210))
        }
        
      }, deleteFile = FALSE) # Small Site photo above plot
      
      output$FSF_LargeSitePhoto_SD_One <- renderImage({
        if (input$FSF_allORone_SD == 'One Species by Site') {
          return(list(src = glue("www/Sat_Imagery/{unique(FSF_RawFilter_One()$SiteCode)}.png"),
                      contentType = "image/png", width = 1250, height = 625))
        }
        else if (input$FSF_allORone_SD == "One Species by Island") {
          return(list(src = "www/Sat_Imagery/CHISisl.png",
                      contentType = "image/png", width = 1250, height = 625))
        }
        else if (input$FSF_allORone_SD == 'One Species by MPA') {
          return(list(src = "www/Sat_Imagery/CHISmpa.png",
                      contentType = "image/png", width = 1250, height = 625))
        }
      }, deleteFile = FALSE) # Large Site photo below plot
      
      output$FSF_DToutClass_SD_One <- renderDT({
        datatable(FSF_SpeciesClass_SD_One(), 
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    searching = FALSE,
                    lengthChange = FALSE,
                    paging = FALSE,
                    ordering = FALSE,
                    info = FALSE),
                  rownames = FALSE) %>% 
          formatStyle(names(FSF_SpeciesClass_SD_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      }) # Species Classification data table
      
      output$FSF_DToutDesc_SD_One <- renderDT({
        datatable(FSF_SpeciesDescription_One(), 
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    searching = FALSE,
                    lengthChange = FALSE,
                    paging = FALSE,
                    ordering = FALSE,
                    info = FALSE),
                  rownames = FALSE) %>% 
          formatStyle(names(FSF_SpeciesDescription_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      }) # Species Description data table
      
      FSF_alphaONI_SD_one <- reactive({
        if(input$FSF_GraphOptions_SD_One == "With No Index"){
          return(0)
        }
        else if(input$FSF_GraphOptions_SD_One == "With ONI"){
          return(1)
        }
        else if(input$FSF_GraphOptions_SD_One == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$FSF_GraphOptions_SD_One == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      FSF_alphaPDO_NOAA_SD_one <- reactive({
        if(input$FSF_GraphOptions_SD_One == "With No Index"){
          return(0)
        }
        if(input$FSF_GraphOptions_SD_One == "With ONI"){
          return(0)
          
        }
        if(input$FSF_GraphOptions_SD_One == "With PDO (NOAA)"){
          return(1)
        }
        if(input$FSF_GraphOptions_SD_One == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      FSF_alphaPDO_UW_SD_one <- reactive({
        if(input$FSF_GraphOptions_SD_One == "With No Index"){
          return(0)
        }
        if(input$FSF_GraphOptions_SD_One == "With ONI"){
          return(0)
          
        }
        if(input$FSF_GraphOptions_SD_One == "With PDO (NOAA)"){
          return(0)
        }
        if(input$FSF_GraphOptions_SD_One == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$FSF_ONIpdoPIC_SD_One <- renderImage({
        if(input$FSF_GraphOptions_SD_One == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$FSF_GraphOptions_SD_One == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$FSF_GraphOptions_SD_One == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      output$FSF_Plot_SD_One <- renderPlot({
        
        if (is.null(input$FSF_Graph_SD_One))
          return(NULL) 
        
        else if(input$FSF_Graph_SD_One == "Boxplot"){
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(FSF_alphaONI_SD_one()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_SD_one()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_SD_one()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_boxplot(data = FSF_RawFilter_One(), width = 150,
                           aes(x = Date, y = Size_cm, group = SurveyYear, color = CommonName)) +
              geom_point(data = FSF_RawFilter_One(), size = 1, color = "black",
                         aes(x = Date, y = MeanSize, group = SurveyYear)) +
              geom_text(data = FSF_RawFilter_One(), size = 4, fontface = "plain",
                        aes(x = Date, y = -1, group = Date, label = paste(' n = \n', FSF_RawFilter_One()$TotalCount))) +
              scale_x_date(date_labels = "%Y", breaks = unique(FSF_RawFilter_One()$Date), expand = expansion(mult = c(0.01, .01)),
                           limits = c(min(FSF_RawFilter_One()$Date) - 150, max(FSF_RawFilter_One()$Date) + 150)) +
              labs(title = glue("{unique(FSF_RawFilter_One()$ScientificName)}"),
                   subtitle= glue("{unique(FSF_RawFilter_One()$IslandName)} {unique(FSF_RawFilter_One()$SiteName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Size Distribution (cm)") +
              scale_color_manual(values = FishColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$FSF_Graph_SD_One == "Violin Plot"){
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(FSF_alphaONI_SD_one()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_SD_one()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_SD_one()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_violin(data = FSF_RawFilter_One(), width = 150,
                          aes(x = Date, y = Size_cm, group = SurveyYear, color = CommonName, fill = CommonName)) +
              geom_point(data = FSF_RawFilter_One(), size = 1, color = "black",
                         aes(x = Date, y = MeanSize, group = SurveyYear)) +
              geom_text(data = FSF_RawFilter_One(), aes(x = Date, y = -1, group = Date, 
                                                        label = paste(' n = \n', FSF_RawFilter_One()$TotalCount)), size = 4) +
              scale_x_date(date_labels = "%Y", breaks = unique(FSF_RawFilter_One()$Date), expand = expansion(mult = c(0.01, .01)),
                           limits = c(min(FSF_RawFilter_One()$Date) - 150, max(FSF_RawFilter_One()$Date) + 150)) +
              labs(title = glue("{unique(FSF_RawFilter_One()$ScientificName)}"),
                   subtitle= glue("{unique(FSF_RawFilter_One()$IslandName)} {unique(FSF_RawFilter_One()$SiteName)}"), 
                   color = "Common Name",
                   fill = "Common Name",
                   x = "Year",
                   y = "Size Distribution (cm)") +
              scale_fill_manual(values = FishColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$FSF_Graph_SD_One == "Joy Plot"){
          return({
            ggplot() +
              geom_rect(data = oni, aes(ymin= DateStart, ymax = DateEnd,xmin = 0, xmax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(FSF_alphaONI_SD_one()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(ymin= DateStart, ymax = DateEnd, xmin = 0, xmax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_SD_one()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(ymin= DateStart, ymax = DateEnd, xmin = 0, xmax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_SD_one()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_density_ridges(data = FSF_RawFilter_One(), 
                                  aes(x = Size_cm, y = Date, group = SurveyYear, fill = CommonName, height = ..density..),
                                  rel_min_height = .01, alpha = .9, stat = "density", scale = 1) +
              scale_y_date(date_labels = "%Y", breaks = FSF_RawFilter_One()$Date, expand = c(0.05, 0),
                           limits = c(min(FSF_RawFilter_One()$Date) - 150, max(FSF_RawFilter_One()$Date) + 360)) +
              scale_x_continuous(limits = c(0, max(FSF_RawFilter_One()$Size_cm))) +
              labs(title = glue("{unique(FSF_RawFilter_One()$ScientificName)}"),
                   subtitle= glue("{unique(FSF_RawFilter_One()$IslandName)} {unique(FSF_RawFilter_One()$SiteCode)}"),
                   fill = "Common Name",
                   x = "Size Distribution (cm)",
                   y = "Year") +
              scale_fill_manual(values = FishColor) +
              theme_minimal() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
          })
        }
        
      }) # Main Plot for FSF_SD Quadrats with one species 
      
      output$FSF_BoxplotDescription_SD_One <- renderImage({
        list(src = glue("www/Boxplot_Description.jpg"), contentType = "image/jpg", width = 550, height = 400)
      }, deleteFile = FALSE) # Boxplot drawing/explanation
      
      output$FSF_DToutData_SD_One <- renderDT({
        datatable(FSF_RawFilterSummary_One(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "500px",
                    scrollX = TRUE, 
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = c(list(list(className = 'dt-center', targets = 0:11))),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(FSF_RawFilterSummary_One()),
                      color = "black",
                      backgroundColor = 'white')
      }) # Filtered data table output
      
    }
    
    { # FSF_SD_by_Island   ----
      
      FSF_RawFilter_Isl <- reactive({
        FSF_DFRaw %>%
          dplyr::filter(CommonName == input$FSF_SpeciesName_SD_Isl) %>%
          dplyr::group_by(SurveyYear) %>% 
          dplyr::mutate(Date = mean(as.Date(Date))) %>% 
          dplyr::ungroup() %>% 
          dplyr::group_by(SurveyYear, IslandName, CommonName) %>%
          dplyr::mutate(TotalCount = length(Size_cm),
                        MeanSize = mean(Size_cm))
      })
      
      FSF_alphaONI_SD_Isl <- reactive({
        if(input$FSF_GraphOptions_SD_Isl == "With No Index"){
          return(0)
        }
        else if(input$FSF_GraphOptions_SD_Isl == "With ONI"){
          return(1)
        }
        else if(input$FSF_GraphOptions_SD_Isl == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$FSF_GraphOptions_SD_Isl == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      FSF_alphaPDO_NOAA_SD_Isl <- reactive({
        if(input$FSF_GraphOptions_SD_Isl == "With No Index"){
          return(0)
        }
        if(input$FSF_GraphOptions_SD_Isl == "With ONI"){
          return(0)
          
        }
        if(input$FSF_GraphOptions_SD_Isl == "With PDO (NOAA)"){
          return(1)
        }
        if(input$FSF_GraphOptions_SD_Isl == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      FSF_alphaPDO_UW_SD_Isl <- reactive({
        if(input$FSF_GraphOptions_SD_Isl == "With No Index"){
          return(0)
        }
        if(input$FSF_GraphOptions_SD_Isl == "With ONI"){
          return(0)
          
        }
        if(input$FSF_GraphOptions_SD_Isl == "With PDO (NOAA)"){
          return(0)
        }
        if(input$FSF_GraphOptions_SD_Isl == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$FSF_ONIpdoPIC_SD_Isl <- renderImage({
        if(input$FSF_GraphOptions_SD_Isl == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$FSF_GraphOptions_SD_Isl == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$FSF_GraphOptions_SD_Isl == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      FSF_AxisScale_SD_Isl <- reactive({
        if(input$FSF_FreeOrLock_SD_Isl == "Locked Scales"){
          return("fixed")
        }
        if(input$FSF_FreeOrLock_SD_Isl == "Free Scales"){
          return("free")
        }
      }) # Facet Plot Axis Scale free or fixed 
      
      output$FSF_Plot_SD_Isl <- renderPlot({  
        
        if (is.null(input$FSF_Graph_Isl))
          return(NULL) 
        
        else if(input$FSF_Graph_SD_Isl == "Boxplot") { 
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(FSF_alphaONI_SD_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_SD_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_SD_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_boxplot(data = FSF_RawFilter_Isl(), width = 150,
                           aes(x = Date, y = Size_cm, group = SurveyYear, color = CommonName)) +
              geom_point(data = FSF_RawFilter_Isl(), size = 1, color = "black",
                         aes(x = Date, y = MeanSize, group = SurveyYear)) +
              scale_x_date(date_labels = "%Y", breaks = unique(FSF_RawFilter_Isl()$Date), expand = expansion(mult = c(0.01, .01)),
                           limits = c(min(FSF_RawFilter_Isl()$Date) - 150, max(FSF_RawFilter_Isl()$Date) + 150)) +
              labs(title = glue("{unique(FSF_RawFilter_Isl()$ScientificName)}"),
                   subtitle = glue("{unique(FSF_RawFilter_Isl()$CommonName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Size Distribution (cm)") +
              facet_grid(rows = vars(IslandName), scales = FSF_AxisScale_SD_Isl()) +
              scale_color_manual(values = FishColor) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        } 
        else if(input$FSF_Graph_SD_Isl == "Violin Plot") { 
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(FSF_alphaONI_SD_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_SD_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_SD_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_violin(data = FSF_RawFilter_Isl(), width = 150,
                          aes(x = Date, y = Size_cm, group = SurveyYear, fill = CommonName)) +
              geom_point(data = FSF_RawFilter_Isl(), size = 1, color = "black",
                         aes(x = Date, y = MeanSize, group = SurveyYear)) +
              scale_x_date(date_labels = "%Y", breaks = unique(FSF_RawFilter_Isl()$Date), expand = expansion(mult = c(0.01, .01)),
                           limits = c(min(FSF_RawFilter_Isl()$Date) - 150, max(FSF_RawFilter_Isl()$Date) + 150)) +
              labs(title = glue("{unique(FSF_RawFilter_Isl()$ScientificName)}"),
                   subtitle = glue("{unique(FSF_RawFilter_Isl()$CommonName)}"),
                   color = "Common Name",
                   x = "Year",
                   y = "Size Distribution (cm)") +
              facet_grid(rows = vars(IslandName), scales = FSF_AxisScale_SD_Isl()) +
              scale_fill_manual(values = FishColor) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
      })
      
    }
    
    { # FSF_SD_Server_byMPA ----
      
      FSF_RawFilter_MPA <- reactive({
        FSF_DFRawMPA %>%
          dplyr::filter(IslandName == input$FSF_IslandName_MPA,
                        CommonName == input$FSF_SpeciesName_SD_MPA) %>%
          expandRows(count = "Count") %>% 
          dplyr::group_by(SurveyYear, ReserveStatus) %>%
          dplyr::mutate(TotalCount = length(Size_cm),
                        MeanSize = mean(Size_cm)) %>% 
          dplyr::ungroup() %>% 
          dplyr::group_by(SurveyYear) %>% 
          dplyr::mutate(Date =  mean(as.Date(Date)))
      })
      
      FSF_alphaONI_SD_MPA <- reactive({
        if(input$FSF_GraphOptions_SD_MPA == "With No Index"){
          return(0)
        }
        else if(input$FSF_GraphOptions_SD_MPA == "With ONI"){
          return(1)
        }
        else if(input$FSF_GraphOptions_SD_MPA == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$FSF_GraphOptions_SD_MPA == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      FSF_alphaPDO_NOAA_SD_MPA <- reactive({
        if(input$FSF_GraphOptions_SD_MPA == "With No Index"){
          return(0)
        }
        if(input$FSF_GraphOptions_SD_MPA == "With ONI"){
          return(0)
          
        }
        if(input$FSF_GraphOptions_SD_MPA == "With PDO (NOAA)"){
          return(1)
        }
        if(input$FSF_GraphOptions_SD_MPA == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      FSF_alphaPDO_UW_SD_MPA <- reactive({
        if(input$FSF_GraphOptions_SD_MPA == "With No Index"){
          return(0)
        }
        if(input$FSF_GraphOptions_SD_MPA == "With ONI"){
          return(0)
          
        }
        if(input$FSF_GraphOptions_SD_MPA == "With PDO (NOAA)"){
          return(0)
        }
        if(input$FSF_GraphOptions_SD_MPA == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$FSF_ONIpdoPIC_SD_MPA <- renderImage({
        if(input$FSF_GraphOptions_SD_MPA == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$FSF_GraphOptions_SD_MPA == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$FSF_GraphOptions_SD_MPA == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      FSF_AxisScale_SD_MPA <- reactive({
        if(input$FSF_FreeOrLock_SD_MPA == "Locked Scales"){
          return("fixed")
        }
        if(input$FSF_FreeOrLock_SD_MPA == "Free Scales"){
          return("free")
        }
      }) # Facet Plot Axis Scale free or fixed 
      
      output$FSF_Plot_SD_MPA <- renderPlot({
        if (is.null(input$FSF_Graph_SD_MPA))
          return(NULL)
        
        else if(input$FSF_Graph_SD_MPA == "Boxplot") { 
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(FSF_alphaONI_SD_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_SD_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_SD_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_boxplot(data = FSF_RawFilter_MPA(), position = "dodge2", width = 175,
                           aes(x = Date, y = Size_cm, group = interaction(SurveyYear, ReserveStatus),
                               fill = ReserveStatus)) +
              scale_x_date(date_labels = "%Y", breaks = unique(FSF_RawFilter_MPA()$Date), expand = expansion(mult = c(0.01, .01)),
                           limits = c(min(FSF_RawFilter_MPA()$Date) - 150, max(FSF_RawFilter_MPA()$Date) + 150)) +
              labs(title = FSF_RawFilter_MPA()$ScientificName,
                   subtitle = FSF_RawFilter_MPA()$MPA_Name,
                   fill = "Reserve Status",
                   x = "Year",
                   y = "Size Distribution (cm)") +
              facet_grid(rows = ifelse(input$FSF_FreeOrLock_SD_MPA == "Locked Scales", vars(ReserveStatus), 
                                       ifelse(input$FSF_FreeOrLock_SD_MPA == "Free Scales", vars(ReserveStatus), 
                                              vars(CommonName))), scales = FSF_AxisScale_SD_MPA()) +
              scale_fill_manual(values = c(Inside = "green3", Outside = "red3")) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold")) 
          })
        } 
        else if(input$FSF_Graph_SD_MPA == "Violin Plot") { 
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(FSF_alphaONI_SD_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_SD_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_SD_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_violin(data = FSF_RawFilter_MPA(),
                          aes(x = Date, y = Size_cm, group = interaction(SurveyYear, ReserveStatus),
                              fill = ReserveStatus)) +
              scale_x_date(date_labels = "%Y", breaks = unique(FSF_RawFilter_MPA()$Date), expand = expansion(mult = c(0.01, .01)),
                           limits = c(min(FSF_RawFilter_MPA()$Date) - 150, max(FSF_RawFilter_MPA()$Date) + 150)) +
              labs(title = glue("{unique(FSF_RawFilter_MPA()$ScientificName)}"),
                   subtitle = FSF_RawFilter_MPA()$MPA_Name,
                   x = "Year",
                   y = "Size Distribution (cm)") +
              facet_grid(rows = ifelse(input$FSF_FreeOrLock_SD_MPA == "Locked Scales", vars(ReserveStatus), 
                                       ifelse(input$FSF_FreeOrLock_SD_MPA == "Free Scales", vars(ReserveStatus), 
                                              vars(CommonName))), scales = FSF_AxisScale_SD_MPA()) +
              scale_fill_manual(values = c(Inside = "green3", Outside = "red3")) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold")) 
          })
        }
      })
      
    }
    
  }
  
  { # ........ FSF_MeanSizes ........   ----
    
    { # FSF_MS_One_Species   ----
      
      FSF_Filter_One <- reactive({ 
        FSF_DF %>%
          dplyr::filter(SiteName == input$FSF_SiteName_One,
                        CommonName == input$FSF_SpeciesName_One) %>%
          dplyr::select(SurveyYear, Date, SiteName, IslandName, ScientificName, CommonName, MeanSize, 
                        StandardError, StandardError, TotalCount, MeanDepth, Island_Mean,
                        SiteNumber, IslandCode, SiteCode, IslandSE, Species) 
      }) # filtered summary table
      
      FSF_SpeciesClass_One <- reactive({ 
        SpeciesFish %>%
          dplyr::filter(CommonName == input$FSF_SpeciesName_One) %>%
          dplyr::select(ScientificName, Kingdom, Phylum, Class, Order, Family, Genus, "Species (Used by KFM)",
                        Status, "Currently Accepted Name", "Authority (Accepted)", CommonName) %>%
          tidyr::pivot_longer(-ScientificName, names_to = "Rank", values_to = "Name") %>%
          dplyr::select(Rank, Name)
      }) # filtered Species classification table
      
      FSF_SpeciesDescription_One <- reactive({
        SpeciesFish %>%
          dplyr::filter(CommonName == input$FSF_SpeciesName_One) %>%
          dplyr::select(ScientificName, "Geographic Range", Identification, Habitat, "Size Range", "Trophic Level", Abundance) %>%
          tidyr::pivot_longer(-ScientificName, names_to = "Category", values_to = "Information") %>%
          dplyr::select(Category, Information)
      }) # filtered Species Description table  
      
      output$FSF_TopPhoto_One <- renderImage({
        
        if (input$FSF_allORone_MS ==  'One Species by Site' && input$FSF_SpeciesName_One == unique(FSF_Filter_One()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(FSF_Filter_One()$Species)}.jpg"),
            contentType = "image/jpg", width = 210, height = 210))
        }
        else if (input$FSF_allORone_MS ==  'One Species by Island' && input$FSF_SpeciesName_Isl == unique(FSF_FilterByIsl_Isl()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(FSF_FilterByIsl_Isl()$Species)}.jpg"),
            contentType = "image/jpg", width = 210, height = 210))
        }
        else if (input$FSF_allORone_MS ==  'One Species by MPA' && input$FSF_SpeciesName_MPA == unique(FSF_Filter_MPA()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(FSF_Filter_MPA()$Species)}.jpg"),
            contentType = "image/jpg", width = 210, height = 210))
        }
        else if (input$FSF_allORone_MS ==  'Two Species by Site' && input$FSF_SpeciesName_Two_One == unique(FSF_Filter_Two_One()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(FSF_Filter_Two_One()$Species)}.jpg"),
            contentType = "image/jpg", width = 210, height = 210))
        }
      }, deleteFile = FALSE) # Small species photo above plot
      
      output$FSF_TopPhoto_Two <- renderImage({
        
        if (input$FSF_allORone_MS ==  'Two Species by Site' && input$FSF_SpeciesName_Two_Two == unique(FSF_Filter_Two_Two()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(FSF_Filter_Two_Two()$Species)}.jpg"),
            contentType = "image/jpg", width = 210, height = 210))
        }
      }, deleteFile = FALSE) # 2nd Small species photo above plot
      
      output$FSF_LargeSpPhoto_One <- renderImage({
        list(src = glue("www/Indicator_Species/{unique(FSF_Filter_One()$Species)}.jpg"),
             contentType = "image/jpg", width = 400, height = 400)
      }, deleteFile = FALSE) # Large species photo below plot
      
      output$FSF_TopSitePhoto_One <- renderImage({
        list(src = glue("www/Sat_Imagery/{unique(FSF_Filter_One()$SiteCode)}.png"),
             contentType = "image/png", width = 430, height = 210)
      }, deleteFile = FALSE) # Small Site photo above plot
      
      output$FSF_LargeSitePhoto_One <- renderImage({
        list(src = glue("www/Sat_Imagery/{unique(FSF_Filter_One()$SiteCode)}.png"),
             contentType = "image/png", width = 1250, height = 625)
      }, deleteFile = FALSE) # Large Site photo below plot
      
      output$FSF_DToutClass_One <- renderDT({
        datatable(FSF_SpeciesClass_One(), 
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    searching = FALSE,
                    lengthChange = FALSE,
                    paging = FALSE,
                    ordering = FALSE,
                    info = FALSE),
                  rownames = FALSE) %>% 
          formatStyle(names(FSF_SpeciesClass_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      }) # Species Classification data table
      
      output$FSF_DToutDesc_One <- renderDT({
        datatable(FSF_SpeciesDescription_One(), 
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    searching = FALSE,
                    lengthChange = FALSE,
                    paging = FALSE,
                    ordering = FALSE,
                    info = FALSE),
                  rownames = FALSE) %>% 
          formatStyle(names(FSF_SpeciesDescription_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      }) # Species Description data table
      
      FSF_alphaONI_one <- reactive({
        if(input$FSF_GraphOptions_One == "With No Index"){
          return(0)
        }
        else if(input$FSF_GraphOptions_One == "With ONI"){
          return(1)
        }
        else if(input$FSF_GraphOptions_One == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$FSF_GraphOptions_One == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      FSF_alphaPDO_NOAA_one <- reactive({
        if(input$FSF_GraphOptions_One == "With No Index"){
          return(0)
        }
        if(input$FSF_GraphOptions_One == "With ONI"){
          return(0)
          
        }
        if(input$FSF_GraphOptions_One == "With PDO (NOAA)"){
          return(1)
        }
        if(input$FSF_GraphOptions_One == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      FSF_alphaPDO_UW_one <- reactive({
        if(input$FSF_GraphOptions_One == "With No Index"){
          return(0)
        }
        if(input$FSF_GraphOptions_One == "With ONI"){
          return(0)
          
        }
        if(input$FSF_GraphOptions_One == "With PDO (NOAA)"){
          return(0)
        }
        if(input$FSF_GraphOptions_One == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$FSF_ONIpdoPIC_One <- renderImage({
        if(input$FSF_GraphOptions_One == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$FSF_GraphOptions_One == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$FSF_GraphOptions_One == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      FSF_LinePlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(FSF_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          geom_line(data = FSF_Filter_One(),
                    aes(x = Date, y = MeanSize, group = ScientificName, color = CommonName), 
                    size = 1) +
          geom_errorbar(data = FSF_Filter_One(),
                        aes(x = Date, ymin = MeanSize - StandardError, ymax = MeanSize + StandardError),
                        width = 0, color = "black", alpha = as.numeric(input$FSF_EB_one)) +
          scale_x_date(date_labels = "%b %Y", breaks = unique(FSF_Filter_One()$Date),
                       limits = c(min(as.Date(FSF_Filter_One()$Date))-365, max(as.Date(FSF_Filter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          labs(title = glue("{unique(FSF_Filter_One()$ScientificName)}"),
               subtitle = glue("{unique(FSF_Filter_One()$IslandName)} {unique(FSF_Filter_One()$SiteName)}"),
               color = "Common Name",
               fill = "Oceanic Nino \nIndex Gradient",
               caption = glue("{FSF_Filter_One()$SiteName} is typically surveyed in {
                       lubridate::month(round(mean(month(FSF_Filter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                       } and has a mean depth of {round(mean(FSF_Filter_One()$MeanDepth), 2)} ft"),
               x = "Year",
               y = "Mean Size (cm)") +
          scale_color_manual(values = FishColor) +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
      }) # Main Line Plot
      
      FSF_BarPlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(FSF_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          new_scale_fill() +
          geom_col(data = FSF_Filter_One(), aes(x = Date - ifelse(input$FSF_DataSummary_One == "One species at one site", 0, 50),
                                                y = MeanSize, fill = CommonName), 
                   position = "dodge", width = ifelse(input$FSF_DataSummary_One == "One species at one site", 250, 100)) +
          geom_errorbar(data = FSF_Filter_One(),
                        aes(x = Date - ifelse(input$FSF_DataSummary_One == "One species at one site", 0, 50), 
                            ymin = MeanSize - StandardError, ymax = MeanSize + StandardError),
                        width = 0, color = "black", alpha = as.numeric(input$FSF_EB_one)) +
          geom_text(data = FSF_Filter_One(),
                    aes(x = Date - ifelse(input$FSF_DataSummary_One == "One species at one site", 0, 50),
                        y = MeanSize, label = round(MeanSize, digits = 2)),
                    vjust = -.2, hjust = .5, alpha = as.numeric(input$FSF_Bar_Text_One)) +
          scale_x_date(date_labels = "%b %Y", breaks = unique(FSF_Filter_One()$Date),
                       limits = c(min(as.Date(FSF_Filter_One()$Date))-365,  max(as.Date(FSF_Filter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          labs(title = glue("{unique(FSF_Filter_One()$ScientificName)}"),
               subtitle = glue("{unique(FSF_Filter_One()$IslandName)} {unique(FSF_Filter_One()$SiteName)}"),
               color = "Common Name",
               fill = "Common Name",
               caption = glue("{FSF_Filter_One()$SiteName} is typically surveyed in {
                 lubridate::month(round(mean(month(FSF_Filter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                 } and has a mean depth of {round(mean(FSF_Filter_One()$MeanDepth), 2)} ft"),
               x = "Year",
               y = "Mean Size (cm)") +
          scale_fill_manual(values = FishColor) +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
      }) # Main Bar Plot
      
      FSF_SmoothPlot_One <- reactive({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(FSF_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_one()), show.legend = FALSE) +
          geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                    position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_one()), show.legend = FALSE) +
          scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
          stat_smooth(data = FSF_Filter_One(), 
                      aes(x = Date, y = MeanSize, group = ScientificName, color = CommonName), 
                      size = 1, span = input$FSF_SmoothSlide_One, se = as.logical(input$FSF_SmoothSE_One)) +
          scale_color_manual(values = FishColor, guide = guide_legend(order = 1)) +
          geom_point(data = FSF_Filter_One(), aes(x = Date, y = MeanSize, color = CommonName), 
                     size = 2, alpha = as.numeric(input$FSF_SmoothPoint_One)) +
          scale_x_date(date_labels = "%b %Y", breaks = unique(FSF_Filter_One()$Date), 
                       limits = c(min(as.Date(FSF_Filter_One()$Date))-365, 
                                  max(as.Date(FSF_Filter_One()$Date))+365),
                       expand = expansion(mult = c(0.01, .01))) +
          labs(title = glue("{unique(FSF_Filter_One()$ScientificName)}"), 
               subtitle = glue("{unique(FSF_Filter_One()$IslandName)} {unique(FSF_Filter_One()$SiteName)}"),
               color = "Common Name",
               caption = glue("{FSF_Filter_One()$SiteName} is typically surveyed in {
                       lubridate::month(round(mean(month(FSF_Filter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                       } and has a mean depth of {round(mean(FSF_Filter_One()$MeanDepth), 2)} ft"),
               x = "Year", y = "Smoothed Conditional Mean Values") +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
      }) # Main Smooth Line Plot
      
      output$FSF_Plot_One <- renderPlot({
        
        if (is.null(input$FSF_Graph_One))
          return(NULL) 
        
        else if(input$FSF_Graph_One == "Line" && input$FSF_DataSummary_One == "One species at one site")
        {
          p <- FSF_LinePlot_One()
        } 
        else if(input$FSF_Graph_One == "Line" && input$FSF_DataSummary_One == "One species with island average")
        {
          p <- FSF_LinePlot_One() +
            new_scale_color() +
            geom_line(data = FSF_Filter_One(),
                      aes(x = Date, y = Island_Mean, group = ScientificName, color = IslandName),
                      size = 1) +
            geom_errorbar(data = FSF_Filter_One(),
                          aes(x = Date, ymin = Island_Mean - IslandSE,ymax = Island_Mean + IslandSE),
                          width = 0, color = "black", alpha = as.numeric(input$FSF_EB_one)) +
            labs(color = "Island Average") +
            scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 2))
        }
        else if(input$FSF_Graph_One == "Bar" && input$FSF_DataSummary_One == "One species at one site") 
        {
          p <- FSF_BarPlot_One()
        }
        else if(input$FSF_Graph_One == "Bar" && input$FSF_DataSummary_One == "One species with island average") 
        {
          p <- FSF_BarPlot_One() +
            new_scale_fill() +
            geom_col(data = FSF_Filter_One(),
                     aes(x = Date + 50, y = Island_Mean, fill = IslandName),
                     position = "dodge",
                     width = 100) +
            geom_errorbar(data = FSF_Filter_One(),
                          aes(x = Date + 50, ymin = Island_Mean - IslandSE, ymax = Island_Mean + IslandSE),
                          width = 0, color = "black", alpha = as.numeric(input$FSF_EB_one)) +
            scale_fill_manual(values = SpeciesColor, guide = guide_legend(order = 2)) +
            labs(fill = "Island Mean")
        } 
        else if(input$FSF_Graph_One == "Smooth Line" && input$FSF_DataSummary_One == "One species at one site")
        {
          p <- FSF_SmoothPlot_One()
        }
        else if(input$FSF_Graph_One == "Smooth Line" && input$FSF_DataSummary_One == "One species with island average")
        {
          p <- FSF_SmoothPlot_One() +
            new_scale_color() +
            stat_smooth(data = FSF_Filter_One(), 
                        aes(x = Date, y = Island_Mean, group = ScientificName, color = IslandName), 
                        size = 1,
                        span = input$FSF_SmoothSlide_One,
                        se = as.logical(input$FSF_SmoothSE_One)) +
            geom_point(data = FSF_Filter_One(), aes(x = Date, y = Island_Mean, color = IslandName), 
                       size = 2, alpha = as.numeric(input$FSF_SmoothPoint_One)) +
            labs(color = "Island Average") +
            scale_color_manual(values = SpeciesColor, guide = guide_legend(order = 2)) 
        }
        return(p)
      }) # Main Plot for FSF_ Quadrats with one species 
      
      output$FSF_BoxplotDescription_One <- renderImage({
        list(src = glue("www/Boxplot_Description.jpg"), contentType = "image/jpg", width = 550, height = 400)
      }, deleteFile = FALSE) # Boxplot drawing/explanation
      
      output$FSF_DToutData_One <- renderDT({
        datatable(FSF_Filter_One(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "500px",
                    scrollX = TRUE, 
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = c(list(list(visible = FALSE, targets = c(10, 12, 13, 14, 15))), 
                                   list(list(className = 'dt-center', targets = 0:11))),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(FSF_Filter_One()),
                      color = "black",
                      backgroundColor = 'white'
          )
      }) # Filtered data table output
      
    }
    
    { # FSF_MS_by_Island   ----
      
      FSF_Filter_Isl <- reactive({
        FSF_DF <- FSF_DF %>%
          dplyr::filter(CommonName == input$FSF_SpeciesName_Isl) %>%
          dplyr::group_by(SurveyYear, IslandName) %>%
          dplyr::mutate(Date = mean(Date),
                        MaxSumBar = sum(MeanSize)) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SiteName, SurveyYear) %>%
          dplyr::mutate(MaxSum = max(sum(MeanSize)))
        
      })
      
      FSF_FilterByIsl_Isl <- reactive({
        FSF_DF %>%
          dplyr::filter(CommonName == input$FSF_SpeciesName_Isl) %>%
          dplyr::group_by(IslandDate, IslandCode, IslandName, ScientificName, CommonName, SurveyYear) %>%
          dplyr::distinct(IslandDate, IslandCode, IslandName, ScientificName, CommonName, SurveyYear, 
                          Island_Mean, IslandSD, IslandSE, IslandTotalCount, Species) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SurveyYear) %>%
          dplyr::mutate(IslandDate = mean(IslandDate))
      })
      
      FSF_yValue_Isl <- reactive({
        if(input$FSF_BarOptions_Isl == "stack"){
          return({
            max(FSF_Filter_Isl()$MaxSumBar)
          }) 
        }
        else if(input$FSF_BarOptions_Isl == "dodge"){
          return({
            max(FSF_Filter_Isl()$MeanSize)
          })
        }
        else if(input$FSF_BarOptions_Isl == "fill"){
          return(1)
        }
      })
      
      FSF_yLabel_Isl <- reactive({
        if(input$FSF_BarOptions_Isl == "stack"){
          y <- "Combined Densities"
        }
        else if(input$FSF_BarOptions_Isl == "dodge"){
          y <- "Seperated Densities"
        }
        else if(input$FSF_BarOptions_Isl == "fill"){
          y <- "Normalized Densities"
        }
        y
      })
      
      FSF_alphaONI_Isl <- reactive({
        if(input$FSF_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        else if(input$FSF_GraphOptions_Isl == "With ONI"){
          return(1)
        }
        else if(input$FSF_GraphOptions_Isl == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$FSF_GraphOptions_Isl == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      FSF_alphaPDO_NOAA_Isl <- reactive({
        if(input$FSF_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        if(input$FSF_GraphOptions_Isl == "With ONI"){
          return(0)
          
        }
        if(input$FSF_GraphOptions_Isl == "With PDO (NOAA)"){
          return(1)
        }
        if(input$FSF_GraphOptions_Isl == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      FSF_alphaPDO_UW_Isl <- reactive({
        if(input$FSF_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        if(input$FSF_GraphOptions_Isl == "With ONI"){
          return(0)
          
        }
        if(input$FSF_GraphOptions_Isl == "With PDO (NOAA)"){
          return(0)
        }
        if(input$FSF_GraphOptions_Isl == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$FSF_ONIpdoPIC_Isl <- renderImage({
        if(input$FSF_GraphOptions_Isl == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$FSF_GraphOptions_Isl == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$FSF_GraphOptions_Isl == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      FSF_AxisScale_Isl <- reactive({
        if(input$FSF_FreeOrLock_Isl == "Locked Scales"){
          return("fixed")
        }
        if(input$FSF_FreeOrLock_Isl == "Free Scales"){
          return("free")
        }
      }) # Facet Plot Axis Scale free or fixed 
      
      output$FSF_Plot_Isl1 <- renderPlot({ # Facet plots    ---- 
        
        if (is.null(input$FSF_Graph_Isl))
          return(NULL) 
        
        else if(input$FSF_Graph_Isl == "Line" && input$FSF_DataSummary_Isl == "Island Mean") { # Line   ----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(FSF_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = FSF_FilterByIsl_Isl(), size = 1,
                        aes(x = IslandDate, y = Island_Mean, group = IslandName, color = IslandName)) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(FSF_FilterByIsl_Isl()$IslandDate))-365,
                                      max(as.Date(FSF_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              geom_errorbar(data = FSF_FilterByIsl_Isl(), 
                            aes(x = IslandDate, ymin = Island_Mean - IslandSE, ymax = Island_Mean + IslandSE),
                            width = 0, color = "black", alpha = as.numeric(input$FSF_EB_Isl)) +
              labs(title = glue("{unique(FSF_FilterByIsl_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Size (cm)") +
              facet_grid(rows = vars(IslandName), scales = FSF_AxisScale_Isl()) +
              scale_color_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        } 
        else if(input$FSF_Graph_Isl == "Line" && input$FSF_DataSummary_Isl == "Site Means (by Island)") {
          return({
            out <- by(data = FSF_Filter_Isl(), INDICES = FSF_Filter_Isl()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(FSF_alphaONI_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_Isl()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_line(data = m, 
                          aes(Date, MeanSize, group = SiteName, colour = SiteName, linetype = SiteName),
                          size = 1) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date),
                             limits = c(min(as.Date(m$Date))-365, max(as.Date(m$Date))+365),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(limits = c(0, ifelse(input$FSF_FreeOrLock_Isl == "Locked Scales", 
                                                        max(FSF_Filter_Isl()$MaxSum), max(m$MeanSize))),
                                   expand = expansion(mult = c(0.01, .01))) +
                geom_errorbar(data = m, 
                              aes(x = Date, ymin = MeanSize - StandardError, ymax = MeanSize + StandardError),
                              width = 0, color = "black", alpha = as.numeric(input$FSF_EB_Isl)) +
                labs(title = m$IslandName,
                     color = "Site Name",
                     linetype ="Site Name",
                     caption = "Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected",
                     x = NULL,
                     y = "Mean Size (cm)") +
                scale_color_manual(values = SiteColor, breaks = as.character(m$SiteName)) +
                scale_linetype_manual(values = SiteLine, breaks = as.character(m$SiteName)) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(FSF_Filter_Isl()$ScientificName)}"),
                                          label_size = 20, label_fontface = "bold.italic"
            ))
          })
        } 
        else if(input$FSF_Graph_Isl == "Bar" && input$FSF_DataSummary_Isl == "Island Mean") { # Bar   ----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(FSF_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = FSF_FilterByIsl_Isl(), position = "dodge", width = 280,
                       aes(x = IslandDate, y = Island_Mean, fill = IslandName)) +
              facet_grid(rows = vars(IslandName), scales = FSF_AxisScale_Isl()) +
              geom_text(data = FSF_FilterByIsl_Isl(),
                        aes(x = IslandDate, y = Island_Mean, label = round(Island_Mean, digits = 2)),
                        position = position_dodge(1), vjust = -.2, hjust = .5, angle = 0, alpha = as.numeric(input$FSF_Bar_Text_Isl)) +
              geom_errorbar(data = FSF_FilterByIsl_Isl(), 
                            aes(x = IslandDate, ymin = Island_Mean - IslandSE, ymax = Island_Mean + IslandSE),
                            width = 0, color = "black", alpha = as.numeric(input$FSF_EB_Isl)) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              scale_x_date(date_labels = "%b %Y", date_breaks = "1 year", 
                           limits = c(min(as.Date(FSF_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(FSF_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(FSF_FilterByIsl_Isl()$ScientificName)}"),
                   subtitle = glue("{unique(FSF_FilterByIsl_Isl()$CommonName)}"),
                   color = "Common Name",
                   fill = "Common Name",
                   x = "Year",
                   y = "Mean Size (cm)") +
              scale_fill_manual(values = SpeciesColor) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$FSF_Graph_Isl == "Bar" && input$FSF_DataSummary_Isl == "Site Means (by Island)") {
          return({
            out <- by(data = FSF_Filter_Isl(), INDICES = FSF_Filter_Isl()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() +
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(FSF_alphaONI_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_Isl()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                new_scale_fill() +
                geom_col(data = m, aes(x = Date, y = MeanSize, fill = SiteName),
                         position = input$FSF_BarOptions_Isl, width = 280) +
                coord_cartesian(ylim = c(0, ifelse(input$FSF_FreeOrLock_Isl == "Locked Scales", 
                                                   FSF_yValue_Isl(), max(m$MaxSumBar)))) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date), expand = expansion(mult = c(0.01, .01)),
                             limits = c(min(as.Date(m$Date))-365, max(as.Date(m$Date))+365)) +
                labs(title = m$IslandName,
                     color = "Site Name",
                     fill = "Site Name",
                     x = "Year",
                     y = FSF_yLabel_Isl()) +
                scale_fill_manual(values = SiteColor) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(FSF_Filter_Isl()$ScientificName)}"),
                                          label_size = 20, label_fontface = "bold.italic"
            ))
          })
        } 
        else if(input$FSF_Graph_Isl == "Smooth Line" && input$FSF_DataSummary_Isl == "Island Mean") { # Smooth   -----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(FSF_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_smooth(data = FSF_FilterByIsl_Isl(), aes(x = IslandDate, y = Island_Mean, color = IslandName),
                          se = as.logical(input$FSF_SmoothSE_Isl), span = input$FSF_SmoothSlide_Isl) +
              geom_point(data = FSF_FilterByIsl_Isl(), aes(x = IslandDate, y = Island_Mean, color = IslandName),
                         size = 1, alpha = as.numeric(input$FSF_SmoothPoint_Isl),inherit.aes = FALSE) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(FSF_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(FSF_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(FSF_FilterByIsl_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Size (cm)") +
              facet_grid(rows = vars(IslandName), scales = FSF_AxisScale_Isl()) +
              scale_color_manual(values = SpeciesColor, guide = guide_legend(nrow = 5)) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$FSF_Graph_Isl == "Smooth Line" && input$FSF_DataSummary_Isl == "Site Means (by Island)") { 
          return({
            out <- by(data = FSF_Filter_Isl(), INDICES = FSF_Filter_Isl()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() +
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(FSF_alphaONI_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_Isl()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_point(data = m, aes(x = Date, y = MeanSize, color = SiteName),
                           size = 1, alpha = as.numeric(input$FSF_SmoothPoint_Isl), inherit.aes = FALSE) +
                geom_smooth(data = m, aes(x = Date, y = MeanSize, color = SiteName),
                            se = as.logical(input$FSF_SmoothSE_Isl),
                            span = input$FSF_SmoothSlide_Isl) +
                scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                             limits = c(min(as.Date(FSF_FilterByIsl_Isl()$IslandDate))-365, 
                                        max(as.Date(FSF_FilterByIsl_Isl()$IslandDate))+365),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(limits = c(0, ifelse(input$FSF_FreeOrLock_Isl == "Locked Scales", 
                                                        max(FSF_Filter_Isl()$MaxSum), max(m$MeanSize))),
                                   expand = expansion(mult = c(0.01, .01))) +
                labs(title = glue("{unique(m$IslandName)}"), 
                     color = "Site Name",
                     x = "Year",
                     y = "Mean Size (cm)") +
                scale_color_manual(values = SiteColor) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 13, colour = "black", face = "bold"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(FSF_Filter_Isl()$ScientificName)}"),
                                          label_size = 20, label_fontface = "bold.italic"
            ))
          })
        }
        
      })
      
      output$FSF_Plot_Isl2 <- renderPlot({  # Single plot    ----
        
        if (is.null(input$FSF_Graph_Isl))
          return(NULL) 
        
        else if(input$FSF_Graph_Isl == "Line" && input$FSF_DataSummary_Isl == "Island Mean") { # Line   ----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(FSF_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = FSF_FilterByIsl_Isl(), 
                        aes(x = IslandDate, y = Island_Mean, group = IslandName, color = IslandName),
                        size = 1) +
              scale_x_date(date_labels = "%Y", breaks = FSF_FilterByIsl_Isl()$IslandDate, 
                           limits = c(min(as.Date(FSF_FilterByIsl_Isl()$IslandDate))-365,
                                      max(as.Date(FSF_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              geom_errorbar(data = FSF_FilterByIsl_Isl(), 
                            aes(x = IslandDate, ymin = Island_Mean - IslandSE, ymax = Island_Mean + IslandSE),
                            width = 0, color = "black", alpha = as.numeric(input$FSF_EB_Isl)) +
              labs(title = glue("{unique(FSF_FilterByIsl_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Size (cm)") +
              
              theme_classic() +
              theme(legend.position = "right",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        } 
        else if(input$FSF_Graph_Isl == "Line" && input$FSF_DataSummary_Isl == "Site Means (by Island)") {
          return({
            ggplot() + 
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(FSF_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = FSF_Filter_Isl(), 
                        aes(Date, MeanSize, group = SiteName, colour = SiteName, linetype = SiteName),
                        size = 1) +
              scale_x_date(date_labels = "%Y", date_breaks = "1 year",
                           limits = c(min(as.Date(FSF_FilterByIsl_Isl()$IslandDate))-365,
                                      max(as.Date(FSF_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              scale_y_continuous(limits = c(0, max(FSF_Filter_Isl()$MaxSum)), expand = expansion(mult = c(0.01, .01))) +
              geom_errorbar(data = FSF_Filter_Isl(), 
                            aes(x = Date, ymin = MeanSize - StandardError, ymax = MeanSize + StandardError),
                            width = 0, color = "black", alpha = as.numeric(input$FSF_EB_Isl)) +
              labs(title = FSF_Filter_Isl()$IslandName,
                   color = "Site Name",
                   linetype ="Site Name",
                   caption = "Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected",
                   x = NULL,
                   y = "Mean Size (cm)") +
              geom_vline(size = 1, xintercept = as.Date("2005-07-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2005-07-01", format = "%Y-%m-%d"), 
                        y= Inf, aes(label = "16 New Sites Added"),
                        hjust = 0,
                        vjust = 1,
                        inherit.aes = FALSE) +
              geom_vline(size = 1, xintercept = as.Date("2001-06-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2001-06-01", format = "%Y-%m-%d"), 
                        y= Inf, aes(label = "Miracle Mile Added"),
                        hjust = 1,
                        vjust = 1,
                        inherit.aes = FALSE) +
              scale_color_manual(values = SiteColor2, guide = guide_legend(ncol = 10)) +
              scale_linetype_manual(values = SiteLine, guide = guide_legend(ncol = 10)) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.key.width = unit(1.5, "cm"),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 12, colour = "black"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$FSF_Graph_Isl == "Bar" && input$FSF_DataSummary_Isl == "Island Mean") { # Bar -----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(FSF_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = FSF_FilterByIsl_Isl(), 
                       aes(x = IslandDate, y = Island_Mean, fill = IslandName),
                       position = input$FSF_BarOptions_Isl,
                       width = 280) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              scale_x_date(date_labels = "%Y", breaks = FSF_FilterByIsl_Isl()$IslandDate, 
                           limits = c(min(as.Date(FSF_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(FSF_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(FSF_FilterByIsl_Isl()$ScientificName)}"),
                   subtitle = glue("{unique(FSF_FilterByIsl_Isl()$CommonName)}"),
                   color = "Common Name",
                   fill = "Common Name",
                   x = "Year",
                   y = FSF_yLabel_Isl()) +
              
              theme_classic() +
              theme(legend.position = "right",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$FSF_Graph_Isl == "Bar" && input$FSF_DataSummary_Isl == "Site Means (by Island)") {
          return({
            ggplot() +
              geom_col(data = FSF_Filter_Isl() %>% dplyr::group_by(SurveyYear) %>% dplyr::mutate(Date = mean(Date)), 
                       aes(x = Date-75, y = MeanSize, fill = SiteName),
                       position = input$FSF_BarOptions_Isl,
                       width = 280) +
              scale_x_date(date_labels = "%Y", date_breaks = "1 year",
                           limits = c(min(as.Date(FSF_Filter_Isl()$Date))-365,
                                      max(as.Date(FSF_Filter_Isl()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = FSF_Filter_Isl()$IslandName,
                   color = "Site Name",
                   fill = "Site Name",
                   x = "Year",
                   y = FSF_yLabel_Isl()) +
              geom_vline(size = 1, xintercept = as.Date("2005-01-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2005-01-01", format = "%Y-%m-%d"), 
                        y= Inf, aes(label = "16 New Sites Added"),
                        hjust = 0,
                        vjust = 1,
                        inherit.aes = FALSE) +
              geom_vline(size = 1, xintercept = as.Date("2001-01-01", format = "%Y-%m-%d")) +
              geom_text(x = as.Date("2001-01-01", format = "%Y-%m-%d"), 
                        y= Inf, aes(label = "Miracle Mile Added"),
                        hjust = 1,
                        vjust = 1,
                        inherit.aes = FALSE) +
              scale_fill_manual(values = SiteColor2, guide = guide_legend(ncol = 10)) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.justification = c(0,0.5),
                    legend.background = element_rect(),
                    legend.key.width = unit(1, "cm"),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 12, colour = "black"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        } 
        else if(input$FSF_Graph_Isl == "Smooth Line" && input$FSF_DataSummary_Isl == "Island Mean") { # Smooth   ----
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(FSF_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_point(data = FSF_FilterByIsl_Isl(), aes(x = IslandDate, y = Island_Mean, color = IslandName), 
                         size = 2, alpha = as.numeric(input$FSF_SmoothPoint_Isl)) +
              geom_smooth(data = FSF_FilterByIsl_Isl(), aes(x= IslandDate, y = Island_Mean, color = IslandName),
                          se = as.logical(input$FSF_SmoothSE_Isl), span = input$FSF_SmoothSlide_Isl) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(FSF_FilterByIsl_Isl()$IslandDate))-365, 
                                      max(as.Date(FSF_FilterByIsl_Isl()$IslandDate))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(FSF_FilterByIsl_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Size (cm)") +
              scale_color_manual(values = SpeciesColor, guide = guide_legend(nrow = 5)) +
              theme_classic() +
              theme(legend.position = "right",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
        else if(input$FSF_Graph_Isl == "Smooth Line" && input$FSF_DataSummary_Isl == "Site Means (by Island)") {
          return({   
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(FSF_alphaONI_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_Isl()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_Isl()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_point(data = FSF_Filter_Isl(), aes(x = Date, y = MeanSize, color = CommonName), 
                         size = 2, alpha = as.numeric(input$FSF_SmoothPoint_Isl)) +
              geom_smooth(data = FSF_Filter_Isl(), aes(x= Date, y = MeanSize, color = SiteName),
                          se = as.logical(input$FSF_SmoothSE_Isl), span = input$FSF_SmoothSlide_Isl) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(FSF_Filter_Isl()$Date))-365, 
                                      max(as.Date(FSF_Filter_Isl()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(FSF_Filter_Isl()$ScientificName)}"), 
                   color = "Common Name",
                   x = "Year",
                   y = "Mean Size (cm)") +
              scale_color_manual(values = SiteColor2, guide = guide_legend(nrow = 5)) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.background = element_rect(),
                    legend.title = element_text(size = 14, colour = "black", face = "bold"),
                    legend.text = element_text(size = 13, colour = "black", face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                    strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
          })
        }
      })
      
    }
    
    { # FSF_MS__byMPA ----
      
      FSF_Filter_MPA <- reactive({
        FSF_DFMPA %>%
          dplyr::filter(CommonName == input$FSF_SpeciesName_MPA) %>%
          dplyr::group_by(IslandCode, SurveyYear) %>%
          dplyr::mutate(Date = mean(Date),
                        MaxSumBar = max(sum(MeanSize))) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SiteName, SurveyYear) %>%
          dplyr::mutate(MaxSum = max(sum(MeanSize))) %>%
          arrange(SiteName)
      })
      
      FSF_FilterBarSite_MPA <-reactive({
        FSF_DFMPA %>%
          dplyr::filter(CommonName == input$FSF_SpeciesName_MPA,
                        SiteName != "Keyhole") %>%
          dplyr::group_by(IslandCode, SurveyYear) %>%
          dplyr::mutate(Date = mean(Date),
                        MaxSumBar = max(sum(MeanSize))) %>%
          dplyr::ungroup() %>%
          dplyr::group_by(SiteName, SurveyYear) %>%
          dplyr::mutate(MaxSum = max(sum(MeanSize)))
      })
      
      FSF_Inside_MPA <- reactive({
        FSF_DFMPA %>% 
          dplyr::filter(CommonName == input$FSF_SpeciesName_MPA,
                        ReserveStatus == "Inside",
                        SiteName != "Keyhole") %>%
          dplyr::group_by(MPA_Date, IslandCode, IslandName, ScientificName, CommonName, SurveyYear) %>%
          dplyr::distinct(MPA_Date, IslandCode, IslandName, ScientificName, CommonName, SurveyYear,
                          MPA_TotalCount, MPA_Mean, MPA_SD, MPA_SE, .keep_all = TRUE)
      })
      
      FSF_Outside_MPA <- reactive({
        FSF_DFMPA %>%
          dplyr::filter(CommonName == input$FSF_SpeciesName_MPA,
                        ReserveStatus == "Outside",
                        SiteName != "Keyhole") %>%
          dplyr::group_by(MPA_Date, IslandCode, IslandName, ScientificName, CommonName, SurveyYear) %>%
          dplyr::distinct(MPA_Date, IslandCode, IslandName, ScientificName, CommonName, SurveyYear,
                          MPA_TotalCount, MPA_Mean, MPA_SD, MPA_SE, .keep_all = TRUE)
      })
      
      FSF_alphaONI_MPA <- reactive({
        if(input$FSF_GraphOptions_MPA == "With No Index"){
          return(0)
        }
        else if(input$FSF_GraphOptions_MPA == "With ONI"){
          return(1)
        }
        else if(input$FSF_GraphOptions_MPA == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$FSF_GraphOptions_MPA == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      FSF_alphaPDO_NOAA_MPA <- reactive({
        if(input$FSF_GraphOptions_MPA == "With No Index"){
          return(0)
        }
        if(input$FSF_GraphOptions_MPA == "With ONI"){
          return(0)
          
        }
        if(input$FSF_GraphOptions_MPA == "With PDO (NOAA)"){
          return(1)
        }
        if(input$FSF_GraphOptions_MPA == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      FSF_alphaPDO_UW_MPA <- reactive({
        if(input$FSF_GraphOptions_MPA == "With No Index"){
          return(0)
        }
        if(input$FSF_GraphOptions_MPA == "With ONI"){
          return(0)
          
        }
        if(input$FSF_GraphOptions_MPA == "With PDO (NOAA)"){
          return(0)
        }
        if(input$FSF_GraphOptions_MPA == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$FSF_ONIpdoPIC_MPA <- renderImage({
        if(input$FSF_GraphOptions_MPA == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$FSF_GraphOptions_MPA == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$FSF_GraphOptions_MPA == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      FSF_AxisScale_MPA <- reactive({
        if(input$FSF_FreeOrLock_MPA == "Locked Scales"){
          return("fixed")
        }
        if(input$FSF_FreeOrLock_MPA == "Free Scales"){
          return("free")
        }
      }) # Facet Plot Axis Scale free or fixed 
      
      output$FSF_Plot_MPA <- renderPlot({
        if (is.null(input$FSF_Graph_MPA))
          return(NULL)
        
        else if(input$FSF_Graph_MPA == "Line" && input$FSF_DataSummary_MPA == "MPA Mean") {  # Line    ----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(FSF_alphaONI_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = FSF_Filter_MPA() %>% dplyr::filter(SiteName != "Keyhole"), 
                        aes(x = MPA_Date, y = MPA_Mean, group = ReserveStatus, color = ReserveStatus, linetype = ReserveStatus),
                        size = 1) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(FSF_Filter_MPA()$MPA_Date)), 
                                      max(as.Date(FSF_Filter_MPA()$MPA_Date))),
                           expand = expansion(mult = c(0.01, .01))) +
              geom_errorbar(data = FSF_Filter_MPA(), 
                            aes(x = MPA_Date, ymin = MPA_Mean - MPA_SE, ymax = MPA_Mean + MPA_SE),
                            width = 0, color = "black", alpha = as.numeric(input$FSF_EB_MPA)) +
              labs(title = glue("{unique(FSF_Filter_MPA()$ScientificName)}"),
                   subtitle = FSF_Filter_MPA()$CommonName,
                   color = "Reserve Status",
                   linetype = "Reserve Status",
                   x = "Year",
                   y = "Mean Size (cm)") +
              scale_color_manual(values=c(Inside = "green3", Outside = "red3")) +
              scale_linetype_manual(values = c(Inside = "dashed", Outside = "solid")) +
              facet_grid(rows = vars(IslandName), scales = FSF_AxisScale_MPA()) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    legend.key.width = unit(2, "cm"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"),
                    strip.text = element_text(size = 12, colour = "Black", angle = 90, face = "bold"))
          })
        }
        else if(input$FSF_Graph_MPA == "Line" && input$FSF_DataSummary_MPA == "Site Means (by MPA)") {
          return({
            out <- by(data = FSF_Filter_MPA(), INDICES = FSF_Filter_MPA()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(FSF_alphaONI_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_MPA()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_line(data = m, 
                          aes(x = Date, MeanSize, group = SiteName, color = SiteName, linetype = SiteName),
                          size = 1) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date),
                             limits = c(min(as.Date(m$Date)), max(as.Date(m$Date))),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(limits = c(0, ifelse(input$FSF_FreeOrLock_MPA == "Locked Scales", 
                                                        max(FSF_Filter_MPA()$MaxSum), max(m$MeanSize))), 
                                   expand = expansion(mult = c(0.01, .01))) +
                geom_errorbar(data = m, 
                              aes(x = Date, ymin = MeanSize - StandardError, ymax = MeanSize + StandardError),
                              width = 0, color = "black", alpha = as.numeric(input$FSF_EB_MPA)) +
                labs(title = m$MPA_Name,
                     color = "Site Name",
                     linetype = "Site Name",
                     caption = "Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected",
                     x = "Year",
                     y = "Mean Size (cm)") +
                scale_color_manual(values = SiteColor, breaks = as.character(m$SiteName)) +
                scale_linetype_manual(values = SiteLine, breaks = as.character(m$SiteName)) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(FSF_Filter_MPA()$ScientificName)}"),
                                          label_size = 16,
                                          label_fontface = "bold.italic"
            ))
          })
        }
        else if(input$FSF_Graph_MPA == "Bar" && input$FSF_DataSummary_MPA == "MPA Mean") { # Bar    -----
          return({ 
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(FSF_alphaONI_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = FSF_Inside_MPA(), 
                       aes(x = MPA_Date - 60, y = MPA_Mean, group = ReserveStatus, fill = ReserveStatus),
                       width = 120) +
              geom_text(data = FSF_Inside_MPA(),
                        aes(x = MPA_Date - 60, y = MPA_Mean, label = round(MPA_Mean, digits = 2)),
                        vjust = -.2, hjust = .5, angle = 0, alpha = as.numeric(input$FSF_Bar_Text_MPA)) +
              geom_errorbar(data = FSF_Inside_MPA(), 
                            aes(x = MPA_Date - 60, ymin = MPA_Mean - MPA_SE, ymax = MPA_Mean + MPA_SE),
                            width = 0, color = "black", alpha = as.numeric(input$FSF_EB_MPA)) +
              geom_col(data = FSF_Outside_MPA(), 
                       aes(x = MPA_Date + 60, y = MPA_Mean, group = ReserveStatus, fill = ReserveStatus),
                       width = 120) +
              geom_text(data = FSF_Outside_MPA(),
                        aes(x = MPA_Date + 60, y = MPA_Mean, label = round(MPA_Mean, digits = 2)),
                        vjust = -.2, hjust = .5, angle = 0, alpha = as.numeric(input$FSF_Bar_Text_MPA)) +
              geom_errorbar(data = FSF_Outside_MPA(), 
                            aes(x = MPA_Date + 60, ymin = MPA_Mean - MPA_SE, ymax = MPA_Mean + MPA_SE),
                            width = 0, color = "black", alpha = as.numeric(input$FSF_EB_MPA)) +
              scale_y_continuous(expand = expansion(mult = c(0, .1))) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(FSF_Filter_MPA()$MPA_Date)) - 150, 
                                      max(as.Date(FSF_Filter_MPA()$MPA_Date)) + 360),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(FSF_Filter_MPA()$ScientificName)}"),
                   subtitle = FSF_Filter_MPA()$CommonName,
                   color = "Reserve Status",
                   linetype = "Reserve Status",
                   x = "Year",
                   y = "Mean Size (cm)") +
              scale_fill_manual(values = c(Inside = "green3", Outside = "red3")) +
              facet_grid(rows = vars(IslandName), scales = FSF_AxisScale_MPA()) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    legend.key.width = unit(2, "cm"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"),
                    strip.text = element_text(size = 12, colour = "Black", angle = 90, face = "bold"))
          })
        }
        else if(input$FSF_Graph_MPA == "Bar" &&  input$FSF_DataSummary_MPA == "Site Means (by MPA)") {
          return({
            out <- by(data = FSF_FilterBarSite_MPA(), INDICES = FSF_FilterBarSite_MPA()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() +
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(FSF_alphaONI_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_MPA()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                new_scale_fill() +
                geom_col(data = m %>% dplyr::filter(ReserveStatus == "Inside"), 
                         aes(x = Date - 70, y = MeanSize, fill = SiteName),
                         position = "stack", width = 140) +
                geom_text(data = m %>% dplyr::filter(ReserveStatus == "Inside") %>% 
                            dplyr::group_by(IslandName, SurveyYear) %>% dplyr::mutate(SumBar = sum(MeanSize)),
                          aes(x = Date - 70, y = SumBar, label = "In"),
                          vjust = -.2, hjust = .5, angle = 0) +
                scale_fill_manual(values = SiteColor) +
                labs(fill = "Inside") +
                new_scale_fill() +
                geom_col(data = m %>% dplyr::filter(ReserveStatus == "Outside") , 
                         aes(x = Date + 70, y = MeanSize, fill = SiteName),
                         position = "stack", width = 140) +
                geom_text(data = m %>% dplyr::filter(ReserveStatus == "Outside") %>%
                            dplyr::group_by(IslandName, SurveyYear) %>%
                            dplyr::mutate(SumBar = sum(MeanSize)),
                          aes(x = Date + 70, y = SumBar, label = "Out"),
                          vjust = -.2, hjust = .5, angle = 0) +
                scale_y_continuous(limits = c(0, ifelse(input$FSF_FreeOrLock_MPA == "Locked Scales", 
                                                        max(FSF_Filter_MPA()$MaxSumBar), max(m$MeanSize))),
                                   expand = expansion(mult = c(0.01, .01))) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date), 
                             limits = c(min(as.Date(m$Date)) - 150, max(as.Date(m$Date))),
                             expand = expansion(mult = c(0.01, .01))) +
                labs(title = m$MPA_Name,
                     fill = "Outside",
                     x = "Year",
                     y = "Mean Size (cm)") +
                scale_fill_manual(values = SiteColor) +
                scale_color_manual(values = SiteColor) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(FSF_Filter_MPA()$ScientificName)}"),
                                          label_size = 16,
                                          label_fontface = "bold.italic"
            ))
          })
        } 
        else if(input$FSF_Graph_MPA == "Smooth Line" && input$FSF_DataSummary_MPA == "MPA Mean") {  # Smooth       ----
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(FSF_alphaONI_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_MPA()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_point(data = FSF_Filter_MPA() %>% dplyr::filter(SiteName != "Keyhole"), 
                         aes(x= MPA_Date, y = MPA_Mean, color = ReserveStatus),
                         size = 1, alpha = as.numeric(input$FSF_SmoothPoint_MPA), show.legend = FALSE) +
              geom_smooth(data = FSF_Filter_MPA() %>% dplyr::filter(SiteName != "Keyhole"), 
                          aes(x= MPA_Date, y = MPA_Mean, color = ReserveStatus),
                          se = as.logical(input$FSF_SmoothSE_MPA),
                          span = input$FSF_SmoothSlide_MPA) +
              scale_x_date(date_labels = "%Y", date_breaks = '1 year',
                           limits = c(min(as.Date(FSF_Filter_MPA()$MPA_Date)), 
                                      max(as.Date(FSF_Filter_MPA()$MPA_Date))),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(FSF_Filter_MPA()$ScientificName)}"),
                   subtitle = FSF_Filter_MPA()$CommonName,
                   color = "Reserve Status",
                   linetype = "Reserve Status",
                   x = "Year",
                   y = "Mean Size (cm)") +
              scale_color_manual(values=c(Inside = "green3", Outside = "red3")) +
              scale_linetype_manual(values = c(Inside = "dashed", Outside = "solid")) +
              facet_grid(rows = vars(IslandName), scales = FSF_AxisScale_MPA()) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    legend.key.width = unit(2, "cm"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"),
                    strip.text = element_text(size = 12, colour = "Black", angle = 90, face = "bold"))
          })
        }
        else if(input$FSF_Graph_MPA == "Smooth Line" && input$FSF_DataSummary_MPA == "Site Means (by MPA)") {
          return({
            out <- by(data = FSF_Filter_MPA(), INDICES = FSF_Filter_MPA()$IslandName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                          position = "identity", alpha = as.numeric(FSF_alphaONI_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_MPA()), show.legend = FALSE) +
                geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                          position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_MPA()), show.legend = FALSE) +
                scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
                geom_point(data = m, aes(x = Date, MeanSize, color = SiteName),
                           size = 1, alpha = as.numeric(input$FSF_SmoothPoint_MPA), show.legend = FALSE) +
                geom_smooth(data = m, aes(x = Date, MeanSize, color = SiteName, linetype = SiteName),
                            se = as.logical(input$FSF_SmoothSE_MPA),
                            span = input$FSF_SmoothSlide_MPA) +
                scale_x_date(date_labels = "%Y", breaks = unique(m$Date),
                             limits = c(min(as.Date(m$Date)) - 150, max(as.Date(m$Date))),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(limits = c(0, max(FSF_Filter_MPA()$MaxSum)), expand = expansion(mult = c(0.01, .01))) +
                labs(title = m$MPA_Name,
                     color = "Site Name",
                     linetype = "Site Name",
                     caption = "Dashed lines are inside SMRs, dotted lines are in SMCAs, and solid lines are unprotected",
                     x = "Year",
                     y = "Mean Size (cm)") +
                scale_color_manual(values = SiteColor) +
                scale_linetype_manual(values = SiteLine) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.key.width = unit(1, "cm"),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 12, colour = "black"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
            })
            
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v',
                                          labels = glue("{unique(FSF_Filter_MPA()$ScientificName)}"),
                                          label_size = 16,
                                          label_fontface = "bold.italic"
            ))
          })
        }
      })
      
    }
    
    { # FSF_MS_Two_Species    ----
      
      FSF_Filter_Two_One <- reactive({
        FSF_DF %>%
          dplyr::filter(SiteName == input$FSF_SiteName_Two,
                        CommonName == input$FSF_SpeciesName_Two_One) %>%
          dplyr::select(SurveyYear, Date, SiteName, IslandName, ScientificName, CommonName, MeanSize, 
                        StandardError, StandardError, TotalCount, MeanDepth, Island_Mean,
                        SiteNumber, IslandCode, SiteCode, Species) 
      })
      
      FSF_Filter_Two_Two <- reactive({
        FSF_DF %>%
          dplyr::filter(SiteName == input$FSF_SiteName_Two,
                        CommonName == input$FSF_SpeciesName_Two_Two) %>%
          dplyr::select(SurveyYear, Date, SiteName, IslandName, ScientificName, CommonName, MeanSize, 
                        StandardError, StandardError, TotalCount, MeanDepth, Island_Mean,
                        SiteNumber, IslandCode, SiteCode, Species) 
      })
      
      output$FSF_LargeSpPhoto_Two_1 <- renderImage({
        
        if (is.null(input$FSF_SpeciesName_Two_One))
          return(NULL) 
        
        if (input$FSF_SpeciesName_Two_One == unique(FSF_Filter_Two_One()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(FSF_Filter_Two_One()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(FSF_Filter_Two_One()$CommonName)}"),
            width = 450,
            height = 450
          ))
        }
      }, deleteFile = FALSE)
      
      output$FSF_LargeSpPhoto_Two_2 <- renderImage({
        
        if (input$FSF_SpeciesName_Two_Two == unique(FSF_Filter_Two_Two()$CommonName)) {
          return(list(
            src = glue("www/Indicator_Species/{unique(FSF_Filter_Two_Two()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(FSF_Filter_Two_Two()$CommonName)}"),
            width = 450,
            height = 450
          ))
        }
      }, deleteFile = FALSE)
      
      output$FSF_TopSitePhoto_Two <- renderImage({
        if (is.null(input$FSF_SpeciesName_Two_One))
          return(NULL)
        
        if (input$FSF_SiteName_Two == unique(FSF_Filter_Two_One()$SiteName)) {
          return(list(
            src = glue("www/Sat_Imagery/{unique(FSF_Filter_Two_One()$SiteCode)}.png"),
            contentType = "image/png",
            alt = glue("{unique(FSF_Filter_Two_One()$SiteName)}"),
            width = 430,
            height = 210
          ))
        }
      }, deleteFile = FALSE)
      
      output$FSF_LargeSitePhoto_Two <- renderImage({
        if (is.null(input$FSF_SpeciesName_Two_One))
          return(NULL)
        
        if (input$FSF_SiteName_Two == unique(FSF_Filter_Two_One()$SiteName)) {
          return(list(
            src = glue("www/Sat_Imagery/{unique(FSF_Filter_Two_One()$SiteCode)}.png"),
            contentType = "image/png",
            alt = glue("{unique(FSF_Filter_Two_One()$SiteName)}"),
            width = 1250,
            height = 625
          ))
        }
      }, deleteFile = FALSE)
      
      FSF_alphaONI_Two <- reactive({
        if(input$FSF_GraphOptions_Two == "With No Index"){
          return(0)
        }
        else if(input$FSF_GraphOptions_Two == "With ONI"){
          return(1)
        }
        else if(input$FSF_GraphOptions_Two == "With PDO (NOAA)"){
          return(0)
        }
        else if(input$FSF_GraphOptions_Two == "With PDO (UW)"){
          return(0)
        }
      }) # ONI layer toggle (changes alpha value)
      
      FSF_alphaPDO_NOAA_Two <- reactive({
        if(input$FSF_GraphOptions_Two == "With No Index"){
          return(0)
        }
        if(input$FSF_GraphOptions_Two == "With ONI"){
          return(0)
          
        }
        if(input$FSF_GraphOptions_Two == "With PDO (NOAA)"){
          return(1)
        }
        if(input$FSF_GraphOptions_Two == "With PDO (UW)"){
          return(0)
        }
      }) # PDO NOAA layer toggle (changes alpha value)
      
      FSF_alphaPDO_UW_Two <- reactive({
        if(input$FSF_GraphOptions_Two == "With No Index"){
          return(0)
        }
        if(input$FSF_GraphOptions_Two == "With ONI"){
          return(0)
          
        }
        if(input$FSF_GraphOptions_Two == "With PDO (NOAA)"){
          return(0)
        }
        if(input$FSF_GraphOptions_Two == "With PDO (UW)"){
          return(1)
        }
      }) # PDO UW layer toggle (changes alpha value)
      
      output$FSF_ONIpdoPIC_Two <- renderImage({
        if(input$FSF_GraphOptions_Two == 'With ONI'){
          return(list(src = "www/ONI.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$FSF_GraphOptions_Two == 'With PDO (NOAA)'){
          return(list(src = "www/PDO_NOAA.png", contentType = "image/png", width = 340, height = 75))
        }
        if(input$FSF_GraphOptions_Two == 'With PDO (UW)'){
          return(list(src = "www/PDO_UW.png", contentType = "image/png", width = 340, height = 75))
        }
      }, deleteFile = FALSE) # ONI/PDO scale photo
      
      output$FSF_Plot_Two <- renderPlot({
        
        if (is.null(input$FSF_Graph_Two))
          return(NULL) 
        
        else if(input$FSF_Graph_Two == "Line"){
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(FSF_alphaONI_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_Two()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_line(data = FSF_Filter_Two_One(), 
                        aes(x = Date, y = MeanSize, group = ScientificName, color = CommonName),
                        size = 1) +
              geom_errorbar(data = FSF_Filter_Two_One(),
                            aes(x = Date, ymin = MeanSize - StandardError, ymax = MeanSize + StandardError),
                            width = 0, color = "black", alpha = as.numeric(input$FSF_EB_Two)) + 
              geom_line(data = FSF_Filter_Two_Two(), 
                        aes(x = Date, y = MeanSize*input$FSF_Y_Slide_Two, group = ScientificName, color = CommonName),
                        size = 1) +
              geom_errorbar(data = FSF_Filter_Two_Two(),
                            aes(x = Date, ymin = MeanSize*input$FSF_Y_Slide_Two - StandardError*input$FSF_Y_Slide_Two, 
                                ymax = MeanSize*input$FSF_Y_Slide_Two + StandardError*input$FSF_Y_Slide_Two),
                            width = 0, color = "black", alpha = as.numeric(input$FSF_EB_Two)) + 
              scale_y_continuous(sec.axis = sec_axis(~./input$FSF_Y_Slide_Two, 
                                                     name = glue("{unique(FSF_Filter_Two_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%b %Y", breaks = unique(FSF_Filter_Two_One()$Date), 
                           limits = c(min(as.Date(FSF_Filter_Two_One()$Date))-365, 
                                      max(as.Date(FSF_Filter_Two_One()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(FSF_Filter_Two_One()$ScientificName)
                              } and {unique(FSF_Filter_Two_Two()$ScientificName)}"), 
                   subtitle = glue("{unique(FSF_Filter_Two_One()$IslandName)} {unique(FSF_Filter_Two_One()$SiteName)}"),
                   color = "Common Name",
                   caption = 
                     glue(
                       "{FSF_Filter_Two_One()$SiteName} is typically surveyed in {
                     lubridate::month(round(mean(month(FSF_Filter_Two_One()$Date)), 0), label = TRUE, abbr = FALSE)
                     } and has a mean depth of {round(mean(FSF_Filter_Two_One()$MeanDepth), 2)} ft"),
                   x = "Year",
                   y = glue('{unique(FSF_Filter_Two_One()$CommonName)} Mean Density')) +
              scale_color_manual(values = FishColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
          })}
        else if(input$FSF_Graph_Two == "Bar") {
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(FSF_alphaONI_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_Two()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              new_scale_fill() +
              geom_col(data = FSF_Filter_Two_One(), 
                       aes(x = Date - 50, y = MeanSize, fill = CommonName),
                       position = "dodge",
                       width = 100) +
              geom_col(data = FSF_Filter_Two_Two(), 
                       aes(x = Date + 50, y = MeanSize*input$FSF_Y_Slide_Two, fill = CommonName),
                       position = "dodge",
                       width = 100) +
              geom_errorbar(data = FSF_Filter_Two_One(),
                            aes(x = Date - 50, ymin = MeanSize - StandardError, ymax = MeanSize + StandardError),
                            width = 0, color = "black", alpha = as.numeric(input$FSF_EB_Two)) + 
              geom_errorbar(data = FSF_Filter_Two_Two(),
                            aes(x = Date + 50, ymin = MeanSize*input$FSF_Y_Slide_Two - StandardError*input$FSF_Y_Slide_Two, 
                                ymax = MeanSize*input$FSF_Y_Slide_Two + StandardError*input$FSF_Y_Slide_Two),
                            width = 0, color = "black", alpha = as.numeric(input$FSF_EB_Two)) + 
              scale_y_continuous(sec.axis = sec_axis(~./input$FSF_Y_Slide_Two, 
                                                     name = glue("{unique(FSF_Filter_Two_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%b %Y", breaks = unique(FSF_Filter_Two_One()$Date),
                           limits = c(min(as.Date(FSF_Filter_Two_One()$Date))-365,
                                      max(as.Date(FSF_Filter_Two_One()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(FSF_Filter_Two_One()$ScientificName)
                              } and {unique(FSF_Filter_Two_Two()$ScientificName)}"),
                   subtitle = glue("{unique(FSF_Filter_Two_One()$IslandName)} {unique(FSF_Filter_Two_One()$SiteName)}"),
                   fill = "Common Name",
                   caption = glue( "{FSF_Filter_Two_One()$SiteName} is typically surveyed in {
                     lubridate::month(round(mean(month(FSF_Filter_Two_One()$Date)), 0), label = TRUE, abbr = FALSE)
                     } and has a mean depth of {round(mean(FSF_Filter_Two_One()$MeanDepth), 2)} ft"),
                   x = "Year",
                   y = "Mean Size (cm)") +
              scale_fill_manual(values = FishColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold", color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
          })}
        else if(input$FSF_Graph_Two == "Smooth Line"){
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(FSF_alphaONI_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_NOAA_Two()), show.legend = FALSE) +
              geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                        position = "identity", alpha = as.numeric(FSF_alphaPDO_UW_Two()), show.legend = FALSE) +
              scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
              geom_smooth(data = FSF_Filter_Two_One(), 
                          aes(x = Date, y = MeanSize, group = ScientificName, color = CommonName),
                          size = 1,  span = input$FSF_SmoothSlide_Two, se = as.logical(input$FSF_SmoothSE_Two)) +
              geom_point(data = FSF_Filter_Two_One(),
                         aes(x = Date, y = MeanSize, color = CommonName),
                         size = 1, alpha = as.numeric(input$FSF_SmoothPoint_Two)) +
              geom_smooth(data = FSF_Filter_Two_Two(), 
                          aes(x = Date, y = MeanSize*input$FSF_Y_Slide_Two, group = ScientificName, color = CommonName),
                          size = 1,  span = input$FSF_SmoothSlide_Two, se = as.logical(input$FSF_SmoothSE_Two)) +
              geom_point(data = FSF_Filter_Two_Two(),
                         aes(x = Date, y = MeanSize*input$FSF_Y_Slide_Two, color = CommonName),
                         size = 1, alpha = as.numeric(input$FSF_SmoothPoint_Two)) +
              scale_y_continuous(sec.axis = sec_axis(~./input$FSF_Y_Slide_Two, 
                                                     name = glue("{unique(FSF_Filter_Two_Two()$CommonName)} Mean Density"))) +
              scale_x_date(date_labels = "%b %Y", breaks = unique(FSF_Filter_Two_One()$Date), 
                           limits = c(min(as.Date(FSF_Filter_Two_One()$Date))-365, 
                                      max(as.Date(FSF_Filter_Two_One()$Date))+365),
                           expand = expansion(mult = c(0.01, .01))) +
              labs(title = glue("{unique(FSF_Filter_Two_One()$ScientificName)
                              } and {unique(FSF_Filter_Two_Two()$ScientificName)}"), 
                   subtitle = glue("{unique(FSF_Filter_Two_One()$IslandName)} {unique(FSF_Filter_Two_One()$SiteName)}"),
                   color = "Common Name",
                   caption = 
                     glue(
                       "{FSF_Filter_Two_One()$SiteName} is typically surveyed in {
                     lubridate::month(round(mean(month(FSF_Filter_Two_One()$Date)), 0), label = TRUE, abbr = FALSE)
                     } and has a mean depth of {round(mean(FSF_Filter_Two_One()$MeanDepth), 2)} ft"),
                   x = "Year",
                   y = glue('{unique(FSF_Filter_Two_One()$CommonName)} Mean Density')) +
              scale_color_manual(values = FishColor) +
              theme_classic() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black")) 
          })}
      })
      
      output$FSF_DToutData_Two_1 <- renderDT({
        datatable(FSF_Filter_Two_One(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "500px",
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = c(list(list(visible = FALSE, targets = c(1, 3, 4, 7, 8, 9, 10, 11, 12, 13, 14, 15))), 
                                   list(list(className = 'dt-center', targets = 0:6))),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(FSF_Filter_Two_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      })
      
      output$FSF_DToutData_Two_2 <- renderDT({
        datatable(FSF_Filter_Two_Two(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "500px",
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = c(list(list(visible = FALSE, targets = c(1, 3, 4, 7, 8, 9, 10, 11, 12, 13, 14, 15))), 
                                   list(list(className = 'dt-center', targets = 0:6))),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(FSF_Filter_Two_Two()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      })
      
    }
    
    { # FSF_MS_all   ----
      
      FSF_Filter_All <- reactive({
        FSF_DF %>%
          dplyr::filter(SiteName == input$FSF_SiteNameAll) %>%
          drop_na()
      })
      
      output$FSF_Plot_All <- renderPlot({
        if (is.null(input$FSF_GraphAll))
          return(NULL)
        
        if (input$FSF_GraphAll == "Line") {
          return({
            out <- by(data = FSF_Filter_All(), INDICES = FSF_Filter_All()$Species, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_line(data = m, size = 1,
                          aes(Date, MeanSize, group = CommonName, color = CommonName, linetype = SiteName)) +
                scale_x_date(date_labels = "%b %Y", breaks = unique(m$Date),
                             expand = expansion(mult = c(0.01, .01))) +
                geom_errorbar(data = m, width = 0.25,color = "black",
                              aes(x = Date, ymin = MeanSize - StandardError, ymax = MeanSize + StandardError)) +
                labs(title = m$ScientificName, 
                     subtitle = glue("{m$IslandName} {m$SiteName}"),
                     color = "Common Name",
                     x = "Year",
                     y = "Mean Size (cm)") +
                scale_color_manual(values = FishColor) +
                scale_linetype_manual(values = SiteLine, guide = FALSE) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 13, colour = "black", face = "bold"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
              
            })
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v'))
          })
        } 
        else if (input$FSF_GraphAll == "Bar") {
          return({
            out <- by(data = FSF_Filter_All(), INDICES = FSF_Filter_All()$CommonName, FUN = function(m) {
              m <- droplevels(m)
              m <- ggplot() + 
                geom_col(data = m, width = 250,
                         aes(x = Date, y = MeanSize, group = CommonName, fill = CommonName, linetype = SiteName)) +
                geom_text(data = m, 
                          aes(x = Date, y = MeanSize, label = round(MeanSize, digits = 2)),
                          vjust = -.2, hjust = .5, angle = 0) +
                scale_x_date(date_labels = "%b %Y", breaks = unique(m$Date),
                             expand = expansion(mult = c(0.01, .01))) +
                scale_y_continuous(expand = expansion(mult = c(0, .1))) +
                labs(title = m$ScientificName, 
                     subtitle = glue("{m$IslandName} {m$SiteName}"),
                     color = "Common Name",
                     x = "Year",
                     y = "Mean Size (cm)") +
                scale_color_manual(values = FishColor) +
                scale_linetype_manual(values = SiteLine, guide = FALSE) +
                theme_classic() +
                theme(legend.position = "right",
                      legend.justification = c(0,0.5),
                      legend.background = element_rect(),
                      legend.title = element_text(size = 14, colour = "black", face = "bold"),
                      legend.text = element_text(size = 13, colour = "black", face = "bold"),
                      plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                      plot.subtitle = element_text(hjust = 0.5, size = 16),
                      plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                      axis.title = element_text(size = 16, face = "bold"),
                      axis.text.y = element_text(size = 12, face = "bold"),
                      axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"),
                      strip.text = element_text(size = 12, colour = "black", angle = 90, face = "bold"))
              
            })
            do.call(cowplot::plot_grid, c(out, ncol = 1, align = 'v'))
          })
        } 
      })
      
    }
    
  }
  
  output$RDFC_UIout <- renderUI({ # Visit Dates UI   ----
    if (is.null(input$RDFC_allORone))
      return(NULL)
    
    else if(input$RDFC_allORone == "One Species by Site"){ # By Site      ----
      dyn_ui <- tabPanel("Roving Diver Fish Count", value = "RDFC_TP",
                         plotOutput(outputId = "RDFC_Plot", 
                                    height = 600),
                         tags$hr(),
                         fluidRow(
                           conditionalPanel("input.RDFC_Graph_One == 'Line' || 
                                            input.RDFC_Graph_One == 'Bar'",
                                            column(3, radioButtons(inputId = "RDFC_EB_one",
                                                                   label = "Show error bars?",
                                                                   choices = c("Yes" = 1, "No" = 0),
                                                                   inline = TRUE)))),
                         conditionalPanel("input.RDFC_GraphOptions_One == 'With ONI'",
                                          tags$hr(),
                                          ONI_tagList),
                         conditionalPanel("input.RDFC_GraphOptions_One == 'With PDO (NOAA)'",
                                          tags$hr(),
                                          PDO_NOAA_tagList),
                         conditionalPanel("input.RDFC_GraphOptions_One == 'With PDO (UW)'",
                                          tags$hr(),
                                          PDO_UW_tagList),
                         conditionalPanel("input.RDFC_GraphOptions_One == 'Boxplot'",
                                          tags$hr(),
                                          imageOutput(outputId = "RDFC_BoxplotDescription_One")),
                         tags$hr(),
                         fluidRow(column(4, tags$h2(tags$strong(input$RDFC_SpeciesName_One)),
                                         imageOutput(outputId = "RDFC_LargeSpPhoto_One",
                                                     height = 500)),
                                  column(3, tags$h2(tags$strong("Species Classification")),
                                         DTOutput(outputId = "RDFC_DToutClass_One",
                                                  height = 500)),
                                  column(5, tags$h2(tags$strong("Species Description")),
                                         DTOutput(outputId = "RDFC_DToutDesc_One",
                                                  height = 500))),
                         tags$hr(),
                         DTOutput(outputId = "RDFC_DToutData_One",
                                  height = 550),
                         tags$hr())
    }
    else if(input$RDFC_allORone == "One Species by Island"){ # By Island  ----
      dyn_ui <- tabPanel("Roving Diver Fish Count", value = "RDFC_TP",
                         plotOutput(outputId = "RDFC_Plot_Isl", 
                                    height = 600),
                         tags$hr())
    }
    return(dyn_ui)
  })
  
  { # ........ RDFC_Mean_Counts ........   ----
    
    RDFC_Filter_One <- reactive({ 
      RDFC_DF %>%
        dplyr::filter(SiteName == input$RDFC_SiteName_One,
                      CommonName == input$RDFC_SpeciesName_One,
                      ExperienceLevel == "E") %>% 
        dplyr::group_by(SurveyYear, IslandName, SiteName, ScientificName, CommonName) %>%
        dplyr::mutate(Low_Count = min(Count),
                      High_Count = max(Count),
                      Mean_Count = round(mean(Count), 2),
                      StandardError = round(sd(Count)/sqrt(length(Count)), 2),
                      StandardDeviation = round(sd(Count), 2),
                      Date = mean(as.Date(Date)),
                      Observers = length(Count)) %>% 
        dplyr::select("SiteNumber", "SurveyYear", "Date", "IslandName", "SiteName", "ScientificName", "CommonName", "Score", 
                      "Abundance", "Count", "Low_Count", "High_Count", "Mean_Count", "StandardError", "StandardDeviation",  
                      "Observers", "PermanentObserverNumber", "ExperienceLevel", "IslandCode", "SiteCode", "Species", 
                      "ReserveStatus", "MeanDepth", "IslandDate")
    }) # filtered RDFC_ summary table
    
    RDFC_SideBar_Filter <- reactive({ 
      RDFC_DF %>%
        dplyr::filter(SiteName == input$RDFC_SiteName_One,
                      ExperienceLevel == "E") 
    }) # filtered RDFC_ summary table for sidebar menu
    
    output$RDFC_SideBar_One <- renderUI({
      selectInput(inputId = "RDFC_SpeciesName_One",
                  label = "Choose a Species:",
                  choices = levels(factor(RDFC_SideBar_Filter()$CommonName)),
                  selected = "California sheephead, male")
    }) # Sidebar species menu
    
    RDFC_SpeciesClass_One <- reactive({ 
      SpeciesFish %>%
        dplyr::filter(CommonName == input$RDFC_SpeciesName_One) %>%
        dplyr::select(ScientificName, Kingdom, Phylum, Class, Order, Family, Genus, "Species (Used by KFM)",
                      Status, "Currently Accepted Name", "Authority (Accepted)", CommonName) %>%
        tidyr::pivot_longer(-ScientificName, names_to = "Rank", values_to = "Name") %>%
        dplyr::select(Rank, Name)
    }) # filtered Species classification table
    
    RDFC_SpeciesDescription_One <- reactive({
      SpeciesFish %>%
        dplyr::filter(CommonName == input$RDFC_SpeciesName_One) %>%
        dplyr::select(ScientificName, "Geographic Range", Identification, Habitat, "Size Range", "Trophic Level", Abundance) %>%
        tidyr::pivot_longer(-ScientificName, names_to = "Category", values_to = "Information") %>%
        dplyr::select(Category, Information)
    }) # filtered Species Description table  
    
    output$RDFC_TopPhoto_One <- renderImage({
      
      if (input$RDFC_allORone =='One Species by Site') {
        return(list(
          src = glue("www/Indicator_Species/{unique(RDFC_Filter_One()$Species)}.jpg"),
          contentType = "image/jpg", width = 210, height = 210))
      }
      else if (input$RDFC_allORone == 'One Species by Island') {
        return(list(
          src = glue("www/Indicator_Species/{unique(RDFC_FilterByIsl_Isl()$Species)}.jpg"),
          contentType = "image/jpg", width = 210, height = 210))
      }
      else if (input$RDFC_allORone == 'One Species by MPA') {
        return(list(
          src = glue("www/Indicator_Species/{unique(RDFC_Filter_MPA()$Species)}.jpg"),
          contentType = "image/jpg", width = 210, height = 210))
      }
      else if (input$RDFC_allORone == 'Two Species by Site') {
        return(list(
          src = glue("www/Indicator_Species/{unique(RDFC_Filter_Two_One()$Species)}.jpg"),
          contentType = "image/jpg", width = 210, height = 210))
      }
    }, deleteFile = FALSE) # Small species photo above plot
    
    output$RDFC_LargeSpPhoto_One <- renderImage({
      list(src = glue("www/Indicator_Species/{unique(RDFC_Filter_One()$Species)}.jpg"),
           contentType = "image/jpg", width = 400, height = 400)
    }, deleteFile = FALSE) # Large species photo below plot
    
    output$RDFC_TopSitePhoto_One <- renderImage({
      list(src = glue("www/Sat_Imagery/{unique(RDFC_Filter_One()$SiteCode)}.png"),
           contentType = "image/png", width = 430, height = 210)
    }, deleteFile = FALSE) # Small Site photo above plot
    
    output$RDFC_LargeSitePhoto_One <- renderImage({
      list(src = glue("www/Sat_Imagery/{unique(RDFC_Filter_One()$SiteCode)}.png"),
           contentType = "image/png", width = 1250, height = 625)
    }, deleteFile = FALSE) # Large Site photo below plot
    
    output$RDFC_DToutClass_One <- renderDT({
      datatable(RDFC_SpeciesClass_One(), 
                options = list(
                  initComplete = JS(
                    "function(settings, json) {",
                    "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                    "}"),
                  searching = FALSE,
                  lengthChange = FALSE,
                  paging = FALSE,
                  ordering = FALSE,
                  info = FALSE),
                rownames = FALSE) %>% 
        formatStyle(names(RDFC_SpeciesClass_One()),
                    color = "black",
                    backgroundColor = 'white',
                    backgroundPosition = 'center'
        )
    }) # Species Classification data table
    
    output$RDFC_DToutDesc_One <- renderDT({
      datatable(RDFC_SpeciesDescription_One(), 
                options = list(
                  initComplete = JS(
                    "function(settings, json) {",
                    "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                    "}"),
                  searching = FALSE,
                  lengthChange = FALSE,
                  paging = FALSE,
                  ordering = FALSE,
                  info = FALSE),
                rownames = FALSE) %>% 
        formatStyle(names(RDFC_SpeciesDescription_One()),
                    color = "black",
                    backgroundColor = 'white',
                    backgroundPosition = 'center'
        )
    }) # Species Description data table
    
    RDFC_alphaONI_one <- reactive({
      if(input$RDFC_GraphOptions_One == "With No Index"){
        return(0)
      }
      else if(input$RDFC_GraphOptions_One == "With ONI"){
        return(1)
      }
      else if(input$RDFC_GraphOptions_One == "With PDO (NOAA)"){
        return(0)
      }
      else if(input$RDFC_GraphOptions_One == "With PDO (UW)"){
        return(0)
      }
    }) # ONI layer toggle (changes alpha value)
    
    RDFC_alphaPDO_NOAA_one <- reactive({
      if(input$RDFC_GraphOptions_One == "With No Index"){
        return(0)
      }
      if(input$RDFC_GraphOptions_One == "With ONI"){
        return(0)
        
      }
      if(input$RDFC_GraphOptions_One == "With PDO (NOAA)"){
        return(1)
      }
      if(input$RDFC_GraphOptions_One == "With PDO (UW)"){
        return(0)
      }
    }) # PDO NOAA layer toggle (changes alpha value)
    
    RDFC_alphaPDO_UW_one <- reactive({
      if(input$RDFC_GraphOptions_One == "With No Index"){
        return(0)
      }
      if(input$RDFC_GraphOptions_One == "With ONI"){
        return(0)
        
      }
      if(input$RDFC_GraphOptions_One == "With PDO (NOAA)"){
        return(0)
      }
      if(input$RDFC_GraphOptions_One == "With PDO (UW)"){
        return(1)
      }
    }) # PDO UW layer toggle (changes alpha value)
    
    output$RDFC_Plot <- renderPlot({
      ggplot() +
        geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd,ymin = 0, ymax = Inf, fill = ANOM), 
                  position = "identity", alpha = as.numeric(RDFC_alphaONI_one()), show.legend = FALSE) +
        geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                  position = "identity", alpha = as.numeric(RDFC_alphaPDO_NOAA_one()), show.legend = FALSE) +
        geom_rect(data = pdo_uw, aes(xmin= DateStart, xmax = DateEnd, ymin = 0, ymax = Inf, fill = pdoAnom), 
                  position = "identity", alpha = as.numeric(RDFC_alphaPDO_UW_one()), show.legend = FALSE) +
        scale_fill_gradient2(high = "red3", mid = "white", low = "blue3", midpoint = 0) +
        geom_line(data = RDFC_Filter_One(), size = 1, linetype = "solid", 
                  aes(x = Date, y = High_Count, group = ScientificName, color = CommonName)) +
        geom_point(data = RDFC_Filter_One(), size = 2,
                   aes(x = Date, y = Mean_Count, group = ScientificName, color = CommonName)) +
        geom_line(data = RDFC_Filter_One(), size = 1, linetype = "dashed",
                  aes(x = Date, y = Low_Count, group = ScientificName, color = CommonName)) +
        geom_errorbar(data = RDFC_Filter_One(),
                      aes(x = Date, ymin = Mean_Count - StandardError, ymax = Mean_Count + StandardError),
                      width = 0, color = "black", alpha = as.numeric(input$RDFC_EB_one)) +
        geom_text(data = RDFC_Filter_One(), size = 4, fontface = "plain", position = position_dodge(1),
                  aes(x = Date, y = max(RDFC_Filter_One()$High_Count)*1.1, 
                      group = Date, label = paste(' N = \n', RDFC_Filter_One()$Observers))) +
        scale_x_date(date_labels = "%b %Y", breaks = unique(RDFC_Filter_One()$Date),
                     limits = c(min(as.Date(RDFC_Filter_One()$Date))-365, max(as.Date(RDFC_Filter_One()$Date))+365),
                     expand = expansion(mult = c(0.01, .01))) +
        labs(title = glue("{unique(RDFC_Filter_One()$ScientificName)}"),
             subtitle = glue("{unique(RDFC_Filter_One()$IslandName)} {unique(RDFC_Filter_One()$SiteName)}"),
             color = "Common Name",
             caption = glue("{RDFC_Filter_One()$SiteName} is typically surveyed in {
                       lubridate::month(round(mean(month(RDFC_Filter_One()$Date)), 0), label = TRUE, abbr = FALSE)
                       } and has a mean depth of {round(mean(RDFC_Filter_One()$MeanDepth), 2)
        } ft. N = the number of observers. Solid lines represent the high count, points are the mean, and dashed lines are the low count"),
             x = "Year",
             y = "Count") +
        theme_classic() +
        theme(legend.position = "bottom",
              legend.title = element_text(size = 14, vjust = .5, face = "bold"),
              legend.text = element_text(size = 14, vjust = .5),
              plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
              plot.subtitle = element_text(hjust = 0.5, size = 18),
              plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
              axis.title = element_text(size = 16, face = "bold"),
              axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
              axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
    })
    
    output$RDFC_DToutData_One <- renderDT({
      datatable(RDFC_Filter_One(),
                extensions = c('Buttons', 'ColReorder'),
                options = list(
                  initComplete = JS(
                    "function(settings, json) {",
                    "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                    "}"),
                  scrollY = "500px",
                  scrollX = TRUE, 
                  paging = FALSE,
                  ordering = TRUE,
                  info = FALSE,
                  dom = 'Bfrtip',
                  buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                  columnDefs = c( # list(list(visible = FALSE, targets = c(10, 12, 13, 14, 15))), 
                    list(list(className = 'dt-center', targets = 0:23))),
                  colReorder = TRUE),
                rownames = FALSE) %>% 
        formatStyle(names(RDFC_Filter_One()),
                    color = "black",
                    backgroundColor = 'white'
        )
    }) # Filtered data table output
    
  }
  
  output$outTemp <- renderUI({ # Temp_UI ----
    if (is.null(input$temp_allORone))
      return(NULL)
    
    if(input$temp_allORone == "Benthic Temperature by Site") {
      dyn_ui <- tabPanel("Temperature", value = 'temps', # Temp_TP_one       ----
                         plotOutput(outputId = "temp_Zoom_One",
                                    height = 500),
                         plotOutput(outputId = "temp_Overall_One",
                                    height = 200,
                                    brush = brushOpts(id = "temp_Brush_One", direction = "x", opacity = 0.6)),
                         conditionalPanel("input.temp_GraphOptions_One == 'With ONI' || 
                                          input.temp_GraphOptions_One == 'With PDO (NOAA)'",
                                          tags$hr(),
                                          radioButtons(inputId = "temp_ONI_DATA_One",
                                                       label = "Show the all Index data?",
                                                       choices = c("No", "Yes"), inline = TRUE)),
                         conditionalPanel("input.temp_GraphOptions_One == 'With ONI'",
                                          tags$hr(),
                                          ONI_tagList),
                         conditionalPanel("input.temp_GraphOptions_One == 'With PDO (NOAA)'",
                                          tags$hr(),
                                          PDO_NOAA_tagList),
                         tags$hr()
      )
    }
    else if (input$temp_allORone == "Benthic Temperature by Island") {
      dyn_ui <- tabPanel("Temperature", value = 'temps', # Temp_TP_averaged  ----
                         plotOutput(outputId = "temp_Zoom_Isl",
                                    height = 400),
                         plotOutput(outputId = "temp_Overall_Isl",
                                    height = 200,
                                    brush = brushOpts(id = "temp_Brush_Isl", direction = "x", opacity = 0.6)),
                         conditionalPanel("input.temp_GraphOptions_Isl == 'With ONI' || 
                                          input.temp_GraphOptions_Isl == 'With PDO (NOAA)'",
                                          tags$hr(),
                                          radioButtons(inputId = "temp_ONI_DATA_Isl",
                                                       label = "Show the all Index data?",
                                                       choices = c("No", "Yes"), inline = TRUE)),
                         conditionalPanel("input.temp_GraphOptions_Isl == 'With ONI'",
                                          tags$hr(),
                                          ONI_tagList),
                         conditionalPanel("input.temp_GraphOptions_Isl == 'With PDO (NOAA)'",
                                          tags$hr(),
                                          PDO_NOAA_tagList),
                         tags$hr(),
      )
    }
    else if (input$temp_allORone == "Oceanic Nino Index (ONI)") {
      dyn_ui <- tabPanel("Temperature", value = 'temps', # Temp_TP_ONI       ----
                         plotOutput(outputId = "oniZoom",
                                    height = 400),
                         plotOutput(outputId = "oniOverall",
                                    height = 200,
                                    brush = brushOpts(id = "brushoni", direction = "x", opacity = 0.6)),
                         tags$hr()
      )
    }
    else if (input$temp_allORone == "Pacific Decadal Oscillation (PDO)") {
      dyn_ui <- tabPanel("Temperature", value = 'temps', # Temp_TP_PDO       ----
                         plotOutput(outputId = "pdoZoom",
                                    height = 400),
                         plotOutput(outputId = "pdoOverall",
                                    height = 200,
                                    brush = brushOpts(id = "brushpdo", direction = "x", opacity = 0.6)),
                         tags$hr()
      )
    }
    else if (input$temp_allORone == "Scripps Institute of Oceanography (SIO)") {
      dyn_ui <- tabPanel("Temperature", value = 'temps', # Temp_TP_SIO       ----
                         plotOutput(outputId = "sioZoom",
                                    height = 400),
                         plotOutput(outputId = "sioOverall",
                                    height = 200,
                                    brush = brushOpts(id = "brushsio", direction = "x", opacity = 0.6)),
                         tags$hr()
      )
    }
    return(dyn_ui)
  })
  
  { # ........ Temp_Servers ........   ----
    
    { # Temp_OneSite   ----
      
      output$temp_TopSitePhoto <- renderImage({
        if(is.null(input$temp_allORone)){
          return(NULL)
        }
        else if(input$temp_allORone == "Benthic Temperature by Site") {
          return(list(src = glue("www/Sat_Imagery/{unique(temp_Filter_One()$SiteCode)}.png"),
                      contentType = "image/png", width = 430, height = 210)) 
        }
        else if(input$temp_allORone == "Benthic Temperature by Island") {
          return(list(src = glue("www/Sat_Imagery/{unique(temp_Filter_Isl()$IslandCode)}.png"),
                      contentType = "image/png", width = 430, height = 210))
        }
        else if(input$temp_allORone == "Oceanic Nino Index (ONI)") {
          return(list(src = "www/Sat_Imagery/ONI3.4.png",
                      contentType = "image/png", width = 420, height = 210))
        }
        else if(input$temp_allORone == "Pacific Decadal Oscillation (PDO)") {
          return(list(src =  "www/Sat_Imagery/PDO.png",
                      contentType = "image/png", width = 375, height = 210)) 
        }
        else if(input$temp_allORone == "Scripps Institute of Oceanography (SIO)") {
          return(
            list(src = "www/Sat_Imagery/SIO.png",
                 contentType = "image/png", width = 450, height = 210)
          ) 
        }
      }, deleteFile = FALSE)
      
      output$temp_BottomSitePhoto <- renderImage({
        if(is.null(input$temp_allORone)){
          return(NULL)
        }
        else if(input$temp_allORone == "Benthic Temperature by Site") {
          return(list(src = glue("www/Sat_Imagery/{unique(temp_Filter_One()$SiteCode)}.png"),
                      contentType = "image/png", width = 1250, height = 625)) 
        }
        else if(input$temp_allORone == "Benthic Temperature by Island") {
          return(list(src = glue("www/Sat_Imagery/{unique(temp_Filter_Isl()$IslandCode)}.png"),
                      contentType = "image/png", width = 1250, height = 625)) 
        }
        else if(input$temp_allORone == "Oceanic Nino Index (ONI)") {
          return(list(src = "www/Sat_Imagery/ONI3.4.png",
                      contentType = "image/png", width = 1250, height = 625)) 
        }
        else if(input$temp_allORone == "Pacific Decadal Oscillation (PDO)") {
          return(list(src = "www/Sat_Imagery/PDO.png",
                      contentType = "image/png", width = 1120, height = 625)) 
        }
        else if(input$temp_allORone == "Scripps Institute of Oceanography (SIO)") {
          return(list(src = "www/Sat_Imagery/SIO.png",
                      contentType = "image/png", width = 1250, height = 600)) 
        }
      }, deleteFile = FALSE)
      
      temp_Filter_One <- reactive({
        temp %>%dplyr::filter(SiteName == input$SiteNameTemp)
      })
      
      temp_alphaONI_one <- reactive({
        if(input$temp_GraphOptions_One == "With No Index"){
          return(0)
        }
        else if(input$temp_GraphOptions_One == "With ONI"){
          return(.95)
          
        }
        else if(input$temp_GraphOptions_One == "With PDO (NOAA)"){
          return(0)
        }
      })
      
      temp_alphaPDO_one <- reactive({
        if(input$temp_GraphOptions_One == "With No Index"){
          return(0)
        }
        if(input$temp_GraphOptions_One == "With ONI"){
          return(0)
          
        }
        if(input$temp_GraphOptions_One == "With PDO (NOAA)"){
          return(.95)
        }
      })
      
      temp_scaledate_one <- reactive({
        if(input$temp_GraphOptions_One == "With No Index"){
          return({
            c(min(as.Date(temp_Filter_One()$Date))-365, 
              max(as.Date(temp_Filter_One()$Date))+365)
          })
        }
        else if(input$temp_GraphOptions_One == "With ONI" && input$temp_ONI_DATA_One == "Yes"){
          return({
            c(min(as.Date(oni$DateStart)), 
              max(as.Date(temp_Filter_One()$Date)))
          })
        } 
        else if(input$temp_GraphOptions_One == "With PDO (NOAA)" && input$temp_ONI_DATA_One == "Yes"){
          return({
            c(min(as.Date(pdo_noaa$DateStart)), 
              max(as.Date(temp_Filter_One()$Date)))
          })
        } 
        else if(input$temp_ONI_DATA_One == "No"){
          return({
            c(min(as.Date(temp_Filter_One()$Date))-365, 
              max(as.Date(temp_Filter_One()$Date))+365)
          }) 
        }
      })
      
      output$temp_Zoom_One <- renderPlot({
        
        if (!is.null(input$temp_Brush_One)) {
          ggplot() +
            geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd, ymin = -Inf, ymax = Inf, fill = ANOM), 
                      position = "identity", alpha = as.numeric(temp_alphaONI_one())) +
            geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd,
                                           ymin = -Inf, ymax = Inf, fill = pdoAnom),
                      position = "identity", alpha = as.numeric(temp_alphaPDO_one())) +
            scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
            geom_ribbon(data = temp_Filter_One(), aes(x= Date, ymin = MinTemp, ymax = MaxTemp), 
                        alpha = as.numeric(input$temp_minMax_One), fill = "deepskyblue2") +
            geom_line(data = temp_Filter_One(), size = 1, aes(x= Date, y = MeanTemp), color = "black") +
            stat_smooth(geom = 'line', data = temp_Filter_One(), aes(x = Date, y = MeanTemp), se = FALSE, span = 0.75, 
                        alpha = as.numeric(input$temp_Smooth_One), size = 1, color = "green2") +
            labs(title = glue("{unique(temp_Filter_One()$IslandName)} {unique(temp_Filter_One()$SiteName)}"),
                 subtitle = "Weekly Water temperatures",
                 x = NULL,
                 y = "Temperature (°C)") +
            scale_x_date(date_labels = "%b %Y", date_breaks = "6 months", 
                         limits = c(as.Date("1970-01-01") + input$temp_Brush_One$xmin, 
                                    as.Date("1970-01-01") + input$temp_Brush_One$xmax),
                         expand = c(0.01,0)) +
            scale_y_continuous(breaks = c(10, 14, 18, 22),
                               sec.axis = sec_axis(~.*(9/5)+32, name = "Temperature (°F)", 
                                                   breaks = c(50, 57.2, 64.4, 71.6))) +
            theme_classic() +
            theme(legend.position = "none",
                  legend.background = element_rect(),
                  legend.title = element_text(),
                  plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                  plot.subtitle = element_text(hjust = 0.5, size = 16),
                  axis.title = element_text(size = 14, face = "bold"),
                  axis.text.y = element_text(size = 12, face = "bold"),
                  panel.grid.major.y = element_line(size = 1, color = "black", linetype = "solid"),
                  axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"))
        }
        
        else if (is.null(input$temp_Brush_One)){
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin = DateStart, xmax = DateEnd, ymin = -Inf, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(temp_alphaONI_one()))+
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd,
                                             ymin = -Inf, ymax = Inf, fill = pdoAnom),
                        position = "identity", alpha = as.numeric(temp_alphaPDO_one())) +
              scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
              geom_ribbon(data = temp_Filter_One(), aes(x= Date, ymin = MinTemp, ymax = MaxTemp), 
                          alpha = as.numeric(input$temp_minMax_One), fill = "deepskyblue2") +
              geom_line(data = temp_Filter_One(), size = 0.5, aes(x= Date, y = MeanTemp), color = "black") +
              stat_smooth(geom = 'line', data = temp_Filter_One(), aes(x = Date, y = MeanTemp), se = FALSE, span = 0.75, 
                          alpha = as.numeric(input$temp_Smooth_One), size = 1, color = "green2") +
              labs(title = glue("{unique(temp_Filter_One()$IslandName)} {unique(temp_Filter_One()$SiteName)}"),
                   subtitle = "Weekly Water temperatures",
                   x = NULL,
                   y = "Temperature (°C)") +
              scale_x_date(date_labels = "%b %Y", 
                           date_breaks = ifelse(input$temp_GraphOptions_One == "With No Index", "1 year", 
                                                ifelse(input$temp_GraphOptions_One == "With ONI", "2 years", "4 years")), 
                           limits = temp_scaledate_one(),
                           expand = c(0.01,0)) +
              scale_y_continuous(breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                                 sec.axis = sec_axis(~.*(9/5)+32, name = "Temperature (°F)", 
                                                     breaks = c(46.4, 50, 53.6, 57.2, 60.8, 64.4, 68, 71.6))) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.background = element_rect(),
                    legend.title = element_text(),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    axis.title = element_text(size = 14, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    panel.grid.major.y = element_line(size = 1, color = "black", linetype = "solid"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold")) 
          })
        }
      })
      
      output$temp_Overall_One <- renderPlot({
        ggplot() +
          geom_rect(data = oni, aes(xmin = DateStart, xmax = DateEnd, ymin = -Inf, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(temp_alphaONI_one()), show.legend = FALSE) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd,
                                         ymin = -Inf, ymax = Inf, fill = pdoAnom),
                    position = "identity", alpha = as.numeric(temp_alphaPDO_one()), show.legend = FALSE) +
          scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
          geom_ribbon(data = temp_Filter_One(), aes(x= Date, ymin = MinTemp, ymax = MaxTemp), 
                      alpha = as.numeric(input$temp_minMax_One), fill = "deepskyblue2") +
          geom_line(data = temp_Filter_One(), aes(x= Date, y = MeanTemp), alpha = 1, color = "black") +
          labs(title = NULL,
               caption = glue("Mean depth of {unique(temp_Filter_One()$SiteName)
                 } {unique(temp_Filter_One()$IslandName)
                 } is {round(mean(temp_Filter_One()$MeanDepth), 2)} ft"),
               fill = "Oceanic Nino \n Index Gradient",
               x = "Date",
               y = "Temp (°C)") +
          scale_x_date(date_labels = "%b %Y", 
                       date_breaks = ifelse(input$temp_GraphOptions_One == "With No Index", "1 year", 
                                            ifelse(input$temp_GraphOptions_One == "With ONI", "2 years", "4 years")), 
                       limits = temp_scaledate_one(), expand = c(0.01,0)) +
          scale_y_continuous(breaks = c(10, 14, 18, 22),
                             sec.axis = sec_axis(~.*(9/5)+32, name = "Temp (°F)", 
                                                 breaks = c(50, 57.2, 64.4, 71.6))) +
          theme_classic() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 12, vjust = .5, face = "bold"),
                legend.text = element_text(size = 10, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 16),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 14, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold"),
                panel.grid.major.y = element_line(size = 1, color = "black", linetype = "solid"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"))
      })
      
    }
    
    { # Temp_Islands   ----
      
      temp_Filter_Isl <- reactive({
        tempByIsland %>%
          dplyr::filter(IslandName == input$temp_IslandName_Isl)
      })
      
      temp_alphaONI_Isl <- reactive({
        if(input$temp_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        else if(input$temp_GraphOptions_Isl == "With ONI"){
          return(.95)
          
        }
        else if(input$temp_GraphOptions_Isl == "With PDO (NOAA)"){
          return(0)
        }
      })
      
      temp_alphaPDO_Isl <- reactive({
        if(input$temp_GraphOptions_Isl == "With No Index"){
          return(0)
        }
        if(input$temp_GraphOptions_Isl == "With ONI"){
          return(0)
          
        }
        if(input$temp_GraphOptions_Isl == "With PDO (NOAA)"){
          return(.95)
        }
      })
      
      temp_scaledate_Isl <- reactive({
        if(input$temp_GraphOptions_Isl == "With No Index"){
          return({
            c(min(as.Date(temp_Filter_Isl()$Date))-365, 
              max(as.Date(temp_Filter_Isl()$Date))+365)
          })
        }
        else if(input$temp_GraphOptions_Isl == "With ONI" && input$temp_ONI_DATA_Isl == "Yes"){
          return({
            c(min(as.Date(oni$DateStart)), 
              max(as.Date(temp_Filter_Isl()$Date)))
          })
        } 
        else if(input$temp_GraphOptions_Isl == "With PDO (NOAA)" && input$temp_ONI_DATA_Isl == "Yes"){
          return({
            c(min(as.Date(pdo_noaa$DateStart)), 
              max(as.Date(temp_Filter_Isl()$Date)))
          })
        } 
        else if(input$temp_ONI_DATA_Isl == "No"){
          return({
            c(min(as.Date(temp_Filter_Isl()$Date))-365, 
              max(as.Date(temp_Filter_Isl()$Date))+365)
          }) 
        }
      })
      
      output$temp_Zoom_Isl <- renderPlot({
        
        if (!is.null(input$temp_Brush_Isl)) {
          ggplot() +
            geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd, ymin = -Inf, ymax = Inf, fill = ANOM), 
                      position = "identity", alpha = as.numeric(temp_alphaONI_Isl())) +
            geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd,
                                           ymin = -Inf, ymax = Inf, fill = pdoAnom),
                      position = "identity", alpha = as.numeric(temp_alphaPDO_Isl())) +
            scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
            geom_ribbon(data = temp_Filter_Isl(), aes(x= Date, ymin = MinTemp, ymax = MaxTemp),
                        alpha = as.numeric(input$temp_minMax_Isl), fill = "deepskyblue2") +
            geom_line(data = temp_Filter_Isl(), size = 1, aes(x= Date, y = MeanTemp), color = "black") +
            stat_smooth(geom = 'line', data = temp_Filter_Isl(), aes(x= Date, y = MeanTemp),se = FALSE, span = 0.75, 
                        alpha = as.numeric(input$temp_Smooth_Isl), size = 1, color = "green2") +
            labs(title = temp_Filter_Isl()$IslandName,
                 subtitle = "Weekly Benthic Water Temperatures",
                 color = "Mean Weekly Water Temperature",
                 x = NULL,
                 y = "Temperature (°C)") +
            scale_x_date(date_labels = "%b %Y", date_breaks = "6 months", 
                         limits = c(as.Date("1970-01-01") + input$temp_Brush_Isl$xmin, 
                                    as.Date("1970-01-01") + input$temp_Brush_Isl$xmax),
                         expand = expansion(mult = c(0.01, .01))) +
            scale_y_continuous(breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                               sec.axis = sec_axis(~.*(9/5)+32, name = "Temperature (°F)", 
                                                   breaks = c(46.4, 50, 53.6, 57.2, 60.8, 64.4, 68, 71.6))) +
            theme_classic() +
            theme(legend.position = "none",
                  legend.background = element_rect(),
                  legend.title = element_text(),
                  plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                  plot.subtitle = element_text(hjust = 0.5, size = 16),
                  axis.title = element_text(size = 14, face = "bold"),
                  axis.text.y = element_text(size = 12, face = "bold"),
                  panel.grid.major.y = element_line(size = 1, color = "black", linetype = "solid"),
                  axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"))
        }
        
        else if (is.null(input$temp_Brush_Isl)){
          return({
            ggplot() +
              geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd, ymin = -Inf, ymax = Inf, fill = ANOM), 
                        position = "identity", alpha = as.numeric(temp_alphaONI_Isl())) +
              geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd,
                                             ymin = -Inf, ymax = Inf, fill = pdoAnom),
                        position = "identity", alpha = as.numeric(temp_alphaPDO_Isl())) +
              scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
              geom_ribbon(data = temp_Filter_Isl(), aes(x= Date, ymin = MinTemp, ymax = MaxTemp), 
                          alpha = as.numeric(input$temp_minMax_Isl), fill = "deepskyblue2") +
              geom_line(data = temp_Filter_Isl(), size = 0.5, aes(x= Date, y = MeanTemp), color = "black") +
              stat_smooth(geom = 'line', data = temp_Filter_Isl(), aes(x= Date, y = MeanTemp), se = FALSE, span = 0.75,
                          alpha = as.numeric(input$temp_Smooth_Isl), size = 1, color = "green2") +
              labs(title = temp_Filter_Isl()$IslandName,
                   subtitle = "Weekly Benthic Water Temperatures",
                   color = "Mean Weekly Water Temperature",
                   x = NULL,
                   y = "Temperature (°C)") +
              scale_x_date(date_labels = "%b %Y", 
                           date_breaks = ifelse(input$temp_GraphOptions_Isl == "With No Index", "1 year", 
                                                ifelse(input$temp_GraphOptions_Isl == "With ONI", "2 years", "4 years")), 
                           limits = temp_scaledate_Isl(), expand = expansion(mult = c(0.01, .01))) +
              scale_y_continuous(breaks = c(8, 10, 12, 14, 16, 18, 20, 22),
                                 sec.axis = sec_axis(~.*(9/5)+32, name = "Temperature (°F)", 
                                                     breaks = c(46.4, 50, 53.6, 57.2, 60.8, 64.4, 68, 71.6))) +
              theme_classic() +
              theme(legend.position = "none",
                    legend.background = element_rect(),
                    legend.title = element_text(),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    axis.title = element_text(size = 14, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold"),
                    panel.grid.major.y = element_line(size = 1, color = "black", linetype = "solid"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"))
          })
        }
      })
      
      output$temp_Overall_Isl <- renderPlot({
        ggplot() +
          geom_rect(data = oni, aes(xmin= DateStart, xmax = DateEnd, ymin = -Inf, ymax = Inf, fill = ANOM), 
                    position = "identity", alpha = as.numeric(temp_alphaONI_Isl())) +
          geom_rect(data = pdo_noaa, aes(xmin= DateStart, xmax = DateEnd,
                                         ymin = -Inf, ymax = Inf, fill = pdoAnom),
                    position = "identity", alpha = as.numeric(temp_alphaPDO_Isl())) +
          scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
          geom_ribbon(data = temp_Filter_Isl(), aes(x= Date, ymin = MinTemp, ymax = MaxTemp), 
                      alpha = as.numeric(input$temp_minMax_Isl), fill = "deepskyblue2") +
          geom_line(data = temp_Filter_Isl(), aes(x= Date, y = MeanTemp), 
                    alpha = 1,  color = "black") +
          labs(title = NULL,
               caption = glue(
                 "Mean depth of all monitoring sites combined is {temp_Filter_Isl()$MeanDepth} ft."),
               fill = "Oceanic Nino \n Index Gradient",
               x = "Date",
               y = "Temp (°C)") +
          scale_x_date(date_labels = "%b %Y", 
                       date_breaks = ifelse(input$temp_GraphOptions_Isl == "With No Index", "1 year", 
                                            ifelse(input$temp_GraphOptions_Isl == "With ONI", "2 years", "4 years")),
                       limits = temp_scaledate_Isl(), expand = expansion(mult = c(0.01, .01))) +
          scale_y_continuous(breaks = c(10, 14, 18, 22),
                             sec.axis = sec_axis(~.*(9/5)+32, name = "Temp (°F)", 
                                                 breaks = c(50, 57.2, 64.4, 71.6))) +
          theme_classic() +
          theme(legend.position = "none",
                legend.title = element_text(size = 12, vjust = .5, face = "bold"),
                legend.text = element_text(size = 10, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                plot.subtitle = element_text(hjust = 0.5, size = 16),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 14, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold"))
      })
      
    }
    
    { # Temp_ONI_Server ----
      
      onibar <- ggplot(oni, aes(x= Date, y= ANOM, fill = ANOM)) +
        geom_bar(stat = "identity") +
        geom_smooth(se = FALSE, span = 0.75, color = "deeppink") +
        scale_x_date(date_labels = "%Y", date_breaks = "2 year",
                     expand = c(0.01,0)) +
        labs(title = "Oceanic Nino Index (ONI)",
             subtitle = "Nino Region 3.4 (5°N-5°S,120°-170°W)",
             fill = "Anomaly Intensity (°C)",
             x = NULL,
             y = "Sea Surface Temperature Anomaly (°C)") +
        scale_y_continuous(breaks = c(-2, -1.5, -1, -.5, 0, .5, 1, 1.5, 2, 2.5),
                           labels = c("(-2)", "Strong La Nina (-1.5)", "Moderate La Nina (-1)", 
                                      "Weak La Nina (-.5)", "Neutral (0)", "Weak El Nino (.5)",
                                      "Moderate El Nino (1)", "Strong El Nino (1.5)", 
                                      "Very Strong El Nino (2)", "(2.5)")) +
        scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +
        geom_hline(size = 1, yintercept = c(-2, -1.5, -1, -.5, 0, .5, 1, 1.5, 2, 2.5),
                   color = c("blue4", "blue","deepskyblue2", "green3", "black", 
                             "green3", "gold2", "orange2", "red", "red4")) +
        geom_vline(size = 1, xintercept = as.Date("1982-01-01", format = "%Y-%m-%d")) +
        geom_label(x = as.Date("1982-01-01", format = "%Y-%m-%d"), 
                   y= 2.5, aes(label = "KFM begins"),
                   hjust = 0,
                   vjust = 0,
                   inherit.aes = FALSE) +
        theme_dark()+
        theme(legend.position = "none",
              legend.background = element_rect(),
              legend.title = element_text(angle = 270, size = 16, face = "bold"),
              plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
              plot.subtitle = element_text(hjust = 0.5, size = 16),
              axis.title = element_text(size = 16, face = "bold"),
              axis.text.y = element_text(angle = 45, size = 14, face = "bold"),
              axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              axis.line = element_line(colour = "black"))
      
      onigrad <- ggplot(data = oni) +
        geom_rect(aes(xmin= DateStart, xmax = DateEnd, 
                      ymin = 0, ymax = 1, fill = ANOM), 
                  position = "identity", alpha = 1) +
        scale_fill_gradient2(high = "red3", 
                             mid = "white",
                             low = "blue3", 
                             midpoint = 0) +
        scale_x_date(date_labels = "%b %Y", date_breaks = "2 year", 
                     expand = c(0.01,0)) +
        labs(title = "Oceanic Nino Index (ONI)",
             subtitle = "Nino Region 3.4 (5°N-5°S,120°-170°W)",
             fill = "Anomaly Intensity (°C)",
             x = NULL,
             y = "Sea Surface Temperature Anomaly (°C)") +
        scale_y_continuous(breaks = 0:1) +
        scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +
        geom_vline(size = 1, xintercept = as.Date("1982-01-01", format = "%Y-%m-%d")) +
        geom_label(x = as.Date("1982-01-01", format = "%Y-%m-%d"), 
                   y= .8, aes(label = "KFM begins"),
                   hjust = 0,
                   vjust = 0,
                   inherit.aes = FALSE) +
        theme_classic()+
        theme(legend.position = "none",
              legend.title = element_text(angle = 0, size = 16, face = "bold"),
              plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
              plot.subtitle = element_text(hjust = 0.5, size = 16),
              axis.title = element_text(size = 16, face = "bold"),
              axis.text.y = element_text(angle = 45, size = 14, face = "bold"),
              axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              axis.line = element_line(colour = "black"))
      
      output$oniZoom <- renderPlot({
        if (!is.null(input$brushoni) && input$graphONI == "Bar") {
          return({onibar <- onibar + scale_x_date(date_labels = "%b %Y", date_breaks = "1 year", 
                                                  limits = c(as.Date("1970-01-01") + input$brushoni$xmin, 
                                                             as.Date("1970-01-01") + input$brushoni$xmax),
                                                  expand = c(0.01,0))
          })
        }
        if (!is.null(input$brushoni) && input$graphONI == "Gradient") {
          return({onigrad <- onigrad + scale_x_date(date_labels = "%b %Y", date_breaks = "1 year", 
                                                    limits = c(as.Date("1970-01-01") + input$brushoni$xmin, 
                                                               as.Date("1970-01-01") + input$brushoni$xmax),
                                                    expand = c(0.01,0))
          })
        }
        else if (is.null(input$brushoni) && input$graphONI == "Bar") {
          return(onibar)
        }
        else if (is.null(input$brushoni) && input$graphONI == "Gradient") {
          return(onigrad)
        }
      })
      
      output$oniOverall <- renderPlot({
        ggplot(oni, aes(x= Date, y= ANOM, fill = ANOM)) +
          geom_bar(stat = "identity") +
          scale_x_date(date_labels = "%Y", date_breaks = "2 year",
                       expand = c(0.01,0)) +
          labs(title = NULL,
               x = "Date",
               y = "SST Anomaly") +
          scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +
          geom_hline(size = 1, yintercept = c(-2, -1.5, -1, -.5, 0, .5, 1, 1.5, 2, 2.5),
                     color = c("blue4", "blue","deepskyblue2", "green3", "black", "green3", 
                               "gold2", "orange2", "red", "red4")) +
          geom_vline(size = 1, xintercept = as.Date("1982-01-01", format = "%Y-%m-%d")) +
          theme_dark()+
          theme(legend.position = "none",
                legend.background = element_rect(),
                legend.title = element_text(angle = 270, size = 16, face = "bold"),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(angle = 45, size = 14, face = "bold"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
                panel.grid.major = element_blank(),
                panel.grid.minor = element_blank(),
                axis.line = element_line(colour = "black"))
      })
    }
    
    { # Temp_PDO_Server ----
      
      pdoData <- reactive({
        if (input$dataPDO == "NOAA") {
          return(pdo_noaa)
        }
        else if (input$dataPDO == "University of Washington") {
          return(pdo_uw)
        }
      })
      
      pdobar <- reactive({
        ggplot(data = pdoData(), aes(x= Date, y= pdoAnom, fill = pdoAnom)) +
          geom_bar(stat = "identity") +
          geom_smooth(se = FALSE, span = 0.1, color = "deeppink") +
          scale_x_date(date_labels = "%Y", date_breaks = "4 year",
                       expand = c(0.01,0)) +
          labs(title = "Pacific Decadal Oscillation (PDO)",
               subtitle = glue("Data from {unique(pdoData()$Data)}"),
               fill = "Anomaly Intensity (°C)",
               x = "Date",
               y = "Sea Surface Temperature Anomaly (°C)") +
          scale_y_continuous(breaks = -4:4) +
          scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +
          geom_vline(size = 1, xintercept = as.Date("1982-01-01", format = "%Y-%m-%d")) +
          geom_label(x = as.Date("1982-01-01", format = "%Y-%m-%d"), 
                     y= 3.6, aes(label = "KFM begins"),
                     hjust = 0,
                     vjust = 0,
                     inherit.aes = FALSE) +
          theme_dark()+
          theme(legend.position = "none",
                legend.title = element_text(angle = 270, size = 16, face = "bold"),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                plot.subtitle = element_text(hjust = 0.5, size = 16),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(angle = 45, size = 14, face = "bold"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
                panel.grid.major = element_blank(),
                panel.grid.minor = element_blank(),
                axis.line = element_line(colour = "black"))
      })
      
      pdobarzoo <- reactive({
        ggplot(data = pdoData(), aes(x= Date, y= pdoAnom, fill = pdoAnom)) +
          geom_bar(stat = "identity") +
          geom_smooth(se = FALSE, span = 0.1, color = "deeppink") +
          scale_x_date(date_labels = "%b %Y", date_breaks = "1 year", 
                       limits = c(as.Date("1970-01-01") + input$brushpdo$xmin, 
                                  as.Date("1970-01-01") + input$brushpdo$xmax),
                       expand = c(0.01,0)) +
          labs(title = "Pacific Decadal Oscillation (PDO)",
               subtitle = glue("Data from {unique(pdoData()$Data)}"),
               fill = "Anomaly Intensity (°C)",
               x = "Date",
               y = "Sea Surface Temperature Anomaly (°C)") +
          scale_y_continuous(breaks = -4:4) +
          scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +
          geom_vline(size = 1, xintercept = as.Date("1982-01-01", format = "%Y-%m-%d")) +
          geom_label(x = as.Date("1982-01-01", format = "%Y-%m-%d"), 
                     y= 3.6, aes(label = "KFM begins"),
                     hjust = 0,
                     vjust = 0,
                     inherit.aes = FALSE) +
          theme_dark()+
          theme(legend.position = "none",
                legend.title = element_text(angle = 270, size = 16, face = "bold"),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                plot.subtitle = element_text(hjust = 0.5, size = 16),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(angle = 45, size = 14, face = "bold"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
                panel.grid.major = element_blank(),
                panel.grid.minor = element_blank(),
                axis.line = element_line(colour = "black"))
      })
      
      pdograd <- reactive({
        ggplot(data = pdoData()) +
          geom_rect(aes(xmin= DateStart, xmax = DateEnd, 
                        ymin = 0, ymax = 1, fill = pdoAnom), 
                    position = "identity", alpha = 1) +
          scale_fill_gradient2(high = "red3", 
                               mid = "white",
                               low = "blue3", 
                               midpoint = 0) +
          scale_x_date(date_labels = "%b %Y", date_breaks = "4 year", 
                       expand = c(0.01,0)) +
          labs(title = "Pacific Decadal Oscillation (PDO)",
               subtitle = glue("Data from {unique(pdoData()$Data)}"),
               fill = "Anomaly Intensity (°C)",
               x = "Date",
               y = "Mean Monthly Sea Surface Temperature Anomaly (°C)") +
          scale_y_continuous(breaks = 0:1) +
          scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +
          geom_vline(size = 1, xintercept = as.Date("1982-01-01", format = "%Y-%m-%d")) +
          geom_label(x = as.Date("1982-01-01", format = "%Y-%m-%d"), 
                     y= .8, aes(label = "KFM begins"),
                     hjust = 0,
                     vjust = 0,
                     inherit.aes = FALSE) +
          theme_classic()+
          theme(legend.position = "none",
                legend.title = element_text(angle = 0, size = 16, face = "bold"),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                plot.subtitle = element_text(hjust = 0.5, size = 16),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(angle = 45, size = 14, face = "bold"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
                panel.grid.major = element_blank(),
                panel.grid.minor = element_blank(),
                axis.line = element_line(colour = "black"))
      })
      
      pdogradzoo <- reactive({
        ggplot(data = pdoData()) +
          geom_rect(aes(xmin= DateStart, xmax = DateEnd, 
                        ymin = 0, ymax = 1, fill = pdoAnom), 
                    position = "identity", alpha = 1) +
          scale_fill_gradient2(high = "red3", 
                               mid = "white",
                               low = "blue3", 
                               midpoint = 0) +
          scale_x_date(date_labels = "%b %Y", date_breaks = "1 year", 
                       limits = c(as.Date("1970-01-01") + input$brushpdo$xmin, 
                                  as.Date("1970-01-01") + input$brushpdo$xmax),
                       expand = c(0.01,0)) +
          labs(title = "Pacific Decadal Oscillation (PDO)",
               subtitle = glue("Data from {unique(pdoData()$Data)}"),
               fill = "Anomaly Intensity (°C)",
               x = "Date",
               y = "Sea Surface Temperature Anomaly (°C)") +
          scale_y_continuous(breaks = 0:1) +
          scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +
          geom_vline(size = 1, xintercept = as.Date("1982-01-01", format = "%Y-%m-%d")) +
          geom_label(x = as.Date("1982-01-01", format = "%Y-%m-%d"), 
                     y= .8, aes(label = "KFM begins"),
                     hjust = 0,
                     vjust = 0,
                     inherit.aes = FALSE) +
          theme_classic()+
          theme(legend.position = "none",
                legend.title = element_text(angle = 0, size = 16, face = "bold"),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                plot.subtitle = element_text(hjust = 0.5, size = 16),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(angle = 45, size = 14, face = "bold"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
                panel.grid.major = element_blank(),
                panel.grid.minor = element_blank(),
                axis.line = element_line(colour = "black"))
      })
      
      output$pdoZoom <- renderPlot({
        if (!is.null(input$brushpdo) && input$graphPDO == "Bar") {
          return(pdobarzoo())
        }
        else if (!is.null(input$brushpdo) && input$graphPDO == "Gradient") {
          return(pdogradzoo())
        }
        else if (is.null(input$brushpdo) && input$graphPDO == "Bar") {
          return(pdobar())
        }
        else if (is.null(input$brushpdo) && input$graphPDO == "Gradient") {
          return(pdograd())
        }
      })
      
      output$pdoOverall <- renderPlot({
        ggplot(pdoData(), aes(x= Date, y= pdoAnom, fill = pdoAnom)) +
          geom_bar(stat = "identity") +
          scale_x_date(date_labels = "%Y", date_breaks = "5 year",
                       expand = c(0.01,0)) +
          labs(title = NULL,
               x = NULL,
               y = "SST Anomaly (°C)") +
          scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +
          geom_vline(size = 1, xintercept = as.Date("1982-01-01", format = "%Y-%m-%d")) + 
          theme_dark()+
          theme(legend.position = "none",
                legend.background = element_rect(),
                legend.title = element_text(angle = 270, size = 16, face = "bold"),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(angle = 45, size = 14, face = "bold"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
                panel.grid.major = element_blank(),
                panel.grid.minor = element_blank(),
                axis.line = element_line(colour = "black"))
      })
    }
    
    { # Temp_SIO_Server ----
      
      sioData <- reactive({
        if (input$dataSIO == "Surface Temp") {
          return(scrippsTemp)
        }
        else if (input$dataSIO == "Bottom Temp (~ 5 m)") {
          return(scrippsTemp)
        }
        else if (input$dataSIO == "Surface Salinity") {
          return(scrippsSalt)
        }
        else if (input$dataSIO == "Bottom Salinity (~ 5 m)") {
          return(scrippsSalt)
        }
        
      })
      
      siobar <- reactive({
        
        if (input$dataSIO == "Surface Temp") {
          return({
            ggplot() + 
              geom_boxplot(data = sioData(), 
                           aes(x = year(End_of_Week), y = MeanSurfTemp, color = MeanSurfTemp, group = year(End_of_Week))) +
              stat_smooth(data = sioData(), 
                          aes(x = year(End_of_Week), y = MeanSurfTemp, color = MeanSurfTemp),
                          se = FALSE, span = 0.75, color = "deeppink") +
              scale_x_continuous(breaks = seq(1916, 2019, 2), expand = c(0.01,0)) +
              labs(title = "Sea Surface Temperatures",
                   subtitle = "Scripps Institute of Oceanography (SIO)",
                   fill = "Water Temperature (°C)",
                   x = NULL,
                   y = "Mean Weekly Temperatures (°C)") +
              geom_vline(size = 1, xintercept = 1982.5, alpha = .25) +
              geom_label(x = 1982.5,
                         y= Inf, aes(label = "KFM begins"),
                         hjust = 0,
                         vjust = 1,
                         inherit.aes = FALSE) +
              theme_minimal()+
              theme(legend.position = "bottom",
                    legend.title = element_text(angle = 0, size = 16, face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(angle = 45, size = 14, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
                    panel.grid.major = element_blank(),
                    panel.grid.minor = element_blank(),
                    axis.line = element_line(colour = "black"))
          })
        }
        else if (input$dataSIO == "Bottom Temp (~ 5 m)") {
          return({
            ggplot() + 
              geom_boxplot(data = sioData(), 
                           aes(x = year(End_of_Week), y = MeanBotTemp, color = MeanBotTemp, group = year(End_of_Week))) +
              stat_smooth(data = sioData(), 
                          aes(x = year(End_of_Week), y = MeanBotTemp, color = MeanBotTemp),
                          se = FALSE, span = 0.75, color = "darkgreen") +
              scale_x_continuous(breaks = seq(1916, 2019, 2), expand = c(0.01,0)) +
              labs(title = "Sea Surface Temperatures",
                   subtitle = "Scripps Institute of Oceanography (SIO)",
                   fill = "Water Temperature (°C)",
                   x = NULL,
                   y = "Mean Weekly Temperatures (°C)") +
              geom_vline(size = 1, xintercept = 1982.5, alpha = .25) +
              geom_label(x = 1982.5,
                         y= Inf, aes(label = "KFM begins"),
                         hjust = 0,
                         vjust = 1,
                         inherit.aes = FALSE) +
              theme_minimal()+
              theme(legend.position = "bottom",
                    legend.title = element_text(angle = 0, size = 16, face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(angle = 45, size = 14, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
                    panel.grid.major = element_blank(),
                    panel.grid.minor = element_blank(),
                    axis.line = element_line(colour = "black"))
          })
        }
        else if (input$dataSIO == "Surface Salinity") {
          return({
            ggplot() + 
              geom_line(data = sioData(), 
                        aes(x = End_of_Week, y = MeanSurfSal, color = MeanSurfSal)) +
              stat_smooth(data = sioData(), 
                          aes(x = End_of_Week, y = MeanSurfSal, color = MeanSurfSal),
                          se = FALSE, span = 0.75, color = "deeppink") +
              scale_x_date(date_labels = "%Y", date_breaks = "2 year",
                           expand = c(0.01,0)) +
              labs(title = "Surface Salinity",
                   subtitle = "Scripps Institute of Oceanography (SIO)",
                   x = NULL,
                   y = "Mean Weekly Practical Salinity Units (PSU)") +
              geom_vline(size = 1, xintercept = as.Date("1982-01-01", format = "%Y-%m-%d")) +
              geom_label(x = as.Date("1982-01-01", format = "%Y-%m-%d"),
                         y= Inf, aes(label = "KFM begins"),
                         hjust = 0,
                         vjust = 1,
                         inherit.aes = FALSE) +
              theme_minimal()+
              theme(legend.position = "none",
                    legend.title = element_text(angle = 0, size = 16, face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(angle = 45, size = 14, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
                    panel.grid.major = element_blank(),
                    panel.grid.minor = element_blank(),
                    axis.line = element_line(colour = "black"))
          })
        }
        else if (input$dataSIO == "Bottom Salinity (~ 5 m)") {
          return({
            ggplot() + 
              geom_line(data = sioData(), 
                        aes(x = End_of_Week, y = MeanBotSal, color = MeanBotSal)) +
              stat_smooth(data = sioData(), 
                          aes(x = End_of_Week, y = MeanBotSal, color = MeanBotSal),
                          se = FALSE, span = 0.75, color = "darkgreen") +
              scale_x_date(date_labels = "%Y", date_breaks = "2 year",
                           expand = c(0.01,0)) +
              labs(title = "Surface Salinity",
                   subtitle = "Scripps Institute of Oceanography (SIO)",
                   x = NULL,
                   y = "Mean Weekly Practical Salinity Units (PSU)") +
              geom_vline(size = 1, xintercept = as.Date("1982-01-01", format = "%Y-%m-%d")) +
              geom_label(x = as.Date("1982-01-01", format = "%Y-%m-%d"),
                         y= Inf, aes(label = "KFM begins"),
                         hjust = 0,
                         vjust = 1,
                         inherit.aes = FALSE) +
              theme_minimal()+
              theme(legend.position = "none",
                    legend.title = element_text(angle = 0, size = 16, face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(angle = 45, size = 14, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
                    panel.grid.major = element_blank(),
                    panel.grid.minor = element_blank(),
                    axis.line = element_line(colour = "black"))
          })
        }
        
      })
      
      siobarzoo <- reactive({
        
        if (input$dataSIO == "Surface Temp") {
          return({
            ggplot() + 
              geom_boxplot(data = sioData(), 
                           aes(x = year(End_of_Week), y = MeanSurfTemp, color = MeanSurfTemp, group = year(End_of_Week))) +
              stat_smooth(data = sioData(), 
                          aes(x = year(End_of_Week), y = MeanSurfTemp, color = MeanSurfTemp),
                          se = FALSE, span = 0.75, color = "deeppink") +
              scale_x_continuous(breaks = seq(1916, 2019, 2), expand = c(0.01,0),
                                 limits = c(input$brushsio$xmin, input$brushsio$xmax)) +
              labs(title = "Sea Surface Temperatures",
                   subtitle = "Scripps Institute of Oceanography (SIO)",
                   fill = "Water Temperature (°C)",
                   x = NULL,
                   y = "Mean Weekly Temperatures (°C)") +
              geom_vline(size = 1, xintercept = 1982.5, alpha = .25) +
              geom_label(x = 1982.5,
                         y= Inf, aes(label = "KFM begins"),
                         hjust = 0,
                         vjust = 1,
                         inherit.aes = FALSE) +
              theme_minimal()+
              theme(legend.position = "bottom",
                    legend.title = element_text(angle = 0, size = 16, face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(angle = 45, size = 14, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
                    panel.grid.major = element_blank(),
                    panel.grid.minor = element_blank(),
                    axis.line = element_line(colour = "black"))
          })
        }
        else if (input$dataSIO == "Bottom Temp (~ 5 m)") {
          return({
            ggplot() + 
              geom_boxplot(data = sioData(), 
                           aes(x = year(End_of_Week), y = MeanBotTemp, color = MeanBotTemp, group = year(End_of_Week))) +
              stat_smooth(data = sioData(), 
                          aes(x = year(End_of_Week), y = MeanBotTemp, color = MeanBotTemp),
                          se = FALSE, span = 0.75, color = "darkgreen") +
              scale_x_continuous(breaks = seq(1916, 2019, 2), expand = c(0.01,0),
                                 limits = c(input$brushsio$xmin, input$brushsio$xmax)) +
              labs(title = "Sea Surface Temperatures",
                   subtitle = "Scripps Institute of Oceanography (SIO)",
                   fill = "Water Temperature (°C)",
                   x = NULL,
                   y = "Mean Weekly Temperatures (°C)") +
              geom_vline(size = 1, xintercept = 1982.5, alpha = .25) +
              geom_label(x = 1982.5,
                         y= Inf, aes(label = "KFM begins"),
                         hjust = 0,
                         vjust = 1,
                         inherit.aes = FALSE) +
              theme_minimal()+
              theme(legend.position = "bottom",
                    legend.title = element_text(angle = 0, size = 16, face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(angle = 45, size = 14, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
                    panel.grid.major = element_blank(),
                    panel.grid.minor = element_blank(),
                    axis.line = element_line(colour = "black"))
          })
        }
        else if (input$dataSIO == "Surface Salinity") {
          return({
            ggplot() + 
              geom_line(data = sioData(), 
                        aes(x = End_of_Week, y = MeanSurfSal, color = MeanSurfSal)) +
              stat_smooth(data = sioData(), 
                          aes(x = End_of_Week, y = MeanSurfSal, color = MeanSurfSal),
                          se = FALSE, span = 0.75, color = "deeppink") +
              scale_x_date(date_labels = "%Y", date_breaks = "2 year",
                           limits = c(as.Date("1970-01-01") + input$brushsio$xmin, 
                                      as.Date("1970-01-01") + input$brushsio$xmax),
                           expand = c(0.01,0)) +
              labs(title = "Surface Salinity",
                   subtitle = "Scripps Institute of Oceanography (SIO)",
                   x = NULL,
                   y = "Mean Weekly Practical Salinity Units (PSU)") +
              geom_vline(size = 1, xintercept = as.Date("1982-01-01", format = "%Y-%m-%d")) +
              geom_label(x = as.Date("1982-01-01", format = "%Y-%m-%d"),
                         y= Inf, aes(label = "KFM begins"),
                         hjust = 0,
                         vjust = 1,
                         inherit.aes = FALSE) +
              theme_minimal()+
              theme(legend.position = "none",
                    legend.title = element_text(angle = 0, size = 16, face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(angle = 45, size = 14, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
                    panel.grid.major = element_blank(),
                    panel.grid.minor = element_blank(),
                    axis.line = element_line(colour = "black"))
          })
        }
        else if (input$dataSIO == "Bottom Salinity (~ 5 m)") {
          return({
            ggplot() + 
              geom_line(data = sioData(), 
                        aes(x = End_of_Week, y = MeanBotSal, color = MeanBotSal)) +
              stat_smooth(data = sioData(), 
                          aes(x = End_of_Week, y = MeanBotSal, color = MeanBotSal),
                          se = FALSE, span = 0.75, color = "darkgreen") +
              scale_x_date(date_labels = "%Y", date_breaks = "2 year",
                           limits = c(as.Date("1970-01-01") + input$brushsio$xmin, 
                                      as.Date("1970-01-01") + input$brushsio$xmax),
                           expand = c(0.01,0)) +
              labs(title = "Surface Salinity",
                   subtitle = "Scripps Institute of Oceanography (SIO)",
                   x = NULL,
                   y = "Mean Weekly Practical Salinity Units (PSU)") +
              geom_vline(size = 1, xintercept = as.Date("1982-01-01", format = "%Y-%m-%d")) +
              geom_label(x = as.Date("1982-01-01", format = "%Y-%m-%d"),
                         y= Inf, aes(label = "KFM begins"),
                         hjust = 0,
                         vjust = 1,
                         inherit.aes = FALSE) +
              theme_minimal()+
              theme(legend.position = "none",
                    legend.title = element_text(angle = 0, size = 16, face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(angle = 45, size = 14, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
                    panel.grid.major = element_blank(),
                    panel.grid.minor = element_blank(),
                    axis.line = element_line(colour = "black"))
          })
        }
        
      })
      
      sioover <- reactive({
        
        if (input$dataSIO == "Surface Temp") {
          return({
            ggplot() + 
              geom_boxplot(data = sioData(), 
                           aes(x= year(End_of_Week), y= MeanSurfTemp, color = MeanSurfTemp, group = year(End_of_Week))) +
              stat_smooth(data = sioData(), aes(x= year(End_of_Week), y= MeanSurfTemp, color = MeanSurfTemp),
                          se = FALSE, span = 0.75, color = "deeppink") +
              scale_x_continuous(breaks = seq(1916, 2019, 2), expand = c(0.01,0)) +
              labs(fill = "Water Temperature (°C)",
                   x = "Date",
                   y = "(°C)") +
              geom_vline(size = 1, xintercept = 1982.5, alpha = .25) +
              geom_label(x = 1982.5,
                         y= Inf, aes(label = "KFM begins"),
                         hjust = 0,
                         vjust = 1,
                         inherit.aes = FALSE) +
              theme_minimal()+
              theme(legend.position = "bottom",
                    legend.title = element_text(angle = 0, size = 16, face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(angle = 45, size = 14, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
                    panel.grid.major = element_blank(),
                    panel.grid.minor = element_blank(),
                    axis.line = element_line(colour = "black"))
          })
        }
        else if (input$dataSIO == "Bottom Temp (~ 5 m)") {
          return({
            ggplot() + 
              geom_boxplot(data = sioData(), 
                           aes(x= year(End_of_Week), y= MeanBotTemp, color = MeanBotTemp, group = year(End_of_Week))) +
              stat_smooth(data = sioData(), aes(x= year(End_of_Week), y= MeanBotTemp, color = MeanBotTemp),
                          se = FALSE, span = 0.75, color = "darkgreen") +
              scale_x_continuous(breaks = seq(1916, 2019, 2), expand = c(0.01,0)) +
              labs(fill = "Water Temperature (°C)",
                   x = "Date",
                   y = "(°C)") +
              geom_vline(size = 1, xintercept = 1982.5, alpha = .25) +
              geom_label(x = 1982.5,
                         y= Inf, aes(label = "KFM begins"),
                         hjust = 0,
                         vjust = 1,
                         inherit.aes = FALSE) +
              theme_minimal()+
              theme(legend.position = "bottom",
                    legend.title = element_text(angle = 0, size = 16, face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(angle = 45, size = 14, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
                    panel.grid.major = element_blank(),
                    panel.grid.minor = element_blank(),
                    axis.line = element_line(colour = "black"))
          })
        }
        else if (input$dataSIO == "Surface Salinity") {
          return({
            ggplot() + 
              geom_line(data = sioData(), 
                        aes(x = End_of_Week, y = MeanSurfSal, color = MeanSurfSal)) +
              stat_smooth(data = sioData(), 
                          aes(x = End_of_Week, y = MeanSurfSal, color = MeanSurfSal),
                          se = FALSE, span = 0.75, color = "deeppink") +
              scale_x_date(date_labels = "%Y", date_breaks = "4 year",
                           expand = c(0.01,0)) +
              labs(x = "Date",
                   y = "(PSU)") +
              geom_vline(size = 1, xintercept = as.Date("1982-01-01", format = "%Y-%m-%d")) +
              geom_label(x = as.Date("1982-01-01", format = "%Y-%m-%d"),
                         y= Inf, aes(label = "KFM begins"),
                         hjust = 0,
                         vjust = 1,
                         inherit.aes = FALSE) +
              theme_minimal()+
              theme(legend.position = "none",
                    legend.title = element_text(angle = 0, size = 16, face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(angle = 45, size = 14, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
                    panel.grid.major = element_blank(),
                    panel.grid.minor = element_blank(),
                    axis.line = element_line(colour = "black"))
          })
        }
        else if (input$dataSIO == "Bottom Salinity (~ 5 m)") {
          return({
            ggplot() + 
              geom_line(data = sioData(), 
                        aes(x = End_of_Week, y = MeanBotSal, color = MeanBotSal)) +
              stat_smooth(data = sioData(), 
                          aes(x = End_of_Week, y = MeanBotSal, color = MeanBotSal),
                          se = FALSE, span = 0.75, color = "darkgreen") +
              scale_x_date(date_labels = "%Y", date_breaks = "4 year",
                           expand = c(0.01,0)) +
              labs(x = "Date",
                   y = "(PSU)") +
              geom_vline(size = 1, xintercept = as.Date("1982-01-01", format = "%Y-%m-%d")) +
              geom_label(x = as.Date("1982-01-01", format = "%Y-%m-%d"),
                         y= Inf, aes(label = "KFM begins"),
                         hjust = 0,
                         vjust = 1,
                         inherit.aes = FALSE) +
              theme_minimal()+
              theme(legend.position = "none",
                    legend.title = element_text(angle = 0, size = 16, face = "bold"),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                    plot.subtitle = element_text(hjust = 0.5, size = 16),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(angle = 45, size = 14, face = "bold"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
                    panel.grid.major = element_blank(),
                    panel.grid.minor = element_blank(),
                    axis.line = element_line(colour = "black"))
          })
        }
        
      })
      
      output$sioZoom <- renderPlot({
        if (!is.null(input$brushsio)) {
          return(siobarzoo())
        }
        else if (is.null(input$brushsio)) {
          return(siobar())
        }
      })
      
      output$sioOverall <- renderPlot({
        sioover()
      })
    }
    
  }
  
  output$outStat <- renderUI({ # Stat_UI ----
    if (is.null(input$statTest))
      return(NULL)
    
    if(input$statTest == "Empirical Cumulative Distribution") {
      dyn_ui <- tabPanel("Stats", value = 'stat', # Stat_TP_ECD      ----
                         plotOutput(outputId = "EDC"),
                         tags$hr()
      )
    }
    return(dyn_ui)
  })
  
  { # ........ Stat_SideBar_UI ........  ----
    
    output$StatDataOut <- renderUI({ # by_Site   ----
      
      
      if(input$statProtocol == "NHSF"){
        return(
          selectInput(inputId = "SpeciesECD",
                      label = "Choose a Species:",
                      choices =unique(NHSF_DFRaw$CommonName)))
      }
      else if(input$statProtocol == "One Meter"){
        return(
          selectInput(inputId = "SpeciesECD",
                      label = "Choose a Species:",
                      choices =unique(oneM_DFRaw$CommonName)))
      }
      else if(input$statProtocol == "Five Meter") {
        return(
          selectInput(inputId = "SpeciesECD",
                      label = "Choose a Species:",
                      choices =unique(fiveM_DFRaw$CommonName)))
      }
      else if(input$statProtocol == "Bands"){
        return(
          selectInput(inputId = "SpeciesECD",
                      label = "Choose a Species:",
                      choices =unique(bands_DFRaw$CommonName)))
      }
      
    }) 
    
    output$StatDataOut1 <- renderUI({ # by_Isl   ----
      
      
      if(input$statProtocol == "NHSF"){
        return(
          selectInput(inputId = "SpeciesECD1",
                      label = "Choose a Species:",
                      choices =unique(NHSF_DFRaw$CommonName)))
      }
      else if(input$statProtocol == "One Meter"){
        return(
          selectInput(inputId = "SpeciesECD1",
                      label = "Choose a Species:",
                      choices =unique(oneM_DFRaw$CommonName)))
      }
      else if(input$statProtocol == "Five Meter") {
        return(
          selectInput(inputId = "SpeciesECD1",
                      label = "Choose a Species:",
                      choices =unique(fiveM_DFRaw$CommonName)))
      }
      else if(input$statProtocol == "Bands"){
        return(
          selectInput(inputId = "SpeciesECD1",
                      label = "Choose a Species:",
                      choices =unique(bands_DFRaw$CommonName)))
      }
      
    })
    
    output$StatDataOut2 <- renderUI({ # by_MPA   ----
      
      
      if(input$statProtocol == "NHSF"){
        return(
          selectInput(inputId = "SpeciesECD2",
                      label = "Choose a Species:",
                      choices =unique(NHSF_DFRaw$CommonName)))
      }
      else if(input$statProtocol == "One Meter"){
        return(
          selectInput(inputId = "SpeciesECD2",
                      label = "Choose a Species:",
                      choices =unique(oneM_DFRaw$CommonName)))
      }
      else if(input$statProtocol == "Five Meter") {
        return(
          selectInput(inputId = "SpeciesECD2",
                      label = "Choose a Species:",
                      choices =unique(fiveM_DFRaw$CommonName)))
      }
      else if(input$statProtocol == "Bands"){
        return(
          selectInput(inputId = "SpeciesECD2",
                      label = "Choose a Species:",
                      choices =unique(bands_DFRaw$CommonName)))
      }
      
    })
    
    output$StatDataOut3 <- renderUI({ # by_All   ----
      
      
      if(input$statProtocol == "NHSF"){
        return(
          selectInput(inputId = "SpeciesECD3",
                      label = "Choose a Species:",
                      choices =unique(NHSF_DFRaw$CommonName)))
      }
      else if(input$statProtocol == "One Meter"){
        return(
          selectInput(inputId = "SpeciesECD3",
                      label = "Choose a Species:",
                      choices =unique(oneM_DFRaw$CommonName)))
      }
      else if(input$statProtocol == "Five Meter") {
        return(
          selectInput(inputId = "SpeciesECD3",
                      label = "Choose a Species:",
                      choices =unique(fiveM_DFRaw$CommonName)))
      }
      else if(input$statProtocol == "Bands"){
        return(
          selectInput(inputId = "SpeciesECD3",
                      label = "Choose a Species:",
                      choices =unique(bands_DFRaw$CommonName)))
      }
      
      
    })
  }
  
  { # ........ Stat_Servers ........   ----
    
    { # Stat EDC ----
      
      EDCdata <-reactive({
        if(input$statProtocol == "NHSF" && input$SiteOrIslStat == "By Site"){
          return({
            NHSF_DFRaw %>%
              dplyr::filter(SiteName == input$SiteNameECD,
                            CommonName == input$SpeciesECD)
          })
        }
        else if(input$statProtocol == "NHSF" && input$SiteOrIslStat == "By Island"){
          return({
            NHSF_DFRaw %>%
              dplyr::filter(IslandName == input$IslNameECD,
                            CommonName == input$SpeciesECD1)
          })
        }
        else if(input$statProtocol == "NHSF" && input$SiteOrIslStat == "By MPA"){
          return({
            NHSF_DFRaw %>%
              dplyr::filter(SiteNumber != '5' &
                              SiteNumber != '6' & 
                              SiteNumber != '7' & 
                              SiteNumber != '8' &
                              SiteNumber != '10',
                            SurveyYear > 2004,
                            IslandName == input$MPANameECD,
                            CommonName == input$SpeciesECD2)
          })
        }
        else if(input$statProtocol == "One Meter" && input$SiteOrIslStat == "By Site"){
          return({
            oneM_DFRaw %>%
              dplyr::filter(SiteName == input$SiteNameECD,
                            CommonName == input$SpeciesECD)
          })
        }
        else if(input$statProtocol == "One Meter" && input$SiteOrIslStat == "By Island"){
          return({
            oneM_DFRaw %>%
              dplyr::filter(IslandName == input$IslNameECD,
                            CommonName == input$SpeciesECD1)
          })
        }
        else if(input$statProtocol == "Five Meter" && input$SiteOrIslStat == "By Site") {
          return({
            fiveM_DFRaw %>%
              dplyr::filter(SiteName == input$SiteNameECD,
                            CommonName == input$SpeciesECD)
          })
        }
        else if(input$statProtocol == "Five Meter" && input$SiteOrIslStat == "By Island") {
          return({
            fiveM_DFRaw %>%
              dplyr::filter(IslandName == input$IslNameECD,
                            CommonName == input$SpeciesECD1)
          })
        }
        else if(input$statProtocol == "Bands" && input$SiteOrIslStat == "By Site"){
          return({
            bands_DFRaw %>%
              dplyr::filter(SiteName == input$SiteNameECD,
                            CommonName == input$SpeciesECD)
          })
        }
        else if(input$statProtocol == "Bands" && input$SiteOrIslStat == "By Island"){
          return({
            bands_DFRaw %>%
              dplyr::filter(IslandName == input$IslNameECD,
                            CommonName == input$SpeciesECD1)
          })
        }
        
      })  
      
      output$EDC <- renderPlot({
        if(input$statProtocol == "NHSF" && input$SiteOrIslStat != "By MPA"){
          return({
            ggplot() +
              stat_ecdf(data = EDCdata(), aes(Size_mm, color = CommonName), 
                        geom = "point", size = 2) +
              labs(title = glue("{unique(EDCdata()$ScientificName)}"),
                   subtitle= ifelse(input$SiteOrIslStat == "By Site",
                                    glue("{unique(EDCdata()$IslandName)} {unique(EDCdata()$SiteName)}"), 
                                    glue("{unique(EDCdata()$IslandName)}")), 
                   fill = "Common Name",
                   color = "Common Name",
                   y = "Cumulative Probability",
                   x = "Size Distribution (mm)") +
              scale_fill_manual(values = SpeciesColor) +
              scale_color_manual(values = SpeciesColor) +
              theme_minimal() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
          })
        }
        if(input$statProtocol == "NHSF" && input$SiteOrIslStat == "By MPA"){
          return({
            ggplot() +
              stat_ecdf(data = EDCdata(), aes(Size_mm, color = ReserveStatus), 
                        geom = "point", size = 2) +
              labs(title = glue("{unique(EDCdata()$ScientificName)}"),
                   subtitle= ifelse(input$SiteOrIslStat == "By Site",
                                    glue("{unique(EDCdata()$IslandName)} {unique(EDCdata()$SiteName)}"), 
                                    glue("{unique(EDCdata()$IslandName)}")), 
                   fill = "Common Name",
                   color = "Common Name",
                   y = "Cumulative Probability",
                   x = "Size Distribution (mm)") +
              scale_fill_manual(values = SpeciesColor) +
              scale_color_manual(values = c(Inside = "green3", Outside = "red3")) +
              theme_minimal() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
          })
        }
        else if(input$statProtocol == "One Meter" | input$statProtocol == "Five Meter" | input$statProtocol == "Bands"){
          return({
            ggplot() +
              stat_ecdf(data = EDCdata(), aes(Count, color = CommonName), geom = "point", size = 2) +
              labs(title = glue("{unique(EDCdata()$ScientificName)}"),
                   subtitle= ifelse(input$SiteOrIslStat == "By Site",
                                    glue("{unique(EDCdata()$IslandName)} {unique(EDCdata()$SiteName)}"), 
                                    glue("{unique(EDCdata()$IslandName)}")),  
                   fill = "Common Name",
                   color = "Common Name",
                   y = "Cumulative Probability",
                   x = ifelse(input$statProtocol == "One Meter", "Count per 2 m squared", 
                              ifelse(input$statProtocol == "Five Meter", "Count per 5 m squared", 
                                     "Count per 30 m squared"))) +
              scale_fill_manual(values = SpeciesColor) +
              scale_color_manual(values = SpeciesColor) +
              theme_minimal() +
              theme(legend.position = "bottom",
                    legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                    legend.text = element_text(size = 14, vjust = .5),
                    plot.title = element_text(hjust = 0.5, size = 22, face = "bold.italic"),
                    plot.subtitle = element_text(hjust = 0.5, size = 18),
                    plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                    axis.title = element_text(size = 16, face = "bold"),
                    axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
          })
        }
      })
    }
    
  }
  
  output$HistoryPDF <- renderUI({ # ........ History_PDF_Archive ........   -----
    
    tags$iframe(
      style="height:600px; width:100%; scrolling=yes",
      src = "Handbook/History.pdf")
  })
  
  { # ........ Protocol_Servers ........    ----
    
    Protocol_filter <- reactive({
      Protocol_PDFs %>%
        dplyr::filter(Alt_SurveyType == input$protoChoice)
    })
    
    # 1st Small species photo above plot
    output$Proto_Photo <- renderImage({
      list(src = "www/KFM_Old.jpg", contentType = "image/jpg", width = 191, height = 230)
    }, deleteFile = FALSE) 
    
    output$Proto_Photo_Two <- renderImage({
      if (input$protoChoice == "1 m Quads"){
        return(list(src = "www/Protocol_Photos/1m.jpg", contentType = "image/jpg", width = 346, height = 230))
      }
      else if (input$protoChoice == "5 m Quads"){
        return(list(src = "www/Protocol_Photos/5mQuads.jpg", contentType = "image/jpg", width = 346, height = 230))
      }
      else if (input$protoChoice == "ARMs"){
        return(list(src = "www/Protocol_Photos/ARM.jpg", contentType = "image/jpg", width = 346, height = 230))
      }
      else if (input$protoChoice == "Bands"){
        return(list(src = "www/Protocol_Photos/Band.jpg", contentType = "image/jpg", width = 346, height = 230))
      }
      else if (input$protoChoice == "Fish Sizes"){
        return(list(src = "www/Protocol_Photos/FSF.jpg", contentType = "image/jpg", width = 346, height = 230))
      }
      else if (input$protoChoice == "NHSF"){
        return(list(src = "www/Protocol_Photos/NHSF.jpg", contentType = "image/jpg", width = 346, height = 230))
      }
      else if (input$protoChoice == "RDFC"){
        return(list(src = "www/Protocol_Photos/RDFC.jpg", contentType = "image/jpg", width = 346, height = 230))
      }
      else if (input$protoChoice == "RPCs"){
        return(list(src = "www/Protocol_Photos/RPC.jpg", contentType = "image/jpg", width = 346, height = 230))
      }
      else if (input$protoChoice == "Species List"){
        return(list(src = "www/Protocol_Photos/SpeciesList.jpg", contentType = "image/jpg", width = 346, height = 230))
      }
      else if (input$protoChoice == "Temp Loggers"){
        return(list(src = "www/Protocol_Photos/Temp.jpg", contentType = "image/jpg", width = 346, height = 230))
      }
      else if (input$protoChoice == "Site Videos"){
        return(list(src = "www/Protocol_Photos/Video.jpg", contentType = "image/jpg", width = 346, height = 230))
      }
      else if (input$protoChoice == "Fish Transects"){
        return(list(src = "www/Protocol_Photos/VFT.jpg", contentType = "image/jpg", width = 346, height = 230))
      }
    }, deleteFile = FALSE) 
    
    output$SurveyProtocols <- renderUI({
      if (is.null(input$Proto))
        return(NULL)
      
      if(input$Proto == "Survey Protocols"){ # Protocol_PDFs   -----
        return({
          tags$iframe(
            style="height:600px; width:100%; scrolling=yes",
            src = glue("Handbook/Protocols/{unique(Protocol_filter()$Protocol)}")) 
        })
      }
      else if(input$Proto == "Protocol Guides"){ # Protocol Guide PDFs   -----
        return(tags$iframe(style="height:600px; width:100%; scrolling=yes",
                           src = glue("Handbook/Protocol_Guides/{unique(Protocol_filter()$ProtocolGuide)}")))
      }
      else if(input$Proto == "Species Guides"){ # Protocol Guide PDFs   -----
        return(tags$iframe(style="height:600px; width:100%; scrolling=yes",
                           src = glue("Handbook/Species_Guides/{unique(Protocol_filter()$SpeciesGuide)}")))
      }
      else if(input$Proto == "Data Management and History") {  # Data Management_PDFs   -----
        return(tags$iframe(style="height:600px; width:100%; scrolling=yes",
                           src = glue("Handbook/Data_Managment/{unique(Protocol_filter()$DataManagement)}")))
      }
      else if(input$Proto == "Datasheets") {  # Datasheet_PDFs   -----
        return(tags$iframe(style="height:600px; width:100%; scrolling=yes",
                           src = glue("Datasheets/{unique(Protocol_filter()$Datasheet)}")))
      }
      else if(input$Proto == "Other Guides" && input$other_guides == "Santa Barbara Coastal LTER") {  # SBC_LTER PDFs   -----
        return(tags$iframe(style="height:600px; width:100%; scrolling=yes",
                           src = "Handbook/Other_Guides/LTER FieldGuide 2015.pdf"))
      }
      else if(input$Proto == "Other Guides" && input$other_guides == "Urchin Disease Guide") {  # Urchin Diesease PDFs   -----
        return(tags$iframe(style="height:600px; width:100%; scrolling=yes",
                           src = "Handbook/Other_Guides/urchin_disease_guide.pdf"))
      }
      else if(input$Proto == "Other Guides" && input$other_guides == "PISCO UPC") {  # PISCO_UPC PDFs   -----
        return(tags$iframe(style="height:600px; width:100%; scrolling=yes",
                           src = "Handbook/Other_Guides/PISCO_UPC.pdf"))
      }
      else if(input$Proto == "Other Guides" && input$other_guides == "PISCO UPC (Algae Only)") {  # PISCO_UPC algae PDFs   -----
        return(tags$iframe(style="height:600px; width:100%; scrolling=yes",
                           src = "Handbook/Other_Guides/PISCO_UPC_algae.pdf"))
      }
      else if(input$Proto == "Other Guides" && input$other_guides == "PISCO Swath Inverts") {  # PISCO_Swath PDFs   -----
        return(tags$iframe(style="height:600px; width:100%; scrolling=yes",
                           src = "Handbook/Other_Guides/PISCO_2013_swath_inverts.pdf"))
      }
    })
  }
  
  output$outPhoto <-renderUI({ # Photo_UI   ----
    if (is.null(input$photogroups))
      return(NULL)
    else if(input$photogroups == "Indicator Species") { #  Indicator Species   ----
      dyn_ui <- tabPanel("Photo Library", value = 'photo',
                         radioButtons(inputId = "class",
                                      label = "Choose",
                                      choices = c("Algae", "Invertebrates", "Fish"),
                                      inline = TRUE),
                         tags$hr(),
                         fluidRow(column(8, imageOutput(outputId = "Indicator",
                                                        height = 700)),
                                  column(3, tags$h2(tags$strong("Species Classification")),
                                         DTOutput(outputId = "DToutClassPhoto",
                                                  height = 600))))
    }
    else if(input$photogroups == "Disease") { #  Disease     ----
      dyn_ui <- tabPanel("Photo Library", value = 'photo',
                         tags$hr(),
                         conditionalPanel("input.disease == 'Abalone'",
                                          tags$h1(tags$strong("Withering Syndrome (WS) in Red Abalone (Haliotis rufescens)")),
                                          imageOutput(outputId = "AbaloneWD1",
                                                      height = 600), tags$hr(),
                                          imageOutput(outputId = "AbaloneWD2",
                                                      height = 600)),
                         conditionalPanel("input.disease == 'Urchins'",
                                          fluidRow(
                                            column(6, tags$h1(tags$strong("Red Urchin Wasting Disease")),
                                                   imageOutput(outputId = "RedWD",
                                                               height = 400)),
                                            column(6, tags$h1(tags$strong("Purple Urchin Wasting Disease")),
                                                   imageOutput(outputId = "PurpleWD",
                                                               height = 400))),
                                          tags$hr(),
                                          fluidRow(
                                            column(6, tags$h1(tags$strong("Red Urchin Blackspot Disease")),
                                                   imageOutput(outputId = "RedBS",
                                                               height = 400)),
                                            column(6, tags$h1(tags$strong("Purple Urchin Blackspot Disease")),
                                                   imageOutput(outputId = "PurpleBS",
                                                               height = 400))),
                                          tags$hr(),
                                          fluidRow(
                                            column(6, tags$h1(tags$strong("Red Urchin Both Diseases")),
                                                   imageOutput(outputId = "RedWDBS",
                                                               height = 400)),
                                            column(6, tags$h1(tags$strong("Purple Urchin Both Diseases")),
                                                   imageOutput(outputId = "PurpleWDBS",
                                                               height = 400)))),
                         conditionalPanel("input.disease == 'Stars'",
                                          tags$h1(tags$strong("Bat Star Wasting Disease")),
                                          fluidRow(column(1, actionButton(inputId = "Disease_previous",
                                                                          label = "Previous")),
                                                   column(1, verbatimTextOutput(outputId = "Disease_numK")),
                                                   column(1, actionButton(inputId = "Disease_next",
                                                                          label = "Next"))),
                                          imageOutput(outputId = "BatWD",
                                                      height = 600)))
    }
    else if(input$photogroups == "Kelp Forest Scenes") { #  Kelp forest scenes   ----
      dyn_ui <- tabPanel("Photo Library", value = 'photo',
                         tags$hr(),
                         conditionalPanel("input.Photographer == 'Kenan Chan'",
                                          tags$h1(tags$strong(input$Photographer)),
                                          fluidRow(
                                            column(1, actionButton(inputId = "KFS_previous",
                                                                   label = "Previous")),
                                            column(1, verbatimTextOutput(outputId = "KFS_numK")),
                                            column(1, actionButton(inputId = "KFS_next",
                                                                   label = "Next"))), 
                                          imageOutput(outputId = "KFS_photo_K", 
                                                      height = 600)),
                         conditionalPanel("input.Photographer == 'Laurie Montgomery'",
                                          tags$h1(tags$strong(input$Photographer)),
                                          fluidRow(
                                            column(1, actionButton(inputId = "KFS_previousL",
                                                                   label = "Previous")),
                                            column(1, verbatimTextOutput(outputId = "KFS_numL")),
                                            column(1, actionButton(inputId = "KFS_nextL",
                                                                   label = "Next"))),
                                          imageOutput(outputId = "KFS_photo_L", 
                                                      height = 600)),
                         conditionalPanel("input.Photographer == 'Brett Seymour'",
                                          tags$h1(tags$strong(input$Photographer)),
                                          fluidRow(
                                            column(1, actionButton(inputId = "KFS_previousB",
                                                                   label = "Previous")),
                                            column(1, verbatimTextOutput(outputId = "KFS_numB")),
                                            column(1, actionButton(inputId = "KFS_nextB",
                                                                   label = "Next"))),
                                          imageOutput(outputId = "KFS_photo_B", 
                                                      height = 600)))
    }
    return(dyn_ui)
  })
  
  { # ........ Photo_Servers ........ ----
    
    # add actionButton for next photos
    
    { # Indicators Server   ----
      
      
      photoName <- reactive({
        ifelse(input$class == "Algae", input$Algae,
               ifelse(input$class == "Invertebrates", input$Invertebrates,
                      ifelse(input$class == "Fish", input$Fish, "NA")))
      })
      
      AlgaeInd <- reactive({
        dplyr::filter(Indicators, CommonName == input$Algae)
      })
      
      InvertInd <- reactive({
        dplyr::filter(Indicators, CommonName == input$Invertebrates)
      })
      
      FishInd <- reactive({
        dplyr::filter(Indicators, CommonName == input$Fish)
      })
      
      SpeciesClassPhoto <- reactive({
        SpeciesName %>%
          dplyr::filter(CommonName == photoName()) %>%
          dplyr::select(ScientificName, Kingdom, Phylum, Class, Order, Family, Genus, "Species (Used by KFM)", 
                        Status, "Currently Accepted Name", "Authority (Accepted)", CommonName) %>%
          tidyr::pivot_longer(-ScientificName, names_to = "Rank", values_to = "Name") %>%
          dplyr::select(Rank, Name)
      })
      
      output$Indicator <- renderImage({
        
        if (is.null(input$class))
          return(NULL)
        
        if (input$class == "Algae" && input$Algae == AlgaeInd()$CommonName) {
          return(list(
            src = glue("www/Indicator_Species/{unique(AlgaeInd()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(AlgaeInd()$CommonName)}"),
            width = 700,
            height = 700
          ))
        }
        else if(input$class == "Invertebrates" && input$Invertebrates == InvertInd()$CommonName) {
          return(list(
            src = glue("www/Indicator_Species/{unique(InvertInd()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(InvertInd()$CommonName)}"),
            width = 700,
            height = 700
          ))
        }
        else if(input$class == "Fish" && input$Fish == FishInd()$CommonName) {
          return(list(
            src = glue("www/Indicator_Species/{unique(FishInd()$Species)}.jpg"),
            contentType = "image/jpg",
            alt = glue("{unique(FishInd()$CommonName)}"),
            width = 700,
            height = 700
          ))
        }
      } , deleteFile = FALSE)
      
      output$DToutClassPhoto <- renderDT({
        datatable(SpeciesClassPhoto(), 
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    pageLength = length(SpeciesClassPhoto()$Rank),
                    searching = FALSE,
                    lengthChange = FALSE,
                    paging = FALSE,
                    ordering = FALSE,
                    info = FALSE),
                  rownames = FALSE) %>% 
          formatStyle(names(SpeciesClassPhoto()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      })
      # output$PN <- renderText({
      #   photoName()
      # })
    }
    
    { # Disease Server   ----
      
      d <- reactive({
        1 + input$Disease_next - input$Disease_previous
      })
      
      output$AbaloneWD1 <- renderImage({
        list(
          src = "www/Disease/Abalone/WD (1).jpg",
          contentType = "image/jpg",
          alt = "Abalone RLO-WS-1",
          width = 900,
          height = 600
        )
      } , deleteFile = FALSE)
      
      output$AbaloneWD2 <- renderImage({
        list(
          src = "www/Disease/Abalone/WD (3).jpg",
          contentType = "image/jpg",
          alt = "Abalone RLO-WS-1",
          width = 900,
          height = 600
        )
      } , deleteFile = FALSE)
      
      output$RedWD <- renderImage({
        list(
          src = "www/Disease/Red/WD (1).jpg",
          contentType = "image/jpg",
          alt = "Red WD 1",
          width = 500,
          height = 400
        )
      } , deleteFile = FALSE)
      
      output$PurpleWD <- renderImage({
        list(
          src = "www/Disease/Purple/WD (1).jpg",
          contentType = "image/jpg",
          alt = "Purple1",
          width = 500,
          height = 400
        )
      } , deleteFile = FALSE)
      
      output$RedBS <- renderImage({
        list(
          src = "www/Disease/Red/BS (1).jpg",
          contentType = "image/jpg",
          alt = "Red BS 1",
          width = 500,
          height = 400
        )
      } , deleteFile = FALSE)
      
      output$PurpleBS <- renderImage({
        list(
          src = "www/Disease/Purple/BS (1).jpg",
          contentType = "image/jpg",
          alt = "Purple BS 1",
          width = 500,
          height = 400
        )
      } , deleteFile = FALSE)
      
      output$RedWDBS <- renderImage({
        list(
          src = "www/Disease/Red/WDBS (1).jpg",
          contentType = "image/jpg",
          alt = "Red WDBS 1",
          width = 500,
          height = 400
        )
      } , deleteFile = FALSE)
      
      output$PurpleWDBS <- renderImage({
        list(
          src = "www/Disease/Purple/WDBS (1).jpg",
          contentType = "image/jpg",
          alt = "Purple WDBS 1",
          width = 500,
          height = 400
        )
      } , deleteFile = FALSE)
      
      output$Disease_numK <- renderText({
        glue("{d()}/{length(list.files(path = 'www/Disease/Bat'))}")
      })
      
      output$BatWD <- renderImage({
        list(
          src = glue("www/Disease/Bat/WD ({d()}).jpg"),
          contentType = "image/jpg",
          alt = "Bat Star 1",
          width = 900,
          height = 600
        )
      } , deleteFile = FALSE)
      
    }
    
    { # Kelp Forest Scenes   -----
      
      k <- reactive({
        1 + input$KFS_next - input$KFS_previous
      })
      
      l <- reactive({
        1 + input$KFS_nextL - input$KFS_previousL
      })
      
      b <- reactive({
        1 + input$KFS_nextB - input$KFS_previousB
      })
      
      output$KFS_numK <- renderText({
        glue("{k()}/{length(list.files(path = 'www/kelp_forest_scenes/Kenan_Chan'))}")
      })
      
      output$KFS_numL <- renderText({
        glue("{l()}/{length(list.files(path = 'www/kelp_forest_scenes/Laurie_Montgomery'))}")
      })
      
      output$KFS_numB <- renderText({
        glue("{b()}/{length(list.files(path = 'www/kelp_forest_scenes/Brett_Seymour'))}")
      })
      
      output$KFS_photo_K <- renderImage({
        list(src = glue("www/kelp_forest_scenes/Kenan_Chan/1 ({k()}).jpg"),
             contentType = "image/jpg",
             height = 600,
             width = 900) 
      }, deleteFile = FALSE)
      
      output$KFS_photo_L <- renderImage({
        list(src = glue("www/kelp_forest_scenes/Laurie_Montgomery/1 ({l()}).jpg"),
             contentType = "image/jpg",
             height = 600,
             width = 900) 
      }, deleteFile = FALSE)
      
      output$KFS_photo_B <- renderImage({
        list(src = glue("www/kelp_forest_scenes/Brett_Seymour/1 ({b()}).jpg"),
             contentType = "image/jpg",
             height = 600,
             width = 900) 
      }, deleteFile = FALSE)
      
    }
  }
  
  output$MAPS <- renderUI({ # Maps_UI ----
    if (is.null(input$maptype))
      return(NULL)
    
    if(input$maptype == "Leaflet Maps") {
      dyn_ui <- tabPanel("Site Maps", value = "maps", # Maps_TP_Leaflet      ----
                         leafletOutput(outputId = "Leaflet",
                                       height = 600, width = '100%'))
    }
    else if(input$maptype == "Satellite Site Maps") {
      dyn_ui <- tabPanel("Site Maps", value = "maps", # Maps_TP_Sat      ----
                         imageOutput(outputId = "statMap",
                                     height = 600, width = 1000))
    }
    else if (input$maptype == "Bathymetry Maps") {
      dyn_ui <- tabPanel("Site Maps", value = "maps", # Maps_TP_Bath  ----
                         imageOutput(outputId = "image1",
                                     height = 800),
                         tags$hr())
    }
    else if (input$maptype == "ARM Maps") {
      dyn_ui <- tabPanel("Site Maps", value = "maps", # Maps_TP_ARMs  ----
                         imageOutput(outputId = "ARMmap",
                                     height = 800),
                         tags$hr())
    }
    else if (input$maptype == "Site Descriptions") {
      dyn_ui <- tabPanel("Site Maps", value = "maps", # Maps_TP_Descriptions  ----
                         htmlOutput(outputId = 'SitePDF'),
                         tags$hr())
    }
    return(dyn_ui)
  })
  
  { # ........ Map_Servers ........   ----
    
    { # Leaflet Maps     ----
      
      output$Leaflet <- renderLeaflet({
        leaflet() %>%
          setView(lng = -119.7277, lat = 33.76416, zoom = 9) %>%
          addTiles(group = "OSM (default)") %>% 
          addProviderTiles(providers$Esri, group = "ESRI") %>%
          addProviderTiles(providers$Esri.OceanBasemap, group = "Ocean Base") %>%
          addProviderTiles(providers$Esri.WorldImagery, group = "Imagery") %>%
          addProviderTiles(providers$Esri.WorldTopoMap, group = "Topography") %>%
          addProviderTiles(providers$Esri.NatGeoWorldMap, group = "Nat. Geo.") %>%
          addPolygons(data = marine, color = marine$Color, weight = 1,
                      fillOpacity = 0.1, opacity = 0.25, label = marine$NAME, group = "MPA Boundaries")  %>%
          addPolygons(data = NPS_boundary, weight = 2, color = "green", fill = FALSE,
                      label = "Channel Islands National Park (CINP) Boundary", group = "CINP Boundary") %>%
          addPolygons(data = CINMS_boundary, weight = 2, color = "blue", fill = FALSE,
                      label = "Channel Islands National Marine Sanctuary (CINMS) Boundary", group = "CINMS Boundary") %>%
          addPolylines(data = transects, group = "Transects")  %>%
          addCircles(radius = 1, group = "Transect End Points", color = "green",
                     lng = Transect_Endpoints$Start_Long, lat = Transect_Endpoints$Start_Lat, 
                     label = Transect_Endpoints$Start_Label) %>%
          addCircles(radius = 1, group = "Transect End Points", color = "red",
                     lng = Transect_Endpoints$End_Long, lat = Transect_Endpoints$End_Lat, 
                     label = Transect_Endpoints$End_Label) %>%
          addMarkers(data = siteInfo2, label = paste(siteInfo2$IslandCode, siteInfo2$SiteName), group = "Site Markers") %>% 
          addCircleMarkers(data = Buoys_List, label = Buoys_List$DC.description, group = "Buoy Stations") %>% 
          addLayersControl(
            baseGroups = c("OSM (default)", "ESRI", "Ocean Base", "Imagery", "Topography", "Nat. Geo."),
            overlayGroups = c("Site Markers", "Transects", "Transect End Points",
                              "MPA Boundaries", "CINP Boundary", "CINMS Boundary",  "Buoy Stations"),
            options = layersControlOptions(collapsed = TRUE)) %>%
          addMeasure(position = "bottomleft",
                     primaryLengthUnit = "meters",
                     primaryAreaUnit = "sqmeters",
                     activeColor = "#3D535D",
                     completedColor = "#7D4479")
      })
      
    }
    
    { # Satellite Site Maps  -----
      
      statMapSiteCode <- reactive({
        siteInfo1 %>% dplyr::filter(SiteName == input$SiteNameStatMaps)  
      })
      
      output$statMap <- renderImage({
        list(
          src = glue("www/Sat_Imagery/{statMapSiteCode()$SiteCode}.png"),
          contentType = "image/png",
          width = 1250,
          height = 625
        )
      }, deleteFile = FALSE)
    }
    
    { # Bathymetery Maps   ----
      
      output$image1 <- renderImage({
        
        bathsite <- reactive({
          BATHlist %>%
            dplyr::filter(SiteName == input$bathMaps)
        })
        
        if (is.null(input$bathMaps))
          return(NULL)
        
        if (input$bathMaps == bathsite()$SiteName) {
          return(list(
            src = glue("www/Bathymetry/{unique(bathsite()$SiteNumber)}.png"),
            contentType = "image/png",
            alt = glue("{unique(bathsite()$SiteName)}"),
            width = 1000,
            height = 750
          ))
        }
      } , deleteFile = FALSE)
      
      
    }
    
    { # ARM Maps   ----
      
      output$ARMmap <- renderImage({
        
        armsite <- reactive({
          ARMlist %>%
            dplyr::filter(SiteName == input$armMaps)
        })
        
        if (is.null(input$armMaps))
          return(NULL)
        
        if (input$armMaps == armsite()$SiteName) {
          return(list(
            src = glue("www/ARMs/{unique(armsite()$SiteNumber)}.png"),
            contentType = "image/png",
            alt = glue("{unique(armsite()$SiteName)}"),
            width = 1000,
            height = 750
          ))
        }
      }, deleteFile = FALSE)
      
    }
    
    { # Site Descriptions   ----
      
      output$SitePDF <- renderUI({
        
        SiteDescription <- reactive({
          siteInfo2 %>%
            dplyr::filter(SiteName == input$SiteDesc)
        })
        
        tags$iframe(
          style="height:1000px; width:100%; scrolling=yes",
          src = glue("Site_Descriptions/{unique(SiteDescription()$SiteNumber)}.pdf"))
        
      })
    }
  }
  
  output$viewReport <- renderUI({ # ........ Report_PDF_Archive ........   -----
    
    tags$iframe(style="height:600px; width:100%; scrolling=yes",
                src = glue("Annual_Reports/{input$Reports}.pdf"))
  })
  
  
  output$VD_UIout <- renderUI({ # Visit Dates UI   ----
    if (is.null(input$VD_allORone))
      return(NULL)
    
    else if(input$VD_allORone == "By Site"){ # By Site      ----
      dyn_ui <- tabPanel("Visit Dates", value = "VD_TP",
                         plotOutput(outputId = "VD_Plot_One", 
                                    height = 600),
                         tags$hr(),
                         plotOutput(outputId = "VD_Plot_One_Two", 
                                    height = 600),
                         tags$hr(),
                         fluidRow(column(6, tags$h2(tags$strong("Monitoring Days Summary")),
                                         DTOutput(outputId = "VD_StatSummary_One_One",
                                                  height = 350)),
                                  column(6, tags$h2(tags$strong("Monitoring Months Summary")),
                                         DTOutput(outputId = "VD_StatSummary_One_Two",
                                                  height = 350))),
                         tags$hr(),
                         tags$h2(tags$strong("Monitoring Dates Summary")),
                         DTOutput(outputId = "VD_Summary_One",
                                  height = 500),
                         tags$hr())
    }
    else if(input$VD_allORone == "By Island"){ # By Island  ----
      dyn_ui <- tabPanel("Visit Dates", value = "VD_TP",
                         plotOutput(outputId = "VD_Plot_Isl", 
                                    height = 600),
                         tags$hr(),
                         fluidRow(column(6, tags$h2(tags$strong("Monitoring Days Summary")),
                                         DTOutput(outputId = "VD_StatSummary_Isl_One",
                                                  height = 350)),
                                  column(6, tags$h2(tags$strong("Monitoring Months Summary")),
                                         DTOutput(outputId = "VD_StatSummary_Isl_Two",
                                                  height = 350))),
                         tags$hr(),
                         tags$h2(tags$strong("Monitoring Dates Summary")),
                         DTOutput(outputId = "VD_Summary_Isl",
                                  height = 500),
                         tags$hr())
    }
    else if(input$VD_allORone == "Weekly Itinerary"){ # Weekly Itinerary  ----
      dyn_ui <- tabPanel("Visit Dates", value = "VD_TP",
                         DTOutput(outputId = "VD_Trip_Itinerary"),
                         tags$hr(),
                         leafletOutput(outputId = "LeafletTrip",
                                       height = 600, width = '100%'),
                         verbatimTextOutput(outputId = "Map_Text"),
                         tags$hr(),
                         DTOutput(outputId = "Lealet_Buoy_Table"), 
                         tags$hr())
    }
    return(dyn_ui)
  })
  
  output$VD_TripNum_Out <- renderUI({
    radioButtons(inputId = "VD_TripNum",
                 label = "Choose a Trip: ",
                 choices = 1:max(VD_Itinerary_SB()$Trip_Number))
  })
  
  {  # ........ VD_Servers ........  ----
    
    { # By Site     ----
      
      VD_Filter_One <- reactive({
        if (input$VD_SurveyType_One == "All"){
          return(
            visitDates %>%
              dplyr::filter(SiteName == input$VD_SiteName_One) 
          )
        }else if(input$VD_SurveyType_One == "Core Vs Fish"){
          visitDates$SurveyType <- visitDates$CvsF
          visitDates %>% 
            dplyr::filter(SiteName == input$VD_SiteName_One) %>% 
            dplyr::distinct(Date, SurveyType, .keep_all = TRUE)
        }else{
          visitDates %>% 
            dplyr::filter(SiteName == input$VD_SiteName_One, 
                          SurveyType == input$VD_SurveyType_One)
        }
      })
      
      output$VD_TopSitePhoto_One <- renderImage({
        if (input$VD_allORone =='By Site') {
          return(
            list(src = glue("www/Sat_Imagery/{unique(VD_Filter_One()$SiteCode)}.png"),
                 contentType = "image/png", width = 430, height = 210))
        }
        else if (input$VD_allORone =='By Island') {
          return(
            list(src = glue("www/Sat_Imagery/{unique(VD_Filter_Isl()$IslandCode)}.png"),
                 contentType = "image/png", width = 430, height = 210))
        }
        else if (input$VD_allORone =='Weekly Itinerary') {
          return(
            list(src = glue("www/Protocol_Photos/Boat.jpg"),
                 contentType = "image/jpg", width = 315, height = 210))
        }
      }, deleteFile = FALSE) # Small Site photo above plot
      
      output$VD_LargeSitePhoto_One <- renderImage({
        if (input$VD_allORone =='By Site') {
          return(
            list(src = glue("www/Sat_Imagery/{unique(VD_Filter_One()$SiteCode)}.png"),
                 contentType = "image/png", width = 1250, height = 625))
        }
        else if (input$VD_allORone =='By Island') {
          return(
            list(src = glue("www/Sat_Imagery/{unique(VD_Filter_Isl()$IslandCode)}.png"),
                 contentType = "image/png", width = 1250, height = 625))
        }
        else if (input$VD_allORone =='Weekly Itinerary') {
          return(
            list(src = glue("www/Protocol_Photos/Boat.jpg"),
                 contentType = "image/jpg", width = 937, height = 625))
        }
      }, deleteFile = FALSE) # Large Site photo below plot
      
      output$VD_Plot_One <- renderPlot({
        ggplot() +
          geom_point(data = VD_Filter_One(), position = position_jitterdodge(jitter.height = .2), size = 2,
                     aes(x = lubridate::year(Date), y = lubridate::month(Date),
                         group = SurveyYear, color = SurveyType)) +
          geom_line(data = VD_Filter_One(), show.legend = FALSE, alpha = as.numeric(input$VD_MeanDate_One),
                    aes(x = lubridate::year(MeanDate), y = lubridate::month(MeanDate),
                        group = SiteName), color = "black") +
          scale_y_continuous(expand = expansion(mult = c(0, .1)), breaks = 4:11, 
                             labels =  c("Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov")) +
          scale_x_continuous(breaks = unique(lubridate::year(VD_Filter_One()$Date))) +
          labs(title = glue("{unique(VD_Filter_One()$IslandName)} {unique(VD_Filter_One()$SiteName)}"),
               color = "Survey Type",
               x = "Year",
               y = "Month") +
          guides(color = guide_legend(nrow = 1)) +
          theme_minimal() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
      })
      
      output$VD_Plot_One_Two <- renderPlot({
        ggplot() +
          geom_point(data = VD_Filter_One(), 
                     position = position_jitterdodge(jitter.height = .2, jitter.width = .75), size = 2,
                     aes(x = lubridate::year(Date), y = lubridate::wday(Date),
                         group = SurveyYear, color = SurveyType)) +
          geom_line(data = VD_Filter_One(), show.legend = FALSE, alpha = as.numeric(input$VD_MeanDate_One),
                    aes(x = lubridate::year(MeanDate), y = MeanWeekDay,
                        group = SiteName), color = "black") +
          scale_y_continuous(expand = expansion(mult = c(0, .1)), breaks = 1:7, 
                             labels =  c("Sun", "Mon", "Tues", "Wed", "Thur", "Fri", "Sat")) +
          scale_x_continuous(breaks = unique(lubridate::year(VD_Filter_One()$Date))) +
          labs(title = glue("{unique(VD_Filter_One()$IslandName)} {unique(VD_Filter_One()$SiteName)}"),
               color = "Survey Type",
               x = "Month",
               y = "Weekday") +
          guides(color = guide_legend(nrow = 1)) +
          theme_minimal() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
      })
      
      VD_FilterDT_One <- reactive({
        visitDates %>% 
          dplyr::filter(SiteName == input$VD_SiteName_One) %>% 
          dplyr::distinct(Date, SurveyYear, SiteCode, .keep_all = TRUE) %>% 
          dplyr::select(SurveyYear, SiteNumber, IslandName, SiteName, Date, MeanDate, Day_of_Week, Month) %>% 
          arrange(Date) 
      })
      
      VD_FilterDT_One_One <- reactive({
        visitDates %>% 
          dplyr::mutate(Day_of_Week = lubridate::wday(Date, label = TRUE, abbr = FALSE)) %>% 
          dplyr::filter(SiteName == input$VD_SiteName_One) %>%
          dplyr::distinct(Day_of_Week, Date, SurveyYear) %>%
          dplyr::mutate(Count_up_to_2004 = ifelse(SurveyYear < 2005, 1, 0),
                        Count_after_2004 = ifelse(SurveyYear > 2004, 1, 0)) %>% 
          dplyr::group_by(Day_of_Week) %>% 
          dplyr::mutate(Count_up_to_2004 = sum(Count_up_to_2004),
                        Count_after_2004 = sum(Count_after_2004)) %>% 
          dplyr::distinct(Day_of_Week, Count_up_to_2004, Count_after_2004) %>% 
          arrange(Day_of_Week) 
      })
      
      VD_FilterDT_One_Two <- reactive({
        visitDates %>% 
          dplyr::mutate(Month = lubridate::month(Date, label = TRUE, abbr = FALSE)) %>% 
          dplyr::filter(SiteName == input$VD_SiteName_One) %>% 
          dplyr::distinct(Month, Date, SurveyYear) %>%
          dplyr::mutate(Count_up_to_2004 = ifelse(SurveyYear < 2005, 1, 0),
                        Count_after_2004 = ifelse(SurveyYear > 2004, 1, 0)) %>% 
          dplyr::group_by(Month) %>% 
          dplyr::mutate(Count_up_to_2004 = sum(Count_up_to_2004),
                        Count_after_2004 = sum(Count_after_2004)) %>% 
          dplyr::distinct(Month, Count_up_to_2004, Count_after_2004) %>% 
          arrange(Month)
      })
      
      output$VD_StatSummary_One_One <- renderDT({
        datatable(VD_FilterDT_One_One(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "300px",
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = list(list(className = 'dt-center', targets = 0:2)),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(VD_FilterDT_One_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      })
      
      output$VD_StatSummary_One_Two <- renderDT({
        datatable(VD_FilterDT_One_Two(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "300px",
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = list(list(className = 'dt-center', targets = 0:2)),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(VD_FilterDT_One_Two()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      })
      
      output$VD_Summary_One <- renderDT({
        datatable(VD_FilterDT_One(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "425px",
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = list(list(className = 'dt-center', targets = 0:6)),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(VD_FilterDT_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      })
      
    }
    
    { # By Island     ----
      
      VD_Filter_Isl <- reactive({
        if (input$VD_SurveyType_Isl == "All"){
          return(
            visitDates %>%
              dplyr::filter(IslandName == input$VD_IslandName_Isl)
          )
        }else if(input$VD_SurveyType_Isl == "Core Vs Fish"){
          visitDates$SurveyType <- visitDates$CvsF
          visitDates %>% 
            dplyr::filter(IslandName == input$VD_IslandName_Isl) 
        }else{
          visitDates %>% 
            dplyr::filter(IslandName == input$VD_IslandName_Isl, 
                          SurveyType == input$VD_SurveyType_Isl) 
        }
      })
      
      output$VD_Plot_Isl <- renderPlot({
        ggplot() +
          geom_point(data = VD_Filter_Isl(), 
                     position = position_jitterdodge(jitter.height = .2, jitter.width = .75), size = 2,
                     aes(x = lubridate::year(Date), y = lubridate::month(Date),
                         group = SurveyYear, color = SurveyType)) +
          geom_line(data = VD_Filter_Isl(), show.legend = FALSE, alpha = as.numeric(input$VD_MeanDate_Isl),
                    aes(x = lubridate::year(Isl_MeanDate), y = lubridate::month(Isl_MeanDate),
                        group = IslandName, color = IslandName)) +
          scale_y_continuous(expand = expansion(mult = c(0, .1)), breaks = 4:11, 
                             labels =  c("Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov")) +
          scale_x_continuous(breaks = unique(lubridate::year(VD_Filter_Isl()$Date))) +
          labs(title = glue("{unique(VD_Filter_Isl()$IslandName)}"),
               color = "Survey Type",
               x = "Year",
               y = "Month") +
          guides(color = guide_legend(nrow = 1)) +
          theme_minimal() +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 14, vjust = .5, face = "bold"),
                legend.text = element_text(size = 14, vjust = .5),
                plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
                plot.subtitle = element_text(hjust = 0.5, size = 18),
                plot.caption = element_text(hjust = 0, size = 12, face = "bold"),
                axis.title = element_text(size = 16, face = "bold"),
                axis.text.y = element_text(size = 12, face = "bold",  color = "black"),
                axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, face = "bold",  color = "black"))
      })
      
      VD_FilterDT_Isl <- reactive({
        visitDates %>% 
          dplyr::group_by(SurveyYear) %>% 
          dplyr::mutate(Day_of_Week = lubridate::wday(Date, label = TRUE, abbr = FALSE),
                        Month = lubridate::month(Date, label = TRUE, abbr = FALSE))%>% 
          dplyr::filter(IslandName == input$VD_IslandName_Isl) %>% 
          dplyr::distinct(Date, SurveyYear, SiteCode, .keep_all = TRUE) %>% 
          dplyr::select(SurveyYear, SiteNumber, IslandName, SiteName, Date, Isl_MeanDate, Day_of_Week, Month) %>% 
          arrange(Date) 
      })
      
      VD_FilterDT_Isl_One <- reactive({
        visitDates %>% 
          dplyr::mutate(Day_of_Week = lubridate::wday(Date, label = TRUE, abbr = FALSE)) %>% 
          dplyr::filter(IslandName == input$VD_IslandName_Isl) %>%
          dplyr::distinct(Day_of_Week, Date, SurveyYear) %>%
          dplyr::mutate(Count_up_to_2004 = ifelse(SurveyYear < 2005, 1, 0),
                        Count_after_2004 = ifelse(SurveyYear > 2004, 1, 0)) %>% 
          dplyr::group_by(Day_of_Week) %>% 
          dplyr::mutate(Count_up_to_2004 = sum(Count_up_to_2004),
                        Count_after_2004 = sum(Count_after_2004)) %>% 
          dplyr::distinct(Day_of_Week, Count_up_to_2004, Count_after_2004) %>% 
          arrange(Day_of_Week) 
      })
      
      VD_FilterDT_Isl_Two <- reactive({
        visitDates %>% 
          dplyr::mutate(Month = lubridate::month(Date, label = TRUE, abbr = FALSE)) %>% 
          dplyr::filter(IslandName == input$VD_IslandName_Isl) %>% 
          dplyr::distinct(Month, Date, SurveyYear) %>%
          dplyr::mutate(Count_up_to_2004 = ifelse(SurveyYear < 2005, 1, 0),
                        Count_after_2004 = ifelse(SurveyYear > 2004, 1, 0)) %>% 
          dplyr::group_by(Month) %>% 
          dplyr::mutate(Count_up_to_2004 = sum(Count_up_to_2004),
                        Count_after_2004 = sum(Count_after_2004)) %>% 
          dplyr::distinct(Month, Count_up_to_2004, Count_after_2004) %>% 
          arrange(Month)
      })
      
      output$VD_StatSummary_Isl_One <- renderDT({
        datatable(VD_FilterDT_Isl_One(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "300px",
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = list(list(className = 'dt-center', targets = 0:2)),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(VD_FilterDT_Isl_One()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      })
      
      output$VD_StatSummary_Isl_Two <- renderDT({
        datatable(VD_FilterDT_Isl_Two(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "300px",
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = list(list(className = 'dt-center', targets = 0:2)),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(VD_FilterDT_Isl_Two()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      })
      
      output$VD_Summary_Isl <- renderDT({
        datatable(VD_FilterDT_Isl(),
                  extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    initComplete = JS(
                      "function(settings, json) {",
                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
                      "}"),
                    scrollY = "425px",
                    paging = FALSE,
                    ordering = TRUE,
                    info = FALSE,
                    dom = 'Bfrtip',
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    columnDefs = list(list(className = 'dt-center', targets = 0:6)),
                    colReorder = TRUE),
                  rownames = FALSE) %>% 
          formatStyle(names(VD_FilterDT_Isl()),
                      color = "black",
                      backgroundColor = 'white',
                      backgroundPosition = 'center'
          )
      })
      
    }
    
    { # Weekly Itinerary
      
      VD_Itinerary_SB <- reactive({
        visitDates %>%
          dplyr::filter(SurveyYear == input$VD_Year)
      })
      
      VD_Itinerary <- reactive({
        VD_Itinerary_SB() %>%
          dplyr::filter(Trip_Number == input$VD_TripNum) %>% 
          dplyr::distinct(Date, SiteName, .keep_all = TRUE) %>% 
          dplyr::group_by(SurveyYear) %>% 
          dplyr::mutate(Trip_Number = cumsum(c(TRUE, diff(Date) > 3))) %>% 
          dplyr::ungroup() %>% 
          dplyr::select(Date, SiteNumber, SiteName, IslandName, Day_of_Week, Month, Latitude, Longitude)
      })
      
      output$VD_Trip_Itinerary <- renderDT({
        datatable(VD_Itinerary(), rownames = FALSE, extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    scrollY = "100%", scrollX = TRUE, paging = FALSE,
                    ordering = TRUE, info = FALSE, dom = 'Bfrtip', colReorder = TRUE,
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    initComplete = JS("function(settings, json) {",
                                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});", "}"),
                    columnDefs = c(list(list(className = 'dt-center', targets = 0:7))))) %>% 
          formatStyle(names(VD_Itinerary()),
                      color = "black", backgroundColor = 'white')
      }) 
      
      output$LeafletTrip <- renderLeaflet({
        leaflet() %>%
          setView(lng = -119.7277, lat = 33.76416, zoom = 9) %>%
          addTiles(group = "OSM (default)") %>%
          addProviderTiles(providers$Esri, group = "ESRI") %>%
          addProviderTiles(providers$Esri.OceanBasemap, group = "Ocean Base") %>%
          addProviderTiles(providers$Esri.WorldImagery, group = "Imagery") %>%
          addProviderTiles(providers$Esri.WorldTopoMap, group = "Topography") %>%
          addProviderTiles(providers$Esri.NatGeoWorldMap, group = "Nat. Geo.") %>%
          addPolygons(data = marine, color = marine$Color, weight = 1,
                      fillOpacity = 0.1, opacity = 0.25, label = marine$NAME, group = "MPAs")  %>%
          addPolygons(data = NPS_boundary, weight = 2, color = "green", fill = FALSE,
                      label = "Channel Islands National Park Boundary", group = "Park Boundary") %>%
          addPolygons(data = CINMS_boundary, weight = 2, color = "blue", fill = FALSE,
                      label = "Channel Islands National Marine Sanctuary Boundary", group = "Sanctuary Boundary") %>%
          addPolylines(data = transects, group = "Transects")  %>%
          
          addPolylines(data = VD_Itinerary(), color = "red", group = "Trip Legs",
                       lng = c(-119.273384, unique(VD_Itinerary()$Longitude)),
                       lat = c(34.245145, unique(VD_Itinerary()$Latitude)))  %>%
          
          addMarkers(data = VD_Itinerary(), group = "Site Markers",
                     label = paste(VD_Itinerary()$Day_of_Week, VD_Itinerary()$SiteName)) %>% 
          addCircleMarkers(data = Buoys_List, label = Buoys_List$DC.description, group = "Buoy Stations") %>% 
          addLayersControl(
            baseGroups = c("OSM (default)", "ESRI", "Ocean Base", "Imagery", "Topography", "Nat. Geo."),
            overlayGroups = c("MPAs", "Park Boundary", "Sanctuary Boundary", 
                              "Transects", "Site Markers", "Buoy Stations", "Trip Legs"),
            options = layersControlOptions(collapsed = TRUE)) %>%
          addMeasure(position = "bottomleft",
                     primaryLengthUnit = "meters",
                     primaryAreaUnit = "sqmeters",
                     activeColor = "#3D535D",
                     completedColor = "#7D4479")
      })
      
      output$Map_Text <- renderText({
        paste("Buoy Number:", Buoy_Num()$station, 
              "Latitude:", input$LeafletTrip_marker_click$lat, 
              "Longitude:", input$LeafletTrip_marker_click$lng)
      })
      
      event <- reactive({input$LeafletTrip_marker_click})
      
      Buoy_Num <- reactive({
        Buoys_List %>% 
          dplyr::filter(lat == input$LeafletTrip_marker_click$lat,
                        lon == input$LeafletTrip_marker_click$lng)
      })
      
      Buoy_Num_Data <- reactive({
        if (Buoy_Num()$station == 46053) {
          return({
            Buoy_46053_DF %>% 
              dplyr::filter(Date == subset(Buoy_46053_DF$Date, Date >= min(VD_Itinerary()$Date) & Date <= max(VD_Itinerary()$Date)))
          })
        }
        else if (Buoy_Num()$station == 46054) {
          return({
            Buoy_46054_DF %>% 
              dplyr::filter(Date == subset(Buoy_46054_DF$Date, Date >= min(VD_Itinerary()$Date) & Date <= max(VD_Itinerary()$Date)))
          })
        }
        else if (Buoy_Num()$station == 46218) {
          return({
            Buoy_46218_DF %>% 
              dplyr::filter(Date == subset(Buoy_46218_DF$Date, Date >= min(VD_Itinerary()$Date) & Date <= max(VD_Itinerary()$Date)))
          })
        }
        else if (Buoy_Num()$station == 46251) {
          return({
            Buoy_46251_DF %>% 
              dplyr::filter(Date == subset(Buoy_46251_DF$Date, Date >= min(VD_Itinerary()$Date) & Date <= max(VD_Itinerary()$Date)))
          })
        }
        else{
          return({
            Buoy_46053_DF %>% 
              dplyr::filter(Date == subset(Buoy_46053_DF$Date, Date >= min(VD_Itinerary()$Date) & Date <= max(VD_Itinerary()$Date)))
          })
        }
      })
      
      output$Lealet_Buoy_Table <- renderDT({
        
        datatable(Buoy_Num_Data(), rownames = FALSE, extensions = c('Buttons', 'ColReorder'),
                  options = list(
                    scrollY = "500px", scrollX = TRUE, paging = FALSE,
                    ordering = TRUE, info = FALSE, dom = 'Bfrtip', colReorder = TRUE,
                    buttons =  c('copy', 'csv', 'excel', 'pdf', 'print'),
                    initComplete = JS("function(settings, json) {",
                                      "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});", "}"),
                    columnDefs = c(list(list(className = 'dt-center', targets = 0:7))))) %>% 
          formatStyle(names(Buoy_Num_Data()),
                      color = "black", backgroundColor = 'white')
      })
      
    }
    
  }
  
} # End of Server function  ----














